<!doctype html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>六爻排盘工具</title>
	<!-- Firebase SDK 已移除，使用 Supabase -->
	<style>
		:root { color-scheme: light dark; }
		* { box-sizing: border-box; }
		body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","Noto Sans CJK SC",sans-serif; margin: 0; padding: 20px; line-height: 1.6; }
		h1 { margin: 20px 0; color: #333; text-align: center; }
		.card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; margin: 10px -10px; }
		.kv { display: grid; grid-template-columns: 60px 1fr; gap: 2px; }
		.kv .k { color: #6b7280; }
		.kv .v { min-width: 0; }
		
		/* 简单行（问事、时间等）居中对齐 */
		.kv .k:first-child,
		.kv .k:nth-child(3),
		.kv .k:nth-child(5),
		.kv .k:nth-child(7),
		.kv .k:nth-child(9),
		.kv .k:nth-child(11) {
			align-self: center;
		}
		.kv .v:nth-child(2),
		.kv .v:nth-child(4),
		.kv .v:nth-child(6),
		.kv .v:nth-child(8),
		.kv .v:nth-child(10),
		.kv .v:nth-child(12) {
			align-self: center;
		}
		
		/* 复杂行（干支、旬空等）顶部对齐 */
		.kv .k:nth-child(13),
		.kv .k:nth-child(15) {
			align-self: start;
		}
		.kv .v:nth-child(14),
		.kv .v:nth-child(16) {
			align-self: start;
		}
		.note { font-size: 12px; color: #888; }
		.hidden { display: none; }
		.toggle { color: #888; cursor: pointer; user-select: none; font-size: 12px; font-weight: 400; }
		.terms { font-size: 12px; color: #888; line-height: 1.8; display: inline-block; text-align: left; }
		.term-item { margin-bottom: 4px; }
		.term-item.current { color: #999; }
		.term-item:not(.current) { color: #ccc; font-size: 11px; }
		.terms-table { width: 100%; border-collapse: collapse; font-size: 12px; color: #888; }
		.terms-table td { padding: 4px 6px; vertical-align: top; border-bottom: 1px dashed rgba(0,0,0,0.08); }
		.terms-table tr:last-child td { border-bottom: none; }
		.toggle { margin-left: 8px; display: inline-block; }
		.shichen { font-size: 12px; color: #888; line-height: 1.8; display: inline-block; text-align: left; }
		.shichen-list { font-size: 12px; color: #888; }
		.caret { font-size: 12px; color: #888; cursor: pointer; margin-left: 6px; }
		.ganzhi { font-size: 12px; color: #888; }
		.ganzhi-item { margin-bottom: 4px; }
		.ganzhi-label { color: #6b7280; }
		.ganzhi-table { width: 100%; border-collapse: collapse; font-size: 12px; color: #888; }
		.ganzhi-table td { padding: 4px 6px; vertical-align: top; border-bottom: 1px dashed rgba(0,0,0,0.08); text-align: center; }
		.ganzhi-table tr:last-child td { border-bottom: none; }
		.ganzhi-table td > div:first-child { font-weight: bold; margin-bottom: 4px; text-align: center; }
		.relations { font-size: 10px; color: #999; line-height: 1.3; text-align: center; background-color: #f8f9fa; padding: 4px 3px; border-radius: 3px; margin-top: 2px; }
		.xunkong-label { font-size: 10px; color: #666; margin-bottom: 2px; text-align: center; }
		.xunkong-value { font-size: 11px; color: #333; font-weight: bold; text-align: center; }
		
		/* 卦象显示样式 */
		.gua-container { display: flex; flex-direction: column; align-items: center; margin-top: 20px; width: 100%; }
		.gua-sections-row { display: flex; justify-content: center; gap: 40px; margin-bottom: 30px; width: 100%; }
		.gua-section { width: auto; min-width: 200px; }
		.ben-gua-container { border: none; border-radius: 0; padding: 15px; background-color: #f5f5f5; width: 285px; transform: translateX(10px); }
		.bian-gua-container { border: none; border-radius: 0; padding: 15px; background-color: #f5f5f5; width: 200px; transform: translateX(-20px); }
		.gua-label { font-size: 8px; color: #999; text-align: center; display: inline; font-weight: normal; margin-bottom: 10px; }
		.gua-name { font-size: 8px; color: #999; font-weight: bold; display: inline; cursor: pointer; transition: color 0.2s ease; }
		.gua-name:hover { color: #007bff !important; }
		
		/* 卦名悬浮框样式 */
		.gua-tooltip {
			position: fixed !important;
			background: rgba(0,0,0,0.95) !important;
			color: white !important;
			padding: 15px !important;
			border-radius: 8px !important;
			font-size: 12px !important;
			z-index: 999999 !important;
			width: 90% !important;
			max-width: 600px !important;
			max-height: 500px !important;
			overflow-y: auto !important;
			line-height: 1.6 !important;
			box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
			pointer-events: auto !important;
			display: block !important;
			visibility: visible !important;
			left: 50% !important;
			transform: translateX(-50%) !important;
		}
		
		.gua-tooltip .tooltip-title {
			font-weight: bold;
			font-size: 14px;
			color: #ffd700;
			margin-bottom: 10px;
			text-align: center;
			border-bottom: 1px solid #444;
			padding-bottom: 5px;
		}
		
		.gua-tooltip .tooltip-content {
			color: #e0e0e0;
		}
		
		.gua-tooltip .tooltip-content strong {
			color: #ffd700;
		}
		
		.gua-tooltip .hexagram-symbol {
			font-family: monospace;
			text-align: center;
			margin: 8px 0;
			color: #fff;
			line-height: 1.2;
		}
		.gua-header { margin-bottom: 15px; text-align: center; }
		.gua-palace { font-size: 6px; color: #999; text-align: center; margin-top: -5px; margin-bottom: 10px; }
		.line { font-family: monospace; font-size: 16px; margin: 8px 0; text-align: center; position: relative; }
		.yao-symbol { cursor: pointer; user-select: none; }

		.yao-symbol:hover { color: #007bff; }
		.shi-ying-mark { color: #999; font-size: 8px; position: absolute; left: 66%; top: 60%; transform: translateY(-50%); line-height: 1; vertical-align: middle; }
		.dizhi-mark { position: absolute; font-size: 8px; line-height: 1; vertical-align: middle; }
		.dizhi-mark-left { left: 40%; top: 60%; transform: translateY(-50%); }
		.dizhi-mark-right { left: 44%; top: 60%; transform: translateY(-50%); }
		.tiangan-mark { position: absolute; font-size: 8px; line-height: 1; vertical-align: middle; color: #666; }
		.tiangan-mark-left { left: 50%; top: 60%; transform: translate(-50%, -50%); }
		.tiangan-mark-change-left { left: 40%; top: 60%; transform: translate(-50%, -50%); }
		.tiangan-mark-right { left: 50%; top: 60%; transform: translate(-50%, -50%); }
		.liuqin-mark { position: absolute; font-size: 8px; line-height: 1; vertical-align: middle; color: #666; }
		.liuqin-mark-left { left: 32%; top: 60%; transform: translateY(-50%); }
		.liuqin-mark-right { left: 53%; top: 60%; transform: translateY(-50%); }
		.liushen-mark { position: absolute; font-size: 8px; line-height: 1; vertical-align: middle; color: #666; cursor: pointer; user-select: none; }
		.liushen-mark:hover { color: #007bff; }
		.liushen-mark-left { left: 24%; top: 60%; transform: translateY(-50%); }
		
		/* 旬空标记样式 */
		.xunkong-mark { position: absolute; font-size: 8px; line-height: 1; vertical-align: middle; color: red; }
		.xunkong-mark-left { left: 19%; top: 60%; transform: translateY(-50%); }
		.xunkong-mark-right { left: 63%; top: 60%; transform: translateY(-50%); }
		
		/* 用神标记样式 */
		.yongshen-mark { position: absolute; font-size: 8px; line-height: 1; vertical-align: middle; color: red; }
		.yongshen-mark-left { left: 6%; top: 60%; transform: translateY(-50%); }
		.yongshen-mark-right { left: 95%; top: 60%; transform: translateY(-50%); }
		
		/* 吉凶标记样式 */
		.jixiong-mark { position: absolute; font-size: 8px; line-height: 1; vertical-align: middle; color: red; cursor: pointer; user-select: none; }
		.jixiong-mark:hover { color: #007bff; }
		.jixiong-mark-left { left: 0%; top: 60%; transform: translateY(-50%); }
		
		/* 吉凶悬浮框样式 */
		.jixiong-tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; z-index: 1000; max-width: 300px; line-height: 1.4; pointer-events: none; }
		.jixiong-tooltip .title { font-weight: bold; color: white; margin-bottom: 4px; }
		.jixiong-tooltip .standard { color: white; margin-bottom: 2px; }
		.jixiong-tooltip .standard.highlight { color: #ff6b6b; font-weight: bold; }
		
		/* 日辰冲爻标记样式 */
		.daychong-mark { position: absolute; font-size: 8px; line-height: 1; vertical-align: middle; color: red; cursor: pointer; user-select: none; }
		.daychong-mark:hover { color: #007bff; }
		.daychong-mark-left { left: 11%; top: 60%; transform: translateY(-50%); }
		.daychong-mark-right { left: 68%; top: 60%; transform: translateY(-50%); }
		
		/* 暗动/日破隐藏信息样式 */
		.daychong-tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; z-index: 1000; max-width: 300px; line-height: 1.4; pointer-events: none; }
		.daychong-tooltip .title { font-weight: bold; color: white; margin-bottom: 4px; }
		.daychong-tooltip .content { color: white; margin-bottom: 2px; }
		.daychong-tooltip .highlight { color: #ff6b6b; font-weight: bold; }
		
		/* 注意事项样式 */
		.notes-title { 
			color: white; 
			font-size: 10px; 
			cursor: pointer; 
			user-select: none; 
			background-color: #444;
			padding: 2px 8px;
			border-radius: 4px;
			transition: background-color 0.2s ease;
		}
		.notes-title:hover { 
			background-color: #666; 
		}
		.notes-tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; z-index: 1000; max-width: 300px; line-height: 1.4; pointer-events: none; }
		.notes-tooltip .content { color: white; margin-bottom: 2px; }
		
		/* 便捷查询按钮容器样式 - 电脑全屏和手机适配 */
		.convenient-query-container {
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
			align-items: center;
			gap: 3px;
			max-width: 100%;
			margin: 0 auto;
			padding: 0 10px;
			text-align: center;
		}
		
		/* 便捷查询按钮标记样式 */
		.dizhi-chonghe-title, .wuxing-shengke-title, .dongyao-fadong-title, .fei-title, .shier-changsheng-title, .dongdong-xianglian-title, .bianjixiong-title, .sanheju-title { 
			color: white; 
			font-size: 10px; 
			cursor: pointer; 
			user-select: none; 
			background-color: #444;
			padding: 2px 8px;
			border-radius: 4px;
			transition: background-color 0.2s ease;
			white-space: nowrap;
			flex: 0 0 auto;
			min-width: fit-content;
			flex-shrink: 0;
		}
		

		.dizhi-chonghe-title:hover, .wuxing-shengke-title:hover, .dongyao-fadong-title:hover, .fei-title:hover, .shier-changsheng-title:hover, .dongdong-xianglian-title:hover, .bianjixiong-title:hover, .sanheju-title:hover { 
			background-color: #666; 
		}
		
		/* 便捷查询按钮的悬浮框样式 */
		.dizhi-chonghe-tooltip, .wuxing-shengke-tooltip, .dongyao-fadong-tooltip, .fei-tooltip, .shier-changsheng-tooltip, .dongdong-xianglian-tooltip, .bianjixiong-tooltip, .sanheju-tooltip { 
			position: absolute; 
			background: rgba(0,0,0,0.9); 
			color: white; 
			padding: 8px 12px; 
			border-radius: 6px; 
			font-size: 11px; 
			z-index: 1000; 
			max-width: 300px; 
			line-height: 1.4; 
			pointer-events: none; 
		}
		
		/* 十二长生悬浮框特殊样式 */
		.shier-changsheng-tooltip { 
			max-width: 650px; 
			font-size: 10px; 
		}
		
		/* 十二长生iframe样式 */
		.shier-changsheng-tooltip iframe {
			border: none;
			background: white;
			border-radius: 6px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.2);
		}
		.change { color: #DC143C; cursor: pointer; }
		
		/* 数字量化信息样式 */
		.strength-info { position: absolute; font-size: 7px; line-height: 1; vertical-align: middle; color: #333; cursor: pointer; user-select: none; }
		.strength-info:hover { color: #007bff; }
		.month-strength { left: 70%; top: 60%; transform: translateY(-50%); }
		.day-strength { left: 78%; top: 60%; transform: translateY(-50%); }
		.strength-tooltip { position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 4px 6px; border-radius: 3px; font-size: 10px; z-index: 1000; white-space: nowrap; pointer-events: none; }
		.strength-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 4px solid transparent; border-top-color: rgba(0,0,0,0.8); }
		
		/* 六神悬浮框样式 */
		.liushen-tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; z-index: 1000; max-width: 300px; line-height: 1.4; pointer-events: none; }
		.liushen-tooltip .title { font-weight: bold; color: white; margin-bottom: 4px; }
		.liushen-tooltip .attribute { color: white; margin-bottom: 2px; }
		.liushen-tooltip .positive { color: white; margin-bottom: 2px; }
		.liushen-tooltip .negative { color: white; margin-bottom: 2px; }
		
		/* 六爻悬浮框样式 */
		.yao-tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; z-index: 1000; max-width: 300px; line-height: 1.4; pointer-events: none; }
		.yao-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: rgba(0,0,0,0.9); }
		.yao-tooltip .title { font-weight: bold; color: white; margin-bottom: 4px; }
		.yao-tooltip .content { color: white; margin-bottom: 2px; }
		.yao-tooltip .highlight { color: #ff6b6b; font-weight: bold; }
		
		/* 旬空隐藏信息样式 */
		.xunkong-title { cursor: pointer; user-select: none; }
		.xunkong-title:hover { color: #007bff; }
		.xunkong-tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; z-index: 1000; max-width: 300px; line-height: 1.4; pointer-events: none; }
		.xunkong-tooltip::after { content: ''; position: absolute; top: 50%; left: -12px; transform: translateY(-50%); border: 6px solid transparent; border-right-color: rgba(0,0,0,0.9); }
		.xunkong-tooltip .title { font-weight: bold; color: white; margin-bottom: 4px; }
		.xunkong-tooltip .content { color: white; margin-bottom: 2px; }
		.xunkong-tooltip .highlight { color: #ff6b6b; font-weight: bold; }
		
		/* 五行颜色 */
		.wx-jin { color: #DAA520; } /* 金 - 金黄色 */
		.wx-mu { color: #228B22; } /* 木 - 绿色 */
		.wx-shui { color: #4169E1; } /* 水 - 蓝色 */
		.wx-huo { color: #DC143C; } /* 火 - 红色 */
		.wx-tu { color: #8B4513; } /* 土 - 棕色 */
		
		/* 三合局标记样式 */
		.sanhe-mark { position: absolute; bottom: 5px; width: 16px; height: 0.5px; cursor: pointer; z-index: 1; }
		.sanhe-shui { background-color: #4169E1; } /* 水局 - 蓝色 */
		.sanhe-mu { background-color: #228B22; } /* 木局 - 绿色 */
		.sanhe-jin { background-color: #DAA520; } /* 金局 - 金色 */
		.sanhe-huo { background-color: #DC143C; } /* 火局 - 红色 */
		
		/* 三合局悬浮框样式 */
		.sanhe-tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 11px; z-index: 1000; max-width: 300px; line-height: 1.4; pointer-events: none; }
		.sanhe-tooltip .title { font-weight: bold; color: white; margin-bottom: 4px; }
		.sanhe-tooltip .content { color: white; margin-bottom: 2px; }
		.sanhe-tooltip .highlight { color: #ff6b6b; font-weight: bold; background-color: rgba(255, 107, 107, 0.1); padding: 2px 4px; border-radius: 3px; }
		.time-ctrl { font-size: 12px; color: #888; margin-top: 6px; }
		.time-ctrl input[type="radio"] { margin-right: 4px; }
		.time-ctrl label { margin-right: 12px; cursor: pointer; }
		
		/* 电脑全屏显示 - 一行显示所有按钮 */
		@media (min-width: 768px) {
			.convenient-query-container {
				justify-content: center;
				gap: 3px;
				flex-wrap: nowrap;
			}
		}
		
		/* 手机显示 - 自动换行，保持居中 */
		@media (max-width: 767px) {
			.convenient-query-container {
				justify-content: center;
				gap: 3px;
				flex-wrap: wrap;
			}
		}
		
		/* 手机端全面响应式优化 */
		@media (max-width: 767px) {
			/* 整体容器优化 */
			body {
				padding: 10px;
				font-size: 14px;
			}
			
			/* 卡片容器优化 */
			.card {
				padding: 15px;
				margin: 10px -10px;
				border-radius: 8px;
			}
			
			/* 标题优化 */
			h1 {
				font-size: 20px;
				margin: 10px 0;
			}
			
			/* 时间控制面板优化 */
			.time-ctrl {
				flex-direction: column;
				align-items: flex-start;
				gap: 8px;
			}
			
			.time-ctrl label {
				margin-right: 0;
				margin-bottom: 4px;
			}
			
			/* 手动时间面板优化 */
			.manual-panel {
				padding: 10px;
				margin-top: 10px;
			}
			
			.manual-panel input, 
			.manual-panel select {
				width: 100%;
				margin-right: 0;
				margin-bottom: 8px;
				padding: 8px;
				box-sizing: border-box;
			}
			
			/* 农历时间面板优化 */
			.lunar-panel {
				padding: 10px;
			}
			
			.lunar-panel input, 
			.lunar-panel select {
				width: 100%;
				margin-right: 0;
				margin-bottom: 8px;
				padding: 8px;
				box-sizing: border-box;
			}
			
			/* 六爻选择区域优化 */
			#yaoInputs {
				margin-bottom: 15px;
			}
			
			#yaoInputs select {
				width: 100%;
				padding: 8px;
				margin-bottom: 10px;
				box-sizing: border-box;
			}
			
			/* 按钮优化 */
			#generateGuaBtn {
				width: 100%;
				padding: 12px;
				font-size: 16px;
				margin: 10px 0;
			}
			
			/* 排盘结果优化 */
			#guaResult {
				padding: 10px;
				font-size: 12px;
			}
			
			/* 卦象显示优化 */
			.gua-display {
				flex-direction: column;
				align-items: center;
				gap: 15px;
			}
			
			.gua-section {
				width: 100%;
				max-width: 100%;
			}
			
			/* 爻线显示优化 */
			.line {
				font-size: 12px;
				padding: 5px 0;
				word-break: break-all;
			}
			
			/* 悬浮框优化 */
			.dizhi-chonghe-tooltip, 
			.wuxing-shengke-tooltip, 
			.dongyao-fadong-tooltip, 
			.fei-tooltip, 
			.shier-changsheng-tooltip, 
			.dongdong-xianglian-tooltip, 
			.bianjixiong-tooltip {
				max-width: 280px;
				font-size: 10px;
				padding: 6px 10px;
			}
			
			/* 表格优化 */
			table {
				font-size: 11px;
			}
			
			table td, table th {
				padding: 4px 6px;
			}
		}
		


		.manual-panel { margin-top: 8px; padding: 8px; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; background: rgba(255,255,255,0.5); }
		.manual-panel input, .manual-panel select { margin-right: 8px; padding: 4px 6px; border: 1px solid rgba(0,0,0,0.2); border-radius: 4px; }
		.ganzhi { font-size: 12px; color: #888; }
		.ganzhi-item { margin-bottom: 4px; }
		.ganzhi-label { color: #6b7280; }
		.ganzhi-table { width: 100%; border-collapse: collapse; font-size: 12px; color: #888; }
		.ganzhi-table td { padding: 4px 6px; vertical-align: top; border-bottom: 1px dashed rgba(0,0,0,0.08); }
		.ganzhi-table tr:last-child td { border-bottom: none; }
		

		
		#yongshenSelect option {
			text-align: center;
		}
		
		/* 用神选择框样式 - 与问事框右对齐 */
		#yongshenText {
			width: 85% !important;
		}
		
		/* 手机端用神框样式 */
		@media (max-width: 767px) {
			#yongshenText {
				width: 70% !important;
			}
		}
		
		/* 手机端样式调整 */
		@media (max-width: 767px) {
			/* 本卦容器调整 */
			.ben-gua-container {
				width: 290px !important;
				max-width: 290px !important;
				min-width: 290px !important;
				transform: translateX(36px) scale(0.85) !important;
			}
			
			/* 变卦容器调整 */
			.bian-gua-container {
				transform: translateX(-46px) scale(0.85) !important;
			}
			
			/* 防止伏神日辰月建数字换行 */
			.fushen-strength-mark,
			.strength-info {
				white-space: nowrap !important;
				display: inline-block !important;
			}
			
			/* 防止所有数字量化标记换行 */
			.month-strength-mark, .day-strength-mark {
				white-space: nowrap !important;
				display: inline-block !important;
			}
			
			/* 防止伏神数值容器换行 */
			.fushen-values {
				white-space: nowrap !important;
				display: inline-block !important;
			}
		}
		
		/* 9:16比例及以下屏幕优化 */
		@media (max-aspect-ratio: 9/16), (max-width: 768px) {
			/* 工具按钮 - 9:16以及更小页面时一行两个按钮 */
			.tools-grid {
				grid-template-columns: repeat(2, 1fr) !important;
				gap: 12px !important;
				padding: 2px 2px 10px 2px !important;
				justify-items: center !important;
				align-items: center !important;
			}
			
			.tool-button {
				height: 35px !important;
				width: 150px !important;
			}
			
			.tool-name {
				font-size: 17px !important;
			}
			
			
			/* 本卦变卦容器调整 */
			.ben-gua-container {
				width: 250px !important;
				max-width: 250px !important;
				min-width: 250px !important;
				transform: translate(30px, -55px) scale(0.75) !important;
				padding: 10px !important;
			}
			
			.bian-gua-container {
				width: 200px !important;
				max-width: 200px !important;
				min-width: 200px !important;
				transform: translate(-37px, -55px) scale(0.75) !important;
				padding: 10px !important;
			}
			
			/* 卦象显示区域调整 */
			.gua-sections-row {
				gap: 20px !important;
				margin-bottom: 0 !important;
			}
			
			/* 卦象标签和名称调整 */
			.gua-label, .gua-name {
				font-size: 7px !important;
			}
			
			/* 爻位信息调整 */
			.yao-info {
				font-size: 10px !important;
			}
			
			/* 整体容器调整 */
			.gua-container {
				margin-top: 0 !important;
				margin-bottom: -20px !important;
			}
			
			/* 断卦笔记容器调整 */
			.duangua-notes {
				margin: 20px -18px !important;
				transform: translateY(-65px) !important;
			}
			
			/* 时间相关字体调整 */
			.kv .v {
				font-size: 12px !important;
			}
			
			.kv .v input[type="radio"] + label {
				font-size: 11px !important;
			}
			
			/* 时间源按钮垂直对齐 */
			.kv .v input[type="radio"] {
				vertical-align: middle !important;
				margin-right: 3px !important;
				margin-top: -1px !important;
			}
			
			.kv .v label {
				vertical-align: middle !important;
				display: inline-block !important;
				margin-right: 8px !important;
			}
		}
		
		/* 断卦笔记样式 */
		.duangua-notes {
			margin: 20px -8px;
			padding: 20px;
			border: 1px solid #ddd;
			border-radius: 8px;
			background: #f9f9f9;
		}
		.duangua-notes h3 {
			text-align: center;
			margin: 0 0 15px 0;
			color: #333;
			font-size: 16px;
		}
		.duangua-input {
			width: 100%;
			min-height: 80px;
			padding: 12px;
			border: none;
			border-radius: 6px;
			font-size: 14px;
			font-family: inherit;
			resize: vertical;
			margin-bottom: 15px;
			box-sizing: border-box;
			margin-left: -10px;
			margin-right: -10px;
			width: calc(100% + 20px);
			background: transparent;
			outline: none;
		}
		.duangua-steps {
			font-size: 13px;
			color: #666;
			line-height: 1.6;
		}
		.duangua-steps .step {
			margin-bottom: 8px;
		}
		.duangua-steps .step-title {
			font-weight: bold;
			color: #333;
			margin-bottom: 4px;
		}
		.duangua-steps .step-content {
			margin-left: 20px;
		}
		.duangua-steps .highlight {
			color: #ff6b6b;
			font-weight: bold;
		}
		
		/* 断卦步骤小三角样式 */
		.duangua-toggle {
			display: inline-block;
			width: 0;
			height: 0;
			border-top: 6px solid #666;
			border-left: 4px solid transparent;
			border-right: 4px solid transparent;
			cursor: pointer;
			margin-left: 8px;
			transition: transform 0.3s ease;
		}
		.duangua-toggle.expanded {
			transform: rotate(180deg);
		}
		.duangua-steps-content {
			display: block;
			transition: all 0.3s ease;
		}
		.duangua-steps-content.hidden {
			display: none;
		}
		
		/* 动爻发动信息标记样式 */
		.dongyao-mark {
			position: absolute;
			font-size: 7px;
			line-height: 1;
			vertical-align: middle;
			color: #333;
			cursor: pointer;
			user-select: none;
			z-index: 10;
		}
		.dongyao-mark:hover {
			color: #007bff;
		}
		.dongyao-mark-right {
			left: 85%;
			top: 60%;
			transform: translateY(-50%);
		}
		.dongyao-mark .fei {
			color: red;
			font-weight: bold;
		}
		
		/* 动爻发动信息悬浮框样式 */
		.dongyao-tooltip {
			position: absolute;
			background: rgba(0,0,0,0.9);
			color: white;
			padding: 8px 12px;
			border-radius: 6px;
			font-size: 11px;
			z-index: 1000;
			max-width: 300px;
			line-height: 1.4;
			pointer-events: none;
		}
		.dongyao-tooltip .title {
			font-weight: bold;
			color: white;
			margin-bottom: 4px;
		}
		.dongyao-tooltip .content {
			color: white;
			margin-bottom: 2px;
		}
		.dongyao-tooltip .highlight {
			color: #ff6b6b;
			font-weight: bold;
		}
		.dongyao-tooltip .wuxing {
			color: white;
			margin-bottom: 2px;
		}
		
		/* 底部导航栏样式 */
		.bottom-navigation {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			background-color: #fff;
			border-top: 1px solid #e5e7eb;
			box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
			z-index: 1000;
			display: flex;
			height: 75px;
		}
		
		.nav-tab {
			flex: 1;
			display: flex;
			align-items: flex-start;
			justify-content: center;
			cursor: pointer;
			transition: all 0.3s ease;
			border-right: 1px solid #e5e7eb;
			font-size: 14px;
			font-weight: 500;
			color: #6b7280;
			padding-top: 15px;
		}
		
		.nav-tab:last-child {
			border-right: none;
		}
		
		.nav-tab.active {
			color: #374151;
			background-color: #f3f4f6;
		}
		
		.nav-tab:hover {
			background-color: #e5e7eb;
		}
		
		.nav-tab.active:hover {
			background-color: #e5e7eb;
		}
		
		/* 主内容区域样式 */
		.main-content {
			padding-bottom: 95px; /* 为底部导航栏留出空间 */
			padding-top: 40px; /* 为顶部导航栏留出空间 */
		}
		
		/* 标签页内容样式 */
		.tab-content {
			display: none;
		}
		
		.tab-content.active {
			display: block;
		}
		
		/* 学习页面样式 */
		.study-container {
			padding: 0px;
			max-width: 1200px;
			margin: 0 auto;
		}
		
		/* 学习页面body padding调整 */
		#study-tab body {
			padding: 0px !important;
		}
		
		/* 工具页面样式 */
		.tools-container {
			padding: 20px;
			max-width: 1200px;
			margin: 0 auto;
			padding-top: -50px; /* 为固定导航栏留出空间 */
		}
		
		.tools-content {
			background: transparent;
			padding: 0;
		}
		
		/* 工具按钮容器 */
		.tools-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 15px;
			padding: 0px 20px 20px 20px;
			max-width: 600px;
			margin: 0 auto;
			margin-top: -100px;
		}
		
		/* 移动端响应式调整 */
		@media (max-width: 768px) {
			.tools-grid {
				grid-template-columns: repeat(3, 1fr);
				gap: 10px;
				padding: 0px 15px 15px 15px;
			}
			
			.tool-button {
				width: 100%;
				height: 26px;
			}
			
			.tool-name {
				font-size: 11px;
			}
		}
		
		@media (max-width: 768px) {
			.tools-grid {
				grid-template-columns: repeat(2, 1fr) !important;
				gap: 12px !important;
				padding: 2px 2px 10px 2px !important;
				justify-items: center !important;
				align-items: center !important;
			}
			
			.tool-button {
				height: 35px !important;
				width: 150px !important;
			}
			
			.tool-name {
				font-size: 17px !important;
			}
			
			/* 记录详情页面紫色容器在较小屏幕下调整 */
			#view-record-tab .paipan-container > div[style*="background: #8B5CF6"] {
				max-width: 90% !important;
				margin-left: auto !important;
				margin-right: auto !important;
			}
		}
		
		@media (max-width: 480px) {
			.tools-grid {
				gap: 8px;
				padding: 0px 10px 10px 10px;
			}
			
			.tool-button {
				height: 23px;
			}
			
			.tool-name {
				font-size: 10px;
			}
		}
		
            /* 工具按钮样式 */
            .tool-button {
                    width: 100px;
                    height: 33px;
                    background: white;
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: #333333;
                    font-family: 'Microsoft YaHei', Arial, sans-serif;
                    position: relative;
                    overflow: hidden;
            }
		
            .tool-button:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    background: #f8f8f8;
                    color: #333333;
                    border-color: #d0d0d0;
            }
		
		.tool-button:active {
			transform: translateY(-2px);
		}
		
		.tool-button::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
			opacity: 0;
			transition: opacity 0.3s ease;
		}
		
		.tool-button:hover::before {
			opacity: 1;
		}
		
		.tool-name {
			font-size: 12px;
			font-weight: 600;
			text-align: center;
			line-height: 1.2;
			z-index: 1;
			position: relative;
		}
		
		/* 统一工具按钮颜色 - 已移除蓝紫色覆盖 */
		
		/* 工具子板块导航 */
		.tools-nav {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			display: flex;
			background: white;
			justify-content: center;
			z-index: 1000;
			padding: 20px 0 -6px 0;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		
		.tools-nav-item {
			padding: 22px 24px 2px 24px;
			cursor: pointer;
			color: #374151;
			font-size: 16px;
			font-weight: 500;
			transition: all 0.2s ease;
		}
		
		.tools-nav-item:hover {
			color: #6b7280;
		}
		
		.tools-nav-item.active {
			color: #374151;
		}
		
		/* 学习子板块导航 */
		.study-nav {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			display: flex;
			justify-content: center;
			align-items: flex-end;
			background: white;
			z-index: 1000;
			padding: 0px 0 -6px 0;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		
		.study-nav-item {
			padding: 22px 24px 2px 24px;
			cursor: pointer;
			color: #6b7280;
			font-size: 16px;
			font-weight: 500;
			border-bottom: 2px solid transparent;
			transition: all 0.2s ease;
		}
		
		.study-nav-item:hover {
			color: #374151;
		}
		
		.study-nav-item.active {
			color: #374151;
		}
		
		/* 学习子板块内容 */
		.study-subsection {
			display: none;
			background: transparent;
			border-radius: 0;
			box-shadow: none;
			padding: 0;
			min-height: calc(100vh - 140px); /* 适配固定导航栏的高度 */
		}
		
		/* 视频容器样式 */
		.video-container {
			transition: transform 0.2s ease, box-shadow 0.2s ease;
		}
		
		.video-container:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.15);
		}
		
		.study-subsection.active {
			display: block;
		}
		
		.study-subsection h3 {
			margin: 0 0 15px 0;
			color: #374151;
			font-size: 18px;
			text-align: center;
		}
		
		.study-content p {
			margin: 8px 0;
			line-height: 1.6;
			color: #4b5563;
			text-align: center;
		}
		
		.study-content strong {
			color: #374151;
			font-weight: 600;
		}
		
		/* 书本按钮样式 */
		.book-container {
			display: flex;
			flex-wrap: wrap;
			gap: 20px;
			justify-content: center;
			width: 100%;
			margin-left: auto;
			margin-right: auto;
		}
		
		#study-library {
			margin-top: -135px;
		}
		
           .book-button {
                   position: relative;
                   width: 84px;
                   height: 112px;
                   background: linear-gradient(135deg, #666666 0%, #555555 50%, #444444 100%);
                   border-radius: 6px 8px 8px 6px;
                   cursor: pointer;
                   transition: all 0.3s ease;
                   box-shadow: 
                           0 3px 6px rgba(0,0,0,0.3),
                           inset -1px 0 3px rgba(0,0,0,0.2),
                           inset 0 1px 1px rgba(255,255,255,0.1);
                   transform: perspective(200px) rotateY(-5deg);
                   display: flex;
                   flex-direction: column;
                   align-items: center;
                   justify-content: center;
                   padding: 10px 7px;
           }
		
		.book-button:hover {
			transform: perspective(200px) rotateY(0deg) translateY(-5px);
			box-shadow: 
				0 8px 16px rgba(0,0,0,0.4),
				inset -2px 0 4px rgba(0,0,0,0.2),
				inset 0 1px 2px rgba(255,255,255,0.1);
		}
		
           .book-button::before {
                   content: '';
                   position: absolute;
                   left: 0;
                   top: 0;
                   bottom: 0;
                   width: 3px;
                   background: linear-gradient(to bottom, #333333, #555555, #333333);
                   border-radius: 8px 0 0 8px;
           }
		
           .book-button::after {
                   content: '';
                   position: absolute;
                   right: 0;
                   top: 0;
                   bottom: 0;
                   width: 2px;
                   background: linear-gradient(to bottom, #333333, #555555, #333333);
                   border-radius: 0 12px 12px 0;
           }
		
		.book-title {
			color: #F5DEB3;
			font-size: 10px;
			font-weight: bold;
			text-align: center;
			line-height: 1.2;
			text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
			margin-bottom: 6px;
		}
		
		.book-author {
			color: #DEB887;
			font-size: 7px;
			text-align: center;
			text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
		}
		
		.book-pages {
			position: absolute;
			right: 8px;
			top: 50%;
			transform: translateY(-50%);
			width: 2px;
			height: 60%;
			background: linear-gradient(to bottom, 
				rgba(255,255,255,0.1) 0%, 
				rgba(255,255,255,0.05) 50%, 
				rgba(0,0,0,0.1) 100%);
			border-radius: 1px;
		}
		
		/* 练习按钮样式 */
		.practice-container {
			width: 100%;
		}
		
		.practice-button {
			width: 100%;
			background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
			border: 2px solid #dee2e6;
			border-radius: 12px;
			padding: 20px;
			margin-bottom: 15px;
			cursor: pointer;
			transition: all 0.3s ease;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			position: relative;
			overflow: hidden;
		}
		
		.practice-button:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 16px rgba(0,0,0,0.15);
			border-color: #007bff;
		}
		
		.practice-button:active {
			transform: translateY(0);
		}
		
		.practice-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 12px;
		}
		
		.practice-name {
			font-size: 18px;
			font-weight: bold;
			color: #2c3e50;
			margin: 0;
		}
		
		.practice-status {
			font-size: 14px;
			font-weight: 600;
			padding: 4px 12px;
			border-radius: 20px;
			text-align: center;
			min-width: 60px;
		}
		
		.practice-status.completed {
			background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
			color: #8b6914;
			box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
		}
		
		.practice-status.not-completed {
			background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
			color: #ffffff;
		}
		
		.practice-difficulty {
			display: flex;
			align-items: center;
			gap: 4px;
		}
		
		.difficulty-label {
			font-size: 14px;
			color: #6c757d;
			margin-right: 8px;
		}
		
		.difficulty-stars {
			display: flex;
			gap: 2px;
		}
		
		.star {
			font-size: 16px;
			color: #dee2e6;
			transition: color 0.2s ease;
		}
		
		.star.filled {
			color: #ffc107;
		}
		
		.star.half-filled {
			background: linear-gradient(90deg, #ffc107 50%, #dee2e6 50%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}
		
		/* 排盘页面样式 */
		.paipan-container {
			padding: 20px;
			max-width: 1200px;
			margin: 0 auto;
			padding-top: 20px; /* 减少顶部间距 */
		}
		
		/* 记录详情页面样式 */
		#view-record-tab .paipan-container {
			max-width: 1200px;
		}
		
		/* 记录详情页面body padding调整 */
		#view-record-tab body {
			padding: 10px !important;
		}
		
		/* 记录详情页面本卦变卦内容缩小 */
		#view-record-tab .gua-container {
			transform: scale(0.90);
			transform-origin: top center;
		}
		
		/* 记录详情页面本卦变卦容器顶部间隙 */
		#view-record-tab .record-gua-content {
			padding-top: 50px !important;
		}
		
		/* 记录详情页面断卦笔记容器宽度和居中 */
		#view-record-tab .duangua-notes {
			width: 100% !important;
			max-width: 100% !important;
			margin: 20px 0 !important;
			display: block !important;
			text-align: center !important;
		}
		
		
		/* 排盘子板块导航 */
		.paipan-nav {
			position: fixed;
			top: 0; /* 恢复到顶部 */
			left: 0;
			right: 0;
			display: flex;
			justify-content: center;
			align-items: flex-end;
			background: white;
			z-index: 1000; /* 恢复高 z-index */
			padding: 20px 0 -6px 0;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		
		.paipan-nav-item {
			padding: 22px 24px 2px 24px;
			cursor: pointer;
			color: #374151;
			font-size: 16px;
			font-weight: 500;
			border-bottom: 2px solid transparent;
			transition: all 0.2s ease;
		}
		
		/* 记录页面样式 */
		.record-container {
			padding: 20px;
			max-width: 1200px;
			margin: 0 auto;
			padding-top: 20px; /* 为固定导航栏留出空间 */
		}
		
		/* 记录子板块导航 */
		.record-nav {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			display: flex;
			justify-content: center;
			align-items: flex-end;
			background: white;
			z-index: 1000;
			padding: 20px 0 -6px 0;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}
		
		.record-nav-item {
			padding: 22px 24px 2px 24px;
			cursor: pointer;
			color: #374151;
			font-size: 16px;
			font-weight: 500;
			border-bottom: 2px solid transparent;
			transition: all 0.2s ease;
		}
		
		/* 排盘记录样式 */
		.record-list {
			padding: 20px 0;
			min-height: calc(100vh - 140px);
			width: 97%;
			margin: 0 auto;
		}
		
		.record-item {
			background: transparent;
			border-radius: 0;
			box-shadow: none;
			padding: 20px 0;
			margin-bottom: 0;
			border-left: none;
			border-top: 1px solid rgba(0,0,0,0.1);
			border-bottom: 1px solid rgba(0,0,0,0.1);
		}
		
		.record-item:first-child {
			border-top: none;
			margin-top: -120px;
		}
		
		.record-item:last-child {
			border-bottom: none;
		}
		
		.record-empty {
			text-align: center;
			color: #9ca3af;
			font-size: 16px;
			margin-top: 100px;
		}
		
		/* 查看记录详情页面导航栏样式 */
		.view-record-header {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			z-index: 1000;
			background-color: #374151;
			color: white;
			padding: 8px 20px;
			display: flex;
			align-items: center;
			gap: 12px;
			border-bottom: 1px solid #4b5563;
		}
		
		/* 记录详情页面特殊样式 - 减少顶部留白 */
		#view-record-tab {
			padding-top: 0 !important;
			margin-top: -60px !important;
		}
		
		.back-button {
			background: none;
			border: none;
			color: white;
			cursor: pointer;
			padding: 4px 8px;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: background-color 0.2s;
		}
		
		.back-button:hover {
			background-color: #4b5563;
		}
		
		.back-arrow {
			font-size: 28px;
			font-weight: bold;
			line-height: 1;
		}
		
		.header-title {
			font-size: 16px;
			font-weight: 500;
		}
	</style>
</head>
<body>
	<!-- 主内容区域 -->
	<div class="main-content">
		<!-- 六爻排盘标签页 -->
		<div id="paipan-tab" class="tab-content active">
			<!-- 排盘子板块导航 -->
			<div class="paipan-nav">
				<div class="paipan-nav-item active">六爻排盘</div>
			</div>
			
			<div class="paipan-container">
				<div class="card">
		<div class="kv">
			<div class="k">问事</div>
			<div class="v">
				<input type="text" id="questionText" placeholder="请输入要问的事项...（选填）" style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
			</div>
			<div class="k" style="display: flex; align-items: center;">用神</div>
			<div class="v">
				<input type="text" id="yongshenText" placeholder="请选择用神" list="yongshenOptions" required pattern="^(父母|妻财|官鬼|兄弟|子孙|世爻|应爻)$" title="请输入：父母、妻财、官鬼、兄弟、子孙、世爻、应爻之一" style="width: 30%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
				<span id="judgeBasis" style="color: #999; font-size: 12px; cursor: pointer; margin-left: 8px; text-decoration: underline;">*判断依据</span>
				<datalist id="yongshenOptions">
					<option value="父母"></option>
					<option value="妻财"></option>
					<option value="官鬼"></option>
					<option value="兄弟"></option>
					<option value="子孙"></option>
					<option value="世爻"></option>
					<option value="应爻"></option>
				</datalist>
			</div>
			<div class="k">时间</div><div class="v" id="nowText">—</div>
			<div class="k">&nbsp;</div> <!-- 时间源 -->
			<div class="v">
				<input type="radio" id="realtimeToggle" name="timeSource" value="realtime" checked>
				<label for="realtimeToggle">实时</label>
				<input type="radio" id="manualToggle" name="timeSource" value="manual">
				<label for="manualToggle">手动(阳历)</label>
				<input type="radio" id="lunarToggle" name="timeSource" value="lunar">
				<label for="lunarToggle">手动(农历)</label>
			</div>
			<div class="k"></div>
			<div class="v">
				<div id="manualPanel" class="manual-panel hidden">
					<input type="number" id="manualYear" placeholder="年" min="1900" max="2100">
					<input type="number" id="manualMonth" placeholder="月" min="1" max="12">
					<select id="manualDay">
						<option value="">日</option>
					</select>
					<input type="number" id="manualHour" placeholder="时" min="0" max="23">
					<input type="number" id="manualMinute" placeholder="分" min="0" max="59">
					<input type="number" id="manualSecond" placeholder="秒" min="0" max="59">
				</div>
				<div id="lunarPanel" class="manual-panel hidden">
					<input type="number" id="lunarYear" placeholder="年" min="1900" max="2100">
					<input type="number" id="lunarMonth" placeholder="月" min="1" max="12">
					<select id="lunarDay">
						<option value="">日</option>
					</select>
					<input type="number" id="lunarHour" placeholder="时" min="0" max="23">
					<input type="number" id="lunarMinute" placeholder="分" min="0" max="59">
					<input type="number" id="lunarSecond" placeholder="秒" min="0" max="59">
				</div>
			</div>
			<div class="k">时辰</div>
			<div class="v">
				<div id="currentShiText" class="shichen">—</div><span id="shiCaret" class="caret">▼</span>
				<div id="shiPanel" class="hidden shichen-list" style="margin-top:6px;"></div>
			</div>
			<div class="k">节气</div>
			<div class="v">
				<div id="currentTermText" class="terms">—</div><span id="toggleTerms" class="caret">▼</span>
				<div id="termPanel" class="hidden" style="margin-top:6px;">
					<table class="terms-table" id="termTable"></table>
				</div>
			</div>
			<div class="k">干支</div>
			<div class="v">
				<div id="ganzhiText" class="ganzhi">—</div>
			</div>
			<div class="k"><span class="xunkong-title">旬空</span></div>
			<div class="v">
				<div id="xunkongText" class="ganzhi">—</div>
			</div>
		</div>
		<div class="note" style="text-align: center; margin-top: 20px; font-size: 10px;">所有时间基于中国标准时间（Asia/Shanghai，UTC+8）<br>页面每秒自动更新</div>
	</div>

	<!-- 便捷查询按钮 -->
	<div class="card" style="background: transparent; box-shadow: none; margin: 0; padding: 10px 0;">
		<div style="text-align: center; display: flex; align-items: center; justify-content: center; min-height: 40px;">
			<div class="convenient-query-container">
				<span class="notes-title">卜前必看</span>
				<span class="dizhi-chonghe-title">地支冲合</span>
				<span class="wuxing-shengke-title">五行生克</span>
				<span class="dongyao-fadong-title">动爻发动</span>
				<span class="fei-title">废</span>
				<span class="shier-changsheng-title">十二长生</span>
				<span class="dongdong-xianglian-title">动动相连</span>
				<span class="bianjixiong-title">辨吉凶</span>
				<span class="sanheju-title">三合局</span>
			</div>
		</div>
	</div>

	<!-- 判断依据详细说明（隐藏，悬浮框形式） -->
	<div id="judgeBasisImage" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); width: 80%; max-width: 800px; max-height: 80%; overflow-y: auto;">
		<div style="text-align: left; max-width: 600px; margin: 0 auto 20px auto; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
			<div style="font-weight: bold; color: #333; margin-bottom: 10px; font-size: 14px;">判断用神原则：</div>
			<div style="color: #666; line-height: 1.6; font-size: 12px;">
				<div style="margin-bottom: 8px;">• 优先取世爻、应爻为用神（应爻是对方，世爻是我）</div>
				<div style="margin-bottom: 8px;">• 再取动爻为用神</div>
				<div style="margin-bottom: 8px;">• 最后取有特殊现象的爻为用神——神兆机与动（月破、日冲、月合、日合、旬空......）</div>
			</div>
		</div>
		
		<div style="text-align: left; max-width: 600px; margin: 0 auto; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
			<div style="margin-bottom: 20px;">
				<div style="font-weight: bold; color: #333; margin-bottom: 4px; font-size: 13px;">父母：<span style="font-weight: normal; color: #666; font-size: 12px;">凡生我.对我有益,能庇护保护我的都叫父母,不止父母亲。</span></div>
				<div style="color: #666; line-height: 1.6; font-size: 12px; margin-bottom: 4px;">
					<span style="color: #DC143C;">预测考学,以父母为成绩;生意往来中,以父母为合同契约等……</span>
				</div>
				<div style="color: #666; line-height: 1.6; font-size: 12px;">
					<div style="margin-bottom: 4px;">1.代表父母、长辈、老人、老师、师父等人际关系</div>
					<div style="margin-bottom: 4px;">2.代表房屋、衣物、雨伞等庇护我的物品</div>
					<div style="margin-bottom: 4px;">3.代表书信、文书、契约、合同、成绩等与文星有关的事物</div>
					<div style="margin-bottom: 4px;">4.代表信息、消息、短信等现代通讯、公交卡、银行卡</div>
					<div style="margin-bottom: 4px;">5.代表车辆、飞机等运输工具</div>
					<div style="margin-bottom: 4px;">6.代表下雨、下雪等天气现象</div>
				</div>
			</div>
			<div style="margin-bottom: 20px;">
				<div style="font-weight: bold; color: #333; margin-bottom: 4px; font-size: 13px;">兄弟：<span style="font-weight: normal; color: #666; font-size: 12px;">与我比肩的、同辈的、相互竞争的人事。</span></div>
				<div style="color: #666; line-height: 1.6; font-size: 12px;">
					<div style="margin-bottom: 4px;">1.代表兄弟姐妹、堂兄堂妹、关系较好的表兄表妹、关系较好的朋友、同事、同僚、师兄弟等同辈人</div>
					<div style="margin-bottom: 4px;">2.代表假肢、假牙、假发等替代品</div>
					<div style="margin-bottom: 4px;">3.代表同行等竞争对手</div>
					<div style="margin-bottom: 4px;">4.代表破财、截财、花费等破财之事</div>
					<div style="margin-bottom: 4px;">5.代表阻碍、阻拦、门槛等不顺畅之事</div>
					<div style="margin-bottom: 4px;">6.代表大风、逆风等天气</div>
				</div>
			</div>
			<div style="margin-bottom: 20px;">
				<div style="font-weight: bold; color: #333; margin-bottom: 4px; font-size: 13px;">子孙<span style="color: #DC143C;">(解忧之神)</span>:<span style="font-weight: normal; color: #666; font-size: 12px;">我所生,受我庇护的人或事物。</span></div>
				<div style="color: #666; line-height: 1.6; font-size: 12px;">
					<div style="margin-bottom: 4px;">1.代表儿女、孙子、孙女、幼儿、胎儿、晚辈、徒弟、下属等人际关系,如入赘的女婿、师父收的徒弟</div>
					<div style="margin-bottom: 4px;">2.代表医生、医药、救治、医疗器械、健身器械等与救死扶伤有关的事物</div>
					<div style="margin-bottom: 4px;">3.代表忠臣、良将、神灵等正派角色</div>
					<div style="margin-bottom: 4px;">4.代表六禽、六畜等动物角色,<span style="color: #DC143C;">凡测动物,以子孙为用神(我庇护的,野生动物不受我庇护的另算)</span></div>
					<div style="margin-bottom: 4px;">5.代表娱乐、开心、玩乐、消遣等高兴快乐事物</div>
					<div style="margin-bottom: 4px;">6.代表僧侣道士天师等克鬼职业</div>
					<div style="margin-bottom: 4px;">7.代表顺风、福德、天晴等有宜之事</div>
				</div>
			</div>
			
			<div style="margin-bottom: 20px;">
				<div style="font-weight: bold; color: #333; margin-bottom: 4px; font-size: 13px;">妻财：<span style="font-weight: normal; color: #666; font-size: 12px;">受我掌控、支配的人事。</span></div>
				<div style="color: #666; line-height: 1.6; font-size: 12px; margin-bottom: 4px;">
					<span style="color: #DC143C;">测财运不论男女,妻财为用神;男士测婚姻姻缘,妻财为用神。</span>
				</div>
				<div style="color: #666; line-height: 1.6; font-size: 12px;">
					<div style="margin-bottom: 4px;">1.代表妻子、情人、女友、暧昧对象、相亲对象等女性(之前的,现在的、未来的)</div>
					<div style="margin-bottom: 4px;">2.代表钱、金银、首饰、报酬、薪水、奖金等与钱财有关的物品</div>
					<div style="margin-bottom: 4px;">3.代表私人用品、失物等</div>
					<div style="margin-bottom: 4px;">4.代表粮食、食物、酒水等饮食</div>
				</div>
			</div>
			<div style="margin-bottom: 20px;">
				<div style="font-weight: bold; color: #333; margin-bottom: 4px; font-size: 13px;">官鬼<span style="color: #DC143C;">(灾/病)</span>：<span style="font-weight: normal; color: #666; font-size: 12px;">克我的、制约我的人事。</span></div>
				<div style="color: #666; line-height: 1.6; font-size: 12px; margin-bottom: 4px;">
					<span style="color: #DC143C;">测工作不论男女,官鬼为用神;女士测婚姻姻缘,官鬼为用神。</span>
				</div>
				<div style="color: #666; line-height: 1.6; font-size: 12px;">
					<div style="margin-bottom: 4px;">1.代表官员、老板、领导、丈夫、男友、情郎等管束我的人</div>
					<div style="margin-bottom: 4px;">2.代表盗贼、犯罪分子等不正当的职业</div>
					<div style="margin-bottom: 4px;">3.代表疾病、灾祸等凶险之事</div>
					<div style="margin-bottom: 4px;">4.代表事业、官运、工作之事</div>
					<div style="margin-bottom: 4px;">5.代表疑虑、焦虑、担心、害怕等忧患之事</div>
					<div style="margin-bottom: 4px;">6.代表鬼怪、鬼神、尸体、去世的人等</div>
				</div>
			</div>
			
			<div style="margin-bottom: 20px;">
				<div style="font-weight: bold; color: #333; margin-bottom: 4px; font-size: 13px;">总结：</div>
				<div style="color: #666; line-height: 1.6; font-size: 12px;">
					<div style="margin-bottom: 4px;"><span style="color: #DC143C;">测自己的病,世爻为用神；测财运如何,妻财为用神</span></div>
					<div style="margin-bottom: 4px;"><span style="color: #DC143C;">测考试成绩,父母为用神；测是否升迁,官鬼为用神</span></div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- 独立的关闭按钮，固定在屏幕右上角 -->
	<button id="closeJudgeBasisBtn" onclick="document.getElementById('judgeBasisImage').style.display='none'; this.style.display='none';" style="display: none; position: fixed; top: 20px; right: 20px; padding: 8px 16px; background-color: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; z-index: 1002;">关闭</button>



	<!-- 六爻卦象选择部分 -->
	<div class="card">
		<div id="yaoInputs" style="text-align: center;">
			<div style="display: inline-block; text-align: left;">
				<div style="margin-bottom: 8px;"><span style="display: inline-block; width: 40px; font-size: 12px;">上爻</span><select id="line6" style="width: 120px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;"></select></div>
				<div style="margin-bottom: 8px;"><span style="display: inline-block; width: 40px; font-size: 12px;">五爻</span><select id="line5" style="width: 120px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;"></select></div>
				<div style="margin-bottom: 8px;"><span style="display: inline-block; width: 40px; font-size: 12px;">四爻</span><select id="line4" style="width: 120px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;"></select></div>
				<div style="margin-bottom: 8px;"><span style="display: inline-block; width: 40px; font-size: 12px;">三爻</span><select id="line3" style="width: 120px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;"></select></div>
				<div style="margin-bottom: 8px;"><span style="display: inline-block; width: 40px; font-size: 12px;">二爻</span><select id="line2" style="width: 120px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;"></select></div>
				<div style="margin-bottom: 8px;"><span style="display: inline-block; width: 40px; font-size: 12px;">初爻</span><select id="line1" style="width: 120px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;"></select></div>
			</div>
		</div>
		<div style="text-align: center;">
			<button id="generateGuaBtn" style="padding: 10px 40px; font-size: 16px; background-color: #000000; color: white; border: none; border-radius: 4px; cursor: pointer; text-align: center; min-width: 120px; display: block; margin: 0 auto;">开始排盘</button>
			<div id="yongshenError" class="note" style="color:#DC143C; margin-top:8px; display:none;">请选择用神</div>
		</div>
		<div id="guaResult"></div>
		</div>
		</div>
			</div>
		</div>
		
		<!-- 排盘记录标签页 -->
		<div id="record-tab" class="tab-content">
			<!-- 记录子板块导航 -->
			<div class="record-nav">
				<div class="record-nav-item active">排盘记录</div>
			</div>
			
			<div class="record-container">
				<div class="record-list">
				<div class="record-empty">
					<p>暂无排盘记录</p>
					<p style="font-size: 14px; margin-top: 8px;">完成排盘后，记录将显示在这里</p>
				</div>
				</div>
			</div>
		</div>
		
		<!-- 查看记录详情标签页 -->
		<div id="view-record-tab" class="tab-content">
			<!-- 记录详情内容将在这里动态生成 -->
		</div>
		
		<!-- 学习标签页 -->
		<div id="study-tab" class="tab-content">
			<div class="study-container">
				<!-- 学习子板块导航 -->
				<div class="study-nav">
					<div class="study-nav-item active" data-subsection="library">书库</div>
					<div class="study-nav-item" data-subsection="practice">练习</div>
					<div class="study-nav-item" data-subsection="video">视频</div>
				</div>
				
				<!-- 书库子板块 -->
				<div id="study-library" class="study-subsection active">
					<div class="book-container" style="background: transparent; margin-top: 80px;">
						<div class="book-button" onclick="openBook('book1')">
							<div class="book-title">《周易》</div>
							<div class="book-pages"></div>
						</div>
						<div class="book-button" onclick="openBook('book2')">
							<div class="book-title">敬请期待</div>
							<div class="book-pages"></div>
						</div>
						<div class="book-button" onclick="openBook('book3')">
							<div class="book-title">敬请期待</div>
							<div class="book-pages"></div>
						</div>
					</div>
				</div>
				
				<!-- 练习子板块 -->
				<div id="study-practice" class="study-subsection">
					<div class="practice-container" style="background: transparent; margin-top: -60px;">
						<div class="practice-button" onclick="startPractice('practice1')">
							<div class="practice-header">
								<h3 class="practice-name">记忆64卦</h3>
								<div class="practice-status not-completed">未通关</div>
							</div>
							<div class="practice-difficulty">
								<span class="difficulty-label">难度：</span>
								<div class="difficulty-stars">
									<span class="star filled">★</span>
									<span class="star filled">★</span>
									<span class="star filled">★</span>
									<span class="star">★</span>
									<span class="star">★</span>
								</div>
							</div>
						</div>
						
						<div class="practice-button" onclick="startPractice('practice2')">
							<div class="practice-header">
								<h3 class="practice-name">敬请期待</h3>
								<div class="practice-status not-completed">未通关</div>
							</div>
							<div class="practice-difficulty">
								<span class="difficulty-label">难度：</span>
								<div class="difficulty-stars">
									<span class="star">★</span>
									<span class="star">★</span>
									<span class="star">★</span>
									<span class="star">★</span>
									<span class="star">★</span>
								</div>
							</div>
						</div>
						
						<div class="practice-button" onclick="startPractice('practice3')">
							<div class="practice-header">
								<h3 class="practice-name">敬请期待</h3>
								<div class="practice-status not-completed">未通关</div>
							</div>
							<div class="practice-difficulty">
								<span class="difficulty-label">难度：</span>
								<div class="difficulty-stars">
									<span class="star">★</span>
									<span class="star">★</span>
									<span class="star">★</span>
									<span class="star">★</span>
									<span class="star">★</span>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<!-- 视频子板块 -->
				<div id="study-video" class="study-subsection">
					<div class="study-content" style="padding-top: 0px; background: transparent; margin-top: -60px;">
						<!-- 视频容器 -->
						<div class="video-container" style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
							<h4 style="color: #333; margin: 0 0 15px 0; text-align: center; font-size: 18px; font-weight: 600;">六爻排盘全流程</h4>
							<div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%; background: #f5f5f5; border-radius: 8px; overflow: hidden;">
								<iframe src="https://player.bilibili.com/player.html?bvid=BV1qDe2zeEoz&page=1&autoplay=0" 
										scrolling="no" 
										border="0" 
										frameborder="no" 
										framespacing="0" 
										allowfullscreen="true"
										style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
								</iframe>
							</div>
							<p style="margin-top: 15px; color: #666; font-size: 14px; text-align: center; line-height: 1.6;">
								学习六爻排盘的完整流程，从基础概念到实际操作，助您快速掌握六爻占卜技巧。
							</p>
						</div>
						
						<!-- 示例：第二个视频容器 -->
						<div class="video-container" style="background: white; border-radius: 12px; padding: 15px 20px 20px 20px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
							<h4 style="color: #333; margin: 0 0 15px 0; text-align: center; font-size: 18px; font-weight: 600;">更多精彩内容即将更新</h4>
							<div style="position: relative; width: 100%; height: 0; padding-bottom: 56.25%; background: #f5f5f5; border-radius: 8px; overflow: hidden;">
								<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #999;">
									<div style="font-size: 48px; margin-bottom: 10px;">▶️</div>
									<div style="font-size: 16px;">更多精彩内容即将更新</div>
								</div>
							</div>
							<p style="margin-top: 15px; color: #666; font-size: 14px; text-align: center; line-height: 1.6;">
								更多精彩内容即将更新
							</p>
						</div>
						
						<!-- 预留更多视频容器的位置 -->
						<!-- 后续添加的视频可以复制上面的 video-container 结构 -->
					</div>
				</div>
			</div>
		</div>
		
		<!-- 工具标签页 -->
		<div id="tools-tab" class="tab-content">
			<!-- 工具子板块导航 -->
			<div class="tools-nav">
				<div class="tools-nav-item active">工具</div>
			</div>
			
			<div class="tools-container">
				<div class="tools-content">
					<div class="tools-grid">
						<div class="tool-button tool-1" onclick="openTool('xiaoliuren')">
							<div class="tool-name">小六壬</div>
						</div>
						<div class="tool-button tool-2" onclick="openTool('minggong')">
							<div class="tool-name">命宫计算器</div>
						</div>
						<div class="tool-button tool-3" onclick="openTool('guaquery')">
							<div class="tool-name">64卦查询</div>
						</div>
						<div class="tool-button tool-4" onclick="openTool('guatable')">
							<div class="tool-name">64卦表</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<!-- 我的标签页 -->
		<div id="profile-tab" class="tab-content">
			<!-- 我的子板块导航 -->
			<div class="tools-nav">
				<div class="tools-nav-item active">我的</div>
			</div>
			
			<div class="tools-container">
				<div style="text-align: center; padding: 20px;">
					<!-- 用户状态显示 -->
					<div id="profileUserInfo" style="display: none; margin-bottom: 20px; margin-top: -20px;">
						<div style="font-size: 18px; color: #333; margin-bottom: 10px;">欢迎回来</div>
						<div id="profileUserEmail" style="color: #666; font-size: 14px; margin-bottom: 20px;"></div>
						
						<!-- 密码管理按钮 -->
						<div style="margin-bottom: 15px;">
							<button id="changePasswordBtn" style="background: #555; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 10px;">修改密码</button>
							<button id="profileLogoutBtn" style="background: #333; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">退出登录</button>
						</div>
					</div>
					
					<!-- 未登录状态 -->
					<div id="profileLoginPrompt" style="margin-bottom: 20px;">
						<div style="font-size: 16px; color: #333; margin-bottom: 15px;">登录后可保存排盘记录到云端</div>
						<button id="profileLoginBtn" style="background: #555; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">登录/注册</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- 底部导航栏 -->
	<div class="bottom-navigation">
		<div class="nav-tab active" data-tab="paipan">
			<span>排盘</span>
		</div>
		<div class="nav-tab" data-tab="record">
			<span>记录</span>
		</div>
		<div class="nav-tab" data-tab="study">
			<span>学习</span>
		</div>
		<div class="nav-tab" data-tab="tools">
			<span>工具</span>
		</div>
		<div class="nav-tab" data-tab="profile">
			<span>我的</span>
		</div>
	</div>

	<script>
	(function(){
		const stems = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
		const branches = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];

		// 天干五行映射
		const stemWuxing = ['mu', 'mu', 'huo', 'huo', 'tu', 'tu', 'jin', 'jin', 'shui', 'shui'];
		// 地支五行映射
		const branchWuxing = ['shui', 'tu', 'mu', 'mu', 'tu', 'huo', 'huo', 'tu', 'jin', 'jin', 'tu', 'shui'];
		
		// 三合局定义
		const sanheJu = {
			'shui': ['申', '子', '辰'], // 申子辰三合水局
			'mu': ['亥', '卯', '未'],   // 亥卯未三合木局
			'jin': ['巳', '酉', '丑'],  // 巳酉丑三合金局
			'huo': ['寅', '午', '戌']   // 寅午戌三合火局
		};
		
		// 三合局中神
		const sanheZhongShen = {
			'子': 'shui', '卯': 'mu', '酉': 'jin', '午': 'huo'
		};
		
		// 判断三个地支是否组成三合局
		function isSanheJu(dizhi1, dizhi2, dizhi3) {
			const dizhiArray = [dizhi1, dizhi2, dizhi3].sort();
			for (const [wuxing, sanhe] of Object.entries(sanheJu)) {
				if (sanhe.sort().join('') === dizhiArray.join('')) {
					return { isSanhe: true, wuxing: wuxing, name: getSanheName(wuxing) };
				}
			}
			return { isSanhe: false };
		}
		
		// 判断两个地支是否属于同一三合局
		function isSameSanheJu(dizhi1, dizhi2) {
			for (const [wuxing, sanhe] of Object.entries(sanheJu)) {
				if (sanhe.includes(dizhi1) && sanhe.includes(dizhi2)) {
					return true;
				}
			}
			return false;
		}
		
		// 获取三合局名称
		function getSanheName(wuxing) {
			const nameMap = {
				'shui': '申子辰三合水局',
				'mu': '亥卯未三合木局',
				'jin': '巳酉丑三合金局',
				'huo': '寅午戌三合火局'
			};
			return nameMap[wuxing];
		}
		
		// 判断三合局情况一：三个动爻/暗动爻组成三合局（仅限本卦）
		function checkSanheCase1(dizhiArray, changeMarks, daychongMarks) {
			// 第一步：找出所有动爻和暗动之爻的地支及其索引
			const dongYao = [];
			for (let i = 0; i < 6; i++) {
				// 只检查本卦中的动爻，不包含变卦
				if (changeMarks[i] || (daychongMarks[i] && daychongMarks[i].includes('暗动'))) {
					dongYao.push({ index: i, dizhi: dizhiArray[i] });
				}
			}
			
			if (dongYao.length >= 3) {
				// 第二步：从动爻中找出所有可能的三合局组合
				const combinations = [];
				for (let i = 0; i < dongYao.length - 2; i++) {
					for (let j = i + 1; j < dongYao.length - 1; j++) {
						for (let k = j + 1; k < dongYao.length; k++) {
							const result = isSanheJu(dongYao[i].dizhi, dongYao[j].dizhi, dongYao[k].dizhi);
							if (result.isSanhe) {
								combinations.push({
									dizhi: [dongYao[i].dizhi, dongYao[j].dizhi, dongYao[k].dizhi],
									wuxing: result.wuxing,
									name: result.name,
									case: 1,
									// 记录参与三合局的具体爻的索引
									participatingIndexes: [dongYao[i].index, dongYao[j].index, dongYao[k].index]
								});
							}
						}
					}
				}
				return combinations;
			}
			return [];
		}
		
		// 判断三合局情况二：初爻+三爻+变爻组成三合局
		function checkSanheCase2(dizhiArray, changeMarks, dizhiChangeArray) {
			// 1. 检查本卦初爻和三爻是否都是动爻
			if (!changeMarks[5] || !changeMarks[3]) return [];
			
			const chuYao = dizhiArray[5];
			const sanYao = dizhiArray[3];
			const chuBian = dizhiChangeArray[5];
			const sanBian = dizhiChangeArray[3];
			
			// 1.1 检查本卦初爻和本卦三爻的地支是否不相同且属于同一个三合局
			if (chuYao === sanYao || !isSameSanheJu(chuYao, sanYao)) return []; // 1.1.1 不是，则不属于情况二
			
			// 1.1.2 是，则继续判断
			// 1.1.2.1 检查本卦初爻+本卦三爻+变卦初爻是否成三合局
			const result1 = isSanheJu(chuYao, sanYao, chuBian);
			if (result1.isSanhe) {
				// 1.1.2.1.1 检查变卦初爻和变卦三爻地支是否相同
				if (chuBian === sanBian) {
					// 相同则横线标记四个地支，两个变爻都参与
					return [{
						dizhi: [chuYao, sanYao, chuBian, sanBian],
						wuxing: result1.wuxing,
						name: result1.name,
						case: 2,
						changedIndexes: [5, 3]
					}];
				} else {
					// 不相同则只标记变卦初爻参与
					return [{
						dizhi: [chuYao, sanYao, chuBian],
						wuxing: result1.wuxing,
						name: result1.name,
						case: 2,
						changedIndexes: [5]
					}];
				}
			}
			
			// 1.1.2.2 不成三合局则继续判断：本卦初爻+本卦三爻+变卦三爻是否成三合局
			const result2 = isSanheJu(chuYao, sanYao, sanBian);
			if (result2.isSanhe) {
				// 成则只标记变卦三爻参与
				return [{
					dizhi: [chuYao, sanYao, sanBian],
					wuxing: result2.wuxing,
					name: result2.name,
					case: 2,
					changedIndexes: [3]
				}];
			}
			
			// 1.1.2.2.1 不成，则不属于情况二
			return [];
		}
		
		// 判断三合局情况三：四爻+上爻+变爻组成三合局
		function checkSanheCase3(dizhiArray, changeMarks, dizhiChangeArray) {
			if (!changeMarks[2] || !changeMarks[0]) return []; // 四爻和上爻必须是动爻
			
			const siYao = dizhiArray[2];
			const shangYao = dizhiArray[0];
			const siBian = dizhiChangeArray[2];
			const shangBian = dizhiChangeArray[0];
			
			// 检查变卦两个爻地支是否相同
			if (siBian === shangBian) {
				// 如果变卦两个爻地支相同，检查是否和本卦两个动爻组成三合局
				const result = isSanheJu(siYao, shangYao, siBian);
				if (result.isSanhe) {
					return [{
						dizhi: [siYao, shangYao, siBian],
						wuxing: result.wuxing,
						name: result.name,
						case: 3,
						changedIndexes: [2, 0]
					}];
				}
			} else {
				// 如果变卦两个爻地支不同，优先检查四爻变爻，如果成立就返回，否则检查上爻变爻
				const result1 = isSanheJu(siYao, shangYao, siBian);
				if (result1.isSanhe) {
					return [{
						dizhi: [siYao, shangYao, siBian],
						wuxing: result1.wuxing,
						name: result1.name,
						case: 3,
						changedIndexes: [2]
					}];
				}
				
				// 如果四爻变爻不成立，再检查上爻变爻
				const result2 = isSanheJu(siYao, shangYao, shangBian);
				if (result2.isSanhe) {
					return [{
						dizhi: [siYao, shangYao, shangBian],
						wuxing: result2.wuxing,
						name: result2.name,
						case: 3,
						changedIndexes: [0]
					}];
				}
			}
			
			return [];
		}
		
		// 判断三合局情况四：动爻+动爻+日/月支组成三合局
		function checkSanheCase4(dizhiArray, changeMarks, daychongMarks, dayBranch, monthBranch) {
			const dongYao = [];
			for (let i = 0; i < 6; i++) {
				// 情况四只检查动爻，不包含暗动爻
				if (changeMarks[i]) {
					dongYao.push({ index: i, dizhi: dizhiArray[i] });
				}
			}
			
			if (dongYao.length < 2) return [];
			
			const combinations = [];
			for (let i = 0; i < dongYao.length - 1; i++) {
				for (let j = i + 1; j < dongYao.length; j++) {
					const yaoA = dongYao[i];
					const yaoB = dongYao[j];
					
					// 检查两个动爻中至少有一个是中神
					if (sanheZhongShen[yaoA.dizhi] || sanheZhongShen[yaoB.dizhi]) {
						// 动爻A+动爻B+日支
						const result1 = isSanheJu(yaoA.dizhi, yaoB.dizhi, dayBranch);
						if (result1.isSanhe) {
							combinations.push({
								dizhi: [yaoA.dizhi, yaoB.dizhi, dayBranch],
								wuxing: result1.wuxing,
								name: result1.name,
								case: 4,
								dayOrMonth: 'day',
								dayOrMonthBranch: dayBranch,
								participatingIndexes: [yaoA.index, yaoB.index] // 记录参与三合局的动爻索引
							});
						}
						
						// 动爻A+动爻B+月支
						const result2 = isSanheJu(yaoA.dizhi, yaoB.dizhi, monthBranch);
						if (result2.isSanhe) {
							combinations.push({
								dizhi: [yaoA.dizhi, yaoB.dizhi, monthBranch],
								wuxing: result2.wuxing,
								name: result2.name,
								case: 4,
								dayOrMonth: 'month',
								dayOrMonthBranch: monthBranch,
								participatingIndexes: [yaoA.index, yaoB.index] // 记录参与三合局的动爻索引
							});
						}
					}
				}
			}
			
			return combinations;
		}
		
		// 判断三合局情况五：日支+月支+爻支组成三合局
		function checkSanheCase5(dizhiArray, dayBranch, monthBranch, dizhiChangeArray = []) {
			// 检查日支+月支是否是申辰/亥未/巳丑/寅戌四个组合之一
			const riYue = [dayBranch, monthBranch].sort();
			
			const validRiYue = [
				['申', '辰'], ['亥', '未'], ['巳', '丑'], ['寅', '戌']
			];
			
			let isValidRiYue = false;
			let targetZhongShen = null;
			
			for (const valid of validRiYue) {
				if (valid.join('') === riYue.join('')) {
					isValidRiYue = true;
					// 根据日支+月支组合确定对应的中神
					if (valid.join('') === '申辰') {
						targetZhongShen = '子';
					} else if (valid.join('') === '亥未') {
						targetZhongShen = '卯';
					} else if (valid.join('') === '巳丑') {
						targetZhongShen = '酉';
					} else if (valid.join('') === '寅戌') {
						targetZhongShen = '午';
					}
					break;
				}
			}
			
			if (!isValidRiYue || !targetZhongShen) {
				return [];
			}
			
			const combinations = [];
			// 检查本卦所有爻支是否是目标中神
			for (let i = 0; i < 6; i++) {
				const yaoDizhi = dizhiArray[i];
				// 提取纯地支字符（去掉五行信息）
				const pureDizhi = yaoDizhi.replace(/[水火木金土]/g, '');
				if (pureDizhi === targetZhongShen) {
					// 检查日支+月支+爻支是否组成完整三合局
					const result = isSanheJu(dayBranch, monthBranch, pureDizhi);
					if (result.isSanhe) {
						combinations.push({
							dizhi: [dayBranch, monthBranch, pureDizhi],
							wuxing: result.wuxing,
							name: result.name,
							case: 5,
							participatingIndexes: [i] // 记录参与三合局的爻索引
						});
					}
				}
			}
			
			// 检查变卦所有爻支是否是目标中神
			if (dizhiChangeArray.length > 0) {
				for (let i = 0; i < 6; i++) {
					const yaoDizhi = dizhiChangeArray[i];
					// 提取纯地支字符（去掉五行信息）
					const pureDizhi = yaoDizhi.replace(/[水火木金土]/g, '');
					if (pureDizhi === targetZhongShen) {
						// 检查日支+月支+爻支是否组成完整三合局
						const result = isSanheJu(dayBranch, monthBranch, pureDizhi);
						if (result.isSanhe) {
							combinations.push({
								dizhi: [dayBranch, monthBranch, pureDizhi],
								wuxing: result.wuxing,
								name: result.name,
								case: 5,
								participatingIndexes: [i], // 记录参与三合局的爻索引
								isChange: true // 标记这是变卦的爻
							});
						}
					}
				}
			}
			
			return combinations;
		}
		
		// 获取所有三合局
		function getAllSanheJu(dizhiArray, changeMarks, daychongMarks, dizhiChangeArray, dayBranch, monthBranch) {
			const allSanhe = [];
			
			// 情况一
			const case1 = checkSanheCase1(dizhiArray, changeMarks, daychongMarks);
			allSanhe.push(...case1);
			
			// 情况二
			const case2 = checkSanheCase2(dizhiArray, changeMarks, dizhiChangeArray);
			allSanhe.push(...case2);
			
			// 情况三
			const case3 = checkSanheCase3(dizhiArray, changeMarks, dizhiChangeArray);
			allSanhe.push(...case3);
			
			// 情况四
			const case4 = checkSanheCase4(dizhiArray, changeMarks, daychongMarks, dayBranch, monthBranch);
			allSanhe.push(...case4);
			
			// 情况五
			const case5 = checkSanheCase5(dizhiArray, dayBranch, monthBranch, dizhiChangeArray);
			console.log('情况五检测结果:', case5);
			allSanhe.push(...case5);
			

			

			
			return allSanhe;
		}

		// 获取干支五行颜色类名
		function getWuxingClass(stemIndex, branchIndex) {
			const stemWx = stemWuxing[stemIndex];
			const branchWx = branchWuxing[branchIndex];
			return { stemClass: `wx-${stemWx}`, branchClass: `wx-${branchWx}` };
		}

		// 地支相冲相合关系
		const branchConflicts = {
			'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
			'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
		};
		const branchCombinations = {
			'子': '丑', '寅': '亥', '卯': '戌', '辰': '酉', '巳': '申', '午': '未',
			'丑': '子', '亥': '寅', '戌': '卯', '酉': '辰', '申': '巳', '未': '午'
		};

		// 五行生克关系
		const wuxingRelations = {
			'木': { '生': '火', '克': '土' },
			'火': { '生': '土', '克': '金' },
			'土': { '生': '金', '克': '水' },
			'金': { '生': '水', '克': '木' },
			'水': { '生': '木', '克': '火' }
		};

		// 获取地支的五行
		function getBranchWuxing(branch) {
			const wuxingMap = {
				'子': '水', '丑': '土', '寅': '木', '卯': '木', '辰': '土', '巳': '火',
				'午': '火', '未': '土', '申': '金', '酉': '金', '戌': '土', '亥': '水'
			};
			return wuxingMap[branch];
		}

		// 获取天干的五行
		function getStemWuxing(stem) {
			const wuxingMap = {
				'甲': '木', '乙': '木', '丙': '火', '丁': '火', '戊': '土', '己': '土',
				'庚': '金', '辛': '金', '壬': '水', '癸': '水'
			};
			return wuxingMap[stem];
		}

		// 获取五行对应的颜色类名
		function getWuxingColorClass(wuxing) {
			const colorMap = {
				'木': 'wx-mu', '火': 'wx-huo', '土': 'wx-tu', '金': 'wx-jin', '水': 'wx-shui'
			};
			return colorMap[wuxing];
		}

		// 生成地支关系信息（不包含旬空）
		function getBranchRelations(branch) {
			const relations = [];
			const wuxing = getBranchWuxing(branch);
			
			// 相冲
			if(branchConflicts[branch]) {
				relations.push(`${branch}${branchConflicts[branch]}冲`);
			}
			
			// 相合
			if(branchCombinations[branch]) {
				relations.push(`${branch}${branchCombinations[branch]}合`);
			}
			
			// 五行生克
			if(wuxing && wuxingRelations[wuxing]) {
				const rel = wuxingRelations[wuxing];
				relations.push(`${wuxing}生${rel.生}`);
				relations.push(`${wuxing}克${rel.克}`);
			}
			
			return relations;
		}

		// 生成地支关系信息（包含旬空）
		function getBranchRelationsWithXunKong(branch, ganzhi) {
			const relations = [];
			const wuxing = getBranchWuxing(branch);
			
			// 相冲
			if(branchConflicts[branch]) {
				relations.push(`${branch}${branchConflicts[branch]}冲`);
			}
			
			// 相合
			if(branchCombinations[branch]) {
				relations.push(`${branch}${branchCombinations[branch]}合`);
			}
			
			// 五行生克
			if(wuxing && wuxingRelations[wuxing]) {
				const rel = wuxingRelations[wuxing];
				relations.push(`${wuxing}生${rel.生}`);
				relations.push(`${wuxing}克${rel.克}`);
			}
			
			// 旬空
			const xunKong = getXunKong(ganzhi);
			if(xunKong.length > 0) {
				const xunKongText = xunKong.map(b => {
					const wuxing = getBranchWuxing(b);
					const colorClass = getWuxingColorClass(wuxing);
					return `<span class="${colorClass}">${b}</span>`;
				}).join('');
				relations.push(`旬空：${xunKongText}`);
			}
			
			return relations;
		}

		// 农历基础数据（1900-2100）
		const lunarInfo = [
			0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,
			0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,
			0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,
			0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,
			0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,
			0x06ca0,0x0b550,0x15355,0x04da0,0x0a5b0,0x14573,0x052b0,0x0a9a8,0x0e950,0x06aa0,
			0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,
			0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b6a0,0x195a6,
			0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,
			0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x05ac0,0x0ab60,0x096d5,0x092e0,
			0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,
			0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,
			0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,
			0x05aa0,0x076a3,0x096d0,0x04bd7,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,
			0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0
		];

		function cnNow(){
			// 将当前时间转换为中国时区的 Date 对象（绝对时间不变，用于显示与计算基于CST的日界）
			const now = new Date();
			const utcMs = now.getTime() + now.getTimezoneOffset()*60000;
			const cnMs = utcMs + 8*3600000; // UTC+8
			return new Date(cnMs);
		}

		function lYearDays(y){
			let sum = 348;
			for(let i=0x8000;i>0x8;i>>=1) sum += (lunarInfo[y-1900] & i)?1:0;
			return sum + leapDays(y);
		}
		function leapMonth(y){ return lunarInfo[y-1900] & 0xf; }
		function leapDays(y){ if(leapMonth(y)) return (lunarInfo[y-1900] & 0x10000)?30:29; return 0; }
		function monthDays(y,m){ return (lunarInfo[y-1900] & (0x10000>>m))?30:29; }
		function solarToLunarCN(dCN){
			// 以中国时区 1900-01-31 00:00 为基准
			const baseMs = Date.UTC(1900,0,30,16,0,0); // 1900-01-31 00:00 +08:00
			let offset = Math.floor((dCN.getTime() - baseMs)/86400000);
			let temp=0, i, leap=0, isLeap=false;
			for(i=1900; i<2101 && offset>0; i++){
				temp = lYearDays(i); offset -= temp;
			}
			if(offset<0){ offset+=temp; i--; }
			const lYear=i; leap = leapMonth(i);
			let lMonth, lDay;
			for(lMonth=1; lMonth<13 && offset>0; lMonth++){
				if(leap>0 && lMonth==(leap+1) && !isLeap){ --lMonth; isLeap=true; temp=leapDays(lYear); }
				else { temp=monthDays(lYear,lMonth); }
				if(isLeap && lMonth==(leap+1)) isLeap=false;
				offset -= temp;
			}
			if(offset===0 && leap>0 && lMonth===leap+1){ if(isLeap){ isLeap=false; } else { isLeap=true; --lMonth; } }
			if(offset<0){ offset+=temp; --lMonth; }
			lDay = offset+1;
			return { lYear, lMonth, lDay, isLeap };
		}

		// 节气（24节气）
		const sTermInfo=[0,21208,42467,63836,85337,107014,128867,150921,173149,195551,218072,240693,263343,285989,308563,331033,353350,375494,397447,419210,440795,462224,483532,504758];
		const termNames=['小寒','大寒','立春','雨水','惊蛰','春分','清明','谷雨','立夏','小满','芒种','夏至','小暑','大暑','立秋','处暑','白露','秋分','寒露','霜降','立冬','小雪','大雪','冬至'];
		function sTerm(y,n){
			// 返回节气对应的绝对时间（Date对象，所在系统本地显示），算法按通用公式推算
			const ms = 31556925974.7*(y-1900) + sTermInfo[n]*60000 + Date.UTC(1900,0,6,2,5);
			return new Date(ms);
		}

		function findCurrentTermCN(dCN){
			const y = dCN.getFullYear();
			let prev=null, next=null;
			for(let i=0;i<24;i++){
				const t = sTerm(y,i);
				if(t<=dCN){ prev={index:i, time:t}; } else { if(!next) next={index:i, time:t}; }
			}
			if(!prev){ prev={ index:23, time: sTerm(y-1,23) }; }
			if(!next){ next={ index:0, time: sTerm(y+1,0) }; }
			return { prev, next, name: termNames[prev.index] };
		}

		function getTermsByYearAccurate(dCN){
			const y = dCN.getFullYear();
			const list = [];
			for(let i=0;i<24;i++){
				const start = sTerm(y,i);
				const ni = (i+1)%24;
				const ny = (i+1>=24)? (y+1) : y;
				const end = sTerm(ny,ni);
				list.push({ index:i, name:termNames[i], start, end });
			}
			return list;
		}

		function nextTermEndTime(next){
			// 下个节气的结束时间 = 下下个节气的开始时间
			const yearOfNext = next.time.getFullYear();
			let idx2 = next.index + 1;
			let y2 = yearOfNext;
			if(idx2 >= 24){ idx2 = 0; y2 = yearOfNext + 1; }
			return sTerm(y2, idx2);
		}

		function pad(n){ return n<10?('0'+n):(''+n); }
		function lunarMonthName(m, isLeap){
			const mm = ['','正','二','三','四','五','六','七','八','九','十','十一','腊'][m];
			return (isLeap?'闰':'') + mm + '月';
		}
		function lunarDayName(d){
			const n1=['','初','十','廿','三'];
			const n2=['','一','二','三','四','五','六','七','八','九','十'];
			if(d===10) return '初十'; if(d===20) return '二十'; if(d===30) return '三十';
			return n1[Math.floor(d/10)+1] + n2[d%10];
		}

		function fmtCNDateTime(dCN){
			return dCN.getFullYear()+pad(dCN.getMonth()+1)+pad(dCN.getDate())+' '+pad(dCN.getHours())+':'+pad(dCN.getMinutes())+':'+pad(dCN.getSeconds());
		}
		function fmtCNDate(dCN){
			return dCN.getFullYear()+'-'+pad(dCN.getMonth()+1)+'-'+pad(dCN.getDate());
		}
		function fmtCNDateTimeTZ(d){
			return new Intl.DateTimeFormat('zh-CN',{ timeZone:'Asia/Shanghai', hour12:false, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}).format(d);
		}

		// —— 十二时辰与五行/脏腑 ——
		const shiList = [
			{ name:'子', range:'23:00–01:00', wuxing:'水', zangfu:'肾、膀胱', wxClass:'wx-shui', start:23, end:1 },
			{ name:'丑', range:'01:00–03:00', wuxing:'土', zangfu:'脾', wxClass:'wx-tu', start:1, end:3 },
			{ name:'寅', range:'03:00–05:00', wuxing:'木', zangfu:'肝', wxClass:'wx-mu', start:3, end:5 },
			{ name:'卯', range:'05:00–07:00', wuxing:'木', zangfu:'肝', wxClass:'wx-mu', start:5, end:7 },
			{ name:'辰', range:'07:00–09:00', wuxing:'土', zangfu:'胃', wxClass:'wx-tu', start:7, end:9 },
			{ name:'巳', range:'09:00–11:00', wuxing:'火', zangfu:'心', wxClass:'wx-huo', start:9, end:11 },
			{ name:'午', range:'11:00–13:00', wuxing:'火', zangfu:'心、小肠', wxClass:'wx-huo', start:11, end:13 },
			{ name:'未', range:'13:00–15:00', wuxing:'土', zangfu:'脾', wxClass:'wx-tu', start:13, end:15 },
			{ name:'申', range:'15:00–17:00', wuxing:'金', zangfu:'肺', wxClass:'wx-jin', start:15, end:17 },
			{ name:'酉', range:'17:00–19:00', wuxing:'金', zangfu:'大肠', wxClass:'wx-jin', start:17, end:19 },
			{ name:'戌', range:'19:00–21:00', wuxing:'土', zangfu:'胃', wxClass:'wx-tu', start:19, end:21 },
			{ name:'亥', range:'21:00–23:00', wuxing:'水', zangfu:'肾', wxClass:'wx-shui', start:21, end:23 },
		];

		function currentShiIndex(h){
			if(h===23) return 0; // 子
			for(let i=0;i<shiList.length;i++){
				const s = shiList[i];
				if(s.start < s.end){ if(h>=s.start && h<s.end) return i; }
				else { if(h>=s.start || h<s.end) return i; }
			}
			return 0;
		}

		function renderShi(dCN){
			const h = dCN.getHours();
			const idx = currentShiIndex(h);
			const cur = shiList[idx];
			// 当前时辰彩色，其他浅灰隐藏折叠
			document.getElementById('currentShiText').innerHTML = `<span class="${cur.wxClass.stemClass} ${cur.wxClass.branchClass}">${cur.name}时（${cur.range}） · ${cur.wuxing} · ${cur.zangfu}</span>`;
			
			// 表格两列显示
			let rows = [];
			for(let i=0;i<shiList.length;i+=2){
				const s1 = shiList[i];
				let cell1 = `<td><div class="${i===idx?s1.wxClass.stemClass:''} ${i===idx?s1.wxClass.branchClass:''}">${s1.name}时（${s1.range}） · ${s1.wuxing} · ${s1.zangfu}</div></td>`;
				let cell2 = '<td></td>';
				if(i+1<shiList.length){
					const s2 = shiList[i+1];
					cell2 = `<td><div class="${(i+1)===idx?s2.wxClass.stemClass:''} ${i+1===idx?s2.wxClass.branchClass:''}">${s2.name}时（${s2.range}） · ${s2.wuxing} · ${s2.zangfu}</div></td>`;
				}
				rows.push(`<tr>${cell1}${cell2}</tr>`);
			}
			document.getElementById('shiPanel').innerHTML = `<table class="terms-table">${rows.join('')}</table>`;
		}

		// 保存当前排盘记录
		async function saveCurrentRecord() {
			console.log("saveCurrentRecord函数开始执行");
			try {
			// 获取当前排盘信息
			const question = document.getElementById('questionText').value || '未填写';
			const yongshen = document.getElementById('yongshenText').value || '未选择';
			console.log("获取到的信息:", { question, yongshen });
			const currentTime = getCurrentTime();
			console.log("获取到的时间:", currentTime);
			
			// 处理时间格式
			let timeStr = '时间获取失败';
			if (currentTime) {
				if (currentTime.year && currentTime.month && currentTime.day && currentTime.hour) {
					// 如果是排盘时间对象
					timeStr = `${currentTime.year}年${currentTime.month}月${currentTime.day}日 ${currentTime.hour}时`;
				} else if (currentTime instanceof Date) {
					// 如果是Date对象，转换为农历时间
					timeStr = currentTime.toLocaleString('zh-CN');
				} else {
					timeStr = '时间格式异常';
				}
			}
			console.log("时间字符串:", timeStr);
			
			// 获取完整的排盘HTML内容
			const guaResult = document.getElementById('guaResult');
			const fullGuaContent = guaResult ? guaResult.innerHTML : '';
			
			// 创建记录对象
			const record = {
				id: Date.now(),
				question: question,
				yongshen: yongshen,
				time: timeStr,
				timestamp: new Date().toLocaleString('zh-CN'),
				fullGuaContent: fullGuaContent, // 保存完整的排盘HTML内容
				guaData: {
					// 这里可以保存更多排盘数据
					lines: [],
					// 其他排盘相关信息
				}
			};
			
				console.log("创建的记录对象:", record);
				
				// 检查用户是否已登录
				if (window.supabaseService && window.supabaseService.currentUser) {
					// 用户已登录，保存到云端
					console.log("用户已登录，保存到云端");
					try {
						const result = await window.supabaseService.savePaipanRecord(record);
						if (result.success) {
							alert('排盘记录已保存到云端！');
						} else {
							alert('云端保存失败，已保存到本地：' + result.error);
							// 云端保存失败，仍然保存到本地
							saveToLocalStorage(record);
						}
					} catch (error) {
						console.error('云端保存出错:', error);
						alert('云端保存出错，已保存到本地：' + error.message);
						// 云端保存出错，仍然保存到本地
						saveToLocalStorage(record);
					}
				} else {
					// 用户未登录，提示登录
					alert('请先登录后再保存排盘记录到云端');
					// 仍然保存到本地
					saveToLocalStorage(record);
				}
			} catch (error) {
				console.error('saveCurrentRecord函数出错:', error);
				alert('保存失败：' + error.message);
			}
		}
		
		// 保存到本地存储的辅助函数
		function saveToLocalStorage(record) {
			// 获取现有记录
			let records = JSON.parse(localStorage.getItem('liuyaoRecords') || '[]');
			
			// 添加新记录
			records.unshift(record); // 新记录放在最前面
			
			// 限制记录数量（最多保存50条）
			if (records.length > 50) {
				records = records.slice(0, 50);
			}
			
			// 保存到本地存储
			localStorage.setItem('liuyaoRecords', JSON.stringify(records));
			console.log("记录已保存到localStorage:", records.length, "条记录");
			
			// 显示保存成功提示
			alert('排盘记录已保存！');
			
			// 如果当前在排盘记录页面，刷新记录列表
			if (document.getElementById('record-tab').classList.contains('active')) {
				loadRecords();
			}
		}

		// 手动时间选择功能
		function getCurrentTime(){
			const timeSource = document.querySelector('input[name="timeSource"]:checked').value;
			if(timeSource === 'realtime'){
				return cnNow();
			} else if(timeSource === 'manual'){
				const year = parseInt(document.getElementById('manualYear').value);
				const month = parseInt(document.getElementById('manualMonth').value);
				const day = parseInt(document.getElementById('manualDay').value);
				const hour = parseInt(document.getElementById('manualHour').value) || 0;
				const minute = parseInt(document.getElementById('manualMinute').value) || 0;
				const second = parseInt(document.getElementById('manualSecond').value) || 0;
				
				if(year && month && day){
					return new Date(year, month - 1, day, hour, minute, second);
				}
				// 返回部分信息对象
				return { partial: true, solar: true, year, month, day, hour, minute, second };
			} else if(timeSource === 'lunar'){
				const lYear = parseInt(document.getElementById('lunarYear').value);
				const lMonth = parseInt(document.getElementById('lunarMonth').value);
				const lDay = parseInt(document.getElementById('lunarDay').value);
				const hour = parseInt(document.getElementById('lunarHour').value) || 0;
				const minute = parseInt(document.getElementById('lunarMinute').value) || 0;
				const second = parseInt(document.getElementById('lunarSecond').value) || 0;
				
				if(lYear && lMonth && lDay){
					const solarDate = lunarToSolar(lYear, lMonth, lDay);
					solarDate.setHours(hour, minute, second);
					return solarDate;
				}
				// 返回部分信息对象，而不是null
				return { partial: true, lYear, lMonth, lDay, hour, minute, second };
			}
			return cnNow();
		}

		// 从农历年份计算年干支
		function getGanZhiYearFromLunar(lYear) {
			// 农历年份对应的干支年
			const baseYear = 1984; // 1984年是甲子年
			const span = lYear - baseYear;
			const tgIndex = (span % 10 + 10) % 10;
			const dzIndex = (span % 12 + 12) % 12;
			return { tgIndex, dzIndex };
		}

		// 从农历年月计算月干支
		function getGanZhiMonthFromLunar(lYear, lMonth) {
			// 这里需要根据农历月份计算对应的干支月
			// 简化处理：使用农历月份作为参考
			const yearGZ = getGanZhiYearFromLunar(lYear);
			const monthIndex = lMonth - 1; // 农历月份从1开始，转换为0-11
			
			// 天干按口诀计算
			let firstMonthStem;
			if([0,5].includes(yearGZ.tgIndex)) firstMonthStem = 2; // 甲己 → 丙
			else if([1,6].includes(yearGZ.tgIndex)) firstMonthStem = 4; // 乙庚 → 戊
			else if([2,7].includes(yearGZ.tgIndex)) firstMonthStem = 6; // 丙辛 → 庚
			else if([3,8].includes(yearGZ.tgIndex)) firstMonthStem = 8; // 丁壬 → 壬
			else firstMonthStem = 0; // 戊癸 → 甲

			const tgIndex = (firstMonthStem + monthIndex) % 10;
			const dzIndex = (2 + monthIndex) % 12; // 寅月为正月
			return { tgIndex, dzIndex };
		}

		function updatePartialSolarDisplay(year, month, day, hour, minute, second) {
			let timeText = '';
			
			// 构建时间显示文本
			if(year) timeText += `${year}年`;
			if(month) timeText += `${month}月`;
			if(day) timeText += `${day}日`;
			if(hour !== undefined) timeText += ` ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:${second.toString().padStart(2, '0')}`;
			
			if(timeText) {
				timeText += '(阳历)';
			} else {
				timeText = '请输入阳历日期';
			}
			
			document.getElementById('nowText').textContent = timeText;
			
			// 构建干支显示 - 横向表格形式
			const ganzhiItems = [];
			const xunkongItems = [];
			
			// 生成关系信息的HTML
			function generateRelationsHTML(relations) {
				if(relations.length === 0) return '';
				return relations.map(rel => {
					// 提取五行字符并添加颜色
					let html = rel;
					
					// 为天干添加颜色
					['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'].forEach((stem, index) => {
						const wuxing = getStemWuxing(stem); // 使用getStemWuxing函数获取中文五行
						const colorClass = getWuxingColorClass(wuxing);
						html = html.replace(new RegExp(stem, 'g'), `<span class="${colorClass}">${stem}</span>`);
					});
					
					// 为地支添加颜色（处理相冲相合中的地支字符）
					['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'].forEach((branch, index) => {
						const wuxing = getBranchWuxing(branch); // 使用getBranchWuxing函数获取中文五行
						const colorClass = getWuxingColorClass(wuxing);
						html = html.replace(new RegExp(branch, 'g'), `<span class="${colorClass}">${branch}</span>`);
					});
					
					// 为五行字符添加颜色
					['木', '火', '土', '金', '水'].forEach(wx => {
						const colorClass = getWuxingColorClass(wx);
						html = html.replace(new RegExp(wx, 'g'), `<span class="${colorClass}">${wx}</span>`);
					});
					
					return html;
				}).join('<br>');
			}
			
			// 生成旬空显示HTML
			function generateXunKongHTML(xunKong) {
				if(xunKong.length === 0) return '—';
				return xunKong.map(branch => {
					const wuxing = getBranchWuxing(branch);
					const colorClass = getWuxingColorClass(wuxing);
					return `<span class="${colorClass}">${branch}</span>`;
				}).join('');
			}
			
			// 年干支（只需要年份）
			if(year) {
				const tempDate = new Date(year, 0, 1); // 使用1月1日作为临时日期
				const yearGZ = getGanZhiYear(tempDate);
				const yearWxClass = getWuxingClass(yearGZ.tgIndex, yearGZ.dzIndex);
				const yearBranch = branches[yearGZ.dzIndex];
				const yearRelations = getBranchRelations(yearBranch);
				const yearXunKong = getXunKong(yearGZ);
				ganzhiItems.push(`<td><div><span class="${yearWxClass.stemClass}">${stems[yearGZ.tgIndex]}</span><span class="${yearWxClass.branchClass}">${branches[yearGZ.dzIndex]}</span>年</div><div class="relations">${generateRelationsHTML(yearRelations)}</div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">${generateXunKongHTML(yearXunKong)}</div></td>`);
			} else {
				ganzhiItems.push(`<td><div>— —年</div><div class="relations"></div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">—</div></td>`);
			}
			
			// 月干支（需要年份和月份）
			if(year && month) {
				const tempDate = new Date(year, month - 1, 1); // 使用当月1日作为临时日期
				const yearGZ = getGanZhiYear(tempDate);
				const monthGZ = getGanZhiMonth(tempDate, yearGZ.tgIndex);
				const monthWxClass = getWuxingClass(monthGZ.tgIndex, monthGZ.dzIndex);
				const monthBranch = branches[monthGZ.dzIndex];
				const monthRelations = getBranchRelations(monthBranch);
				const monthXunKong = getXunKong(monthGZ);
				ganzhiItems.push(`<td><div><span class="${monthWxClass.stemClass}">${stems[monthGZ.tgIndex]}</span><span class="${monthWxClass.branchClass}">${branches[monthGZ.dzIndex]}</span>月</div><div class="relations">${generateRelationsHTML(monthRelations)}</div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">${generateXunKongHTML(monthXunKong)}</div></td>`);
			} else {
				ganzhiItems.push(`<td><div>— —月</div><div class="relations"></div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">—</div></td>`);
			}
			
			// 日干支（需要完整的年月日）
			if(year && month && day) {
				const tempDate = new Date(year, month - 1, day);
				const dayGZ = getGanZhiDay(tempDate);
				const dayWxClass = getWuxingClass(dayGZ.tgIndex, dayGZ.dzIndex);
				const dayBranch = branches[dayGZ.dzIndex];
				const dayRelations = getBranchRelations(dayBranch);
				const dayXunKong = getXunKong(dayGZ);
				ganzhiItems.push(`<td><div><span class="${dayWxClass.stemClass}">${stems[dayGZ.tgIndex]}</span><span class="${dayWxClass.branchClass}">${branches[dayGZ.dzIndex]}</span>日</div><div class="relations">${generateRelationsHTML(dayRelations)}</div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">${generateXunKongHTML(dayXunKong)}</div></td>`);
			} else {
				ganzhiItems.push(`<td><div>— —日</div><div class="relations"></div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">—</div></td>`);
			}
			
			// 时干支（需要日干支和时辰）
			if(year && month && day && hour !== undefined) {
				const tempDate = new Date(year, month - 1, day, hour, minute, second);
				const dayGZ = getGanZhiDay(tempDate);
				const hourGZ = getGanZhiHour(tempDate, dayGZ.tgIndex);
				const hourWxClass = getWuxingClass(hourGZ.tgIndex, hourGZ.dzIndex);
				const hourBranch = branches[hourGZ.dzIndex];
				const hourRelations = getBranchRelations(hourBranch);
				const hourXunKong = getXunKong(hourGZ);
				ganzhiItems.push(`<td><div><span class="${hourWxClass.stemClass}">${stems[hourGZ.tgIndex]}</span><span class="${hourWxClass.branchClass}">${branches[hourGZ.dzIndex]}</span>时</div><div class="relations">${generateRelationsHTML(hourRelations)}</div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">${generateXunKongHTML(hourXunKong)}</div></td>`);
			} else {
				ganzhiItems.push(`<td><div>— —时</div><div class="relations"></div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">—</div></td>`);
			}
			
			// 生成旬空显示HTML
			function generateXunKongHTML(xunKong) {
				if(xunKong.length === 0) return '—';
				return xunKong.map(branch => {
					const wuxing = getBranchWuxing(branch);
					const colorClass = getWuxingColorClass(wuxing);
					return `<span class="${colorClass}">${branch}</span>`;
				}).join('');
			}
			
			// 显示干支表格
			document.getElementById('ganzhiText').innerHTML = `<table class="ganzhi-table"><tr>${ganzhiItems.join('')}</tr></table>`;
			
			// 显示旬空表格
			document.getElementById('xunkongText').innerHTML = `<table class="ganzhi-table"><tr>${xunkongItems.join('')}</tr></table>`;
			
			// 其他显示
			if(year && month && day) {
				const tempDate = new Date(year, month - 1, day, hour, minute, second);
				renderTermList(tempDate);
				renderShi(tempDate);
			} else {
				document.getElementById('currentTermText').innerHTML = '—';
				document.getElementById('currentShiText').innerHTML = '—';
			}
		}

		function updateManualTimeDisplay(){
			const dCN = getCurrentTime();
			if(dCN && dCN.partial) {
				if(dCN.solar) {
					// 阳历部分输入
					updatePartialSolarDisplay(dCN.year, dCN.month, dCN.day, dCN.hour, dCN.minute, dCN.second);
				} else {
					// 农历部分输入，使用专门的显示函数
					updatePartialLunarDisplay(dCN.lYear, dCN.lMonth, dCN.lDay, dCN.hour, dCN.minute, dCN.second);
				}
				return;
			}
			if(dCN === null) {
				// 农历日期不完整时，不更新显示
				return;
			}
			const lunar = solarToLunarCN(dCN);
			const lunarStr = `${lunar.lYear} ${lunarMonthName(lunar.lMonth, lunar.isLeap)}${lunarDayName(lunar.lDay)}`;
			
			const timeFmt = fmtCNDateTime(dCN);
			document.getElementById('nowText').textContent = `${timeFmt}(${lunarStr})`;
			
			renderTermList(dCN);
			renderShi(dCN);
			renderGanzhi(dCN, window.allSanheJu || []); // 时间更新时传递三合局信息
		}

		function updateLunarTimeDisplay(){
			const lYear = parseInt(document.getElementById('lunarYear').value);
			const lMonth = parseInt(document.getElementById('lunarMonth').value);
			const lDay = parseInt(document.getElementById('lunarDay').value);
			const hour = parseInt(document.getElementById('lunarHour').value) || 0;
			const minute = parseInt(document.getElementById('lunarMinute').value) || 0;
			const second = parseInt(document.getElementById('lunarSecond').value) || 0;
			
			if(lYear && lMonth && lDay){
				const solarDate = lunarToSolar(lYear, lMonth, lDay);
				solarDate.setHours(hour, minute, second);
				
				// 更新所有显示
				updateManualTimeDisplay();
			} else {
				// 显示部分信息
				updatePartialLunarDisplay(lYear, lMonth, lDay, hour, minute, second);
			}
		}

		function updatePartialLunarDisplay(lYear, lMonth, lDay, hour, minute, second) {
			let timeText = '';
			
			// 构建时间显示文本
			if(lYear) timeText += `${lYear}年`;
			if(lMonth) timeText += `${lMonth}月`;
			if(lDay) timeText += `${lDay}日`;
			if(hour !== undefined) timeText += ` ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:${second.toString().padStart(2, '0')}`;
			
			if(timeText) {
				timeText += '(农历)';
			} else {
				timeText = '请输入农历日期';
			}
			
			document.getElementById('nowText').textContent = timeText;
			
			// 构建干支显示 - 横向表格形式
			const ganzhiItems = [];
			const xunkongItems = [];
			
			// 生成关系信息的HTML
			function generateRelationsHTML(relations) {
				if(relations.length === 0) return '';
				return relations.map(rel => {
					// 提取五行字符并添加颜色
					let html = rel;
					
					// 为天干添加颜色
					['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'].forEach((stem, index) => {
						const wuxing = getStemWuxing(stem); // 使用getStemWuxing函数获取中文五行
						const colorClass = getWuxingColorClass(wuxing);
						html = html.replace(new RegExp(stem, 'g'), `<span class="${colorClass}">${stem}</span>`);
					});
					
					// 为地支添加颜色（处理相冲相合中的地支字符）
					['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'].forEach((branch, index) => {
						const wuxing = getBranchWuxing(branch); // 使用getBranchWuxing函数获取中文五行
						const colorClass = getWuxingColorClass(wuxing);
						html = html.replace(new RegExp(branch, 'g'), `<span class="${colorClass}">${branch}</span>`);
					});
					
					// 为五行字符添加颜色
					['木', '火', '土', '金', '水'].forEach(wx => {
						const colorClass = getWuxingColorClass(wx);
						html = html.replace(new RegExp(wx, 'g'), `<span class="${colorClass}">${wx}</span>`);
					});
					
					return html;
				}).join('<br>');
			}
			
			// 生成旬空显示HTML
			function generateXunKongHTML(xunKong) {
				if(xunKong.length === 0) return '—';
				return xunKong.map(branch => {
					const wuxing = getBranchWuxing(branch);
					const colorClass = getWuxingColorClass(wuxing);
					return `<span class="${colorClass}">${branch}</span>`;
				}).join('');
			}
			
			// 年干支（只需要年份）
			if(lYear) {
				// 使用农历年份计算年干支
				const yearGZ = getGanZhiYearFromLunar(lYear);
				const yearWxClass = getWuxingClass(yearGZ.tgIndex, yearGZ.dzIndex);
				const yearBranch = branches[yearGZ.dzIndex];
				const yearRelations = getBranchRelations(yearBranch);
				const yearXunKong = getXunKong(yearGZ);
				ganzhiItems.push(`<td><div><span class="${yearWxClass.stemClass}">${stems[yearGZ.tgIndex]}</span><span class="${yearWxClass.branchClass}">${branches[yearGZ.dzIndex]}</span>年</div><div class="relations">${generateRelationsHTML(yearRelations)}</div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">${generateXunKongHTML(yearXunKong)}</div></td>`);
			} else {
				ganzhiItems.push(`<td><div>— —年</div><div class="relations"></div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">—</div></td>`);
			}
			
			// 月干支（需要年份和月份）
			if(lYear && lMonth) {
				// 使用农历年月计算月干支
				const monthGZ = getGanZhiMonthFromLunar(lYear, lMonth);
				const monthWxClass = getWuxingClass(monthGZ.tgIndex, monthGZ.dzIndex);
				const monthBranch = branches[monthGZ.dzIndex];
				const monthRelations = getBranchRelations(monthBranch);
				const monthXunKong = getXunKong(monthGZ);
				ganzhiItems.push(`<td><div><span class="${monthWxClass.stemClass}">${stems[monthGZ.tgIndex]}</span><span class="${monthWxClass.branchClass}">${branches[monthGZ.dzIndex]}</span>月</div><div class="relations">${generateRelationsHTML(monthRelations)}</div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">${generateXunKongHTML(monthXunKong)}</div></td>`);
			} else {
				ganzhiItems.push(`<td><div>— —月</div><div class="relations"></div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">—</div></td>`);
			}
			
			// 日干支（需要完整的年月日）
			if(lYear && lMonth && lDay) {
				const solarDate = lunarToSolar(lYear, lMonth, lDay);
				const dayGZ = getGanZhiDay(solarDate);
				const dayWxClass = getWuxingClass(dayGZ.tgIndex, dayGZ.dzIndex);
				const dayBranch = branches[dayGZ.dzIndex];
				const dayRelations = getBranchRelations(dayBranch);
				const dayXunKong = getXunKong(dayGZ);
				ganzhiItems.push(`<td><div><span class="${dayWxClass.stemClass}">${stems[dayGZ.tgIndex]}</span><span class="${dayWxClass.branchClass}">${branches[dayGZ.dzIndex]}</span>日</div><div class="relations">${generateRelationsHTML(dayRelations)}</div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">${generateXunKongHTML(dayXunKong)}</div></td>`);
			} else {
				ganzhiItems.push(`<td><div>— —日</div><div class="relations"></div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">—</div></td>`);
			}
			
			// 时干支（需要日干支和时辰）
			if(lYear && lMonth && lDay && hour !== undefined) {
				const solarDate = lunarToSolar(lYear, lMonth, lDay);
				const dayGZ = getGanZhiDay(solarDate);
				const hourGZ = getGanZhiHour(solarDate, dayGZ.tgIndex);
				const hourWxClass = getWuxingClass(hourGZ.tgIndex, hourGZ.dzIndex);
				const hourBranch = branches[hourGZ.dzIndex];
				const hourRelations = getBranchRelations(hourBranch);
				const hourXunKong = getXunKong(hourGZ);
				ganzhiItems.push(`<td><div><span class="${hourWxClass.stemClass}">${stems[hourGZ.tgIndex]}</span><span class="${hourWxClass.branchClass}">${branches[hourGZ.dzIndex]}</span>时</div><div class="relations">${generateRelationsHTML(hourRelations)}</div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">${generateXunKongHTML(hourXunKong)}</div></td>`);
			} else {
				ganzhiItems.push(`<td><div>— —时</div><div class="relations"></div></td>`);
				xunkongItems.push(`<td><div class="xunkong-value">—</div></td>`);
			}
			
			// 生成旬空显示HTML
			function generateXunKongHTML(xunKong) {
				if(xunKong.length === 0) return '—';
				return xunKong.map(branch => {
					const wuxing = getBranchWuxing(branch);
					const colorClass = getWuxingColorClass(wuxing);
					return `<span class="${colorClass}">${branch}</span>`;
				}).join('');
			}
			
			// 显示干支表格
			document.getElementById('ganzhiText').innerHTML = `<table class="ganzhi-table"><tr>${ganzhiItems.join('')}</tr></table>`;
			
			// 显示旬空表格
			document.getElementById('xunkongText').innerHTML = `<table class="ganzhi-table"><tr>${xunkongItems.join('')}</tr></table>`;
			
			// 其他显示
			if(lYear && lMonth && lDay) {
				const solarDate = lunarToSolar(lYear, lMonth, lDay);
				solarDate.setHours(hour, minute, second);
				renderTermList(solarDate);
				renderShi(solarDate);
			} else {
				document.getElementById('currentTermText').innerHTML = '—';
				document.getElementById('currentShiText').innerHTML = '—';
			}
		}

		// 干支计算（按立春分界）
		function getGanZhiYear(dCN){
			// 以立春为岁首
			const y = dCN.getFullYear();
			const liChun = sTerm(y, 2); // 立春
			const year4 = (dCN >= liChun) ? y : (y - 1);
			
			// 1984甲子年
			const baseYear = 1984;
			const span = year4 - baseYear;
			const tgIndex = (span % 10 + 10) % 10;
			const dzIndex = (span % 12 + 12) % 12;
			return { tgIndex, dzIndex, year: year4 };
		}

		function getGanZhiMonth(dCN, yearTgIndex){
			// 月支以节气划分
			const y = dCN.getFullYear();
			const cur = findCurrentTermCN(dCN).prev.index;
			
			// 节气索引到月序的映射（0-11，对应寅月到丑月）
			// 立春(2) → 寅月(0), 惊蛰(4) → 卯月(1), 清明(6) → 辰月(2), 立夏(8) → 巳月(3)
			// 芒种(10) → 午月(4), 小暑(12) → 未月(5), 立秋(14) → 申月(6), 白露(16) → 酉月(7)
			// 寒露(18) → 戌月(8), 立冬(20) → 亥月(9), 大雪(22) → 子月(10), 小寒(0) → 丑月(11)
			let monthIndex;
			if(cur === 2) monthIndex = 0;      // 立春 → 寅月
			else if(cur === 4) monthIndex = 1;  // 惊蛰 → 卯月
			else if(cur === 6) monthIndex = 2;  // 清明 → 辰月
			else if(cur === 8) monthIndex = 3;  // 立夏 → 巳月
			else if(cur === 10) monthIndex = 4; // 芒种 → 午月
			else if(cur === 12) monthIndex = 5; // 小暑 → 未月
			else if(cur === 14) monthIndex = 6; // 立秋 → 申月
			else if(cur === 16) monthIndex = 7; // 白露 → 酉月
			else if(cur === 18) monthIndex = 8; // 寒露 → 戌月
			else if(cur === 20) monthIndex = 9; // 立冬 → 亥月
			else if(cur === 22) monthIndex = 10; // 大雪 → 子月
			else if(cur === 0) monthIndex = 11;  // 小寒 → 丑月
			else monthIndex = Math.floor(((cur - 2 + 24) % 24) / 2); // 兜底计算
			
			// 地支：寅=2, 卯=3, 辰=4, 巳=5, 午=6, 未=7, 申=8, 酉=9, 戌=10, 亥=11, 子=0, 丑=1
			const dzIndex = (2 + monthIndex) % 12;
			
			// 天干按口诀计算
			// 甲己之年丙作首，乙庚之岁戊为头；丙辛必定寻庚起，丁壬壬寅顺水流；戊癸之年甲寅起
			let firstMonthStem;
			if([0,5].includes(yearTgIndex)) firstMonthStem = 2; // 甲己 → 丙
			else if([1,6].includes(yearTgIndex)) firstMonthStem = 4; // 乙庚 → 戊
			else if([2,7].includes(yearTgIndex)) firstMonthStem = 6; // 丙辛 → 庚
			else if([3,8].includes(yearTgIndex)) firstMonthStem = 8; // 丁壬 → 壬
			else firstMonthStem = 0; // 戊癸 → 甲
			
			const tgIndex = (firstMonthStem + monthIndex) % 10;
			return { tgIndex, dzIndex, monthIndex };
		}

		function getGanZhiDay(dCN){
			// 以1902-02-10（甲子日，index1）为基准
			const baseYear = 1902;
			const baseMonth = 2;
			const baseDay = 10;
			
			// 更准确的偏移天数计算 - 避免时区问题
			function daysBetween(date1, date2) {
				// 将两个日期都设置为UTC时间，避免时区影响
				const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
				const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
				return Math.floor((utc2 - utc1) / (1000 * 60 * 60 * 24));
			}
			
			const base = new Date(baseYear, baseMonth - 1, baseDay);
			const offset = daysBetween(base, dCN);
			
			let cycIndex = (1 + offset) % 60;
			if(cycIndex === 0) cycIndex = 60; // 如果为0则取60（癸亥）
			
			// 六十甲子表（1-60）
			const jiaziTable = [
				null, // 0号位不用
				{ tg: 0, dz: 0 }, // 1.甲子
				{ tg: 1, dz: 1 }, // 2.乙丑
				{ tg: 2, dz: 2 }, // 3.丙寅
				{ tg: 3, dz: 3 }, // 4.丁卯
				{ tg: 4, dz: 4 }, // 5.戊辰
				{ tg: 5, dz: 5 }, // 6.己巳
				{ tg: 6, dz: 6 }, // 7.庚午
				{ tg: 7, dz: 7 }, // 8.辛未
				{ tg: 8, dz: 8 }, // 9.壬申
				{ tg: 9, dz: 9 }, // 10.癸酉
				{ tg: 0, dz: 10 }, // 11.甲戌
				{ tg: 1, dz: 11 }, // 12.乙亥
				{ tg: 2, dz: 0 }, // 13.丙子
				{ tg: 3, dz: 1 }, // 14.丁丑
				{ tg: 4, dz: 2 }, // 15.戊寅
				{ tg: 5, dz: 3 }, // 16.己卯
				{ tg: 6, dz: 4 }, // 17.庚辰
				{ tg: 7, dz: 5 }, // 18.辛巳
				{ tg: 8, dz: 6 }, // 19.壬午
				{ tg: 9, dz: 7 }, // 20.癸未
				{ tg: 0, dz: 8 }, // 21.甲申
				{ tg: 1, dz: 9 }, // 22.乙酉
				{ tg: 2, dz: 10 }, // 23.丙戌
				{ tg: 3, dz: 11 }, // 24.丁亥
				{ tg: 4, dz: 0 }, // 25.戊子
				{ tg: 5, dz: 1 }, // 26.己丑
				{ tg: 6, dz: 2 }, // 27.庚寅
				{ tg: 7, dz: 3 }, // 28.辛卯
				{ tg: 8, dz: 4 }, // 29.壬辰
				{ tg: 9, dz: 5 }, // 30.癸巳
				{ tg: 0, dz: 6 }, // 31.甲午
				{ tg: 1, dz: 7 }, // 32.乙未
				{ tg: 2, dz: 8 }, // 33.丙申
				{ tg: 3, dz: 9 }, // 34.丁酉
				{ tg: 4, dz: 10 }, // 35.戊戌
				{ tg: 5, dz: 11 }, // 36.己亥
				{ tg: 6, dz: 0 }, // 37.庚子
				{ tg: 7, dz: 1 }, // 38.辛丑
				{ tg: 8, dz: 2 }, // 39.壬寅
				{ tg: 9, dz: 3 }, // 40.癸卯
				{ tg: 0, dz: 4 }, // 41.甲辰
				{ tg: 1, dz: 5 }, // 42.乙巳
				{ tg: 2, dz: 6 }, // 43.丙午
				{ tg: 3, dz: 7 }, // 44.丁未
				{ tg: 4, dz: 8 }, // 45.戊申
				{ tg: 5, dz: 9 }, // 46.己酉
				{ tg: 6, dz: 10 }, // 47.庚戌
				{ tg: 7, dz: 11 }, // 48.辛亥
				{ tg: 8, dz: 0 }, // 49.壬子
				{ tg: 9, dz: 1 }, // 50.癸丑
				{ tg: 0, dz: 2 }, // 51.甲寅
				{ tg: 1, dz: 3 }, // 52.乙卯
				{ tg: 2, dz: 4 }, // 53.丙辰
				{ tg: 3, dz: 5 }, // 54.丁巳
				{ tg: 4, dz: 6 }, // 55.戊午
				{ tg: 5, dz: 7 }, // 56.己未
				{ tg: 6, dz: 8 }, // 57.庚申
				{ tg: 7, dz: 9 }, // 58.辛酉
				{ tg: 8, dz: 10 }, // 59.壬戌
				{ tg: 9, dz: 11 } // 60.癸亥
			];
			
			const jiazi = jiaziTable[cycIndex];
			return { tgIndex: jiazi.tg, dzIndex: jiazi.dz, cycIndex };
		}

		function getGanZhiHour(dCN, dayTgIndex){
			// 子时23:00-00:59视作当天子初
			let h = dCN.getHours();
			let branchIndex;
			if(h === 23) branchIndex = 0; 
			else branchIndex = Math.floor((h + 1) / 2) % 12;
			
			const tgIndex = (dayTgIndex * 2 + branchIndex) % 10;
			return { tgIndex, dzIndex: branchIndex };
		}

		function renderGanzhi(dCN, allSanheJu = []){
			const yearGZ = getGanZhiYear(dCN);
			const monthGZ = getGanZhiMonth(dCN, yearGZ.tgIndex);
			const dayGZ = getGanZhiDay(dCN);
			const hourGZ = getGanZhiHour(dCN, dayGZ.tgIndex);
			
			const yearWxClass = getWuxingClass(yearGZ.tgIndex, yearGZ.dzIndex);
			const monthWxClass = getWuxingClass(monthGZ.tgIndex, monthGZ.dzIndex);
			const dayWxClass = getWuxingClass(dayGZ.tgIndex, dayGZ.dzIndex);
			const hourWxClass = getWuxingClass(hourGZ.tgIndex, hourGZ.dzIndex);
			
			// 获取地支关系信息（不包含旬空）
			const yearBranch = branches[yearGZ.dzIndex];
			const monthBranch = branches[monthGZ.dzIndex];
			const dayBranch = branches[dayGZ.dzIndex];
			const hourBranch = branches[hourGZ.dzIndex];
			
			const yearRelations = getBranchRelations(yearBranch);
			const monthRelations = getBranchRelations(monthBranch);
			const dayRelations = getBranchRelations(dayBranch);
			const hourRelations = getBranchRelations(hourBranch);
			
			// 计算旬空
			const yearXunKong = getXunKong(yearGZ);
			const monthXunKong = getXunKong(monthGZ);
			const dayXunKong = getXunKong(dayGZ);
			const hourXunKong = getXunKong(hourGZ);
			
			// 生成关系信息的HTML
			function generateRelationsHTML(relations) {
				if(relations.length === 0) return '';
				return relations.map(rel => {
					// 提取五行字符并添加颜色
					let html = rel;
					
					// 为天干添加颜色
					['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'].forEach((stem, index) => {
						const wuxing = getStemWuxing(stem); // 使用getStemWuxing函数获取中文五行
						const colorClass = getWuxingColorClass(wuxing);
						html = html.replace(new RegExp(stem, 'g'), `<span class="${colorClass}">${stem}</span>`);
					});
					
					// 为地支添加颜色（处理相冲相合中的地支字符）
					['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'].forEach((branch, index) => {
						const wuxing = getBranchWuxing(branch); // 使用getBranchWuxing函数获取中文五行
						const colorClass = getWuxingColorClass(wuxing);
						html = html.replace(new RegExp(branch, 'g'), `<span class="${colorClass}">${branch}</span>`);
					});
					
					// 为五行字符添加颜色
					['木', '火', '土', '金', '水'].forEach(wx => {
						const colorClass = getWuxingColorClass(wx);
						html = html.replace(new RegExp(wx, 'g'), `<span class="${colorClass}">${wx}</span>`);
					});
					
					return html;
				}).join('<br>');
			}
			
			// 生成旬空显示HTML
			function generateXunKongHTML(xunKong) {
				if(xunKong.length === 0) return '—';
				return xunKong.map(branch => {
					const wuxing = getBranchWuxing(branch);
					const colorClass = getWuxingColorClass(wuxing);
					return `<span class="${colorClass}">${branch}</span>`;
				}).join('');
			}
			
			// 检查日支和月支是否参与三合局情况4
			let daySanheMark = '';
			let monthSanheMark = '';
			
			// 检查日支是否参与情况4或情况5
			let daySanheCases = [];
			for (const sanhe of allSanheJu) {
				console.log('检查日支三合局:', sanhe);
				// 情况4：动爻+动爻+日支组成三合局
				if (sanhe.case === 4 && sanhe.dayOrMonth === 'day' && sanhe.dayOrMonthBranch === dayBranch) {
					console.log('找到日支情况4三合局');
					daySanheCases.push(sanhe);
				}
				// 情况5：日支+月支+爻支组成三合局
				else if (sanhe.case === 5 && sanhe.dizhi && sanhe.dizhi.includes(dayBranch)) {
					console.log('找到日支情况5三合局');
					daySanheCases.push(sanhe);
				}
			}
			
			// 检查月支是否参与情况4或情况5
			let monthSanheCases = [];
			console.log('检查月支三合局，月支:', monthBranch);
			console.log('所有三合局:', allSanheJu);
			for (const sanhe of allSanheJu) {
				console.log('检查三合局:', sanhe.case, sanhe.dizhi, sanhe.dayOrMonth, sanhe.dayOrMonthBranch);
				// 情况4：动爻+动爻+月支组成三合局
				if (sanhe.case === 4 && sanhe.dayOrMonth === 'month' && sanhe.dayOrMonthBranch === monthBranch) {
					console.log('找到月支情况4三合局');
					monthSanheCases.push(sanhe);
				}
				// 情况5：日支+月支+爻支组成三合局
				else if (sanhe.case === 5 && sanhe.dizhi && sanhe.dizhi.includes(monthBranch)) {
					console.log('找到月支情况5三合局');
					monthSanheCases.push(sanhe);
				}
			}
			
			// 生成日支标记（合并多个情况）
			if (daySanheCases.length > 0) {
				const combinedDaySanhe = {
					...daySanheCases[0],
					allParticipatingCases: daySanheCases.map(s => s.case)
				};
				daySanheMark = `<div class="sanhe-mark sanhe-${daySanheCases[0].wuxing}" data-sanhe-info='${JSON.stringify(combinedDaySanhe)}' style="position: absolute; bottom: 68px; left: 50%; transform: translateX(-50%); width: 16px; height: 2px;"></div>`;
			}
			
			// 生成月支标记（合并多个情况）
			if (monthSanheCases.length > 0) {
				const combinedMonthSanhe = {
					...monthSanheCases[0],
					allParticipatingCases: monthSanheCases.map(s => s.case)
				};
				monthSanheMark = `<div class="sanhe-mark sanhe-${monthSanheCases[0].wuxing}" data-sanhe-info='${JSON.stringify(combinedMonthSanhe)}' style="position: absolute; bottom: 68px; left: 50%; transform: translateX(-50%); width: 16px; height: 2px;"></div>`;
			}
			
			console.log('最终日支标记:', daySanheMark);
			console.log('最终月支标记:', monthSanheMark);
			console.log('日支:', dayBranch, '月支:', monthBranch);
			console.log('所有三合局:', allSanheJu);
			console.log('检查日支三合局详情:');
			allSanheJu.forEach((sanhe, index) => {
				if (sanhe.case === 4) {
					console.log(`三合局${index}:`, sanhe);
					console.log(`  dayOrMonth: ${sanhe.dayOrMonth}`);
					console.log(`  dayOrMonthBranch: ${sanhe.dayOrMonthBranch}`);
					console.log(`  是否匹配日支: ${sanhe.dayOrMonth === 'day' && sanhe.dayOrMonthBranch === dayBranch}`);
					console.log(`  是否匹配月支: ${sanhe.dayOrMonth === 'month' && sanhe.dayOrMonthBranch === monthBranch}`);
				}
			});
			

			
			document.getElementById('ganzhiText').innerHTML = `
				<table class="ganzhi-table">
					<tr>
						<td>
							<div><span class="${yearWxClass.stemClass}">${stems[yearGZ.tgIndex]}</span><span class="${yearWxClass.branchClass}">${branches[yearGZ.dzIndex]}</span>年</div>
							<div class="relations">${generateRelationsHTML(yearRelations)}</div>
						</td>
						<td style="position: relative;">
							<div><span class="${monthWxClass.stemClass}">${stems[monthGZ.tgIndex]}</span><span class="${monthWxClass.branchClass} day-month-dizhi" data-dizhi="${monthBranch}" data-dizhi-type="month">${branches[monthGZ.dzIndex]}</span>月</div>
							<div class="relations">${generateRelationsHTML(monthRelations)}</div>
							${monthSanheMark}
						</td>
						<td style="position: relative;">
							<div><span class="${dayWxClass.stemClass}">${stems[dayGZ.tgIndex]}</span><span class="${dayWxClass.branchClass} day-month-dizhi" data-dizhi="${dayBranch}" data-dizhi-type="day">${branches[dayGZ.dzIndex]}</span>日</div>
							<div class="relations">${generateRelationsHTML(dayRelations)}</div>
							${daySanheMark}
						</td>
						<td>
							<div><span class="${hourWxClass.stemClass}">${stems[hourGZ.tgIndex]}</span><span class="${hourWxClass.branchClass}">${branches[hourGZ.dzIndex]}</span>时</div>
							<div class="relations">${generateRelationsHTML(hourRelations)}</div>
						</td>
					</tr>
				</table>
			`;
			
			// 显示旬空
			document.getElementById('xunkongText').innerHTML = `
				<table class="ganzhi-table">
					<tr>
						<td><div class="xunkong-value">${generateXunKongHTML(yearXunKong)}</div></td>
						<td><div class="xunkong-value">${generateXunKongHTML(monthXunKong)}</div></td>
						<td><div class="xunkong-value">${generateXunKongHTML(dayXunKong)}</div></td>
						<td><div class="xunkong-value">${generateXunKongHTML(hourXunKong)}</div></td>
					</tr>
				</table>
			`;
		}

		function renderTermList(dCN){
			const terms = getTermsByYearAccurate(dCN);
			// 找当前节气（含起始闭区间左闭右开）
			let curIdx = terms.findIndex(t=> dCN>=t.start && dCN<t.end);
			if(curIdx<0){
				// 时间点极端边界，回退最近开始<=dCN
				let last = -1; for(let i=0;i<terms.length;i++){ if(dCN>=terms[i].start) last=i; }
				curIdx = (last>=0)? last : 0;
			}
			const cur = terms[curIdx];
			document.getElementById('currentTermText').innerHTML = `<span class="term-item current">${cur.name}:${fmtCNDateTimeTZ(cur.start)} ~ ${fmtCNDateTimeTZ(cur.end)}</span>`;

			// 表格两列
			let rows = [];
			for(let i=0;i<terms.length;i+=2){
				const t1 = terms[i];
				let cell1 = `<td><div class="term-item ${i===curIdx?'current':''}">${t1.name}：${fmtCNDateTimeTZ(t1.start)} ~ ${fmtCNDateTimeTZ(t1.end)}</div></td>`;
				let cell2 = '<td></td>';
				if(i+1<terms.length){
					const t2 = terms[i+1];
					cell2 = `<td><div class="term-item ${(i+1)===curIdx?'current':''}">${t2.name}：${fmtCNDateTimeTZ(t2.start)} ~ ${fmtCNDateTimeTZ(t2.end)}</div></td>`;
				}
				rows.push(`<tr>${cell1}${cell2}</tr>`);
			}
			document.getElementById('termTable').innerHTML = rows.join('');
		}

		function tick(){
			updateManualTimeDisplay();
		}

		document.getElementById('toggleTerms').addEventListener('click', ()=>{
			const p = document.getElementById('termPanel');
			p.classList.toggle('hidden');
			document.getElementById('toggleTerms').textContent = p.classList.contains('hidden')? '▼':'▲';
		});

		document.getElementById('shiCaret').addEventListener('click', ()=>{
			const p = document.getElementById('shiPanel');
			p.classList.toggle('hidden');
			document.getElementById('shiCaret').textContent = p.classList.contains('hidden')? '▼':'▲';
		});
		
					// 便捷查询按钮的点击事件
		document.addEventListener('DOMContentLoaded', function() {
			// 地支冲合
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('dizhi-chonghe-title')) {
					// 检查是否已经显示了地支冲合的悬浮框
					const existingTooltip = document.getElementById('dizhi-chonghe-tooltip');
					if (existingTooltip) {
						// 如果已经显示，则隐藏
						hideAllTooltips();
					} else {
						// 如果没有显示，则显示
						showDizhiChongheTooltip(e.target);
					}
				}
			});
			
			// 五行生克
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('wuxing-shengke-title')) {
					// 检查是否已经显示了五行生克的悬浮框
					const existingTooltip = document.getElementById('wuxing-shengke-tooltip');
					if (existingTooltip) {
						// 如果已经显示，则隐藏
						hideAllTooltips();
					} else {
						// 如果没有显示，则显示
						showWuxingShengkeTooltip(e.target);
					}
				}
			});
			
			// 动爻发动
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('dongyao-fadong-title')) {
					// 检查是否已经显示了动爻发动的悬浮框
					const existingTooltip = document.getElementById('dongyao-fadong-tooltip');
					if (existingTooltip) {
						// 如果已经显示，则隐藏
						hideAllTooltips();
					} else {
						// 如果没有显示，则显示
						showDongyaoFadongTooltip(e.target);
					}
				}
			});
			
			// 废
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('fei-title')) {
					// 检查是否已经显示了废的悬浮框
					const existingTooltip = document.getElementById('fei-tooltip');
					if (existingTooltip) {
						// 如果已经显示，则隐藏
						hideAllTooltips();
					} else {
						// 如果没有显示，则显示
						showFeiTooltip(e.target);
					}
				}
			});
			
			// 十二长生 - 使用模态框调用长生十二宫调用.htm
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('shier-changsheng-title')) {
					// 使用iframe加载文件，避免CORS限制
					const modal = document.createElement('div');
					modal.style.cssText = `
						position: fixed;
						top: 0;
						left: 0;
						width: 100%;
						height: 100%;
						background: transparent;
						z-index: 10000;
						display: flex;
						justify-content: center;
						align-items: center;
					`;
					
					const content = document.createElement('div');
					content.style.cssText = `
						background: transparent;
						width: 100%;
						height: 100%;
						border: none;
						overflow: hidden;
						position: relative;
					`;
					
					const closeBtn = document.createElement('button');
					closeBtn.innerHTML = '×';
					closeBtn.style.cssText = `
						position: fixed;
						top: 20px;
						right: 20px;
						background: rgba(0,0,0,0.7);
						color: white;
						border: none;
						border-radius: 50%;
						width: 40px;
						height: 40px;
						font-size: 20px;
						cursor: pointer;
						z-index: 10001;
						box-shadow: 0 2px 10px rgba(0,0,0,0.3);
					`;
					
					closeBtn.onclick = () => {
						document.body.removeChild(modal);
					};
					
					const iframe = document.createElement('iframe');
					iframe.style.cssText = `
						width: 100%;
						height: 100%;
						border: none;
						background: transparent;
					`;
					
					// 尝试多个路径
					const possiblePaths = [
						'六爻排盘调用/长生十二宫 调用.html',
						'./六爻排盘调用/长生十二宫 调用.html',
						'../六爻排盘调用/长生十二宫 调用.html'
					];
					
					let pathIndex = 0;
					
					function tryLoadIframe() {
						if (pathIndex >= possiblePaths.length) {
							alert('无法加载长生十二宫，请检查文件是否存在');
							document.body.removeChild(modal);
							return;
						}
						
						const currentPath = possiblePaths[pathIndex];
						console.log('尝试加载路径:', currentPath);
						
						iframe.src = currentPath;
						iframe.onerror = () => {
							console.log('路径失败:', currentPath);
							pathIndex++;
							setTimeout(tryLoadIframe, 100);
						};
						
						iframe.onload = () => {
							console.log('成功加载:', currentPath);
						};
					}
					
					content.appendChild(closeBtn);
					content.appendChild(iframe);
					modal.appendChild(content);
					document.body.appendChild(modal);
					
					// 开始尝试加载
					setTimeout(tryLoadIframe, 100);
				}
			});
			
			// 动动相连
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('dongdong-xianglian-title')) {
					// 检查是否已经显示了动动相连的悬浮框
					const existingTooltip = document.getElementById('dongdong-xianglian-tooltip');
					if (existingTooltip) {
						// 如果已经显示，则隐藏
						hideAllTooltips();
					} else {
						// 如果没有显示，则显示
						showDongdongXianglianTooltip(e.target);
					}
				}
			});
			
			// 辨吉凶
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('bianjixiong-title')) {
					// 检查是否已经显示了辨吉凶的悬浮框
					const existingTooltip = document.getElementById('bianjixiong-tooltip');
					if (existingTooltip) {
						// 如果已经显示，则隐藏
						hideAllTooltips();
					} else {
						// 如果没有显示，则显示
						showBianjixiongTooltip(e.target);
					}
				}
			});
			
			// 三合局
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('sanheju-title')) {
					// 检查是否已经显示了三合局的悬浮框
					const existingTooltip = document.getElementById('sanheju-tooltip');
					if (existingTooltip) {
						// 如果已经显示，则隐藏
						hideAllTooltips();
					} else {
						// 如果没有显示，则显示
						showSanhejuTooltip(e.target);
					}
				}
			});
			
			// 全局点击事件：点击任何地方都隐藏悬浮框（除非点击的是便捷查询按钮本身）
			document.addEventListener('click', function(e) {
				// 如果点击的是这些按钮本身，不隐藏悬浮框
				if (e.target.classList.contains('notes-title') || 
					e.target.classList.contains('dizhi-chonghe-title') || 
					e.target.classList.contains('wuxing-shengke-title') || 
					e.target.classList.contains('dongyao-fadong-title') || 
					e.target.classList.contains('fei-title') || 
					e.target.classList.contains('shier-changsheng-title') ||
					e.target.classList.contains('dongdong-xianglian-title') ||
					e.target.classList.contains('bianjixiong-title') ||
					e.target.classList.contains('sanheju-title') ||
					e.target.classList.contains('jixiong-mark')) {
					return;
				}
				
				// 隐藏所有悬浮框
				hideAllTooltips();
				hideXunkongTooltip();
				hideLiushenTooltip();
				hideYaoTooltip();
				hideDaychongTooltip();
				hideStrengthTooltip();
				hideSanheTooltip();
				hideDongyaoTooltip();
				hideJixiongTooltip();
			});
			
			// 添加旬空标题点击事件
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('xunkong-title')) {
					// 隐藏其他所有悬浮框
					hideAllTooltips();
					hideXunkongTooltip();
					hideLiushenTooltip();
					hideYaoTooltip();
					hideDaychongTooltip();
					hideStrengthTooltip();
					hideSanheTooltip();
					hideDongyaoTooltip();
					
					showXunkongTooltip(e.target);
				}
			});
			
			// 添加吉凶标记点击事件
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('jixiong-mark')) {
					// 隐藏其他所有悬浮框
					hideAllTooltips();
					hideXunkongTooltip();
					hideLiushenTooltip();
					hideYaoTooltip();
					hideDaychongTooltip();
					hideStrengthTooltip();
					hideSanheTooltip();
					hideDongyaoTooltip();
					
					showJixiongTooltip(e.target);
				}
			});
		});

		// 时间源选择事件
		document.getElementById('realtimeToggle').addEventListener('change', ()=>{
			document.getElementById('manualPanel').classList.add('hidden');
			document.getElementById('lunarPanel').classList.add('hidden');
			updateManualTimeDisplay();
		});
		document.getElementById('manualToggle').addEventListener('change', ()=>{
			document.getElementById('manualPanel').classList.remove('hidden');
			document.getElementById('lunarPanel').classList.add('hidden');
			updateManualTimeDisplay();
		});
		document.getElementById('lunarToggle').addEventListener('change', ()=>{
			document.getElementById('manualPanel').classList.add('hidden');
			document.getElementById('lunarPanel').classList.remove('hidden');
			updateManualTimeDisplay();
		});

		// 手动时间输入事件
		['manualYear', 'manualMonth', 'manualHour', 'manualMinute', 'manualSecond'].forEach(id => {
			document.getElementById(id).addEventListener('input', function() {
				validateTimeInput(this);
				updateManualTimeDisplay();
			});
		});
		// 日期选择事件
		document.getElementById('manualDay').addEventListener('change', updateManualTimeDisplay);

		// 农历时间输入事件
		['lunarYear', 'lunarMonth', 'lunarHour', 'lunarMinute', 'lunarSecond'].forEach(id => {
			document.getElementById(id).addEventListener('input', function() {
				validateTimeInput(this);
				updateLunarTimeDisplay();
			});
		});
		// 农历日期选择事件
		document.getElementById('lunarDay').addEventListener('change', updateLunarTimeDisplay);

		// 添加月份和年份变化时的日期限制
		document.getElementById('manualMonth').addEventListener('change', function() {
			updateDayOptions();
		});
		document.getElementById('manualYear').addEventListener('change', function() {
			updateDayOptions();
		});

		// 农历月份和年份变化时的日期限制
		document.getElementById('lunarMonth').addEventListener('change', function() {
			updateLunarDayOptions();
		});
		document.getElementById('lunarYear').addEventListener('change', function() {
			updateLunarDayOptions();
		});

		// 时间输入验证函数
		function validateTimeInput(input) {
			const value = parseInt(input.value);
			const id = input.id;
			let isValid = true;
			let errorMessage = '';
			
			// 根据不同的输入字段设置验证规则
			switch(id) {
				case 'manualYear':
				case 'lunarYear':
					if (value < 1900 || value > 2100) {
						isValid = false;
						errorMessage = '年份必须在1900-2100之间';
					}
					break;
				case 'manualMonth':
				case 'lunarMonth':
					if (value < 1 || value > 12) {
						isValid = false;
						errorMessage = '月份必须在1-12之间';
					}
					break;
				case 'manualHour':
				case 'lunarHour':
					if (value < 0 || value > 23) {
						isValid = false;
						errorMessage = '小时必须在0-23之间';
					}
					break;
				case 'manualMinute':
				case 'lunarMinute':
					if (value < 0 || value > 59) {
						isValid = false;
						errorMessage = '分钟必须在0-59之间';
					}
					break;
				case 'manualSecond':
				case 'lunarSecond':
					if (value < 0 || value > 59) {
						isValid = false;
						errorMessage = '秒数必须在0-59之间';
					}
					break;
			}
			
			// 显示或隐藏错误提示
			let errorDiv = input.parentNode.querySelector('.error-message');
			if (!errorDiv) {
				errorDiv = document.createElement('div');
				errorDiv.className = 'error-message';
				errorDiv.style.cssText = 'color: red; font-size: 12px; margin-top: 2px;';
				input.parentNode.appendChild(errorDiv);
			}
			
			if (!isValid && input.value !== '') {
				errorDiv.textContent = errorMessage;
				input.style.borderColor = 'red';
			} else {
				errorDiv.textContent = '';
				input.style.borderColor = '#ddd';
			}
		}

		function updateDayOptions() {
			const year = parseInt(document.getElementById('manualYear').value);
			const month = parseInt(document.getElementById('manualMonth').value);
			const daySelect = document.getElementById('manualDay');
			
			// 清空现有选项
			daySelect.innerHTML = '<option value="">日</option>';
			
			if (year && month) {
				const maxDays = new Date(year, month, 0).getDate(); // 获取当月最大天数
				
				// 添加当月所有有效日期
				for (let day = 1; day <= maxDays; day++) {
					const option = document.createElement('option');
					option.value = day;
					option.textContent = day;
					daySelect.appendChild(option);
				}
			}
		}

		function updateLunarDayOptions() {
			const year = parseInt(document.getElementById('lunarYear').value);
			const month = parseInt(document.getElementById('lunarMonth').value);
			const daySelect = document.getElementById('lunarDay');
			
			// 清空现有选项
			daySelect.innerHTML = '<option value="">日</option>';
			
			if (year && month) {
				const maxDays = monthDays(year, month); // 获取农历当月最大天数
				
				// 添加当月所有有效日期
				for (let day = 1; day <= maxDays; day++) {
					const option = document.createElement('option');
					option.value = day;
					option.textContent = day;
					daySelect.appendChild(option);
				}
			}
		}

		function lunarToSolar(lYear, lMonth, lDay) {
			// 农历转阳历
			// 以1900-01-31为基准，计算农历日期对应的阳历日期
			const baseMs = Date.UTC(1900, 0, 30, 16, 0, 0); // 1900-01-31 00:00 +08:00
			let offset = 0;
			
			// 计算从1900年到目标年份的天数
			for (let y = 1900; y < lYear; y++) {
				offset += lYearDays(y);
			}
			
			// 计算目标年份内到目标月份的天数
			const leap = leapMonth(lYear);
			for (let m = 1; m < lMonth; m++) {
				if (leap > 0 && m === leap + 1) {
					offset += leapDays(lYear); // 闰月
				}
				offset += monthDays(lYear, m);
			}
			
			// 加上目标月份的天数
			offset += lDay - 1;
			
			// 转换为阳历日期
			const solarMs = baseMs + offset * 86400000;
			return new Date(solarMs);
		}

		setInterval(tick, 1000);
		
		// 页面加载时初始化日期选项
		updateDayOptions();
		updateLunarDayOptions(); // 初始化农历日期选项
		tick();

		// 旬空计算
		function getXunKong(ganzhi) {
			// 旬空对应关系：
			// 甲子旬：甲子、乙丑、丙寅、丁卯、戊辰、己巳、庚午、辛未、壬申、癸酉 - 空戌亥
			// 甲戌旬：甲戌、乙亥、丙子、丁丑、戊寅、己卯、庚辰、辛巳、壬午、癸未 - 空申酉
			// 甲申旬：甲申、乙酉、丙戌、丁亥、戊子、己丑、庚寅、辛卯、壬辰、癸巳 - 空午未
			// 甲午旬：甲午、乙未、丙申、丁酉、戊戌、己亥、庚子、辛丑、壬寅、癸卯 - 空辰巳
			// 甲辰旬：甲辰、乙巳、丙午、丁未、戊申、己酉、庚戌、辛亥、壬子、癸丑 - 空寅卯
			// 甲寅旬：甲寅、乙卯、丙辰、丁巳、戊午、己未、庚申、辛酉、壬戌、癸亥 - 空子丑
			
			// 直接映射每个干支到对应的旬空
			const ganzhiXunKongMap = {
				// 甲子旬
				'甲子': ['戌', '亥'], '乙丑': ['戌', '亥'], '丙寅': ['戌', '亥'], '丁卯': ['戌', '亥'], '戊辰': ['戌', '亥'],
				'己巳': ['戌', '亥'], '庚午': ['戌', '亥'], '辛未': ['戌', '亥'], '壬申': ['戌', '亥'], '癸酉': ['戌', '亥'],
				// 甲戌旬
				'甲戌': ['申', '酉'], '乙亥': ['申', '酉'], '丙子': ['申', '酉'], '丁丑': ['申', '酉'], '戊寅': ['申', '酉'],
				'己卯': ['申', '酉'], '庚辰': ['申', '酉'], '辛巳': ['申', '酉'], '壬午': ['申', '酉'], '癸未': ['申', '酉'],
				// 甲申旬
				'甲申': ['午', '未'], '乙酉': ['午', '未'], '丙戌': ['午', '未'], '丁亥': ['午', '未'], '戊子': ['午', '未'],
				'己丑': ['午', '未'], '庚寅': ['午', '未'], '辛卯': ['午', '未'], '壬辰': ['午', '未'], '癸巳': ['午', '未'],
				// 甲午旬
				'甲午': ['辰', '巳'], '乙未': ['辰', '巳'], '丙申': ['辰', '巳'], '丁酉': ['辰', '巳'], '戊戌': ['辰', '巳'],
				'己亥': ['辰', '巳'], '庚子': ['辰', '巳'], '辛丑': ['辰', '巳'], '壬寅': ['辰', '巳'], '癸卯': ['辰', '巳'],
				// 甲辰旬
				'甲辰': ['寅', '卯'], '乙巳': ['寅', '卯'], '丙午': ['寅', '卯'], '丁未': ['寅', '卯'], '戊申': ['寅', '卯'],
				'己酉': ['寅', '卯'], '庚戌': ['寅', '卯'], '辛亥': ['寅', '卯'], '壬子': ['寅', '卯'], '癸丑': ['寅', '卯'],
				// 甲寅旬
				'甲寅': ['子', '丑'], '乙卯': ['子', '丑'], '丙辰': ['子', '丑'], '丁巳': ['子', '丑'], '戊午': ['子', '丑'],
				'己未': ['子', '丑'], '庚申': ['子', '丑'], '辛酉': ['子', '丑'], '壬戌': ['子', '丑'], '癸亥': ['子', '丑']
			};
			
			const stem = stems[ganzhi.tgIndex];
			const branch = branches[ganzhi.dzIndex];
			const ganzhiKey = `${stem}${branch}`;
			
			return ganzhiXunKongMap[ganzhiKey] || [];
		}

		// 生成旬空显示HTML
		function generateXunKongHTML(xunKong) {
			if(xunKong.length === 0) return '';
			
			const xunKongText = xunKong.map(branch => {
				const wuxing = getBranchWuxing(branch);
				const colorClass = getWuxingColorClass(wuxing);
				return `<span class="${colorClass}">${branch}</span>`;
			}).join('');
			
			return `旬空：${xunKongText}`;
		}

		// ===== 六爻卦象功能 =====
		
		// 六爻选项
		const yaoOptions = [
			"少阳———",
			"少阴—   —",
			"老阳——— O",
			"老阴—   — X"
		];

		// 64卦表（二进制数字转换上→下，0=阴,1=阳）
		const gua64 = {
			"111111":"乾为天","000000":"坤为地","010001":"水雷屯","100010":"山水蒙",
			"010111":"水天需","111010":"天水讼","000010":"地水师","010000":"水地比",
			"110111":"风天小畜","111011":"天泽履","000111":"地天泰","111000":"天地否",
			"111101":"天火同人","101111":"火天大有","000100":"地山谦","001000":"雷地豫",
			"011001":"泽雷随","100110":"山风蛊","000011":"地泽临","110000":"风地观",
			"101001":"火雷噬嗑","100101":"山火贲","100000":"山地剥","000001":"地雷复",
			"111001":"天雷无妄","100111":"山天大畜","100001":"山雷颐","011110":"泽风大过",
			"010010":"坎为水","101101":"离为火","011100":"泽山咸","001110":"雷风恒",
			"111100":"天山遯","001111":"雷天大壮","101000":"火地晋","000101":"地火明夷",
			"110101":"风火家人","101011":"火泽睽","010100":"水山蹇","001010":"雷水解",
			"100011":"山泽损","110001":"风雷益","011111":"泽天夬","111110":"天风姤",
			"011000":"泽地萃","000110":"地风升","011010":"泽水困","010110":"水风井",
			"011101":"泽火革","101110":"火风鼎","001001":"震为雷","100100":"艮为山",
			"110100":"风山渐","001011":"雷泽归妹","001101":"雷火丰","101100":"火山旅",
			"110110":"巽为风","011011":"兑为泽","110010":"风水涣","010011":"水泽节",
			"110011":"风泽中孚","001100":"雷山小过","010101":"水火既济","101010":"火水未济"
		};

		// 填充下拉菜单
		function initYaoSelects() {
			for (let i = 1; i <= 6; i++) {
				const select = document.getElementById("line"+i);
				if (select) {
					select.innerHTML = '';
					yaoOptions.forEach(opt => {
						const el = document.createElement("option");
						el.text = opt;
						select.add(el);
					});
				}
			}
		}

		// 辅助函数：把爻文字转换成0/1
		function yaoToBinary(yao) {
			if(yao.includes("少阳") || yao.includes("老阳")) return 1;
			if(yao.includes("少阴") || yao.includes("老阴")) return 0;
		}

		// 判断是否变爻
		function getChangeLine(yao) {
			return yao.includes("老阳") || yao.includes("老阴");
		}

		// 老爻变动生成变卦
		function getYaoChange(yao) {
			if(yao.includes("老阳")) return "少阴—   —";
			if(yao.includes("老阴")) return "少阳———";
			return yao;
		}

		// 转换为中文数字
		function toChineseNum(num) {
			const chineseNums = ['一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '十一', '十二', '十三', '十四', '十五', '十六', '十七', '十八', '十九', '二十', '二十一', '二十二', '二十三', '二十四', '二十五', '二十六', '二十七', '二十八', '二十九', '三十', '三十一', '三十二', '三十三', '三十四', '三十五', '三十六', '三十七', '三十八', '三十九', '四十', '四十一', '四十二', '四十三', '四十四', '四十五', '四十六', '四十七', '四十八', '四十九', '五十', '五十一', '五十二', '五十三', '五十四', '五十五', '五十六', '五十七', '五十八', '五十九', '六十', '六十一', '六十二', '六十三', '六十四'];
			return chineseNums[num - 1] || num;
		}

		// 判断卦的宫位和类型
		function getGuaInfo(binary) {
			// 乾宫八卦
			if (['111111', '111110', '111100', '111000', '110000', '100000', '101000', '101111'].includes(binary)) {
				if (binary === '111111') return '<span class="wx-jin">乾-金-八纯</span>';
				if (binary === '111110') return '<span class="wx-jin">乾-金-初爻变</span>';
				if (binary === '111100') return '<span class="wx-jin">乾-金-二爻变</span>';
				if (binary === '111000') return '<span class="wx-jin">乾-金-三爻变</span>';
				if (binary === '110000') return '<span class="wx-jin">乾-金-四爻变</span>';
				if (binary === '100000') return '<span class="wx-jin">乾-金-五爻变</span>';
				if (binary === '101000') return '<span class="wx-jin">乾-金-游魂</span>';
				if (binary === '101111') return '<span class="wx-jin">乾-金-归魂</span>';
				return '<span class="wx-jin">乾-金</span>';
			}
			// 坤宫八卦
			if (['000000', '000001', '000011', '000111', '001111', '011111', '010111', '010000'].includes(binary)) {
				if (binary === '000000') return '<span class="wx-tu">坤-土-八纯</span>';
				if (binary === '000001') return '<span class="wx-tu">坤-土-初爻变</span>';
				if (binary === '000011') return '<span class="wx-tu">坤-土-二爻变</span>';
				if (binary === '000111') return '<span class="wx-tu">坤-土-三爻变</span>';
				if (binary === '001111') return '<span class="wx-tu">坤-土-四爻变</span>';
				if (binary === '011111') return '<span class="wx-tu">坤-土-五爻变</span>';
				if (binary === '010111') return '<span class="wx-tu">坤-土-游魂</span>';
				if (binary === '010000') return '<span class="wx-tu">坤-土-归魂</span>';
				return '<span class="wx-tu">坤-土</span>';
			}
			// 坎宫八卦
			if (['010010', '010011', '010001', '010101', '011101', '001101', '000101', '000010'].includes(binary)) {
				if (binary === '010010') return '<span class="wx-shui">坎-水-八纯</span>';
				if (binary === '010011') return '<span class="wx-shui">坎-水-初爻变</span>';
				if (binary === '010001') return '<span class="wx-shui">坎-水-二爻变</span>';
				if (binary === '010101') return '<span class="wx-shui">坎-水-三爻变</span>';
				if (binary === '011101') return '<span class="wx-shui">坎-水-四爻变</span>';
				if (binary === '001101') return '<span class="wx-shui">坎-水-五爻变</span>';
				if (binary === '000101') return '<span class="wx-shui">坎-水-游魂</span>';
				if (binary === '000010') return '<span class="wx-shui">坎-水-归魂</span>';
				return '<span class="wx-shui">坎-水</span>';
			}
			// 离宫八卦
			if (['101101', '101100', '101110', '101010', '100010', '110010', '111010', '111101'].includes(binary)) {
				if (binary === '101101') return '<span class="wx-huo">离-火-八纯</span>';
				if (binary === '101100') return '<span class="wx-huo">离-火-初爻变</span>';
				if (binary === '101110') return '<span class="wx-huo">离-火-二爻变</span>';
				if (binary === '101010') return '<span class="wx-huo">离-火-三爻变</span>';
				if (binary === '100010') return '<span class="wx-huo">离-火-四爻变</span>';
				if (binary === '110010') return '<span class="wx-huo">离-火-五爻变</span>';
				if (binary === '111010') return '<span class="wx-huo">离-火-游魂</span>';
				if (binary === '111101') return '<span class="wx-huo">离-火-归魂</span>';
				return '<span class="wx-huo">离-火</span>';
			}
			// 震宫八卦
			if (['001001', '001000', '001010', '001110', '000110', '010110', '011110', '011001'].includes(binary)) {
				if (binary === '001001') return '<span class="wx-mu">震-木-八纯</span>';
				if (binary === '001000') return '<span class="wx-mu">震-木-初爻变</span>';
				if (binary === '001010') return '<span class="wx-mu">震-木-二爻变</span>';
				if (binary === '001110') return '<span class="wx-mu">震-木-三爻变</span>';
				if (binary === '000110') return '<span class="wx-mu">震-木-四爻变</span>';
				if (binary === '010110') return '<span class="wx-mu">震-木-五爻变</span>';
				if (binary === '011110') return '<span class="wx-mu">震-木-游魂</span>';
				if (binary === '011001') return '<span class="wx-mu">震-木-归魂</span>';
				return '<span class="wx-mu">震-木</span>';
			}
			// 艮宫八卦
			if (['100100', '100101', '100111', '100011', '101011', '111011', '110011', '110100'].includes(binary)) {
				if (binary === '100100') return '<span class="wx-tu">艮-土-八纯</span>';
				if (binary === '100101') return '<span class="wx-tu">艮-土-初爻变</span>';
				if (binary === '100111') return '<span class="wx-tu">艮-土-二爻变</span>';
				if (binary === '100011') return '<span class="wx-tu">艮-土-三爻变</span>';
				if (binary === '101011') return '<span class="wx-tu">艮-土-四爻变</span>';
				if (binary === '111011') return '<span class="wx-tu">艮-土-五爻变</span>';
				if (binary === '110011') return '<span class="wx-tu">艮-土-游魂</span>';
				if (binary === '110100') return '<span class="wx-tu">艮-土-归魂</span>';
				return '<span class="wx-tu">艮-土</span>';
			}
			// 巽宫八卦
			if (['110110', '110111', '110101', '110001', '111001', '101001', '100001', '100110'].includes(binary)) {
				if (binary === '110110') return '<span class="wx-mu">巽-木-八纯</span>';
				if (binary === '110111') return '<span class="wx-mu">巽-木-初爻变</span>';
				if (binary === '110101') return '<span class="wx-mu">巽-木-二爻变</span>';
				if (binary === '110001') return '<span class="wx-mu">巽-木-三爻变</span>';
				if (binary === '111001') return '<span class="wx-mu">巽-木-四爻变</span>';
				if (binary === '101001') return '<span class="wx-mu">巽-木-五爻变</span>';
				if (binary === '100001') return '<span class="wx-mu">巽-木-游魂</span>';
				if (binary === '100110') return '<span class="wx-mu">巽-木-归魂</span>';
				return '<span class="wx-mu">巽-木</span>';
			}
			// 兑宫八卦
			if (['011011', '011010', '011000', '011100', '010100', '000100', '001100', '001011'].includes(binary)) {
				if (binary === '011011') return '<span class="wx-jin">兑-金-八纯</span>';
				if (binary === '011010') return '<span class="wx-jin">兑-金-初爻变</span>';
				if (binary === '011000') return '<span class="wx-jin">兑-金-二爻变</span>';
				if (binary === '011100') return '<span class="wx-jin">兑-金-三爻变</span>';
				if (binary === '010100') return '<span class="wx-jin">兑-金-四爻变</span>';
				if (binary === '000100') return '<span class="wx-jin">兑-金-五爻变</span>';
				if (binary === '001100') return '<span class="wx-jin">兑-金-游魂</span>';
				if (binary === '001011') return '<span class="wx-jin">兑-金-归魂</span>';
				return '<span class="wx-jin">兑-金</span>';
			}
			return '';
		}

		// 获取世应位置
		function getShiYing(binary) {
			const guaInfo = getGuaInfo(binary);
			
			if (guaInfo.includes('八纯')) {
				return { shi: 0, ying: 3 }; // 上爻为世(0)，三爻为应(3)
			} else if (guaInfo.includes('初爻变')) {
				return { shi: 5, ying: 2 }; // 初爻为世(5)，四爻为应(2)
			} else if (guaInfo.includes('二爻变')) {
				return { shi: 4, ying: 1 }; // 二爻为世(4)，五爻为应(1)
			} else if (guaInfo.includes('三爻变')) {
				return { shi: 3, ying: 0 }; // 三爻为世(3)，上爻为应(0)
			} else if (guaInfo.includes('四爻变')) {
				return { shi: 2, ying: 5 }; // 四爻为世(2)，初爻为应(5)
			} else if (guaInfo.includes('五爻变')) {
				return { shi: 1, ying: 4 }; // 五爻为世(1)，二爻为应(4)
			} else if (guaInfo.includes('游魂')) {
				return { shi: 2, ying: 5 }; // 四爻为世(2)，初爻为应(5)
			} else if (guaInfo.includes('归魂')) {
				return { shi: 3, ying: 0 }; // 三爻为世(3)，上爻为应(0)
			}
			
			return { shi: -1, ying: -1 }; // 无世应
		}

		// 获取地支信息
		function getDizhi(binary) {
			const lower = binary.substring(3, 6); // 内卦（初爻二爻三爻）
			const upper = binary.substring(0, 3); // 外卦（四爻五爻上爻）
			
			const dizhiMap = {
				'111': { lower: ['子水', '寅木', '辰土'], upper: ['午火', '申金', '戌土'] },
				'110': { lower: ['丑土', '亥水', '酉金'], upper: ['未土', '巳火', '卯木'] },
				'010': { lower: ['寅木', '辰土', '午火'], upper: ['申金', '戌土', '子水'] },
				'101': { lower: ['卯木', '丑土', '亥水'], upper: ['酉金', '未土', '巳火'] },
				'100': { lower: ['辰土', '午火', '申金'], upper: ['戌土', '子水', '寅木'] },
				'011': { lower: ['巳火', '卯木', '丑土'], upper: ['亥水', '酉金', '未土'] },
				'001': { lower: ['子水', '寅木', '辰土'], upper: ['午火', '申金', '戌土'] },
				'000': { lower: ['未土', '巳火', '卯木'], upper: ['丑土', '亥水', '酉金'] }
			};
			
			const lowerDizhi = dizhiMap[lower] ? dizhiMap[lower].lower : [];
			const upperDizhi = dizhiMap[upper] ? dizhiMap[upper].upper : [];
			
			// 重新排列：从上爻到初爻的顺序
			// 数组索引：0=上爻, 1=五爻, 2=四爻, 3=三爻, 4=二爻, 5=初爻
			const result = [];
			result[0] = upperDizhi[2]; // 上爻
			result[1] = upperDizhi[1]; // 五爻
			result[2] = upperDizhi[0]; // 四爻
			result[3] = lowerDizhi[2]; // 三爻
			result[4] = lowerDizhi[1]; // 二爻
			result[5] = lowerDizhi[0]; // 初爻
			
			return result;
		}

		// 获取地支的五行颜色类
		function getDizhiColorClass(dizhi) {
			if (dizhi.includes('水')) return 'wx-shui';
			if (dizhi.includes('木')) return 'wx-mu';
			if (dizhi.includes('火')) return 'wx-huo';
			if (dizhi.includes('金')) return 'wx-jin';
			if (dizhi.includes('土')) return 'wx-tu';
			return '';
		}

		// 获取天干信息
		function getTiangan(binary) {
			const lower = binary.substring(3, 6); // 内卦（初爻二爻三爻）
			const upper = binary.substring(0, 3); // 外卦（四爻五爻上爻）
			
			const tianganMap = {
				'111': { lower: '甲', upper: '壬' },
				'110': { lower: '辛', upper: '辛' },
				'010': { lower: '戊', upper: '戊' },
				'101': { lower: '巳', upper: '巳' },
				'100': { lower: '丙', upper: '丙' },
				'011': { lower: '丁', upper: '丁' },
				'001': { lower: '庚', upper: '庚' },
				'000': { lower: '乙', upper: '癸' }
			};
			
			const lowerTiangan = tianganMap[lower] ? tianganMap[lower].lower : '';
			const upperTiangan = tianganMap[upper] ? tianganMap[upper].upper : '';
			
			// 返回从上爻到初爻的天干数组
			const result = [];
			result[0] = upperTiangan; // 上爻
			result[1] = upperTiangan; // 五爻
			result[2] = upperTiangan; // 四爻
			result[3] = lowerTiangan; // 三爻
			result[4] = lowerTiangan; // 二爻
			result[5] = lowerTiangan; // 初爻
			
			return result;
		}

		// 获取六亲信息
		function getLiuqin(binary, dizhi) {
			// 获取卦宫五行
			const guaInfo = getGuaInfo(binary);
			let guaWuxing = '';
			if (guaInfo.includes('乾-金') || guaInfo.includes('兑-金')) guaWuxing = '金';
			else if (guaInfo.includes('震-木') || guaInfo.includes('巽-木')) guaWuxing = '木';
			else if (guaInfo.includes('坎-水')) guaWuxing = '水';
			else if (guaInfo.includes('离-火')) guaWuxing = '火';
			else if (guaInfo.includes('坤-土') || guaInfo.includes('艮-土')) guaWuxing = '土';
			
			// 五行相生相克关系
			const wuxingRelations = {
				'金': { ke: '木', sheng: '水', beike: '火', besheng: '土' },
				'木': { ke: '土', sheng: '火', beike: '金', besheng: '水' },
				'水': { ke: '火', sheng: '木', beike: '土', besheng: '金' },
				'火': { ke: '金', sheng: '土', beike: '水', besheng: '木' },
				'土': { ke: '水', sheng: '金', beike: '木', besheng: '火' }
			};
			
			const relations = wuxingRelations[guaWuxing];
			if (!relations) return [];
			
			// 根据地支五行确定六亲
			const liuqinMap = {
				[guaWuxing]: '兄弟',      // A
				[relations.ke]: '妻财',   // B (A克B)
				[relations.sheng]: '子孙', // C (A生C)
				[relations.beike]: '官鬼', // D (D克A)
				[relations.besheng]: '父母' // E (E生A)
			};
			
			// 根据地支五行返回六亲
			const result = [];
			for (let i = 0; i < dizhi.length; i++) {
				const dizhiWuxing = getDizhiWuxing(dizhi[i]);
				result[i] = liuqinMap[dizhiWuxing] || '';
			}
			
			return result;
		}



		// 获取伏神信息
		function getFushen(binary, liuqin) {
			// 检查本卦六亲分布，找出缺失的六亲
			const allLiuqin = ['父母', '兄弟', '妻财', '官鬼', '子孙'];
			const presentLiuqin = new Set(liuqin.filter(lq => lq !== ''));
			const missingLiuqin = allLiuqin.filter(lq => !presentLiuqin.has(lq));
			
			if (missingLiuqin.length === 0) {
				return null; // 没有缺失的六亲，不需要伏神
			}
			
			// 取第一个缺失的六亲作为伏神
			const fushenLiuqin = missingLiuqin[0];
			
			// 确定伏神落爻位置
			const fushenPosition = getFushenPosition(binary, fushenLiuqin);
			
			if (!fushenPosition) {
				return null; // 无法确定伏神位置
			}
			
			return {
				liuqin: fushenLiuqin,
				position: fushenPosition,
				dizhi: fushenPosition.dizhi
			};
		}

		// 确定伏神落爻位置
		function getFushenPosition(binary, fushenLiuqin) {
			// 获取本卦所属的八宫
			const guaInfo = getGuaInfo(binary);
			// 移除HTML标签，获取纯文本
			const guaInfoText = guaInfo.replace(/<[^>]*>/g, '');
			let palace = '';
			if (guaInfoText.includes('乾-金')) palace = '乾';
			else if (guaInfoText.includes('坤-土')) palace = '坤';
			else if (guaInfoText.includes('坎-水')) palace = '坎';
			else if (guaInfoText.includes('离-火')) palace = '离';
			else if (guaInfoText.includes('震-木')) palace = '震';
			else if (guaInfoText.includes('艮-土')) palace = '艮';
			else if (guaInfoText.includes('巽-木')) palace = '巽';
			else if (guaInfoText.includes('兑-金')) palace = '兑';
			
			// 八纯卦的二进制表示
			const pureGuaMap = {
				'乾': '111111',
				'坤': '000000',
				'坎': '010010',
				'离': '101101',
				'震': '001001',
				'艮': '100100',
				'巽': '110110',
				'兑': '011011'
			};
			
			const pureGuaBinary = pureGuaMap[palace];
			if (!pureGuaBinary) return null;
			
			// 获取八纯卦的地支信息
			const pureGuaDizhi = getDizhi(pureGuaBinary);
			const pureGuaLiuqin = getLiuqin(pureGuaBinary, pureGuaDizhi);
			
			// 在八纯卦中找到伏神六亲所在的爻位
			let fushenYaoIndex = -1;
			for (let i = 0; i < pureGuaLiuqin.length; i++) {
				if (pureGuaLiuqin[i] === fushenLiuqin) {
					fushenYaoIndex = i;
					break;
				}
			}
			
			if (fushenYaoIndex === -1) return null;
			
			return {
				yaoIndex: fushenYaoIndex,
				dizhi: pureGuaDizhi[fushenYaoIndex]
			};
		}

		// 获取地支的五行
		function getDizhiWuxing(dizhi) {
			if (dizhi.includes('水')) return '水';
			if (dizhi.includes('木')) return '木';
			if (dizhi.includes('火')) return '火';
			if (dizhi.includes('金')) return '金';
			if (dizhi.includes('土')) return '土';
			return '';
		}

		// 获取六神信息
		function getLiushen(dayTgIndex) {
			const liushenList = ['青龙', '朱雀', '勾陈', '腾蛇', '白虎', '玄武'];
			
			// 根据日干确定初爻的六神
			let startIndex;
			if (dayTgIndex === 0 || dayTgIndex === 1) { // 甲/乙
				startIndex = 0; // 青龙
			} else if (dayTgIndex === 2 || dayTgIndex === 3) { // 丙/丁
				startIndex = 1; // 朱雀
			} else if (dayTgIndex === 4) { // 戊
				startIndex = 2; // 勾陈
			} else if (dayTgIndex === 5) { // 己
				startIndex = 3; // 腾蛇
			} else if (dayTgIndex === 6 || dayTgIndex === 7) { // 庚/辛
				startIndex = 4; // 白虎
			} else if (dayTgIndex === 8 || dayTgIndex === 9) { // 壬/癸
				startIndex = 5; // 玄武
			}
			
			// 从初爻到上爻的顺序排列六神（数组索引：5=初爻, 4=二爻, 3=三爻, 2=四爻, 1=五爻, 0=上爻）
			const result = [];
			for (let i = 0; i < 6; i++) {
				// 数组索引i对应爻位：0=上爻, 1=五爻, 2=四爻, 3=三爻, 4=二爻, 5=初爻
				// 所以初爻(5)应该对应startIndex，二爻(4)对应startIndex+1，以此类推
				const liushenIndex = (startIndex + (5 - i)) % 6;
				result[i] = liushenList[liushenIndex];
			}
			
			return result;
		}

		// 获取六神隐藏信息
		function getLiushenInfo(liushenName) {
			const liushenInfo = {
				'青龙': {
					title: '青龙：属木,东方,左边',
					positive: '吉者主:正义、忠诚、正式、正配、高大、威严、端正、帅气、靓丽、喜庆、福禄、吉祥、喝酒、饮食',
					negative: '衰者主:嗜酒、贪杯、好色(比较高端的好色 正大歌舞团)、清高、不合群、孤僻、乐极生悲'
				},
				'朱雀': {
					title: '朱雀：属火,南方,前方',
					positive: '吉者主:文书、信息、说话、甜言蜜语、口才、火光、温暖、飞行、快速、红色',
					negative: '衰者主:口舌、是非、官司、火灾、炎热、发言、感冒、发烧、中暑'
				},
				'勾陈': {
					title: '勾陈：属土,中央',
					positive: '吉者主:诚实、稳重、憨厚、可靠、田土、房产、地产、建筑、陈旧、熟悉、熟人、老朋友',
					negative: '衰者主:愚笨、不灵光、迟缓、勾连、牵制、纠缠、肿胀、肿瘤、癌症、牢狱之灾'
				},
				'腾蛇': {
					title: '腾蛇：属土,中央',
					positive: '吉者主:缠绕、弯曲、灵活、思维、小路、艺术、技艺、冥冥之中',
					negative: '衰者主:惊讶、惊吓、心惊、怪异、虚幻、奇幻、噩梦、阴私、阴灵、魂魄'
				},
				'白虎': {
					title: '白虎：属金,西方,右边',
					positive: '吉者主:威猛、霸气、有魄力、男人味、女汉子、果断、不拖泥带水、刀枪、士兵、从军、征伐',
					negative: '衰者主:暴躁、家暴、打架、虐待、血光、流血、损伤、受伤、疾病、死亡、煞气、丧事、孝服'
				},
				'玄武': {
					title: '玄武：属水,北方,后边',
					positive: '吉者主:聪明、智慧、缜密、有城府、内向、害羞、暧昧',
					negative: '衰者主:盗贼、淫乱、纵欲(低俗的,路边按摩会所)、淫邪、赌博、诈骗、欺骗、虚伪、狡诈、抑郁、精神病、小人'
				}
			};
			return liushenInfo[liushenName] || null;
		}

		// 月建数字量化计算
		function calculateMonthStrength(monthBranch, yaoBranch) {
			// 获取月支和爻支的五行（使用中文五行）
			const monthWuxing = getBranchWuxing(monthBranch);
			const yaoWuxing = getBranchWuxing(yaoBranch);
			
			
			// 相合关系
			const branchCombinations = {
				'子': '丑', '寅': '亥', '卯': '戌', '辰': '酉', '巳': '申', '午': '未',
				'丑': '子', '亥': '寅', '戌': '卯', '酉': '辰', '申': '巳', '未': '午'
			};
			
			// 相冲关系
			const branchConflicts = {
				'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
				'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
			};
			
			// 五行生克关系
			const wuxingRelations = {
				'木': { sheng: '火', ke: '土' },
				'火': { sheng: '土', ke: '金' },
				'土': { sheng: '金', ke: '水' },
				'金': { sheng: '水', ke: '木' },
				'水': { sheng: '木', ke: '火' }
			};
			
			// 1) 临月建：地支相同
			if (monthBranch === yaoBranch) {
				return { value: 2, type: '临月建', description: '临月建：地支相同,五行不论' };
			}
			
			// 2) 月建生合：地支相合且五行相生
			if (branchCombinations[monthBranch] === yaoBranch && wuxingRelations[monthWuxing] && wuxingRelations[monthWuxing].sheng === yaoWuxing) {
				return { value: 2, type: '月建生合', description: '月建生合：地支相合,五行相生' };
			}
			
			// 3) 月建相生：地支无用,五行相生
			if (monthBranch !== yaoBranch && 
				branchConflicts[monthBranch] !== yaoBranch && 
				branchConflicts[yaoBranch] !== monthBranch && 
				yaoBranch !== branchCombinations[monthBranch] && 
				wuxingRelations[monthWuxing] && 
				wuxingRelations[monthWuxing].sheng === yaoWuxing) {
				return { value: 1, type: '月建相生', description: '月建相生：地支无用,五行相生' };
			}
			
			// 4) 月建相扶：地支无用,五行相同
			if (monthBranch !== yaoBranch && 
				branchConflicts[monthBranch] !== yaoBranch && 
				branchConflicts[yaoBranch] !== monthBranch && 
				yaoBranch !== branchCombinations[monthBranch] && 
				monthWuxing === yaoWuxing) {
				return { value: 1, type: '月建相扶', description: '月建相扶：地支无用,五行相同' };
			}
			
			// 5) 月建平和：地支相合,五行无用
			if (branchCombinations[monthBranch] === yaoBranch && 
				monthWuxing !== yaoWuxing && 
				(!wuxingRelations[monthWuxing] || wuxingRelations[monthWuxing].sheng !== yaoWuxing) &&
				(!wuxingRelations[monthWuxing] || wuxingRelations[monthWuxing].ke !== yaoWuxing)) {
				return { value: 0.5, type: '月建平和', description: '月建平和：地支相合,五行无用' };
			}
			
			// 6) 春夏月气：辰月作用寅木爻、卯木爻；未月作用巳火爻、午火爻
			if ((monthBranch === '辰' && (yaoBranch === '寅' || yaoBranch === '卯')) ||
				(monthBranch === '未' && (yaoBranch === '巳' || yaoBranch === '午'))) {
				return { value: 0.5, type: '春夏月气', description: '春夏月气：辰月作用寅木爻、卯木爻；未月作用巳火爻、午火爻' };
			}
			
			// 7) 休囚：地支无用,五行无用
			if (monthBranch !== yaoBranch && 
				branchConflicts[monthBranch] !== yaoBranch && 
				branchConflicts[yaoBranch] !== monthBranch && 
				yaoBranch !== branchCombinations[monthBranch] && 
				monthWuxing !== yaoWuxing && 
				(!wuxingRelations[monthWuxing] || wuxingRelations[monthWuxing].sheng !== yaoWuxing) &&
				(!wuxingRelations[monthWuxing] || wuxingRelations[monthWuxing].ke !== yaoWuxing)) {
				return { value: -0.1, type: '休囚', description: '休囚：地支无用,五行无用' };
			}
			
			// 8) 月建克合：地支相合,五行相克
			if (branchCombinations[monthBranch] === yaoBranch && 
				wuxingRelations[monthWuxing] && 
				wuxingRelations[monthWuxing].ke === yaoWuxing) {
				return { value: -0.5, type: '月建克合', description: '月建克合：地支相合,五行相克' };
			}
			
			// 9) 月克：地支无用,五行相克
			if (monthBranch !== yaoBranch && 
				branchConflicts[monthBranch] !== yaoBranch && 
				branchConflicts[yaoBranch] !== monthBranch && 
				yaoBranch !== branchCombinations[monthBranch] && 
				wuxingRelations[monthWuxing] && 
				wuxingRelations[monthWuxing].ke === yaoWuxing) {
				return { value: -1, type: '月克', description: '月克：地支无用,五行相克' };
			}
			
			// 10) 月破：地支相冲
			if (branchConflicts[monthBranch] === yaoBranch || branchConflicts[yaoBranch] === monthBranch) {
				return { value: -2, type: '月破', description: '月破：地支相冲,五行不论' };
			}
			
			// 默认情况 - 返回null表示不显示
			return null;
		}

		// 日辰数字量化计算
		function calculateDayStrength(dayBranch, yaoBranch) {
			// 获取日支和爻支的五行
			const dayWuxing = getBranchWuxing(dayBranch);
			const yaoWuxing = getBranchWuxing(yaoBranch);
			
			// 相合关系
			const branchCombinations = {
				'子': '丑', '寅': '亥', '卯': '戌', '辰': '酉', '巳': '申', '午': '未',
				'丑': '子', '亥': '寅', '戌': '卯', '酉': '辰', '申': '巳', '未': '午'
			};
			
			// 相冲关系
			const branchConflicts = {
				'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
				'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
			};
			
			// 五行生克关系
			const wuxingRelations = {
				'木': { sheng: '火', ke: '土' },
				'火': { sheng: '土', ke: '金' },
				'土': { sheng: '金', ke: '水' },
				'金': { sheng: '水', ke: '木' },
				'水': { sheng: '木', ke: '火' }
			};
			
			// 1) 临日辰：地支相同
			if (dayBranch === yaoBranch) {
				return { value: 2, type: '临日辰', description: '临日辰：地支相同,五行不论' };
			}
			
			// 2) 日辰生合：地支相合且五行相生
			if (branchCombinations[dayBranch] === yaoBranch && wuxingRelations[dayWuxing] && wuxingRelations[dayWuxing].sheng === yaoWuxing) {
				return { value: 2, type: '日辰生合', description: '日辰生合：地支相合,五行相生' };
			}
			
			// 3) 日辰相生：地支无用,五行相生
			if (yaoBranch !== dayBranch && 
				yaoBranch !== branchConflicts[dayBranch] && 
				yaoBranch !== branchCombinations[dayBranch] && 
				wuxingRelations[dayWuxing] && 
				wuxingRelations[dayWuxing].sheng === yaoWuxing) {
				return { value: 1, type: '日辰相生', description: '日辰相生：地支无用,五行相生' };
			}
			
			// 4) 日辰相扶：地支无用,五行相同
			if (yaoBranch !== dayBranch && 
				yaoBranch !== branchConflicts[dayBranch] && 
				yaoBranch !== branchCombinations[dayBranch] && 
				dayWuxing === yaoWuxing) {
				return { value: 1, type: '日辰相扶', description: '日辰相扶：地支无用,五行相同' };
			}
			
			// 5) 日辰平和：地支相合,五行无用
			if (branchCombinations[dayBranch] === yaoBranch && 
				dayWuxing !== yaoWuxing && 
				(!wuxingRelations[dayWuxing] || wuxingRelations[dayWuxing].sheng !== yaoWuxing) &&
				(!wuxingRelations[dayWuxing] || wuxingRelations[dayWuxing].ke !== yaoWuxing)) {
				return { value: 0, type: '日辰平和', description: '日辰平和：地支相合,五行无用' };
			}
			
			// 6) 日辰无休囚：地支无用,五行无用
			if (yaoBranch !== dayBranch && 
				yaoBranch !== branchConflicts[dayBranch] && 
				yaoBranch !== branchCombinations[dayBranch] && 
				dayWuxing !== yaoWuxing && 
				(!wuxingRelations[dayWuxing] || wuxingRelations[dayWuxing].sheng !== yaoWuxing) &&
				(!wuxingRelations[dayWuxing] || wuxingRelations[dayWuxing].ke !== yaoWuxing)) {
				return { value: 0, type: '日辰无休囚', description: '日辰无休囚' };
			}
			
			// 7) 日辰克合：地支相合,五行相克
			if (branchCombinations[dayBranch] === yaoBranch && 
				wuxingRelations[dayWuxing] && 
				wuxingRelations[dayWuxing].ke === yaoWuxing) {
				return { value: -1, type: '日辰克合', description: '日辰克合：地支相合,五行相克' };
			}
			
			// 8) 日辰相克：地支无用,五行相克
			if (yaoBranch !== dayBranch && 
				yaoBranch !== branchConflicts[dayBranch] && 
				yaoBranch !== branchCombinations[dayBranch] && 
				wuxingRelations[dayWuxing] && 
				wuxingRelations[dayWuxing].ke === yaoWuxing) {
				return { value: -1, type: '日辰相克', description: '日辰相克：地支无用,五行相克' };
			}
			
			// 9) 日辰冲爻：日破/暗动，不论数字量化
			if (branchConflicts[dayBranch] === yaoBranch || branchConflicts[yaoBranch] === dayBranch) {
				return { value: 0, type: '日辰冲爻', description: '日辰冲爻：日破/暗动，不论数字量化' };
			}
			
			// 默认情况 - 返回null表示不显示
			return null;
		}

		// 获取六爻隐藏信息
		function getYaoInfo(yaoIndex) {
			const yaoInfo = {
				5: { // 初爻
					title: '初爻：',
					content: '卦的第一个爻:刚开始、当初、小时候、乡下、农村、老家、家里、邻居<br>处于最底层:下面、后面、底下、水井、地基、低洼处、普通市民、儿童、小学生、老百姓、普通职员、科员<br>在人体上代表:脚、脚趾、鞋子、袜子'
				},
				4: { // 二爻
					title: '二爻（<span class="highlight">宅爻</span>）：',
					content: '房子、屋内、办公室、家里、小镇<br>社会身份上代表:比普通人高一级的处长、科长、基层管理员<br>在人体上代表:腿、膝盖、肠、生殖器、子宫、胎位、裤子、护膝'
				},
				3: { // 三爻
					title: '三爻：',
					content: '床、卧室、市政府、县城<br>社会身上上代表:处长、县长、主任、中学生<br>在人体上代表:腰、腹部、臀部、脾胃、内脏、肝胆、底裤、裙子、围裙'
				},
				2: { // 四爻
					title: '四爻：',
					content: '窗户、大门、<span class="highlight">厕所</span>、地级市、高等学校<br>社会身份上代表:市长、厅长、高中生<br>在人体上代表:胸部、背部、乳房、心脏、肺部、挂饰、上衣'
				},
				1: { // 五爻
					title: '五爻（<span class="highlight">君爻：指当权者、一家之主的爻位；心念之爻</span>）：',
					content: '道路、首都、中心学校<br>社会身份上代表:国家元首、一把手、帝王、老板、上司、大学生<br>在人体上代表:脖子、五官、胸部、心脏、喉咙、气管、项链、手臂、围巾、外衣'
				},
				0: { // 上爻
					title: '上爻：',
					content: '远方、远离、边境、国外、祖坟、<span class="highlight">神位</span>、寺庙、墙壁、屋顶<br>社会身份上代表:退休人员、离职人员、老人、毕业生、<span class="highlight">神佛</span>、祖先<br>在人体上代表:头部、面部、神经、帽子、头饰'
				}
			};
			return yaoInfo[yaoIndex] || null;
		}

		// 判断日辰冲爻的类型（暗动、日破或日冲）
		function getDayChongType(yaoIndex, yaoBranch, yaoSymbol, dayBranch, monthBranch, changeMarks, dizhi, dayXunKong) {
			// 检查是否相冲
			const branchConflicts = {
				'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
				'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
			};
			
			// 基本条件：必须相冲
			if (branchConflicts[dayBranch] !== yaoBranch && branchConflicts[yaoBranch] !== dayBranch) {
				return null;
			}
			
			// 检查是否为静爻（少阴或少阳）
			const isJingYao = yaoSymbol.includes('少阳') || yaoSymbol.includes('少阴');
			
			// 如果是动爻相冲，直接标记为日冲
			if (!isJingYao) {
				return '日冲';
			}
			
			// 暗动的三种情况（满足任一即可，仅对静爻）：
			// 1. 静爻，且月建数字量化大于0
			if (monthBranch) {
				const monthStrength = calculateMonthStrength(monthBranch, yaoBranch);
				if (monthStrength && monthStrength.value > 0) {
					return '暗动1';
				}
			}
			
			// 2. 静爻，且该静爻的地支被本卦任意动爻的五行所生
			const yaoWuxing = getBranchWuxing(yaoBranch);
			const wuxingRelations = {
				'木': { sheng: '火', ke: '土' },
				'火': { sheng: '土', ke: '金' },
				'土': { sheng: '金', ke: '水' },
				'金': { sheng: '水', ke: '木' },
				'水': { sheng: '木', ke: '火' }
			};
			
			// 检查是否有动爻的五行生该爻
			for (let i = 0; i < changeMarks.length; i++) {
				if (changeMarks[i]) { // 如果是动爻
					const dongYaoBranch = dizhi[i].replace(/[水火木金土]/g, '');
					const dongYaoWuxing = getBranchWuxing(dongYaoBranch);
					if (wuxingRelations[dongYaoWuxing] && wuxingRelations[dongYaoWuxing].sheng === yaoWuxing) {
						return '暗动2';
					}
				}
			}
			
			// 3. 静爻，且该静爻为旬空
			if (dayXunKong.includes(yaoBranch)) {
				return '暗动3';
			}
			
			// 日破：如果日辰地支和静爻地支相冲，但不属于暗动的三种情况，则为日破
			return '日破';
		}

		// 判断动爻发动信息【解卦部分-动爻发动】
		function getDongyaoInfo(yaoIndex, yaoDizhi, changeMarks, dizhi, dizhiChange, dayBranch, monthBranch) {
			// 如果不是动爻，返回null
			if (!changeMarks[yaoIndex]) {
				return null;
			}
			
			const yaoBranch = yaoDizhi.replace(/[水火木金土]/g, ''); // 提取纯地支
			const yaoWuxing = yaoDizhi.replace(/[子丑寅卯辰巳午未申酉戌亥]/g, ''); // 提取五行
			const changeDizhi = dizhiChange[yaoIndex];
			const changeBranch = changeDizhi.replace(/[水火木金土]/g, ''); // 变爻纯地支
			const changeWuxing = changeDizhi.replace(/[子丑寅卯辰巳午未申酉戌亥]/g, ''); // 变爻五行
			
			// 调试信息
			console.log('动爻信息:', { yaoIndex, yaoDizhi, yaoBranch, yaoWuxing });
			console.log('变爻信息:', { changeDizhi, changeBranch, changeWuxing });
			
			// 1. 检查进神
			const jinShen = {
				'寅': '卯', '申': '酉', '丑': '辰', '未': '戌'
			};
			if (jinShen[yaoBranch] === changeBranch) {
				console.log('判断为进神');
				return { type: 'jin', text: '进神' };
			}
			
			// 2. 检查退神
			const tuiShen = {
				'卯': '寅', '酉': '申', '辰': '丑', '戌': '未'
			};
			if (tuiShen[yaoBranch] === changeBranch) {
				console.log('判断为退神');
				return { type: 'tui', text: '退神·<span class="fei">废</span>' };
			}
			
			// 3. 检查反吟（动爻地支与变爻地支相冲）
			const branchConflicts = {
				'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
				'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
			};
			if (branchConflicts[yaoBranch] === changeBranch || branchConflicts[changeBranch] === yaoBranch) {
				console.log('判断为反吟');
				return { type: 'fanyin', text: '反吟' };
			}
			
			// 4. 检查伏吟（动爻地支与变爻地支相同）
			if (yaoBranch === changeBranch) {
				console.log('判断为伏吟');
				return { type: 'fuyin', text: '伏吟' };
			}
			
			// 5. 检查回头克（变爻克动爻）
			// 前提：A1B1不相冲，B2克B1
			// 五行相克：木克土，土克水，水克火，火克金，金克木
			if ((changeWuxing === '木' && yaoWuxing === '土') ||
				(changeWuxing === '土' && yaoWuxing === '水') ||
				(changeWuxing === '水' && yaoWuxing === '火') ||
				(changeWuxing === '火' && yaoWuxing === '金') ||
				(changeWuxing === '金' && yaoWuxing === '木')) {
				console.log('判断为回头克');
				return { type: 'huitouke', text: '回头克·<span class="fei">废</span>' };
			}
			
			// 6. 检查回头生（变爻生动爻）
			// 前提：A1B1不相冲，B2生B1
			// 五行相生：水生木，木生火，火生土，土生金，金生水
			if ((changeWuxing === '水' && yaoWuxing === '木') ||
				(changeWuxing === '木' && yaoWuxing === '火') ||
				(changeWuxing === '火' && yaoWuxing === '土') ||
				(changeWuxing === '土' && yaoWuxing === '金') ||
				(changeWuxing === '金' && yaoWuxing === '水')) {
				console.log('判断为回头生');
				return { type: 'huitousheng', text: '回头生' };
			}
			
			// 7. 检查化破（变爻被月破或日辰冲）
			if (monthBranch) {
				const monthStrength = calculateMonthStrength(monthBranch, changeBranch);
				if (monthStrength && monthStrength.description.includes('月破')) {
					return { type: 'huapo', text: '化破·<span class="fei">废</span>' };
				}
			}
			if (dayBranch) {
				const dayStrength = calculateDayStrength(dayBranch, changeBranch);
				if (dayStrength && dayStrength.description.includes('日冲')) {
					return { type: 'huapo', text: '化破·<span class="fei">废</span>' };
				}
			}
			
			// 8. 化绝（预留位置，暂时不标记）
			// return { type: 'huajue', text: '化绝·<span class="fei">废</span>' };
			
			console.log('没有匹配任何条件，返回null');
			return null;
		}

		// 判断爻的吉凶【解卦部分-吉凶判断】
		function getJixiong(yaoIndex, changeMarks, dizhi, dizhiChange, dayBranch, monthBranch) {
			const yaoDizhi = dizhi[yaoIndex];
			const yaoBranch = yaoDizhi.replace(/[水火木金土]/g, ''); // 提取纯地支
			const yaoWuxing = yaoDizhi.replace(/[子丑寅卯辰巳午未申酉戌亥]/g, ''); // 提取五行
			
			// 第一标准：动爻发动标记
			if (changeMarks[yaoIndex]) {
				const dongyaoInfo = getDongyaoInfo(yaoIndex, yaoDizhi, changeMarks, dizhi, dizhiChange, dayBranch, monthBranch);
				if (dongyaoInfo) {
					const text = dongyaoInfo.text.replace(/<[^>]*>/g, ''); // 去掉HTML标签
					if (text.includes('回头生') || text.includes('进神')) {
						return { result: '吉', standard: 1 };
					} else if (text.includes('回头克·废') || text.includes('退神·废')) {
						return { result: '凶', standard: 1 };
					}
				}
			}
			
			// 第二标准：其他动爻地支五行生克
			const otherDongyao = [];
			for (let i = 0; i < 6; i++) {
				if (i !== yaoIndex && changeMarks[i]) {
					const otherDizhi = dizhi[i];
					const otherWuxing = otherDizhi.replace(/[子丑寅卯辰巳午未申酉戌亥]/g, '');
					otherDongyao.push(otherWuxing);
				}
			}
			
			if (otherDongyao.length > 0) {
				// 检查是否有其他动爻克该爻
				for (const otherWuxing of otherDongyao) {
					if ((otherWuxing === '木' && yaoWuxing === '土') ||
						(otherWuxing === '土' && yaoWuxing === '水') ||
						(otherWuxing === '水' && yaoWuxing === '火') ||
						(otherWuxing === '火' && yaoWuxing === '金') ||
						(otherWuxing === '金' && yaoWuxing === '木')) {
						return { result: '凶', standard: 2 };
					}
				}
				
				// 检查是否有其他动爻生该爻
				for (const otherWuxing of otherDongyao) {
					if ((otherWuxing === '水' && yaoWuxing === '木') ||
						(otherWuxing === '木' && yaoWuxing === '火') ||
						(otherWuxing === '火' && yaoWuxing === '土') ||
						(otherWuxing === '土' && yaoWuxing === '金') ||
						(otherWuxing === '金' && yaoWuxing === '水')) {
						return { result: '吉', standard: 2 };
					}
				}
			}
			
			// 第三标准：日辰月建数字量化
			if (dayBranch && monthBranch) {
				const monthStrength = calculateMonthStrength(monthBranch, yaoBranch);
				const dayStrength = calculateDayStrength(dayBranch, yaoBranch);
				
				if (monthStrength !== null && dayStrength !== null) {
					const total = monthStrength.value + dayStrength.value;
					if (total > 0) {
						return { result: '吉', standard: 3 };
					} else if (total < 0) {
						return { result: '凶', standard: 3 };
					}
				}
			}
			
			// 如果三个标准都无法判断，返回null
			return null;
		}
		
		// 判断用神
		function getYongshen(selectedLiuqin, liuqin, shiYing, changeMarks, dayXunKong, dizhi, dayBranch, monthBranch, lines) {
			// 如果选择的是世爻或应爻，直接返回对应位置
			if (selectedLiuqin === '世爻') {
				return shiYing.shi;
			}
			if (selectedLiuqin === '应爻') {
				return shiYing.ying;
			}
			
			// 找到本卦中属于选定六亲的所有爻
			const matchingYao = [];
			for (let i = 0; i < liuqin.length; i++) {
				if (liuqin[i] === selectedLiuqin) {
					matchingYao.push(i);
				}
			}
			
			// 如果只有一个匹配的爻，直接返回
			if (matchingYao.length === 1) {
				return matchingYao[0];
			}
			
			// 如果有多个匹配的爻，按优先级选择
			if (matchingYao.length > 1) {
				// 第一优先级：世爻
				for (let yao of matchingYao) {
					if (shiYing.shi === yao) {
						return yao;
					}
				}
				
				// 第二优先级：应爻
				for (let yao of matchingYao) {
					if (shiYing.ying === yao) {
						return yao;
					}
				}
				
				// 第三优先级：动爻
				for (let yao of matchingYao) {
					if (changeMarks[yao]) {
						return yao;
					}
				}
				
				// 第四优先级：月破、日冲、月合、日合、旬空（按顺序）
				for (let yao of matchingYao) {
					const yaoDizhi = dizhi[yao].replace(/[水火木金土]/g, '');
					
					// 检查月破（月支与爻支相冲）
					if (monthBranch) {
						const branchConflicts = {
							'子': '午', '午': '子',
							'丑': '未', '未': '丑',
							'寅': '申', '申': '寅',
							'卯': '酉', '酉': '卯',
							'辰': '戌', '戌': '辰',
							'巳': '亥', '亥': '巳'
						};
						if (branchConflicts[monthBranch] === yaoDizhi) {
							return yao;
						}
					}
					
					// 检查日冲（暗动或日破）
					if (dayBranch) {
						const daychongType = getDayChongType(yao, yaoDizhi, lines[yao], dayBranch, monthBranch, changeMarks, dizhi, dayXunKong);
						if (daychongType) {
							return yao;
						}
					}
					
					// 检查月合（月支与爻支相合）
					if (monthBranch) {
						const branchCombinations = {
							'子': '丑', '丑': '子',
							'寅': '亥', '亥': '寅',
							'卯': '戌', '戌': '卯',
							'辰': '酉', '酉': '辰',
							'巳': '申', '申': '巳',
							'午': '未', '未': '午'
						};
						if (branchCombinations[monthBranch] === yaoDizhi) {
							return yao;
						}
					}
					
					// 检查日合（日支与爻支相合）
					if (dayBranch) {
						const branchCombinations = {
							'子': '丑', '丑': '子',
							'寅': '亥', '亥': '寅',
							'卯': '戌', '戌': '卯',
							'辰': '酉', '酉': '辰',
							'巳': '申', '申': '巳',
							'午': '未', '未': '午'
						};
						if (branchCombinations[dayBranch] === yaoDizhi) {
							return yao;
						}
					}
					
					// 检查旬空
					if (dayXunKong.includes(yaoDizhi)) {
						return yao;
					}
				}
				
				// 如果都没有，返回第一个
				return matchingYao[0];
			}
			
			// 如果没有找到匹配的爻，返回特殊标识
			if (matchingYao.length === 0) {
				return 'fushen'; // 返回特殊标识，表示用神在伏神位置
			}
			
			return -1; // 没有找到匹配的爻
		}

		// 显示六爻悬浮框
		function showYaoTooltip(element, yaoIndex) {
			// 移除现有的六爻提示框
			hideYaoTooltip();
			
			const info = getYaoInfo(yaoIndex);
			if (!info) return;
			
			// 创建提示框
			const tooltip = document.createElement('div');
			tooltip.className = 'yao-tooltip';
			tooltip.id = 'yao-tooltip';
			
			// 构建提示内容
			let content = `<div class="title">${info.title}</div>`;
			content += `<div class="content">${info.content}</div>`;
			
			tooltip.innerHTML = content;
			
			// 计算位置 - 悬浮框紧贴六爻符号正上方，箭头紧靠符号
			const rect = element.getBoundingClientRect();
			tooltip.style.position = 'fixed';
			
			// 先添加到页面以获取实际尺寸
			document.body.appendChild(tooltip);
			
			// 获取tooltip的实际尺寸
			const tooltipRect = tooltip.getBoundingClientRect();
			
			// 计算位置：tooltip底部紧贴六爻符号顶部，水平居中对齐
			const elementCenterX = rect.left + rect.width / 2;
			const tooltipLeft = elementCenterX - tooltipRect.width / 2;
			const tooltipTop = rect.top - tooltipRect.height - 2; // 2px间距
			
			// 设置最终位置
			tooltip.style.left = tooltipLeft + 'px';
			tooltip.style.top = tooltipTop + 'px';
			tooltip.style.transform = 'none'; // 不使用transform，直接定位
			
			// 保存对应的爻位信息，用于重新定位
			tooltip.dataset.yaoIndex = yaoIndex;
		}
		
		// 隐藏六爻悬浮框
		function hideYaoTooltip() {
			const tooltip = document.getElementById('yao-tooltip');
			if (tooltip) {
				tooltip.remove();
			}
		}
		
		// 重新定位当前显示的六爻tooltip
		function repositionCurrentYaoTooltip() {
			const tooltip = document.getElementById('yao-tooltip');
			if (tooltip) {
				// 获取当前tooltip对应的六爻元素
				const yaoIndex = tooltip.dataset.yaoIndex;
				const element = document.querySelector('.yao-symbol[data-yao-index="' + yaoIndex + '"]');
				if (element) {
					// 重新计算位置
					const rect = element.getBoundingClientRect();
					const tooltipRect = tooltip.getBoundingClientRect();
					
					const elementCenterX = rect.left + rect.width / 2;
					const tooltipLeft = elementCenterX - tooltipRect.width / 2;
					const tooltipTop = rect.top - tooltipRect.height - 2;
					
					tooltip.style.left = tooltipLeft + 'px';
					tooltip.style.top = tooltipTop + 'px';
				}
			}
		}

		// 显示旬空隐藏信息
		function showXunkongTooltip(element) {
			// 移除现有的旬空提示框
			hideXunkongTooltip();
			
			// 创建提示框
			const tooltip = document.createElement('div');
			tooltip.className = 'xunkong-tooltip';
			tooltip.id = 'xunkong-tooltip';
			
			// 构建提示内容
			let content = `<div class="title"><span class="highlight">旬空:克、凶不到,断卦中有躲避之意,</span></div>`;
			content += `<div class="content">天干地支两两相对 空出的两个地支是旬空</div>`;
			content += `<div class="content">六爻中只看日空,看六爻有没有和日空相同的地支，对应的爻就是旬空之爻</div>`;
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			// 计算位置（显示在右方）
			const rect = element.getBoundingClientRect();
			const tooltipRect = tooltip.getBoundingClientRect();
			
			const tooltipLeft = rect.right + 2; // 在元素右侧，留2px间距
			const tooltipTop = rect.top + window.scrollY + (rect.height - tooltipRect.height) / 2; // 上下居中对齐
			
			tooltip.style.left = tooltipLeft + 'px';
			tooltip.style.top = tooltipTop + 'px';
		}
		
		// 隐藏旬空悬浮框
		function hideXunkongTooltip() {
			const tooltip = document.getElementById('xunkong-tooltip');
			if (tooltip) {
				tooltip.remove();
			}
		}
		
		// 显示吉凶判断依据
		function showJixiongTooltip(element) {
			// 移除现有的吉凶提示框
			hideJixiongTooltip();
			
			// 创建提示框
			const tooltip = document.createElement('div');
			tooltip.className = 'jixiong-tooltip';
			tooltip.id = 'jixiong-tooltip';
			
			// 获取判断标准
			const standard = parseInt(element.getAttribute('data-jixiong-standard'));
			
			// 构建提示内容
			let content = `<div class="title">判断依据：</div>`;
			content += `<div class="standard${standard === 1 ? ' highlight' : ''}">第一判断标准：以回头生、回头克、化退、化进</div>`;
			content += `<div class="standard${standard === 2 ? ' highlight' : ''}">第二判断标准：动爻生克</div>`;
			content += `<div class="standard${standard === 3 ? ' highlight' : ''}">第三判断标准：日辰月建</div>`;
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			// 计算位置（显示在右方）
			const rect = element.getBoundingClientRect();
			const tooltipRect = tooltip.getBoundingClientRect();
			
			const tooltipLeft = rect.right + 2; // 在元素右侧，留2px间距
			const tooltipTop = rect.top + window.scrollY + (rect.height - tooltipRect.height) / 2; // 上下居中对齐
			
			tooltip.style.left = tooltipLeft + 'px';
			tooltip.style.top = tooltipTop + 'px';
		}
		
		// 隐藏吉凶悬浮框
		function hideJixiongTooltip() {
			const tooltip = document.getElementById('jixiong-tooltip');
			if (tooltip) {
				tooltip.remove();
			}
		}
		
		// 重新定位当前显示的旬空tooltip
		function repositionCurrentXunkongTooltip() {
			const tooltip = document.getElementById('xunkong-tooltip');
			if (tooltip) {
				// 获取旬空标题元素
				const element = document.querySelector('.xunkong-title');
				if (element) {
					// 重新计算位置（显示在右方）
					const rect = element.getBoundingClientRect();
					const tooltipRect = tooltip.getBoundingClientRect();
					
					const tooltipLeft = rect.right + 2; // 在元素右侧，留2px间距
					const tooltipTop = rect.top + window.scrollY + (rect.height - tooltipRect.height) / 2; // 上下居中对齐
					
					tooltip.style.left = tooltipLeft + 'px';
					tooltip.style.top = tooltipTop + 'px';
				}
			}
		}

		// 显示暗动/日破/日冲隐藏信息
		function showDaychongTooltip(element, daychongType) {
			// 移除现有的暗动/日破/日冲提示框
			hideDaychongTooltip();
			
			// 创建提示框
			const tooltip = document.createElement('div');
			tooltip.className = 'daychong-tooltip';
			tooltip.id = 'daychong-tooltip';
			
			// 构建提示内容 - 始终显示完整内容
			let content = '';
			if (daychongType.startsWith('暗动')) {
				content = `<div class="title"><span class="highlight">暗动：</span>(符合以下任一条即可，作用于全部静爻）</div>`;
				
				// 根据具体条件标红
				if (daychongType === '暗动1') {
					content += `<div class="content"><span class="highlight">1. 日辰冲旺相(月建上数字量化>0)的静爻</span></div>`;
					content += `<div class="content">2. 日辰冲动爻相生的静爻(动生静)</div>`;
					content += `<div class="content">3. 日辰冲旬空的静爻</div>`;
				} else if (daychongType === '暗动2') {
					content += `<div class="content">1. 日辰冲旺相(月建上数字量化>0)的静爻</div>`;
					content += `<div class="content"><span class="highlight">2. 日辰冲动爻相生的静爻(动生静)</span></div>`;
					content += `<div class="content">3. 日辰冲旬空的静爻</div>`;
				} else if (daychongType === '暗动3') {
					content += `<div class="content">1. 日辰冲旺相(月建上数字量化>0)的静爻</div>`;
					content += `<div class="content">2. 日辰冲动爻相生的静爻(动生静)</div>`;
					content += `<div class="content"><span class="highlight">3. 日辰冲旬空的静爻</span></div>`;
				}
				
				content += `<div class="content">日破：日辰冲爻（不论静动）,非暗动即日破</div>`;
				content += `<div class="content">日冲：日支与爻支相冲都为日冲（当不属于暗动/日破时，暂且标记为日冲）</div>`;
			} else if (daychongType === '日破') {
				content = `<div class="title">暗动：(符合以下任一条即可，作用于全部静爻）</div>`;
				content += `<div class="content">1. 日辰冲旺相(月建上数字量化>0)的静爻</div>`;
				content += `<div class="content">2. 日辰冲动爻相生的静爻(动生静)</div>`;
				content += `<div class="content">3. 日辰冲旬空的静爻</div>`;
				content += `<div class="content"><span class="highlight">日破：日辰冲爻（不论静动）,非暗动即日破</span></div>`;
				content += `<div class="content">日冲：日支与爻支相冲都为日冲（当不属于暗动/日破时，暂且标记为日冲）</div>`;
			} else if (daychongType === '日冲') {
				content = `<div class="title">暗动：(符合以下任一条即可，作用于全部静爻）</div>`;
				content += `<div class="content">1. 日辰冲旺相(月建上数字量化>0)的静爻</div>`;
				content += `<div class="content">2. 日辰冲动爻相生的静爻(动生静)</div>`;
				content += `<div class="content">3. 日辰冲旬空的静爻</div>`;
				content += `<div class="content">日破：日辰冲爻（不论静动）,非暗动即日破</div>`;
				content += `<div class="content"><span class="highlight">日冲：日支与爻支相冲都为日冲（当不属于暗动/日破时，暂且标记为日冲）</span></div>`;
			}
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			// 使用智能定位
			smartPositionTooltip(element, tooltip);
		}
		
		// 隐藏暗动/日破悬浮框
		function hideDaychongTooltip() {
			const tooltip = document.getElementById('daychong-tooltip');
			if (tooltip) {
				tooltip.remove();
			}
		}
		
		// 重新定位当前显示的暗动/日破tooltip
		function repositionCurrentDaychongTooltip() {
			const tooltip = document.getElementById('daychong-tooltip');
			if (tooltip) {
				// 获取暗动/日破标记元素
				const element = document.querySelector('.daychong-mark:hover');
				if (element) {
					// 重新计算位置
					const rect = element.getBoundingClientRect();
					const tooltipRect = tooltip.getBoundingClientRect();
					
					const elementCenterX = rect.left + rect.width / 2;
					const tooltipLeft = elementCenterX - tooltipRect.width / 2;
					const tooltipTop = rect.top - tooltipRect.height - 2;
					
					tooltip.style.left = tooltipLeft + 'px';
					tooltip.style.top = tooltipTop + 'px';
				}
			}
		}

		// 显示注意事项隐藏信息
		function showNotesTooltip(element) {
			// 隐藏所有其他悬浮框
			hideAllTooltips();
			
			// 创建提示框
			const tooltip = document.createElement('div');
			tooltip.className = 'notes-tooltip';
			tooltip.id = 'notes-tooltip';
			
			// 构建提示内容
			let content = '';
			content += `<div class="content">· 从下往上记六爻；花为阳字为阴(铜钱卦)；以少为尊</div>`;
			content += `<div class="content">· 心静、心诚、只问一件事、问事要具体</div>`;
			content += `<div class="content">· 除卦理不明,不要同件事反复起卦</div>`;
			content += `<div class="content">· 不测违法、损人不利己、捕风捉影之事</div>`;
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			// 使用智能定位
			smartPositionTooltip(element, tooltip);
		}
		
		// 隐藏注意事项悬浮框
		function hideNotesTooltip() {
			const tooltip = document.getElementById('notes-tooltip');
			if (tooltip) {
				tooltip.remove();
			}
		}
		
		// 显示地支冲合隐藏信息
		function showDizhiChongheTooltip(element) {
			hideAllTooltips();
			
			const tooltip = document.createElement('div');
			tooltip.className = 'dizhi-chonghe-tooltip';
			tooltip.id = 'dizhi-chonghe-tooltip';
			
			let content = `<div class="content">六合：<span class="wuxing">子</span><span class="wuxing">丑</span>合，<span class="wuxing">寅</span><span class="wuxing">亥</span>合，<span class="wuxing">巳</span><span class="wuxing">申</span>合，<span class="wuxing">卯</span><span class="wuxing">戌</span>合，<span class="wuxing">辰</span><span class="wuxing">酉</span>合，<span class="wuxing">午</span><span class="wuxing">未</span>合</div>`;
			content += `<div class="content">六冲：<span class="wuxing">子</span><span class="wuxing">午</span>冲，<span class="wuxing">寅</span><span class="wuxing">申</span>冲，<span class="wuxing">巳</span><span class="wuxing">亥</span>冲，<span class="wuxing">卯</span><span class="wuxing">酉</span>冲，<span class="wuxing">辰</span><span class="wuxing">戌</span>冲，<span class="wuxing">丑</span><span class="wuxing">未</span>冲</div>`;
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			smartPositionTooltip(element, tooltip);
		}
		
		// 显示五行生克隐藏信息
		function showWuxingShengkeTooltip(element) {
			hideAllTooltips();
			
			const tooltip = document.createElement('div');
			tooltip.className = 'wuxing-shengke-tooltip';
			tooltip.id = 'wuxing-shengke-tooltip';
			
			let content = `<div class="content"><span class="wuxing">水</span>生<span class="wuxing">木</span>，<span class="wuxing">木</span>生<span class="wuxing">火</span>，<span class="wuxing">土</span>生<span class="wuxing">金</span>，<span class="wuxing">火</span>生<span class="wuxing">土</span>，<span class="wuxing">金</span>生<span class="wuxing">水</span></div>`;
			content += `<div class="content"><span class="wuxing">水</span>克<span class="wuxing">火</span>，<span class="wuxing">木</span>克<span class="wuxing">土</span>，<span class="wuxing">土</span>克<span class="wuxing">水</span>，<span class="wuxing">火</span>克<span class="wuxing">金</span>，<span class="wuxing">金</span>克<span class="wuxing">木</span></div>`;
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			smartPositionTooltip(element, tooltip);
		}
		
		// 显示动爻发动隐藏信息
		function showDongyaoFadongTooltip(element) {
			hideAllTooltips();
			
			const tooltip = document.createElement('div');
			tooltip.className = 'dongyao-fadong-tooltip';
			tooltip.id = 'dongyao-fadong-tooltip';
			
			let content = `<div class="content">化进化退：当动爻发动变化出的变爻与动爻地支五行相同但又不完全一样时,按十二地支顺序,前进的为进神,后退的为退神</div>`;
			content += `<div class="content">*用神化进神一般表示事物往好的方向发展,越来越强,逐渐壮大</div>`;
			content += `<div class="content">*用神化退神一般表示事物往不好的方向发展,越来越差,逐渐消退、退出</div>`;
			content += `<div class="content">例外:</div>`;
			content += `<div class="content">① 预测行人归来的卦,化进神有行人越走越远之意,化退神有退回之意</div>`;
			content += `<div class="content">② 预测复合复婚类卦,化进神是俩人距离越来越远,化退神有退回、回到身边、复合、复婚之意</div>`;
			content += `<div class="content">③预测失物、宠物丢失类卦,化进神是东西找不到了,宠物越跑越远,化退神是找回,寻回,或者自己回来的意思</div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content">反吟:动爻发动,变出与之相冲的爻,为爻化反吟。</div>`;
			content += `<div class="content">解卦:反复,事情反反复复,败而成,成而败,失而得得而失,分而合合而分,或反复多次往来于某地。</div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content">伏吟：动爻发动,变出与之完全相同的爻,为爻化伏吟。</div>`;
			content += `<div class="content">解卦:分为内卦(一二三爻)伏吟、外卦(四五六爻)伏吟、全卦伏吟</div>`;
			content += `<div class="content">① 内卦伏吟:内心忧愁、郁郁不得志、内心苦楚、闷闷不乐、担心、郁闷等</div>`;
			content += `<div class="content">② 外卦伏吟:忧心浮于表面、痛苦呻吟、以泪洗面、哭哭啼啼等</div>`;
			content += `<div class="content">③全卦伏吟:内外之象皆有</div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content">回头克：变爻克动爻</div>`;
			content += `<div class="content">*所有为动爻的用神/世爻化变爻回头克都代表自我放弃</div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content">化破：变爻月破/日破</div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content">化绝：十二长生</div>`;
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			smartPositionTooltip(element, tooltip);
		}
		
		// 显示废隐藏信息
		function showFeiTooltip(element) {
			hideAllTooltips();
			
			const tooltip = document.createElement('div');
			tooltip.className = 'fei-tooltip';
			tooltip.id = 'fei-tooltip';
			
			let content = `<div class="content">动爻变废：</div>`;
			content += `<div class="content">1.动爻发动化回头克(所有为动爻的用神/世爻化变爻回头克都代表自我放弃)</div>`;
			content += `<div class="content">2.动爻发动化退神</div>`;
			content += `<div class="content">3.动爻发动化破(日破、月破)</div>`;
			content += `<div class="content">4.动爻发动化绝(十二长生)</div>`;
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			smartPositionTooltip(element, tooltip);
		}
		
		
		// 显示动动相连隐藏信息
		function showDongdongXianglianTooltip(element) {
			hideAllTooltips();
			
			const tooltip = document.createElement('div');
			tooltip.className = 'dongdong-xianglian-tooltip';
			tooltip.id = 'dongdong-xianglian-tooltip';
			
			let content = `<div class="content">当一个卦有多个动爻(包括暗动),且动爻间存在连续的生克关系,通常动爻会优先和动爻发生作用,然后再连续向用神、世爻产生生克效果。</div>`;
			content += `<div class="content">比如：</div>`;
			content += `<div class="content"><span style="color: #ff6b6b;">动爻A</span></div>`;
			content += `<div class="content"><span style="color: #ff6b6b;">&nbsp;&nbsp;&nbsp;&nbsp;克</span></div>`;
			content += `<div class="content"><span style="color: #ff6b6b;">&nbsp;&nbsp;&nbsp;&nbsp;↓（先作用）</span></div>`;
			content += `<div class="content"><span style="color: #ff6b6b;">动爻B</span></div>`;
			content += `<div class="content"><span style="color: #ff6b6b;">&nbsp;&nbsp;&nbsp;&nbsp;克</span></div>`;
			content += `<div class="content"><span style="color: #ff6b6b;">&nbsp;&nbsp;&nbsp;&nbsp;↓（动爻B被克不再克用爻C）</span></div>`;
			content += `<div class="content"><span style="color: #ff6b6b;">用爻C</span></div>`;
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			smartPositionTooltip(element, tooltip);
		}
		
		// 显示辨吉凶隐藏信息
		function showBianjixiongTooltip(element) {
			hideAllTooltips();
			
			const tooltip = document.createElement('div');
			tooltip.className = 'bianjixiong-tooltip';
			tooltip.id = 'bianjixiong-tooltip';
			
			let content = `<div class="content"><span style="color: #ff6b6b;">a.以回头生、回头克、化退神、化进神为第一判断标准</span></div>`;
			content += `<div class="content"><span style="color: #ff6b6b;">b.以动爻生克为第二判断标准</span></div>`;
			content += `<div class="content"><span style="color: #ff6b6b;">c.以日月对爻的旺衰为第三判断标准</span></div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content">1.爻在日月总体为旺,但被动爻相克——凶</div>`;
			content += `<div class="content">2.爻在日月总体为衰,但被动爻相生——吉</div>`;
			content += `<div class="content">3.爻在日月、动爻总体为凶,但化回头生——吉</div>`;
			content += `<div class="content">4.爻在日月、动爻总体为吉,但化回头克——凶</div>`;
			content += `<div class="content">5.爻发动化回头生,但变爻逢破——吉</div>`;
			content += `<div class="content">6.爻发动化回头克,且变爻逢破——凶</div>`;
			content += `<div class="content">7.爻发动化进神,但变爻逢破——吉</div>`;
			content += `<div class="content">8.爻发动化退神,且变爻逢破——凶</div>`;
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			smartPositionTooltip(element, tooltip);
		}
		
		// 显示三合局隐藏信息
		function showSanhejuTooltip(element) {
			hideAllTooltips();
			
			const tooltip = document.createElement('div');
			tooltip.className = 'sanheju-tooltip';
			tooltip.id = 'sanheju-tooltip';
			
			let content = `<div class="content"><span style="color: #ff6b6b;">三合局：申子辰三合水局,亥卯未三合木局，巳酉丑三合金局,寅午戌三合火局(子酉午卯中神)</span></div>`;
			content += `<div class="content"></div>`;
			content += `<div class="content"><span style="color: #ff6b6b;">成局条件：</span></div>`;
			content += `<div class="content">1.三个动爻成三合局(包括暗动)</div>`;
			content += `<div class="content">2.一爻动,三爻动,连同他们的变爻组成三合局</div>`;
			content += `<div class="content">3.四爻动,六爻动,连同他们的变爻组成三合局</div>`;
			content += `<div class="content">4.两个动爻(其中一个是三合局中的中神)和日辰/月建组成三合局</div>`;
			content += `<div class="content">5.三合局中神为爻,月建日辰为另外两个地支,成三合局</div>`;
			
			tooltip.innerHTML = content;
			document.body.appendChild(tooltip);
			
			smartPositionTooltip(element, tooltip);
		}
		
		// 隐藏所有悬浮框的通用函数
		function hideAllTooltips() {
			hideNotesTooltip();
			hideLiushenTooltip();
			hideYaoTooltip();
			hideDaychongTooltip();
			hideStrengthTooltip();
			hideXunkongTooltip();
			hideSanheTooltip();
			hideDongyaoTooltip();
			hideJixiongTooltip();
			
			// 隐藏便捷查询按钮的悬浮框
			const dizhiChongheTooltip = document.getElementById('dizhi-chonghe-tooltip');
			const wuxingShengkeTooltip = document.getElementById('wuxing-shengke-tooltip');
			const dongyaoFadongTooltip = document.getElementById('dongyao-fadong-tooltip');
			const feiTooltip = document.getElementById('fei-tooltip');
			const shierChangshengTooltip = document.getElementById('shier-changsheng-tooltip');
			const dongdongXianglianTooltip = document.getElementById('dongdong-xianglian-tooltip');
			const bianjixiongTooltip = document.getElementById('bianjixiong-tooltip');
			const sanhejuTooltip = document.getElementById('sanheju-tooltip');
			
			if (dizhiChongheTooltip) dizhiChongheTooltip.remove();
			if (wuxingShengkeTooltip) wuxingShengkeTooltip.remove();
			if (dongyaoFadongTooltip) dongyaoFadongTooltip.remove();
			if (feiTooltip) feiTooltip.remove();
			if (shierChangshengTooltip) shierChangshengTooltip.remove();
			if (dongdongXianglianTooltip) dongdongXianglianTooltip.remove();
			if (bianjixiongTooltip) bianjixiongTooltip.remove();
			if (sanhejuTooltip) sanhejuTooltip.remove();
		}

		// 智能定位悬浮框
		function smartPositionTooltip(element, tooltip) {
			const rect = element.getBoundingClientRect();
			const tooltipRect = tooltip.getBoundingClientRect();
			const viewportWidth = window.innerWidth;
			const viewportHeight = window.innerHeight;
			
			let tooltipLeft, tooltipTop;
			
			// 水平定位：优先显示在右侧，如果空间不够则显示在左侧
			if (rect.right + tooltipRect.width + 10 <= viewportWidth) {
				// 显示在右侧
				tooltipLeft = rect.right + 2;
			} else if (rect.left - tooltipRect.width - 10 >= 0) {
				// 显示在左侧
				tooltipLeft = rect.left - tooltipRect.width - 2;
			} else {
				// 空间不够，居中显示
				tooltipLeft = Math.max(10, (viewportWidth - tooltipRect.width) / 2);
			}
			
			// 垂直定位：优先居中对齐，如果超出边界则调整
			const centerTop = rect.top + window.scrollY + (rect.height - tooltipRect.height) / 2;
			if (centerTop < window.scrollY + 10) {
				// 太靠上，显示在元素下方
				tooltipTop = rect.bottom + window.scrollY + 2;
			} else if (centerTop + tooltipRect.height > window.scrollY + viewportHeight - 10) {
				// 太靠下，显示在元素上方
				tooltipTop = rect.top + window.scrollY - tooltipRect.height - 2;
			} else {
				// 居中显示
				tooltipTop = centerTop;
			}
			
			// 应用定位
			tooltip.style.left = tooltipLeft + 'px';
			tooltip.style.top = tooltipTop + 'px';
		}

		// 显示六神悬浮框
		function showLiushenTooltip(element, liushenName) {
			// 移除现有的六神提示框
			hideLiushenTooltip();
			
			const info = getLiushenInfo(liushenName);
			if (!info) return;
			
			// 创建提示框
			const tooltip = document.createElement('div');
			tooltip.className = 'liushen-tooltip';
			tooltip.id = 'liushen-tooltip';
			
			// 构建提示内容
			let content = `<div class="title">${info.title}</div>`;
			content += `<div class="positive">${info.positive}</div>`;
			content += `<div class="negative">${info.negative}</div>`;
			
			tooltip.innerHTML = content;
			
			document.body.appendChild(tooltip);
			
			// 智能定位
			smartPositionTooltip(element, tooltip);
			
			// 保存对应的六神信息，用于重新定位
			tooltip.dataset.liushenName = liushenName;
		}
		
		// 隐藏六神悬浮框
		function hideLiushenTooltip() {
			const tooltip = document.getElementById('liushen-tooltip');
			if (tooltip) {
				tooltip.remove();
			}
		}
		
		// 重新定位当前显示的六神tooltip
		function repositionCurrentLiushenTooltip() {
			const tooltip = document.getElementById('liushen-tooltip');
			if (tooltip) {
				// 获取当前tooltip对应的六神元素
				const liushenName = tooltip.dataset.liushenName;
				const element = document.querySelector('.liushen-mark[data-liushen="' + liushenName + '"]');
				if (element) {
					// 智能重新定位
					smartPositionTooltip(element, tooltip);
				}
			}
		}

		// 生成卦象
		function generateGua() {
			let binary = "";
			let binaryChange = "";
			let lines = [];
			let changeMarks = [];

			for(let i=6;i>=1;i--){
				const val = document.getElementById("line"+i).value;
				lines.push(val);
				const bin = yaoToBinary(val);
				binary += bin;
				const changed = getChangeLine(val);
				changeMarks.push(changed);
				const newYao = getYaoChange(val);
				binaryChange += yaoToBinary(newYao);
			}

			const guaName = gua64[binary] || "未知卦";
			const guaChangeName = gua64[binaryChange] || "未知卦";

		// 64卦正确序号映射表（按照《周易》传统顺序）
		const gua64Order = {
			"111111": 1,   // 乾为天
			"000000": 2,   // 坤为地
			"010001": 3,   // 水雷屯
			"100010": 4,   // 山水蒙
			"010111": 5,   // 水天需
			"111010": 6,   // 天水讼
			"000010": 7,   // 地水师
			"010000": 8,   // 水地比
			"110111": 9,   // 风天小畜
			"111011": 10,  // 天泽履
			"000111": 11,  // 地天泰
			"111000": 12,  // 天地否
			"111101": 13,  // 天火同人
			"101111": 14,  // 火天大有
			"000100": 15,  // 地山谦
			"001000": 16,  // 雷地豫
			"011001": 17,  // 泽雷随
			"100110": 18,  // 山风蛊
			"000011": 19,  // 地泽临
			"110000": 20,  // 风地观
			"101001": 21,  // 火雷噬嗑
			"100101": 22,  // 山火贲
			"100000": 23,  // 山地剥
			"000001": 24,  // 地雷复
			"111001": 25,  // 天雷无妄
			"100111": 26,  // 山天大畜
			"100001": 27,  // 山雷颐
			"011110": 28,  // 泽风大过
			"010010": 29,  // 坎为水
			"101101": 30,  // 离为火
			"011100": 31,  // 泽山咸
			"001110": 32,  // 雷风恒
			"111100": 33,  // 天山遯
			"001111": 34,  // 雷天大壮
			"101000": 35,  // 火地晋
			"000101": 36,  // 地火明夷
			"110101": 37,  // 风火家人
			"101011": 38,  // 火泽睽
			"010100": 39,  // 水山蹇
			"001010": 40,  // 雷水解
			"100011": 41,  // 山泽损
			"110001": 42,  // 风雷益
			"011111": 43,  // 泽天夬
			"111110": 44,  // 天风姤
			"011000": 45,  // 泽地萃
			"000110": 46,  // 地风升
			"011010": 47,  // 泽水困
			"010110": 48,  // 水风井
			"011101": 49,  // 泽火革
			"101110": 50,  // 火风鼎
			"001001": 51,  // 震为雷
			"100100": 52,  // 艮为山
			"110100": 53,  // 风山渐
			"001011": 54,  // 雷泽归妹
			"001101": 55,  // 雷火丰
			"101100": 56,  // 火山旅
			"110110": 57,  // 巽为风
			"011011": 58,  // 兑为泽
			"110010": 59,  // 风水涣
			"010011": 60,  // 水泽节
			"110011": 61,  // 风泽中孚
			"001100": 62,  // 雷山小过
			"010101": 63,  // 水火既济
			"101010": 64   // 火水未济
		};

		// 获取卦的序号（按照《周易》传统顺序）
		const guaIndex = gua64Order[binary] || 0;
		const guaChangeIndex = gua64Order[binaryChange] || 0;

			let html = "<div class='gua-container'>";
			html += "<div class='gua-sections-row'>";
			
			// 本卦部分
			html += "<div class='ben-gua-container'>";
			html += "<div class='gua-header' style='text-align: center; margin-bottom: 10px;'>";
			html += "<span class='gua-label'>本卦·</span><span class='gua-name'>" + guaName + "</span><span class='gua-label'>第" + toChineseNum(guaIndex) + "</span>";
			html += "</div>";
			html += "<div style='font-size: 6px; color: #999; text-align: center; margin-bottom: 20px;'>" + getGuaInfo(binary) + "</div>";
			html += "<div class='gua-section'>";
			
			const shiYing = getShiYing(binary);
			const dizhi = getDizhi(binary);
			const tiangan = getTiangan(binary);
			const liuqin = getLiuqin(binary, dizhi);
			// 获取伏神信息
			const fushen = getFushen(binary, liuqin);
			console.log('伏神信息:', fushen); // 调试信息
			// 获取当前时间的日干来计算六神
			const currentTime = getCurrentTime();
			let dayTgIndex = 0; // 默认值
			let monthBranch = '';
			let dayBranch = '';
			let dayXunKong = []; // 日空地支
			if (currentTime && !currentTime.partial) {
				const dayGZ = getGanZhiDay(currentTime);
				const monthGZ = getGanZhiMonth(currentTime, getGanZhiYear(currentTime).tgIndex);
				dayTgIndex = dayGZ.tgIndex;
				monthBranch = branches[monthGZ.dzIndex];
				dayBranch = branches[dayGZ.dzIndex];
				dayXunKong = getXunKong(dayGZ); // 获取日空地支
			}
			const liushen = getLiushen(dayTgIndex);
			
			// 获取三合局信息
			const dizhiArray = dizhi.map(d => d.replace(/[水火木金土]/g, '')); // 提取纯地支字符
			const dizhiChangeArray = getDizhi(binaryChange).map(d => d.replace(/[水火木金土]/g, '')); // 变卦地支（纯地支，用于三合局）
			const dizhiChangeFull = getDizhi(binaryChange); // 变卦地支（完整，包含五行，用于动爻发动信息）
			const daychongMarks = [];
			for(let i = 0; i < 6; i++) {
				const yaoDizhi = dizhiArray[i];
				if (dayBranch) {
					const daychongType = getDayChongType(i, yaoDizhi, lines[i], dayBranch, monthBranch, changeMarks, dizhi, dayXunKong);
					daychongMarks.push(daychongType);
				} else {
					daychongMarks.push(null);
				}
			}
			const allSanheJu = getAllSanheJu(dizhiArray, changeMarks, daychongMarks, dizhiChangeArray, dayBranch, monthBranch);
			// 设置为全局变量，供其他函数使用
			window.allSanheJu = allSanheJu;
			
			// 获取用户选择的用神
			const selectedYongshen = document.getElementById('yongshenText').value.trim();
			// 判断用神位置
			const yongshenIndex = getYongshen(selectedYongshen, liuqin, shiYing, changeMarks, dayXunKong, dizhi, dayBranch, monthBranch, lines);
			for(let i=0;i<=5;i++){
				const yaoSymbol = lines[i].replace(/少阳|少阴|老阳|老阴|O|X/g, '').trim();
				let shiYingMark = '';
				if (shiYing.shi === i) {
					shiYingMark = '<span class="shi-ying-mark">世</span>';
				} else if (shiYing.ying === i) {
					shiYingMark = '<span class="shi-ying-mark">应</span>';
				}
				
				// 添加六神标记（最左侧）【排盘内容-六神】
				const liushenText = liushen[i];
				const liushenMark = '<span class="liushen-mark liushen-mark-left" data-liushen="' + liushenText + '">' + liushenText + '</span>';
				
				// 添加旬空标记（六神左侧）【解卦内容-旬空】
				let xunkongMark = '';
				const yaoDizhi = dizhi[i].replace(/[水火木金土]/g, ''); // 提取纯地支字符
				if (dayXunKong.includes(yaoDizhi)) {
					xunkongMark = '<span class="xunkong-mark xunkong-mark-left">空</span>';
				}
				
				// 添加吉凶标记（用神标记左侧）【解卦内容-吉凶】
				let jixiongMark = '';
				const jixiongResult = getJixiong(i, changeMarks, dizhi, dizhiChangeFull, dayBranch, monthBranch);
				if (jixiongResult) {
					jixiongMark = '<span class="jixiong-mark jixiong-mark-left" data-jixiong-result="' + jixiongResult.result + '" data-jixiong-standard="' + jixiongResult.standard + '">' + jixiongResult.result + '</span>';
				}
				
				// 添加用神标记（日辰冲爻左侧）【解卦内容-用神】
				let yongshenMark = '';
				if (yongshenIndex === 'fushen') {
					// 用神在伏神位置，不在这里显示
				} else if (yongshenIndex === i) {
					yongshenMark = '<span class="yongshen-mark yongshen-mark-left">用</span>';
				}
				
				// 添加日辰冲爻标记（旬空左侧）【解卦内容-暗动/日破】
				let daychongMark = '';
				if (dayBranch) {
					const daychongType = getDayChongType(i, yaoDizhi, lines[i], dayBranch, monthBranch, changeMarks, dizhi, dayXunKong);
					if (daychongType) {
						const displayText = daychongType.startsWith('暗动') ? '暗动' : daychongType;
						daychongMark = '<span class="daychong-mark daychong-mark-left" data-daychong-type="' + daychongType + '">' + displayText + '</span>';
					}
				}
				
				// 添加六亲标记（左侧）【排盘内容-六亲】
				const liuqinText = liuqin[i];
				const liuqinMark = '<span class="liuqin-mark liuqin-mark-left">' + liuqinText + '</span>';
				
				// 添加地支标记（左侧）【排盘内容-地支】
				const dizhiText = dizhi[i];
				const dizhiColorClass = getDizhiColorClass(dizhiText);
				
				// 检查当前地支是否参与三合局【解卦内容-三合局】
				const currentDizhi = dizhiArray[i];
				let sanheMark = '';
				let sanheInfo = null;
				let allParticipatingSanhe = []; // 收集当前爻参与的所有三合局
				
				// 查找当前地支参与的三合局（只标记实际参与的地支）
				for (const sanhe of allSanheJu) {
					// 情况一：三个动爻组成三合局，检查当前爻是否在参与索引中
					if (sanhe.case === 1) {
						if (sanhe.participatingIndexes && sanhe.participatingIndexes.includes(i)) {
							allParticipatingSanhe.push(sanhe);
						}
					}
					// 情况二：初爻+三爻+变爻组成三合局
					else if (sanhe.case === 2 && (i === 5 || i === 3)) {
						// 情况二：初爻和三爻一定参与
						allParticipatingSanhe.push(sanhe);
					}
					// 情况三：四爻+上爻+变爻组成三合局
					else if (sanhe.case === 3 && (i === 2 || i === 0)) {
						// 情况三：四爻和上爻一定参与
						allParticipatingSanhe.push(sanhe);
					}
											// 情况四：动爻+动爻+日/月支组成三合局
						else if (sanhe.case === 4) {
							// 检查当前爻是否是动爻且参与情况四（不包括暗动爻）
							// 只有参与三合局的动爻才标记
							if (changeMarks[i] && sanhe.participatingIndexes && sanhe.participatingIndexes.includes(i)) {
								allParticipatingSanhe.push(sanhe);
							}
						}
					// 情况五：日支+月支+爻支组成三合局
					else if (sanhe.case === 5) {
						// 情况五：只有参与三合局的爻才标记
						if (sanhe.participatingIndexes && sanhe.participatingIndexes.includes(i)) {
							allParticipatingSanhe.push(sanhe);
						}
					}
				}
				
				// 如果有参与的三合局，使用第一个作为主要标记，但保存所有信息
				if (allParticipatingSanhe.length > 0) {
					sanheInfo = allParticipatingSanhe[0];
					// 将所有参与的三合局信息合并到一个对象中
					const combinedSanheInfo = {
						...sanheInfo,
						allParticipatingCases: allParticipatingSanhe.map(s => s.case)
					};
					sanheMark = `<div class="sanhe-mark sanhe-${sanheInfo.wuxing}" data-sanhe-info='${JSON.stringify(combinedSanheInfo)}' style="position: absolute; left: 40%; bottom: 5px;"></div>`;
				}
				
				const dizhiMark = '<span class="dizhi-mark dizhi-mark-left ' + dizhiColorClass + '">' + dizhiText + '</span>';
				
				// 添加天干标记（本卦地支右侧，卦象左侧）【排盘内容-天干】
				const tianganText = tiangan[i];
				const tianganMark = '<span class="tiangan-mark tiangan-mark-right">' + tianganText + '</span>';
				
				// 添加数字量化信息（仅在本卦的六爻和变卦的变爻显示）【解卦内容-日辰数字量化、月建数字量化】
				let monthStrengthMark = '';
				let dayStrengthMark = '';
				if (monthBranch && dayBranch) {
					// 提取地支字符（去掉五行）
					const yaoBranch = dizhiText.replace(/[水火木金土]/g, '');
					
					// 计算月建和日辰数字量化
					const monthStrength = calculateMonthStrength(monthBranch, yaoBranch);
					const dayStrength = calculateDayStrength(dayBranch, yaoBranch);
					
					// 只有当计算结果不为null时才显示
					if (monthStrength !== null) {
						const monthValue = monthStrength.value >= 0 ? '+' + monthStrength.value : monthStrength.value.toString();
						// 检查是否为月破（月支与爻支相冲）
						const branchConflicts = {
							'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
							'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
						};
						const isMonthPo = (branchConflicts[monthBranch] === yaoBranch) || (branchConflicts[yaoBranch] === monthBranch);
						const monthColor = isMonthPo ? 'color: #DC143C;' : '';
						monthStrengthMark = '<span class="strength-info month-strength" style="' + monthColor + '" data-type="month" data-value="' + monthStrength.value + '" data-description="' + monthStrength.description + '">' + monthValue + '</span>';
					}
					
					if (dayStrength !== null) {
						const dayValue = dayStrength.value >= 0 ? '+' + dayStrength.value : dayStrength.value.toString();
						// 检查是否为日辰冲爻（日支与爻支相冲）
						const branchConflicts = {
							'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
							'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
						};
						const isDayChong = (branchConflicts[dayBranch] === yaoBranch) || (branchConflicts[yaoBranch] === dayBranch);
						const dayColor = isDayChong ? 'color: #DC143C;' : '';
						dayStrengthMark = '<span class="strength-info day-strength" style="' + dayColor + '" data-type="day" data-value="' + dayStrength.value + '" data-description="' + dayStrength.description + '">' + dayValue + '</span>';
					}
				}
				
				// 添加动爻发动信息标记（日辰数字量化右侧）【解卦内容-动爻发动信息】
				let dongyaoMark = '';
				if (changeMarks[i]) {
					console.log('第' + i + '爻是动爻，调用getDongyaoInfo');
					const dongyaoInfo = getDongyaoInfo(i, dizhiText, changeMarks, dizhi, dizhiChangeFull, dayBranch, monthBranch);
					console.log('getDongyaoInfo返回结果:', dongyaoInfo);
					if (dongyaoInfo) {
						// 获取变爻地支信息（去掉五行）
						const changeDizhi = dizhiChangeFull[i].replace(/[水火木金土]/g, '');
						dongyaoMark = '<span class="dongyao-mark dongyao-mark-right" data-dongyao-type="' + dongyaoInfo.type + '" data-dongyao-text="' + dongyaoInfo.text.replace(/<[^>]*>/g, '') + '" data-change-dizhi="' + changeDizhi + '">' + dongyaoInfo.text + '</span>';
						console.log('生成的dongyaoMark:', dongyaoMark);
					}
				}
				
				// 添加伏神标注（在地支下方）【排盘内容-伏神】
				let fushenMark = '';
				if (fushen && fushen.position && fushen.position.yaoIndex === i) {
					// 为伏神计算数字量化信息【解卦内容-日辰数字量化、月建数字量化】
					let fushenStrengthInfo = '';
					if (monthBranch && dayBranch) {
						// 提取伏神地支字符（去掉五行）
						const fushenBranch = fushen.position.dizhi.replace(/[水火木金土]/g, '');
						
						// 计算伏神的月建和日辰数字量化
						const fushenMonthStrength = calculateMonthStrength(monthBranch, fushenBranch);
						const fushenDayStrength = calculateDayStrength(dayBranch, fushenBranch);
						
						// 只有当计算结果不为null时才显示
						if (fushenMonthStrength !== null || fushenDayStrength !== null) {
							let fushenValues = [];
							if (fushenMonthStrength !== null) {
								const fushenMonthValue = fushenMonthStrength.value >= 0 ? '+' + fushenMonthStrength.value : fushenMonthStrength.value.toString();
								// 检查伏神是否为月破（月支与伏神地支相冲）
								const branchConflicts = {
									'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
									'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
								};
								const isFushenMonthPo = (branchConflicts[monthBranch] === fushenBranch) || (branchConflicts[fushenBranch] === monthBranch);
								const fushenMonthColor = isFushenMonthPo ? 'color: #DC143C;' : 'color: #333;';
								fushenValues.push('<span class="strength-info" style="' + fushenMonthColor + ' font-size: 6px; cursor: pointer; display: inline-block; margin-right: 8px; vertical-align: middle;" data-type="month" data-value="' + fushenMonthStrength.value + '" data-description="' + fushenMonthStrength.description + '">' + fushenMonthValue + '</span>');
							}
							if (fushenDayStrength !== null) {
								const fushenDayValue = fushenDayStrength.value >= 0 ? '+' + fushenDayStrength.value : fushenDayStrength.value.toString();
								// 检查伏神是否为日辰冲爻（日支与伏神地支相冲）
								const branchConflicts = {
									'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
									'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
								};
								const isFushenDayChong = (branchConflicts[dayBranch] === fushenBranch) || (branchConflicts[fushenBranch] === dayBranch);
								const fushenDayColor = isFushenDayChong ? 'color: #DC143C;' : 'color: #333;';
								fushenValues.push('<span class="strength-info" style="' + fushenDayColor + ' font-size: 6px; cursor: pointer; display: inline-block; margin-left: 10px; vertical-align: middle;" data-type="day" data-value="' + fushenDayStrength.value + '" data-description="' + fushenDayStrength.description + '">' + fushenDayValue + '</span>');
							}
							if (fushenValues.length > 0) {
								fushenStrengthInfo = '<span style="margin-left: 5px; display: inline-block; vertical-align: middle; line-height: 1;">' + fushenValues.join('&nbsp;&nbsp;') + '</span>';
							}
						}
					}
					
					// 为伏神地支添加五行颜色
					const fushenDizhiColorClass = getDizhiColorClass(fushen.position.dizhi);
					
					// 添加用神标记（如果用神在伏神位置）【解卦内容-用神】
					let yongshenMark = '';
					if (yongshenIndex === 'fushen') {
						yongshenMark = '<span style="color: red; font-size: 6px; position: absolute; left: 15%; transform: translateX(-50%); top: 100%; display: flex; align-items: center;">用</span>';
					}
					
					fushenMark = '<span style="color: red; font-size: 6px; position: absolute; left: 30%; transform: translateX(-50%); top: 100%; display: flex; align-items: center;">伏神 ' + fushen.liuqin + ' <span class="' + fushenDizhiColorClass + '">' + fushen.position.dizhi + '</span>' + fushenStrengthInfo + '</span>' + yongshenMark;
				}
				
				// 为六爻符号添加点击事件和数据属性
				const yaoSymbolWithClick = "<span class='yao-symbol' data-yao-index='" + i + "'>" + (changeMarks[i] ? "<span class='change'>" + yaoSymbol + "</span>" : yaoSymbol) + "</span>";
				console.log('第' + i + '爻的dongyaoMark值:', dongyaoMark);
				html += "<div class='line' style='position: relative;'>" + jixiongMark + yongshenMark + daychongMark + xunkongMark + liushenMark + liuqinMark + dizhiMark + tianganMark + "<span style='margin-left: 45px;'>" + yaoSymbolWithClick + "</span>" + shiYingMark + monthStrengthMark + dayStrengthMark + dongyaoMark + fushenMark + sanheMark + "</div>";
			}
			html += "</div>";
			html += "</div>";
			
			// 检查是否有变爻
			const hasChange = changeMarks.some(change => change);
			
			// 如果有变爻才显示变卦部分
			if (hasChange) {
				html += "<div class='bian-gua-container'>";
				html += "<div class='gua-header' style='text-align: center; margin-bottom: 10px;'>";
				html += "<span class='gua-label'>变卦·</span><span class='gua-name'>" + guaChangeName + "</span><span class='gua-label'>第" + toChineseNum(guaChangeIndex) + "</span>";
				html += "</div>";
				html += "<div style='font-size: 6px; color: #999; text-align: center; margin-bottom: 20px;'>" + getGuaInfo(binaryChange) + "</div>";
				html += "<div class='gua-section'>";
				const dizhiChange = getDizhi(binaryChange);
				const tianganChange = getTiangan(binaryChange);
				const liuqinChange = getLiuqin(binaryChange, dizhiChange);
				for(let i=0;i<=5;i++){
					const changedYao = getYaoChange(lines[i]);
					const yaoSymbol = changedYao.replace(/少阳|少阴|老阳|老阴|O|X/g, '').trim();
					
					// 添加变卦天干标记（左侧）【排盘内容-天干】
					const tianganText = tianganChange[i];
					const tianganMark = '<span class="tiangan-mark tiangan-mark-change-left">' + tianganText + '</span>';
					
					// 添加变卦地支标记（右侧）【排盘内容-地支】
					const dizhiText = dizhiChange[i];
					const dizhiColorClass = getDizhiColorClass(dizhiText);
					
					// 检查变卦地支是否参与三合局（仅对变爻）【解卦内容-三合局】
					let sanheMarkChange = '';
					if (changeMarks[i]) {
						const currentDizhiChange = dizhiText.replace(/[水火木金土]/g, '');
						let allParticipatingSanheChange = []; // 收集当前变爻参与的所有三合局
						
						// 查找当前变卦地支参与的三合局
						for (const sanhe of allSanheJu) {
							// 检查当前变爻是否实际参与了这个三合局组合
							if (sanhe.dizhi.includes(currentDizhiChange)) {
								// 情况二：初爻+三爻+变爻组成三合局
								if (sanhe.case === 2) {
									// 本卦初爻和本卦三爻必须都是变爻
									if (changeMarks[5] && changeMarks[3]) {
										// 仅当当前变爻索引在返回的changedIndexes中时标记
										if (Array.isArray(sanhe.changedIndexes) && sanhe.changedIndexes.includes(i)) {
											allParticipatingSanheChange.push(sanhe);
										}
									}
								}
								// 情况三：四爻+上爻+变爻组成三合局
								else if (sanhe.case === 3) {
									// 本卦四爻和本卦上爻必须都是变爻
									if (changeMarks[2] && changeMarks[0]) {
										// 仅当当前变爻索引在返回的changedIndexes中时标记
										if (Array.isArray(sanhe.changedIndexes) && sanhe.changedIndexes.includes(i)) {
											allParticipatingSanheChange.push(sanhe);
										}
									}
								}
								// 情况五：日支+月支+爻支组成三合局，变卦中也可能参与
								else if (sanhe.case === 5) {
									// 检查当前变爻是否真的参与了这个三合局
									if (sanhe.participatingIndexes && sanhe.participatingIndexes.includes(i)) {
										allParticipatingSanheChange.push(sanhe);
									}
								}
								// 注意：情况一（三个动爻组成三合局）只在本卦中，变卦不会有情况一
								// 情况四（动爻+动爻+日/月支）只在本卦中，变卦不会有情况四
							}
						}
						
						// 如果有参与的三合局，使用第一个作为主要标记，但保存所有信息
						if (allParticipatingSanheChange.length > 0) {
							const firstSanhe = allParticipatingSanheChange[0];
							// 将所有参与的三合局信息合并到一个对象中
							const combinedSanheInfo = {
								...firstSanhe,
								allParticipatingCases: allParticipatingSanheChange.map(s => s.case)
							};
							sanheMarkChange = `<div class="sanhe-mark sanhe-${firstSanhe.wuxing}" data-sanhe-info='${JSON.stringify(combinedSanheInfo)}' style="position: absolute; left: 44%; bottom: 5px;"></div>`;
						}
					}
					
					const dizhiMark = '<span class="dizhi-mark dizhi-mark-right ' + dizhiColorClass + '">' + dizhiText + '</span>';
					
					// 添加变卦六亲标记（最右侧）【排盘内容-六亲】
					
					const liuqinText = liuqinChange[i];
					const liuqinMark = '<span class="liuqin-mark liuqin-mark-right">' + liuqinText + '</span>';
					
					// 添加变卦旬空标记（六神右侧，仅对变爻显示）【解卦内容-旬空】
					let xunkongMarkChange = '';
					if (changeMarks[i]) { // 只对变爻显示旬空
						const yaoDizhiChange = dizhiText.replace(/[水火木金土]/g, ''); // 提取纯地支字符
						if (dayXunKong.includes(yaoDizhiChange)) {
							xunkongMarkChange = '<span class="xunkong-mark xunkong-mark-right">空</span>';
						}
					}
					
					// 添加变卦日辰冲爻标记（旬空右侧，仅对变爻显示）【解卦内容-暗动/日破】
					let daychongMarkChange = '';
					if (changeMarks[i] && dayBranch) { // 只对变爻显示日辰冲爻
						const yaoDizhiChange = dizhiText.replace(/[水火木金土]/g, ''); // 提取纯地支字符
						// 变爻不应该被日辰冲（既不是暗动也不是日破）
						// 因为大前提是：只有静爻才能被日辰冲
					}
					
					// 添加变卦数字量化信息（仅对变爻显示）【解卦内容-日辰数字量化、月建数字量化】
					let monthStrengthMark = '';
					let dayStrengthMark = '';
					if (changeMarks[i] && monthBranch && dayBranch) {
						// 提取地支字符（去掉五行）
						const yaoBranch = dizhiText.replace(/[水火木金土]/g, '');
						
						// 计算月建和日辰数字量化
						const monthStrength = calculateMonthStrength(monthBranch, yaoBranch);
						const dayStrength = calculateDayStrength(dayBranch, yaoBranch);
						
						// 只有当计算结果不为null时才显示
						if (monthStrength !== null) {
							const monthValue = monthStrength.value >= 0 ? '+' + monthStrength.value : monthStrength.value.toString();
							// 检查变卦是否为月破（月支与变卦地支相冲）
							const branchConflicts = {
								'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
								'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
							};
							const isChangeMonthPo = (branchConflicts[monthBranch] === yaoBranch) || (branchConflicts[yaoBranch] === monthBranch);
							const changeMonthColor = isChangeMonthPo ? 'color: #DC143C;' : '';
							monthStrengthMark = '<span class="strength-info" style="left: 10%; top: 60%; transform: translateY(-50%); ' + changeMonthColor + '" data-type="month" data-value="' + monthStrength.value + '" data-description="' + monthStrength.description + '">' + monthValue + '</span>';
						}
						
						if (dayStrength !== null) {
							const dayValue = dayStrength.value >= 0 ? '+' + dayStrength.value : dayStrength.value.toString();
							// 检查变卦是否为日辰冲爻（日支与变卦地支相冲）
							const branchConflicts = {
								'子': '午', '丑': '未', '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥',
								'午': '子', '未': '丑', '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳'
							};
							const isChangeDayChong = (branchConflicts[dayBranch] === yaoBranch) || (branchConflicts[yaoBranch] === dayBranch);
							const changeDayColor = isChangeDayChong ? 'color: #DC143C;' : '';
							dayStrengthMark = '<span class="strength-info" style="left: 0%; top: 60%; transform: translateY(-50%); ' + changeDayColor + '" data-type="day" data-value="' + dayStrength.value + '" data-description="' + dayStrength.description + '">' + dayValue + '</span>';
						}
					}
					
					// 为变卦六爻符号添加点击事件和数据属性
					const yaoSymbolChangeWithClick = "<span class='yao-symbol' data-yao-index='" + i + "'>" + yaoSymbol + "</span>";
					html += "<div class='line' style='position: relative;'>" + monthStrengthMark + dayStrengthMark + tianganMark + "<span style='margin-left: -82px;'>" + yaoSymbolChangeWithClick + "</span>" + dizhiMark + liuqinMark + xunkongMarkChange + daychongMarkChange + sanheMarkChange + "</div>";
				}
				html += "</div>";
				html += "</div>";
			}
			
			html += "</div>";
			html += "</div>";

			// 隐藏选择区域和按钮
			document.getElementById("yaoInputs").style.display = "none";
			document.getElementById("generateGuaBtn").style.display = "none";
			
			// 添加断卦笔记
			html += "<div class='duangua-notes'>";
			html += "<h3>断卦笔记</h3>";
			html += "<textarea class='duangua-input' id='duanguaInput' placeholder='请输入您的断卦笔记...' oninput='this.style.height = this.scrollHeight + \"px\"'></textarea>";
			html += "<div class='duangua-steps'>";
			html += "<div class='step-title'>断卦步骤<span class='duangua-toggle' id='duanguaToggle' onclick='toggleDuanguaSteps()'></span></div>";
			html += "<div class='duangua-steps-content' id='duanguaStepsContent'>";
			html += "<div class='step'>";
			html += "<div class='step-title'>1.取用神</div>";
			html += "<div class='step-content'>*优先取世爻、应爻为用神(应爻是对方 世爻是我)，再取动爻为用神<br>*最后取有特殊现象的爻为用神——神兆机与动(月破、日冲、月合、日合、旬空......)</div>";
			html += "</div>";
			html += "<div class='step'>";
			html += "<div class='step-title'>2.辨旺衰</div>";
			html += "<div class='step-content'>*看用神和世爻在日辰月建上的数字量化<br>*动摇、变爻有特殊需要再看,一般不看</div>";
			html += "</div>";
			html += "<div class='step'>";
			html += "<div class='step-title'>3.找特殊爻</div>";
			html += "<div class='step-content'>月破、日冲(日破、暗动属于日冲)、旬空</div>";
			html += "</div>";
			html += "<div class='step'>";
			html += "<div class='step-title'>4.看动爻发动</div>";
			html += "<div class='step-content'>*看动爻对用神/世爻的生克冲合关系，以及动爻本身的变化趋势(化进、化退、化回头生、化回头克)<br>*<span class='highlight'>动爻的吉凶权重比日月要高</span><br>*<span class='highlight'>所有为动爻的用神/世爻化变爻回头克都代表自我放弃</span></div>";
			html += "</div>";
			html += "<div class='step'>";
			html += "<div class='step-title'>5.断吉凶</div>";
			html += "</div>";
			html += "</div>";
			html += "</div>";
			html += "</div>";
			// 添加重新排盘和保存记录按钮
			html += "<div style='text-align: center; margin-top: -45px; display: flex; justify-content: center; gap: 12px;'>";
			html += "<button id='resetBtn' style='padding: 8px 16px; font-size: 14px; background-color: #000000; color: white; border: none; border-radius: 4px; cursor: pointer; text-align: center; min-width: 100px;'>重新排盘</button>";
			html += "<button id='saveRecordBtn' style='padding: 8px 16px; font-size: 14px; background-color: #000000; color: white; border: none; border-radius: 4px; cursor: pointer; text-align: center; min-width: 100px;'>保存记录</button>";
			html += "</div>";

			document.getElementById("guaResult").innerHTML = html;
			
			// 初始化断卦笔记
			setTimeout(() => {
				initDuanguaNotes();
			}, 50);
			
			
			// 触发排盘完成事件
			document.dispatchEvent(new CustomEvent('paipanCompleted'));
			
			// 绑定数字量化信息点击事件
			setTimeout(() => {
				const strengthElements = document.querySelectorAll('.strength-info');
				strengthElements.forEach(element => {
					element.addEventListener('click', function(e) {
						e.stopPropagation();
						// 隐藏其他所有悬浮框
						hideXunkongTooltip();
						hideLiushenTooltip();
						hideYaoTooltip();
						hideDaychongTooltip();
						hideSanheTooltip();
						
						showStrengthTooltip(this);
					});
				});
				
				// 点击其他位置隐藏提示框
				document.addEventListener('click', function(e) {
					// 如果点击的是六神标记、六爻符号、旬空标题、暗动/日破标注、三合局标记、注意事项标题、动爻发动信息标记、吉凶标记或五个小字标记，不隐藏悬浮框
					if (e.target.classList.contains('liushen-mark') || e.target.classList.contains('yao-symbol') || e.target.classList.contains('xunkong-title') || e.target.classList.contains('daychong-mark') || e.target.classList.contains('sanhe-mark') || e.target.classList.contains('notes-title') || e.target.classList.contains('dongyao-mark') || e.target.classList.contains('jixiong-mark') || e.target.classList.contains('dizhi-chonghe-title') || e.target.classList.contains('wuxing-shengke-title') || e.target.classList.contains('dongyao-fadong-title') || e.target.classList.contains('fei-title') || e.target.classList.contains('shier-changsheng-title')) {
						return;
					}
					hideStrengthTooltip();
					hideLiushenTooltip();
					hideYaoTooltip();
					hideXunkongTooltip();
					hideDaychongTooltip();
					hideSanheTooltip();
					hideNotesTooltip();
					hideDongyaoTooltip();
					hideAllTooltips(); // 隐藏五个新标记的悬浮框
				});
				
				// 窗口大小改变时重新定位tooltip
				window.addEventListener('resize', function() {
					repositionCurrentTooltip();
					repositionCurrentLiushenTooltip();
					repositionCurrentYaoTooltip();
					repositionCurrentXunkongTooltip();
					repositionCurrentDaychongTooltip();
					repositionCurrentDongyaoTooltip();
					// 三合局悬浮框不需要重新定位，因为它是相对于点击元素定位的
				});
				
				// 重新绑定动动相连点击事件
				document.addEventListener('click', function(e) {
					if (e.target.classList.contains('dongdong-xianglian-title')) {
						showDongdongXianglianTooltip(e.target);
					}
				});
				
				// 重新绑定辨吉凶点击事件
				document.addEventListener('click', function(e) {
					if (e.target.classList.contains('bianjixiong-title')) {
						showBianjixiongTooltip(e.target);
					}
				});
				
				// 重新绑定三合局点击事件
				document.addEventListener('click', function(e) {
					if (e.target.classList.contains('sanheju-title')) {
						showSanhejuTooltip(e.target);
					}
				});
				

				
				// 添加六神点击事件委托
				document.addEventListener('click', function(e) {
					if (e.target.classList.contains('liushen-mark')) {
						// 隐藏其他所有悬浮框
						hideXunkongTooltip();
						hideYaoTooltip();
						hideDaychongTooltip();
						hideStrengthTooltip();
						hideSanheTooltip();
						hideDongyaoTooltip();
						
						const liushenName = e.target.getAttribute('data-liushen');
						if (liushenName) {
							showLiushenTooltip(e.target, liushenName);
						}
					}
				});
				
				// 添加暗动/日破标注点击事件委托
				document.addEventListener('click', function(e) {
					if (e.target.classList.contains('daychong-mark')) {
						// 隐藏其他所有悬浮框
						hideXunkongTooltip();
						hideLiushenTooltip();
						hideYaoTooltip();
						hideStrengthTooltip();
						hideSanheTooltip();
						hideDongyaoTooltip();
						
						const daychongType = e.target.getAttribute('data-daychong-type');
						if (daychongType) {
							showDaychongTooltip(e.target, daychongType);
						}
					}
				});
				
				// 添加三合局标记点击事件委托
				document.addEventListener('click', function(e) {
					if (e.target.classList.contains('sanhe-mark')) {
						// 隐藏其他所有悬浮框
						hideXunkongTooltip();
						hideLiushenTooltip();
						hideYaoTooltip();
						hideDaychongTooltip();
						hideStrengthTooltip();
						hideDongyaoTooltip();
						
						const sanheInfo = e.target.getAttribute('data-sanhe-info');
						if (sanheInfo) {
							try {
								const sanhe = JSON.parse(sanheInfo);
								showSanheTooltip(e.target, sanhe);
							} catch (error) {
								console.error('解析三合局信息失败:', error);
							}
						}
					}
				});
				
				// 添加动爻发动信息标记点击事件委托
				document.addEventListener('click', function(e) {
					if (e.target.classList.contains('dongyao-mark')) {
						// 隐藏其他所有悬浮框
						hideXunkongTooltip();
						hideLiushenTooltip();
						hideYaoTooltip();
						hideDaychongTooltip();
						hideStrengthTooltip();
						hideNotesTooltip();
						hideSanheTooltip();
						
						const dongyaoType = e.target.getAttribute('data-dongyao-type');
						if (dongyaoType) {
							showDongyaoTooltip(e.target, dongyaoType);
						}
					}
				});
				
				// 添加地支点击事件委托（用于显示三合局信息）
				document.addEventListener('click', function(e) {
					if (e.target.classList.contains('dizhi-mark') || e.target.classList.contains('day-month-dizhi')) {
						// 隐藏其他所有悬浮框
						hideXunkongTooltip();
						hideLiushenTooltip();
						hideYaoTooltip();
						hideDaychongTooltip();
						hideStrengthTooltip();
						
						// 检查当前行是否有三合局横线
						const lineElement = e.target.closest('.line');
						if (lineElement) {
							const sanheElement = lineElement.querySelector('.sanhe-mark');
							if (sanheElement) {
								const sanheInfo = sanheElement.getAttribute('data-sanhe-info');
								if (sanheInfo) {
									try {
										const sanhe = JSON.parse(sanheInfo);
										showSanheTooltip(e.target, sanhe);
									} catch (error) {
										console.error('解析三合局信息失败:', error);
									}
								}
							}
						}
						
						// 检查是否是日支或月支，查找对应的三合局信息
						const dizhiType = e.target.getAttribute('data-dizhi-type');
						const dizhi = e.target.getAttribute('data-dizhi');
						
						if (dizhiType && dizhi) {
							// 查找对应的三合局信息
							const allSanheJu = window.allSanheJu || [];
							let matchingSanhe = null;
							
							// 查找情况4
							matchingSanhe = allSanheJu.find(sanhe => 
								sanhe.case === 4 && 
								sanhe.dayOrMonth === dizhiType && 
								sanhe.dayOrMonthBranch === dizhi
							);
							
							// 如果没有找到情况4，查找情况5
							if (!matchingSanhe) {
								matchingSanhe = allSanheJu.find(sanhe => 
									sanhe.case === 5 && 
									sanhe.dizhi && 
									sanhe.dizhi.includes(dizhi)
								);
							}
							
							// 如果找到了情况4或情况5，还要检查是否有多个情况
							if (matchingSanhe) {
								// 收集所有相关的情况
								const allMatchingCases = [];
								allSanheJu.forEach(sanhe => {
									// 情况4
									if (sanhe.case === 4 && 
										sanhe.dayOrMonth === dizhiType && 
										sanhe.dayOrMonthBranch === dizhi) {
										allMatchingCases.push(sanhe);
									}
									// 情况5
									else if (sanhe.case === 5 && 
										sanhe.dizhi && 
										sanhe.dizhi.includes(dizhi)) {
										allMatchingCases.push(sanhe);
									}
								});
								
								// 如果有多个情况，合并信息
								if (allMatchingCases.length > 1) {
									const combinedSanhe = {
										...allMatchingCases[0],
										allParticipatingCases: allMatchingCases.map(s => s.case)
									};
									showSanheTooltip(e.target, combinedSanhe);
								} else {
									showSanheTooltip(e.target, matchingSanhe);
								}
							}
						}
					}
				});
				
				// 添加六爻点击事件委托
				document.addEventListener('click', function(e) {
					// 检查是否点击了六爻符号或其子元素
					let yaoElement = null;
					if (e.target.classList.contains('yao-symbol')) {
						yaoElement = e.target;
					} else if (e.target.closest('.yao-symbol')) {
						yaoElement = e.target.closest('.yao-symbol');
					}
					
					if (yaoElement) {
						// 隐藏其他所有悬浮框
						hideXunkongTooltip();
						hideLiushenTooltip();
						hideDaychongTooltip();
						hideStrengthTooltip();
						hideSanheTooltip();
						
						const yaoIndex = yaoElement.getAttribute('data-yao-index');
						if (yaoIndex !== null) {
							showYaoTooltip(yaoElement, parseInt(yaoIndex));
						}
					}
				});
			}, 200);
			
			// 重新渲染干支显示，传递三合局信息
			const currentTimeForGanzhi = getCurrentTime();
			if (currentTimeForGanzhi && !currentTimeForGanzhi.partial) {
				renderGanzhi(currentTimeForGanzhi, allSanheJu);
			}
			
			// 绑定重新排盘按钮事件
			document.getElementById("resetBtn").addEventListener("click", function() {
				// 显示选择区域和按钮
				document.getElementById("yaoInputs").style.display = "block";
				document.getElementById("generateGuaBtn").style.display = "block";
				// 清空结果
				document.getElementById("guaResult").innerHTML = "";
				// 重置所有选择框为第一个选项
				for (let i = 1; i <= 6; i++) {
					document.getElementById("line"+i).selectedIndex = 0;
				}
			});
			
			// 绑定保存记录按钮事件
			document.getElementById("saveRecordBtn").addEventListener("click", function() {
				// 保存当前排盘记录的功能
				console.log("保存记录按钮被点击了");
				console.log("开始调用 saveCurrentRecord 函数");
				saveCurrentRecord();
			});
		}

		// 显示数字量化提示框
		function showStrengthTooltip(element) {
			// 移除现有的提示框
			hideStrengthTooltip();
			
			const type = element.getAttribute('data-type');
			const value = element.getAttribute('data-value');
			const description = element.getAttribute('data-description');
			
			// 创建提示框
			const tooltip = document.createElement('div');
			tooltip.className = 'strength-tooltip';
			tooltip.id = 'strength-tooltip';
			
			// 构建提示内容，为地支添加五行颜色
			let content = description + '<br>';
			
			// 六合关系，为地支添加五行颜色
			content += '六合：';
			const liuhePairs = [
				['子', '丑'], ['寅', '亥'], ['卯', '戌'], 
				['辰', '酉'], ['巳', '申'], ['午', '未']
			];
			const liuheTexts = [];
			liuhePairs.forEach(pair => {
				const branch1 = pair[0];
				const branch2 = pair[1];
				const wuxing1 = getBranchWuxing(branch1);
				const wuxing2 = getBranchWuxing(branch2);
				const colorClass1 = getWuxingColorClass(wuxing1);
				const colorClass2 = getWuxingColorClass(wuxing2);
				liuheTexts.push(`<span class="${colorClass1}">${branch1}</span><span class="${colorClass2}">${branch2}</span>合`);
			});
			content += liuheTexts.join(',') + '<br>';
			
			// 六冲关系，为地支添加五行颜色
			content += '六冲：';
			const liuchongPairs = [
				['子', '午'], ['丑', '未'], ['寅', '申'], 
				['卯', '酉'], ['辰', '戌'], ['巳', '亥']
			];
			const liuchongTexts = [];
			liuchongPairs.forEach(pair => {
				const branch1 = pair[0];
				const branch2 = pair[1];
				const wuxing1 = getBranchWuxing(branch1);
				const wuxing2 = getBranchWuxing(branch2);
				const colorClass1 = getWuxingColorClass(wuxing1);
				const colorClass2 = getWuxingColorClass(wuxing2);
				liuchongTexts.push(`<span class="${colorClass1}">${branch1}</span><span class="${colorClass2}">${branch2}</span>冲`);
			});
			content += liuchongTexts.join(',');
			
			tooltip.innerHTML = content;
			
			// 计算位置 - 隐藏信息框紧贴数字正上方，箭头紧靠数字
			const rect = element.getBoundingClientRect();
			tooltip.style.position = 'fixed';
			
			// 先添加到页面以获取实际尺寸
			document.body.appendChild(tooltip);
			
			// 获取tooltip的实际尺寸
			const tooltipRect = tooltip.getBoundingClientRect();
			
			// 计算位置：tooltip底部紧贴数字顶部，水平居中对齐
			const elementCenterX = rect.left + rect.width / 2;
			const tooltipLeft = elementCenterX - tooltipRect.width / 2;
			const tooltipTop = rect.top - tooltipRect.height - 2; // 2px间距
			
			// 设置最终位置
			tooltip.style.left = tooltipLeft + 'px';
			tooltip.style.top = tooltipTop + 'px';
			tooltip.style.transform = 'none'; // 不使用transform，直接定位
			
			// 保存对应的元素信息，用于重新定位
			tooltip.dataset.type = element.dataset.type;
			tooltip.dataset.value = element.dataset.value;
		}
		
		// 隐藏数字量化提示框
		function hideStrengthTooltip() {
			const tooltip = document.getElementById('strength-tooltip');
			if (tooltip) {
				tooltip.remove();
			}
		}
		
		// 显示三合局提示框
		function showSanheTooltip(element, sanheInfo) {
			// 移除现有的提示框
			hideSanheTooltip();
			
			// 创建提示框
			const tooltip = document.createElement('div');
			tooltip.className = 'sanhe-tooltip';
			tooltip.id = 'sanhe-tooltip';
			
			// 构建提示内容，根据当前三合局高亮对应部分
			let content = '<div class="content">';
			
			// 申子辰三合水局
			if (sanheInfo.wuxing === 'shui') {
				content += '<span class="wx-shui">申子辰三合水局</span>';
			} else {
				content += '申子辰三合水局';
			}
			content += ',';
			
			// 亥卯未三合木局
			if (sanheInfo.wuxing === 'mu') {
				content += '<span class="wx-mu">亥卯未三合木局</span>';
			} else {
				content += '亥卯未三合木局';
			}
			content += ',';
			
			// 巳酉丑三合金局
			if (sanheInfo.wuxing === 'jin') {
				content += '<span class="wx-jin">巳酉丑三合金局</span>';
			} else {
				content += '巳酉丑三合金局';
			}
			content += ',';
			
			// 寅午戌三合火局
			if (sanheInfo.wuxing === 'huo') {
				content += '<span class="wx-huo">寅午戌三合火局</span>';
			} else {
				content += '寅午戌三合火局';
			}
			content += '(子酉午卯中神)</div>';
			
			// 根据判断情况高亮对应行
			const caseTexts = [
				'1.三个动爻成三合局(包括暗动)',
				'2.一爻动,三爻动,连同他们的变爻组成三合局',
				'3.四爻动,六爻动,连同他们的变爻组成三合局',
				'4.两个动爻(其中一个是三合局中的中神)和日辰/月建组成三合局',
				'5.三合局中神为爻,月建日辰为另外两个地支,成三合局.'
			];
			
			// 检查是否有多个参与的情况
			const participatingCases = sanheInfo.allParticipatingCases || [sanheInfo.case];
			
			caseTexts.forEach((text, index) => {
				const caseNumber = index + 1;
				if (participatingCases.includes(caseNumber)) {
					content += `<div class="content highlight">${text}</div>`;
				} else {
					content += `<div class="content">${text}</div>`;
				}
			});
			
			tooltip.innerHTML = content;
			
			// 计算位置
			const rect = element.getBoundingClientRect();
			tooltip.style.position = 'fixed';
			
			// 先添加到页面以获取实际尺寸
			document.body.appendChild(tooltip);
			
			// 获取tooltip的实际尺寸
			const tooltipRect = tooltip.getBoundingClientRect();
			
			// 获取视口尺寸
			const viewportWidth = window.innerWidth;
			const viewportHeight = window.innerHeight;
			
			// 计算初始位置：tooltip顶部紧贴地支底部，水平居中对齐
			const elementCenterX = rect.left + rect.width / 2;
			let tooltipLeft = elementCenterX - tooltipRect.width / 2;
			let tooltipTop = rect.bottom + 2; // 2px间距
			
			// 水平位置调整：如果超出左边界，则显示在右侧；如果超出右边界，则显示在左侧
			if (tooltipLeft < 10) {
				// 太靠左，显示在元素右侧
				tooltipLeft = rect.right + 2;
			} else if (tooltipLeft + tooltipRect.width > viewportWidth - 10) {
				// 太靠右，显示在元素左侧
				tooltipLeft = rect.left - tooltipRect.width - 2;
			}
			
			// 垂直位置调整：如果超出下边界，则显示在元素上方
			if (tooltipTop + tooltipRect.height > viewportHeight - 10) {
				// 太靠下，显示在元素上方
				tooltipTop = rect.top - tooltipRect.height - 2;
			}
			
			// 设置最终位置
			tooltip.style.left = tooltipLeft + 'px';
			tooltip.style.top = tooltipTop + 'px';
			tooltip.style.transform = 'none';
		}
		
		// 隐藏三合局提示框
		function hideSanheTooltip() {
			const tooltip = document.getElementById('sanhe-tooltip');
			if (tooltip) {
				tooltip.remove();
			}
		}
		
		// 重新定位当前显示的tooltip
		function repositionCurrentTooltip() {
			const tooltip = document.getElementById('strength-tooltip');
			if (tooltip) {
				// 获取当前tooltip对应的元素
				const element = document.querySelector('.strength-info[data-type="' + tooltip.dataset.type + '"][data-value="' + tooltip.dataset.value + '"]');
				if (element) {
					// 重新计算位置
					const rect = element.getBoundingClientRect();
					const tooltipRect = tooltip.getBoundingClientRect();
					
					const elementCenterX = rect.left + rect.width / 2;
					const tooltipLeft = elementCenterX - tooltipRect.width / 2;
					const tooltipTop = rect.top - tooltipRect.height - 2;
					
					tooltip.style.left = tooltipLeft + 'px';
					tooltip.style.top = tooltipTop + 'px';
				}
			}
		}



		// 初始化爻选择器
		initYaoSelects();









		// 添加旬空标题点击事件委托
		document.addEventListener('click', function(e) {
			if (e.target.classList.contains('xunkong-title')) {
				// 隐藏其他所有悬浮框
				hideLiushenTooltip();
				hideYaoTooltip();
				hideDaychongTooltip();
				hideStrengthTooltip();
				hideNotesTooltip();
				hideSanheTooltip();
				hideDongyaoTooltip();
				
				showXunkongTooltip(e.target);
			} else if (e.target.classList.contains('notes-title')) {
				// 隐藏其他所有悬浮框
				hideXunkongTooltip();
				hideLiushenTooltip();
				hideYaoTooltip();
				hideDaychongTooltip();
				hideStrengthTooltip();
				hideSanheTooltip();
				hideDongyaoTooltip();
				
				showNotesTooltip(e.target);
			} else if (!e.target.classList.contains('yao-symbol') && !e.target.classList.contains('sanhe-mark')) {
				// 点击其他位置隐藏所有悬浮框（除了六爻符号和三合局标记）
				hideXunkongTooltip();
				hideLiushenTooltip();
				hideYaoTooltip();
				hideDaychongTooltip();
				hideStrengthTooltip();
				hideNotesTooltip();
				hideSanheTooltip();
				hideDongyaoTooltip();
			}
		});

		// 绑定判断依据点击事件
		document.getElementById("judgeBasis").addEventListener("click", function() {
			const imageDiv = document.getElementById("judgeBasisImage");
			const closeBtn = document.getElementById("closeJudgeBasisBtn");
			if (imageDiv.style.display === "none") {
				imageDiv.style.display = "block";
				closeBtn.style.display = "block";
			} else {
				imageDiv.style.display = "none";
				closeBtn.style.display = "none";
			}
		});

		// 绑定排盘按钮事件（校验用神必填且限定七项）
		document.getElementById("generateGuaBtn").addEventListener("click", function(){
			const val = (document.getElementById('yongshenText').value || '').trim();
			const allowed = ['父母','妻财','官鬼','兄弟','子孙','世爻','应爻'];
			if(!allowed.includes(val)){
				document.getElementById('yongshenError').style.display = 'block';
				document.getElementById('yongshenText').focus();
				return;
			}
			document.getElementById('yongshenError').style.display = 'none';
			generateGua();
		});
		
		// 断卦步骤显示/隐藏切换
		window.toggleDuanguaSteps = function() {
			const toggle = document.getElementById('duanguaToggle');
			const content = document.getElementById('duanguaStepsContent');
			
			if (content.classList.contains('hidden')) {
				// 显示内容
				content.classList.remove('hidden');
				toggle.classList.add('expanded');
			} else {
				// 隐藏内容
				content.classList.add('hidden');
				toggle.classList.remove('expanded');
			}
		};
		
		// 动爻发动信息悬浮框显示/隐藏
		let currentDongyaoTooltip = null;
		
		function showDongyaoTooltip(element, dongyaoType) {
			// 隐藏其他所有悬浮框
			hideXunkongTooltip();
			hideLiushenTooltip();
			hideYaoTooltip();
			hideDaychongTooltip();
			hideStrengthTooltip();
			hideNotesTooltip();
			hideSanheTooltip();
			
			// 创建悬浮框
			const tooltip = document.createElement('div');
			tooltip.className = 'dongyao-tooltip';
			tooltip.id = 'dongyao-tooltip';
			
			// 保存dongyaoType用于重新定位
			tooltip.dataset.dongyaoType = dongyaoType;
			
			// 获取动爻信息（从data属性中获取）
			const dongyaoMark = element.closest('.line').querySelector('.dongyao-mark');
			const dongyaoText = dongyaoMark?.dataset.dongyaoText || '';
			
			let content = '';
			
			switch(dongyaoType) {
				case 'jin':
				case 'tui':
					content = `
						<div class="title">化进化退</div>
						<div class="content">当动爻发动变化出的变爻与动爻地支五行相同但又不完全一样时,按十二地支顺序,前进的为进神,后退的为退神</div>
						<div class="content">*用神化进神一般表示事物往好的方向发展,越来越强,逐渐壮大</div>
						<div class="content">*用神化退神一般表示事物往不好的方向发展,越来越差,逐渐消退、退出</div>
						<div class="content">例外:</div>
						<div class="content">① 预测行人归来的卦,化进神有行人越走越远之意,化退神有退回之意</div>
						<div class="content">② 预测复合复婚类卦,化进神是俩人距离越来越远,化退神有退回、回到身边、复合、复婚之意</div>
						<div class="content">③预测失物、宠物丢失类卦,化进神是东西找不到了,宠物越跑越远,化退神是找回,寻回,或者自己回来的意思</div>
					`;
					break;
				case 'fanyin':
					const yaoDizhi = element.closest('.line').querySelector('.dizhi-mark').textContent.replace(/[水火木金土]/g, '');
					// 从动爻标记的data属性中获取变爻地支信息
					const changeDizhi = element.dataset.changeDizhi || '';
					
					content = `
						<div class="title">反吟</div>
						<div class="content"><span class="wuxing">${yaoDizhi}</span><span class="wuxing">${changeDizhi}</span>冲</div>
						<div class="content">反吟:动爻发动,变出与之相冲的爻,为爻化反吟。</div>
						<div class="content">解卦:反复,事情反反复复,败而成,成而败,失而得得而失,分而合合而分,或反复多次往来于某地。</div>
					`;
					break;
				case 'fuyin':
					content = `
						<div class="title">伏吟</div>
						<div class="content">伏吟：动爻发动,变出与之完全相同的爻,为爻化伏吟。</div>
						<div class="content">解卦:分为内卦(一二三爻)伏吟、外卦(四五六爻)伏吟、全卦伏吟</div>
						<div class="content">① 内卦伏吟:内心忧愁、郁郁不得志、内心苦楚、闷闷不乐、担心、郁闷等</div>
						<div class="content">② 外卦伏吟:忧心浮于表面、痛苦呻吟、以泪洗面、哭哭啼啼等</div>
						<div class="content">③全卦伏吟:内外之象皆有</div>
					`;
					break;
				case 'huitouke':
					content = `
						<div class="title">回头克</div>
						<div class="content">变爻克动爻</div>
						<div class="highlight">*所有为动爻的用神/世爻化变爻回头克都代表自我放弃</div>
					`;
					break;
				case 'huitousheng':
					content = `
						<div class="title">回头生</div>
						<div class="content">变爻生动爻</div>
					`;
					break;
				case 'huapo':
					content = `
						<div class="title">化破</div>
						<div class="content">变爻被月破或日辰冲</div>
					`;
					break;
				default:
					// 如果没有匹配的类型，显示通用的动爻发动信息
					content = `
						<div class="title">动爻发动</div>
						<div class="content">动爻：表示事物发生变化，有行动力</div>
						<div class="content">*动爻的吉凶权重比日月要高</div>
						<div class="content">*所有为动爻的用神/世爻化变爻回头克都代表自我放弃</div>
					`;
					break;
			}
			
			tooltip.innerHTML = content;
			
			// 为五行和地支添加颜色
			const wuxingElements = tooltip.querySelectorAll('.wuxing');
			wuxingElements.forEach(el => {
				el.innerHTML = el.innerHTML
					.replace(/子/g, '<span class="wx-shui">子</span>')
					.replace(/丑/g, '<span class="wx-tu">丑</span>')
					.replace(/寅/g, '<span class="wx-mu">寅</span>')
					.replace(/卯/g, '<span class="wx-mu">卯</span>')
					.replace(/辰/g, '<span class="wx-tu">辰</span>')
					.replace(/巳/g, '<span class="wx-huo">巳</span>')
					.replace(/午/g, '<span class="wx-huo">午</span>')
					.replace(/未/g, '<span class="wx-tu">未</span>')
					.replace(/申/g, '<span class="wx-jin">申</span>')
					.replace(/酉/g, '<span class="wx-jin">酉</span>')
					.replace(/戌/g, '<span class="wx-tu">戌</span>')
					.replace(/亥/g, '<span class="wx-shui">亥</span>');
			});
			
			document.body.appendChild(tooltip);
			currentDongyaoTooltip = tooltip;
			
			// 智能定位
			smartPositionTooltip(element, tooltip);
		}
		
		function hideDongyaoTooltip() {
			if (currentDongyaoTooltip) {
				currentDongyaoTooltip.remove();
				currentDongyaoTooltip = null;
			}
		}
		
		function repositionCurrentDongyaoTooltip() {
			if (currentDongyaoTooltip) {
				const dongyaoType = currentDongyaoTooltip.dataset.dongyaoType;
				const element = document.querySelector('.dongyao-mark[data-dongyao-type="' + dongyaoType + '"]');
				if (element) {
					smartPositionTooltip(element, currentDongyaoTooltip);
				}
			}
		}
		
		// 断卦笔记文本框自动高度调整
		function adjustTextareaHeight(textarea) {
			textarea.style.height = 'auto';
			textarea.style.height = textarea.scrollHeight + 'px';
		}
		
		// 初始化断卦笔记文本框
		function initDuanguaNotes() {
			const textarea = document.getElementById('duanguaInput');
			if (textarea) {
				// 设置初始高度
				textarea.style.height = '80px';
				
				// 绑定输入事件
				textarea.addEventListener('input', function() {
					adjustTextareaHeight(this);
				});
				
				// 绑定焦点事件，确保高度正确
				textarea.addEventListener('focus', function() {
					adjustTextareaHeight(this);
				});
			}
			
			// 初始化断卦步骤为隐藏状态
			const stepsContent = document.getElementById('duanguaStepsContent');
			const toggle = document.getElementById('duanguaToggle');
			if (stepsContent && toggle) {
				stepsContent.classList.add('hidden');
				toggle.classList.remove('expanded');
			}
		}
		
		// 在排盘完成后初始化断卦笔记
		setTimeout(() => {
			initDuanguaNotes();
		}, 100);
		
		// 底部导航栏切换功能
		function initBottomNavigation() {
			const navTabs = document.querySelectorAll('.nav-tab');
			const tabContents = document.querySelectorAll('.tab-content');
			
			navTabs.forEach(tab => {
				tab.addEventListener('click', function() {
					const targetTab = this.getAttribute('data-tab');
					console.log("导航栏点击:", targetTab);
					
					// 移除所有活动状态
					navTabs.forEach(t => t.classList.remove('active'));
					tabContents.forEach(content => content.classList.remove('active'));
					
					// 添加当前活动状态
					this.classList.add('active');
					document.getElementById(targetTab + '-tab').classList.add('active');
					
					// 根据不同的标签页执行相应操作
					if (targetTab === 'record') {
						console.log("切换到排盘记录页面，准备加载记录");
						setTimeout(() => {
							loadRecords();
						}, 100);
					} else if (targetTab === 'study') {
						console.log("切换到学习页面");
						// 初始化学习子板块切换功能
						initStudySubsections();
					} else if (targetTab === 'paipan') {
						console.log("切换到排盘页面");
						// 排盘页面不需要特殊处理
					}
				});
			});
		}
		
		// 初始化底部导航栏
		initBottomNavigation();
		
		
		// 加载排盘记录
		window.loadRecords = async function() {
			console.log("loadRecords函数开始执行");
			const recordList = document.querySelector('.record-list');
			console.log("找到的记录列表元素:", recordList);
			
			let records = [];
			
			// 检查用户是否已登录
			if (window.supabaseService && window.supabaseService.currentUser) {
				// 用户已登录，从云端加载数据
				console.log("用户已登录，从云端加载记录");
				try {
					const result = await window.supabaseService.getPaipanRecords();
					if (result.success) {
						records = result.data || [];
						console.log("从云端获取的记录:", records);
					} else {
						console.error("云端加载失败:", result.error);
						// 云端加载失败，使用本地数据
						records = JSON.parse(localStorage.getItem('liuyaoRecords') || '[]');
					}
				} catch (error) {
					console.error("云端加载出错:", error);
					// 云端加载出错，使用本地数据
					records = JSON.parse(localStorage.getItem('liuyaoRecords') || '[]');
				}
			} else {
				// 用户未登录，使用本地数据
				console.log("用户未登录，从本地加载记录");
				records = JSON.parse(localStorage.getItem('liuyaoRecords') || '[]');
			}
			
			console.log("最终使用的记录:", records);
			
			if (records.length === 0) {
				recordList.innerHTML = `
					<div class="record-empty">
						<p>暂无排盘记录</p>
						<p style="font-size: 14px; margin-top: 8px;">完成排盘后，记录将显示在这里</p>
					</div>
				`;
			} else {
				let html = '';
				records.forEach(record => {
					html += `
						<div class="record-item" onclick="viewRecord(${record.id})" style="cursor: pointer; position: relative;">
							<div style="margin-bottom: 8px;">
								<div style="margin-bottom: 4px; margin-top: -8px; display: flex; justify-content: space-between; align-items: flex-start;">
									<div style="flex: 1;">
										${record.question === '未填写' ? '' : record.question}
									</div>
									<button onclick="event.stopPropagation(); deleteRecord(${record.id})" style="padding: 0; font-size: 16px; background: none; color: #999; border: none; cursor: pointer;">×</button>
								</div>
								<div style="font-size: 12px; color: #999; margin-bottom: -16px;">
									${record.time}
								</div>
							</div>
						</div>
					`;
				});
				recordList.innerHTML = html;
			}
		};
		
		// 查看记录
		window.viewRecord = async function(recordId) {
			let records = [];
			
			// 检查用户是否已登录
			if (window.supabaseService && window.supabaseService.currentUser) {
				// 用户已登录，从云端加载数据
				try {
					const result = await window.supabaseService.getPaipanRecords();
					if (result.success) {
						records = result.data || [];
					} else {
						// 云端加载失败，使用本地数据
						records = JSON.parse(localStorage.getItem('liuyaoRecords') || '[]');
					}
				} catch (error) {
					// 云端加载出错，使用本地数据
					records = JSON.parse(localStorage.getItem('liuyaoRecords') || '[]');
				}
			} else {
				// 用户未登录，使用本地数据
				records = JSON.parse(localStorage.getItem('liuyaoRecords') || '[]');
			}
			
			const record = records.find(r => r.id === recordId);
			console.log("找到的记录:", record);
			if (record) {
				// 隐藏所有标签页内容
				document.querySelectorAll('.tab-content').forEach(tab => {
					tab.classList.remove('active');
				});
				
				// 获取查看记录的标签页
				const viewTab = document.getElementById('view-record-tab');
				
				// 处理云端数据和本地数据的差异
				const question = record.question || '未填写';
				const yongshen = record.yongshen || record.gua_data?.yongshen || '未选择';
				const time = record.time || '时间未知';
				// 优先使用 fullGuaContent，然后是 gua_data.fullGuaContent，最后是 gua_data.html
				let fullGuaContent = record.fullGuaContent || 
					record.gua_data?.fullGuaContent || 
					record.gua_data?.html || 
					'<p>暂无排盘内容</p>';
				
				// 移除重新排盘和保存记录按钮（这些按钮在记录详情页面不需要）
				fullGuaContent = fullGuaContent.replace(/<button[^>]*id="resetBtn"[^>]*>重新排盘<\/button>/g, '');
				fullGuaContent = fullGuaContent.replace(/<button[^>]*id="saveRecordBtn"[^>]*>保存记录<\/button>/g, '');
				// 移除可能残留的按钮容器
				fullGuaContent = fullGuaContent.replace(/<div[^>]*style="[^"]*text-align:\s*center[^"]*margin-top:\s*-45px[^"]*"[^>]*>\s*<\/div>/g, '');
				
				// 移除断卦步骤部分（记录详情页面不需要）
				fullGuaContent = fullGuaContent.replace(/<div class="duangua-steps">[\s\S]*?<\/div>/g, '');
				
				console.log("处理后的数据:", { question, yongshen, time, fullGuaContent });
				
				// 设置查看记录页面的内容
				viewTab.innerHTML = `
					<!-- 排盘记录导航栏 -->
					<div class="paipan-nav">
						<div class="paipan-nav-item active">排盘记录</div>
					</div>
					
					<div class="paipan-container" style="padding-top: 20px;">
						<!-- 上方排盘记录详情 -->
						<div style="margin-bottom: 5px; margin-top: -10px; padding: 15px 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
							<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
								<h2 style="margin: 0; color: #333; font-size: 16px;">排盘记录详情</h2>
								<button onclick="backToRecordList()" style="padding: 6px 12px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">返回</button>
							</div>
							<div style="display: flex; flex-direction: column; gap: 0px;">
								<p style="color: #333;"><strong>问事：</strong>${question}</p>
								<p style="color: #333;"><strong>用神：</strong>${yongshen}</p>
								<p style="color: #333;"><strong>时间：</strong>${time}</p>
							</div>
						</div>
						<!-- 下方本卦变卦内容和断卦笔记内容 -->
						<div class="record-gua-content" style="margin-top: 10px; padding: 15px 10px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
							${fullGuaContent}
						</div>
						</div>
					</div>
				`;
				
				// 显示查看记录标签页
				viewTab.classList.add('active');
				
				// 重新绑定事件监听器
				setTimeout(() => {
					rebindViewRecordEvents(viewTab);
				}, 100);
			} else {
				console.error("未找到记录，recordId:", recordId);
				alert('未找到该记录');
			}
		};
		
		// 播放视频函数
		window.playVideo = function() {
			// 尝试直接跳转到B站视频页面
			window.open('https://www.bilibili.com/video/BV1qDe2zeEoz', '_blank');
		};
		
		// 返回记录列表
		window.backToRecordList = function() {
			// 隐藏查看记录标签页
			const viewTab = document.getElementById('view-record-tab');
			if (viewTab) {
				viewTab.classList.remove('active');
			}
			
			// 显示排盘记录标签页
			document.getElementById('record-tab').classList.add('active');
			
			// 更新导航栏状态
			document.querySelectorAll('.nav-tab').forEach(tab => {
				tab.classList.remove('active');
			});
			document.querySelector('.nav-tab[data-tab="record"]').classList.add('active');
		};
		
		// 删除记录
		window.deleteRecord = async function(recordId) {
			if (confirm('确定要删除这条记录吗？')) {
				try {
					// 检查用户是否已登录
					if (window.supabaseService && window.supabaseService.currentUser) {
						// 用户已登录，从云端删除
						console.log("用户已登录，从云端删除记录:", recordId);
						const result = await window.supabaseService.deletePaipanRecord(recordId);
						if (result.success) {
							console.log("云端删除成功");
						} else {
							console.error("云端删除失败:", result.error);
						}
					}
					
					// 无论云端删除是否成功，都删除本地数据
				let records = JSON.parse(localStorage.getItem('liuyaoRecords') || '[]');
				records = records.filter(r => r.id !== recordId);
				localStorage.setItem('liuyaoRecords', JSON.stringify(records));
					
					// 重新加载记录列表
				loadRecords();
					
					// 不再显示"记录已删除"的弹窗，因为用户已经确认了
				} catch (error) {
					console.error('删除记录出错:', error);
					alert('删除失败：' + error.message);
				}
			}
		};
		
		// 重新绑定查看记录页面中的事件监听器
		function rebindViewRecordEvents(viewContent) {
			console.log("开始重新绑定查看记录页面的事件监听器");
			
			// 绑定便捷查询按钮的点击事件
			const feiTitles = viewContent.querySelectorAll('.fei-title');
			console.log("找到废标签数量:", feiTitles.length);
			feiTitles.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					// 检查是否已经显示了废的悬浮框
					const existingTooltip = document.getElementById('fei-tooltip');
					if (existingTooltip) {
						// 如果已经显示，则隐藏
						hideAllTooltips();
					} else {
						// 如果没有显示，则显示
						showFeiTooltip(this);
					}
				});
			});
			
			// 绑定其他便捷查询按钮
			const dizhiChongheTitles = viewContent.querySelectorAll('.dizhi-chonghe-title');
			dizhiChongheTitles.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					const existingTooltip = document.getElementById('dizhi-chonghe-tooltip');
					if (existingTooltip) {
						hideAllTooltips();
					} else {
						showDizhiChongheTooltip(this);
					}
				});
			});
			
			const wuxingShengkeTitles = viewContent.querySelectorAll('.wuxing-shengke-title');
			wuxingShengkeTitles.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					const existingTooltip = document.getElementById('wuxing-shengke-tooltip');
					if (existingTooltip) {
						hideAllTooltips();
					} else {
						showWuxingShengkeTooltip(this);
					}
				});
			});
			
			const dongyaoFadongTitles = viewContent.querySelectorAll('.dongyao-fadong-title');
			dongyaoFadongTitles.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					const existingTooltip = document.getElementById('dongyao-fadong-tooltip');
					if (existingTooltip) {
						hideAllTooltips();
					} else {
						showDongyaoFadongTooltip(this);
					}
				});
			});
			
			const shierChangshengTitles = viewContent.querySelectorAll('.shier-changsheng-title');
			shierChangshengTitles.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					// 使用iframe加载文件，避免CORS限制
					const modal = document.createElement('div');
					modal.style.cssText = `
						position: fixed;
						top: 0;
						left: 0;
						width: 100%;
						height: 100%;
						background: transparent;
						z-index: 10000;
						display: flex;
						justify-content: center;
						align-items: center;
					`;
					
					const content = document.createElement('div');
					content.style.cssText = `
						background: transparent;
						width: 100%;
						height: 100%;
						border: none;
						overflow: hidden;
						position: relative;
					`;
					
					const closeBtn = document.createElement('button');
					closeBtn.innerHTML = '×';
					closeBtn.style.cssText = `
						position: fixed;
						top: 20px;
						right: 20px;
						background: rgba(0,0,0,0.7);
						color: white;
						border: none;
						border-radius: 50%;
						width: 40px;
						height: 40px;
						font-size: 20px;
						cursor: pointer;
						z-index: 10001;
						box-shadow: 0 2px 10px rgba(0,0,0,0.3);
					`;
					
					closeBtn.onclick = () => {
						document.body.removeChild(modal);
					};
					
					const iframe = document.createElement('iframe');
					iframe.style.cssText = `
						width: 100%;
						height: 100%;
						border: none;
						background: transparent;
					`;
					
					// 尝试多个路径
					const possiblePaths = [
						'六爻排盘调用/长生十二宫 调用.html',
						'./六爻排盘调用/长生十二宫 调用.html',
						'../六爻排盘调用/长生十二宫 调用.html'
					];
					
					let pathIndex = 0;
					
					function tryLoadIframe() {
						if (pathIndex >= possiblePaths.length) {
							alert('无法加载长生十二宫，请检查文件是否存在');
							document.body.removeChild(modal);
							return;
						}
						
						const currentPath = possiblePaths[pathIndex];
						console.log('尝试加载路径:', currentPath);
						
						iframe.src = currentPath;
						iframe.onerror = () => {
							console.log('路径失败:', currentPath);
							pathIndex++;
							setTimeout(tryLoadIframe, 100);
						};
						
						iframe.onload = () => {
							console.log('成功加载:', currentPath);
						};
					}
					
					content.appendChild(closeBtn);
					content.appendChild(iframe);
					modal.appendChild(content);
					document.body.appendChild(modal);
					
					// 开始尝试加载
					setTimeout(tryLoadIframe, 100);
				});
			});
			
			const dongdongXianglianTitles = viewContent.querySelectorAll('.dongdong-xianglian-title');
			dongdongXianglianTitles.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					const existingTooltip = document.getElementById('dongdong-xianglian-tooltip');
					if (existingTooltip) {
						hideAllTooltips();
					} else {
						showDongdongXianglianTooltip(this);
					}
				});
			});
			
			const bianjixiongTitles = viewContent.querySelectorAll('.bianjixiong-title');
			bianjixiongTitles.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					const existingTooltip = document.getElementById('bianjixiong-tooltip');
					if (existingTooltip) {
						hideAllTooltips();
					} else {
						showBianjixiongTooltip(this);
					}
				});
			});
			
			const sanhejuTitles = viewContent.querySelectorAll('.sanheju-title');
			sanhejuTitles.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					const existingTooltip = document.getElementById('sanheju-tooltip');
					if (existingTooltip) {
						hideAllTooltips();
					} else {
						showSanhejuTooltip(this);
					}
				});
			});
			
			// 绑定其他交互元素
			const jixiongMarks = viewContent.querySelectorAll('.jixiong-mark');
			console.log("找到吉凶标记数量:", jixiongMarks.length);
			jixiongMarks.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					console.log("吉凶标记被点击");
					showJixiongTooltip(this);
				});
			});
			
			const dongyaoMarks = viewContent.querySelectorAll('.dongyao-mark');
			console.log("找到动爻标记数量:", dongyaoMarks.length);
			dongyaoMarks.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					console.log("动爻标记被点击");
					// 获取动爻类型
					const dongyaoType = this.dataset.dongyaoType || 'default';
					console.log("动爻类型:", dongyaoType);
					showDongyaoTooltip(this, dongyaoType);
				});
			});
			
			const liushenMarks = viewContent.querySelectorAll('.liushen-mark');
			console.log("找到六神标记数量:", liushenMarks.length);
			liushenMarks.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					console.log("六神标记被点击");
					// 获取六神名称
					const liushenName = this.dataset.liushen || this.textContent;
					showLiushenTooltip(this, liushenName);
				});
			});
			
			const xunkongTitles = viewContent.querySelectorAll('.xunkong-title');
			console.log("找到旬空标题数量:", xunkongTitles.length);
			xunkongTitles.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					console.log("旬空标题被点击");
					showXunkongTooltip(this);
				});
			});
			
			const strengthInfos = viewContent.querySelectorAll('.strength-info');
			console.log("找到数字量化数量:", strengthInfos.length);
			strengthInfos.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					console.log("数字量化被点击");
					showStrengthTooltip(this);
				});
			});
			
			const daychongMarks = viewContent.querySelectorAll('.daychong-mark');
			console.log("找到日冲月破标记数量:", daychongMarks.length);
			daychongMarks.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					console.log("日冲月破标记被点击");
					// 获取daychong类型
					const daychongType = element.dataset.daychongType || element.textContent;
					showDaychongTooltip(this, daychongType);
				});
			});
			
			const sanheMarks = viewContent.querySelectorAll('.sanhe-mark');
			console.log("找到三合局标记数量:", sanheMarks.length);
			sanheMarks.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					console.log("三合局标记被点击");
					showSanheTooltip(this);
				});
			});
			
			// 绑定六爻符号点击事件
			const yaoSymbols = viewContent.querySelectorAll('.yao-symbol');
			console.log("找到六爻符号数量:", yaoSymbols.length);
			yaoSymbols.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					console.log("六爻符号被点击");
					// 获取爻的索引
					const yaoIndex = this.dataset.yaoIndex;
					if (yaoIndex !== undefined) {
						showYaoTooltip(this, parseInt(yaoIndex));
					}
				});
			});
			
			// 绑定断卦步骤切换
			const duanguaToggles = viewContent.querySelectorAll('#duanguaToggle');
			duanguaToggles.forEach(element => {
				element.addEventListener('click', function(e) {
					e.stopPropagation();
					toggleDuanguaSteps();
				});
			});
		}
		
		// ===== 卦名悬浮框功能 =====
		
		// 显示卦信息悬浮框
		window.showGuaTooltip = function(element, guaName) {
			console.log('showGuaTooltip被调用:', guaName);
			
			// 隐藏其他悬浮框
			if (typeof hideAllTooltips === 'function') {
				hideAllTooltips();
			}
			
			// 创建悬浮框
			const tooltip = document.createElement('div');
			tooltip.className = 'gua-tooltip';
			tooltip.id = 'gua-tooltip';
			
			// 直接显示内容
			const guaContent = getGuaContent(guaName);
			tooltip.innerHTML = `
				<div class="tooltip-title">${guaName}</div>
				<div class="tooltip-content">
					${guaContent}
				</div>
			`;
			
			// 添加到页面
			document.body.appendChild(tooltip);
			console.log('悬浮框已添加到页面');
			
			// 计算位置 - 在屏幕中居中显示
			const rect = element.getBoundingClientRect();
			let left = (window.innerWidth - 400) / 2; // 悬浮框宽度400px，居中计算
			let top = (window.innerHeight - 500) / 2; // 悬浮框高度500px，居中计算

			// 边界检查
			if (left < 10) left = 10;
			if (top < 10) top = 10;
			if (left + 400 > window.innerWidth - 10) left = window.innerWidth - 410;
			if (top + 500 > window.innerHeight - 10) top = window.innerHeight - 510;
			
			// 设置位置
			tooltip.style.left = left + 'px';
			tooltip.style.top = top + 'px';
			console.log('悬浮框位置设置:', left, top, '元素位置:', rect.left, rect.bottom);
		}
		
		
		// 获取卦象内容的函数（包含完整64卦内容）
		function getGuaContent(guaName) {
			const guaInfo = {
				'乾为天第一': `
					<div class="hexagram-symbol">————<br>————<br>————<br>————<br>————<br>————</div>
					<p><strong>乾：元亨，利贞。</strong></p>
					<p><strong>《彖》曰：</strong>大哉乾元，万物资始，乃统天。云行雨施，品物流形。大明终始，六位时成。时乘六龙以御天。乾道变化，各正性命。保合大和，乃利点。首出庶物，万国咸宁。</p>
					<p><strong>《象》曰：</strong>天行健，君子以自强不息。</p>
					<p><strong>初九：</strong>潜龙，勿用。<br><strong>《象》曰：</strong>潜龙勿用，阳在下也。</p>
					<p><strong>九二：</strong>见龙在田，利见大人。<br><strong>《象》曰：</strong>见龙在田，德施普也。</p>
					<p><strong>九三：</strong>君子终日乾乾，夕惕若厉，无咎。<br><strong>《象》曰：</strong>终日乾乾，反复道也。</p>
					<p><strong>九四：</strong>或跃在渊，无昝。<br><strong>《象》曰：</strong>或跃在渊，进无咎也。</p>
					<p><strong>九五：</strong>飞龙在天，利见大人。<br><strong>《象》曰：</strong>飞龙在天，大人造也。</p>
					<p><strong>上九：</strong>亢龙有悔。<br><strong>《象》曰：</strong>亢龙有悔，盈不可久也。</p>
					<p><strong>用九：</strong>见群龙无首，吉。<br><strong>《象》曰：</strong>用九，天德不可为首也。</p>
					<p><strong>《文言》曰：</strong>"元"者，善之长也；"亨"者，嘉之会也；"利"者，义之和也；"贞"者，事之干也。君子体仁足以长人，嘉会足以合礼，利物足以和义，贞固足以干事。君子行此四德者，故曰："乾、元、亨、利、贞。"</p>
					<p>初九曰："潜龙勿用。"何谓也？子曰："龙德而隐者也，不易乎世，不成乎名，遯世无闷，不见是而无闷，乐则行之，忧则违之，确乎其不可拔，潜龙也。"九二曰："见龙在田，利见大人。"何谓也？子曰："龙德而正中者也。庸言之信，庸行之谨，闲邪存其诚，善世而不伐，德博而化，《易》曰'见龙在田，利见大人'。君德也。"九三曰："君子终日乾乾，夕惕若厉，无咎。"何谓也？子曰："君子进德修业。忠信所以进德也。修辞立其诚，所以居业也。知至至之，可与几也。知终终之，可与存义也。是故居上位而不骄，在下位而不忧，故乾乾因其时而惕，虽危无咎矣。"九四曰："或跃在渊，无咎。"何谓也？子曰："上下无常，非为邪也。进退无恒，非离群也。君子进德修业，欲及时也，故无咎。"九五曰："飞龙在天，利见大人。"何谓也？子曰："同声相应，同气相求。水流湿，火就燥。云从龙，风从虎。圣人作而万物覩。本乎天者亲上，本乎地者亲下。则各从其类也。"上九曰："亢龙有悔。"何谓也？子曰："贵而无位，高而无民，贤人在下位而无辅，是以动而有悔也。"</p>
					<p>"潜龙勿用"，下也；"见龙在田"，时舍也；"终日乾乾"，行事也；"或跃在渊"，自试也；"飞龙在天"，上治也；"亢龙有悔"，穷之灾也；乾元"用九"，天下治也。</p>
					<p>"潜龙勿用"，阳气潜藏；"见龙在田"，天下文明；"终日乾乾"，与时偕行；"或跃在渊"，乾道乃革；"飞龙在天"，乃位乎天德；"亢龙有悔"，与时偕极；乾元"用九"，乃见天则。</p>
					<p>乾"元"者，始而亨者也；"利贞"者，性情也。乾始能以美利利天下，不言所利，大矣哉，大哉乾乎，刚健中正，纯粹精也。六爻发挥，旁通情也，时乘六龙，以御天也。云行雨施，天下平也。</p>
					<p>君子以成德为行，日可见之行也。"潜"之为言也，隐而未见，行而未成，是以君子弗用也。君子学以聚之，问以辩之，宽以居之，仁以行之。《易》曰："见龙在田，利见大人。"君德也。九三重刚而不中，上不在天，下不在田，故乾乾因其时而惕，虽危"无咎"矣。九四重刚而不中，上不在天，下不在田，中不在人，故"或"之，或之者，疑之也。故"无咎"。夫"大人"者，与天地合其德，与日月合其明，与四时合其序，与鬼神合其吉凶。先天而天弗违，后天而奉天时，天且弗违，而况于人乎！况于鬼神乎！"亢"之为言也，知进而不知退，知存而不知亡，知得而不知丧，其唯圣人乎！知进退存亡而不失其正者，其唯圣人乎！</p>
				`,
				'坤为地第二': `
					<div class="hexagram-symbol">–  –<br>–  –<br>–  –<br>–  –<br>–  –<br>–  –</div>
					<p><strong>坤：元亨，利牝马之贞。君子有攸往，先迷后得主，利西南得朋，东北丧朋，安页吉。</strong></p>
					<p><strong>《彖》曰：</strong>至哉坤元，万物资生，乃顺承天。坤厚载物，德合无疆。含弘光大，品物咸亨。牝马地类，行地无疆，柔顺利贞。君子。君子收行，先迷失道，后顺得常。西南得朋，乃与类行。东北丧朋，乃终有庆。安负之吉，应地无疆。</p>
					<p><strong>《象》曰：</strong>地势坤。君子以厚德载物。</p>
					<p><strong>初六：</strong>履霜，坚冰至。<br><strong>《象》曰：</strong>履霜坚冰，阴始凝也，列致其道，至坚冰也。</p>
					<p><strong>六二：</strong>直、方、大，不习，无不利。<br><strong>《象》曰：</strong>六二之动，直以方也。不习无不利，地道光也。</p>
					<p><strong>六三：</strong>含章，可贞，或从王事，无成有终。<br><strong>《象》曰：</strong>含章可贞，以时发也。或从王事，知光大也。</p>
					<p><strong>六四：</strong>括囊，无咎无誉。<br><strong>《象》曰：</strong>括囊无咎，慎不害也。</p>
					<p><strong>六五：</strong>黄裳，元吉。<br><strong>《象》曰：</strong>黄裳元吉，文在中也。</p>
					<p><strong>上六：</strong>龙战于野，其血玄黄。<br><strong>《象》曰：</strong>龙战于野，其道穷也。</p>
					<p><strong>用六，利永贞。</strong><br><strong>《象》曰：</strong>用六永贞，以大终也。</p>
					<p><strong>《文言》曰：</strong>坤至柔而动也刚，至静而德方，后得主而有常，含万物而化光。坤道其顺乎，承天而时行。积善之家必有余庆，积不善之家必有余殃。臣弑其君，子弑其父，非一朝一夕之故，其所由来者渐矣。由辩之不早辩也。《易》曰："履霜，坚冰至。"盖言顺也。"直"其正也，"方"其义也。君子敬以直内，义以方外，敬义立而德不孤。"直方大，不习无不利。"则不疑其所行也。阴虽有美，"含"之以从王事，弗敢成也。地道也，妻道也，臣道也。地道"无成"而代"有终"也。天地变化，草木蕃，天地闭，贤人隐。《易》曰："括囊，无咎无誉。"盖言谨也。君子"黄"中通理，正位居体，美在其中，而畅于四支，发于事业，美之至也！阴疑于阳必战，为其嫌于无阳也。故称"龙"焉犹未离其类也，故称"血"焉。夫"玄黄"者，天地之杂也，天玄而地黄。</p>
				`,
				'水雷屯第三': `
					<div class="hexagram-symbol">–  –<br>————<br>–  –<br>–  –<br>–  –<br>————</div>
					<p><strong>屯：元亨，利贞。勿用有攸往，利建侯。</strong></p>
					<p><strong>《彖》曰：</strong>屯，刚柔始交而难生。动乎险中，大亨贞。雷雨之动满盈，天造草昧。宜寻建侯而不宁。</p>
					<p><strong>《象》曰：</strong>云雷，屯。君子以经纶。</p>
					<p><strong>初九：</strong>磐桓，利居贞。利建侯。<br><strong>《象》曰：</strong>虽磐桓，志行正也。以贵下贱，大得民也。</p>
					<p><strong>六二：</strong>屯如邅如，乘马班如。匪寇，婚媾。女子贞不字，十年乃字。<br><strong>《象》曰：</strong>六二之难，乘刚也。十年乃字，反常也。</p>
					<p><strong>六三：</strong>即鹿无虞，惟入于林中，君子几不如舍，往吝。<br><strong>《象》曰：</strong>即鹿无虞，以从禽也。君子舍之，往吝穷也。</p>
					<p><strong>六四：</strong>乘马班如，求婚媾。往吉，无不利。<br><strong>《象》曰：</strong>求而往，明也。</p>
					<p><strong>九五：</strong>屯其膏，小贞吉，大贞凶。<br><strong>《象》曰：</strong>屯其膏，施未光也。</p>
					<p><strong>上六：</strong>乘马班如，泣血涟如。<br><strong>《象》曰：</strong>泣血涟如，何可长也。</p>
				`,
				'山水蒙第四': `
					<div class="hexagram-symbol">————<br>–  –<br>–  –<br>–  –<br>————<br>–  –</div>
					<p><strong>蒙：亨。匪我求童蒙，童蒙求我。初筮告，再三渎，渎则不告。利贞。</strong></p>
					<p><strong>《彖》曰：</strong>蒙，山下有险，险而止，蒙。蒙亨，以亨行，时中也。匪我求童蒙，童蒙求我，志应也。初筮告，以刚中也。再三渎，渎则不告，渎蒙也。蒙以养正，圣功也。</p>
					<p><strong>《象》曰：</strong>山下出泉，蒙。君子以果行育德。</p>
					<p><strong>初六：</strong>发蒙，利用刑人，用说桎梏。以往，吝。<br><strong>《象》曰：</strong>利用刑人，以正法也。</p>
					<p><strong>九二：</strong>包蒙，吉。纳妇，吉。子克家。<br><strong>《象》曰：</strong>子克家，刚柔节也。</p>
					<p><strong>六三：</strong>勿用取女，见金夫，不有躬。无攸利。<br><strong>《象》曰：</strong>勿用取女，行不顺也。</p>
					<p><strong>六四：</strong>困蒙，吝。<br><strong>《象》曰：</strong>困蒙之吝，独远实也。</p>
					<p><strong>六五：</strong>童蒙，吉。<br><strong>《象》曰：</strong>童蒙之吉，顺以巽也。</p>
					<p><strong>上九：</strong>击蒙，不利为寇，利御寇。<br><strong>《象》曰：</strong>「利」用「御寇」，上下顺也。</p>
				`,
				'水天需第五': `
					<div class="hexagram-symbol">–  –<br>————<br>–  –<br>————<br>————<br>————</div>
					<p><strong>需：有孚，光亨。贞吉，利涉大川。</strong></p>
					<p><strong>《彖》曰：</strong>需，须也。险在前也，刚健而不陷，其义不困穷矣。需，有孚，光亨，贞吉，位乎天位，以正中也。利涉大川，往有功也。</p>
					<p><strong>《象》曰：</strong>云上于天，需。君子以饮食宴乐。</p>
					<p><strong>初九：</strong>需于郊，利用恒，无咎。<br><strong>《象》曰：</strong>需于郊，不犯难行也。利用恒无咎，未失常也。</p>
					<p><strong>九二：</strong>需于沙，小有言，终吉。<br><strong>《象》曰：</strong>需于沙，衍在中也。虽小有言，以终吉也。</p>
					<p><strong>九三：</strong>需于泥，致寇至。<br><strong>《象》曰：</strong>「需于泥」，灾在外也。自我致寇，敬慎不败也。</p>
					<p><strong>六四：</strong>需于血，出自穴。<br><strong>《象》曰：</strong>「需于血，」顺以听也。</p>
					<p><strong>九五：</strong>需于酒食，贞吉。<br><strong>《象》曰：</strong>「酒食贞吉」，以中正也。</p>
					<p><strong>上六：</strong>入于穴，有不速之客三人来，敬之终吉。<br><strong>《象》曰：</strong>「不速之客来，敬之终吉」，虽不当位，未大失也。</p>
				`,
				'天水讼第六': `
					<div class="hexagram-symbol">————<br>————<br>————<br>–  –<br>————<br>–  –</div>
					<p><strong>讼：有孚，窒。惕中吉，终凶。利见大人。不利涉大川。</strong></p>
					<p><strong>《彖》曰：</strong>讼，上刚下险，险而健，讼。讼，有孚，窒惕，中吉，刚来而得中也。终凶，讼不可成也。利见大人，尚中正也。不利涉大川，入于渊也。</p>
					<p><strong>《象》曰：</strong>天与水违行，讼。君子以作事谋始。</p>
					<p><strong>初六：</strong>不永所事，小有言，终吉。<br><strong>《象》曰：</strong>不永所事，讼不可长也。虽小有言，其辩明也。</p>
					<p><strong>九二：</strong>不克讼，归而逋。其邑人三百户，无眚。<br><strong>《象》曰：</strong>不克讼，归逋窜也。自下讼上，患至掇也。</p>
					<p><strong>六三：</strong>食旧德，贞厉，终吉。或从王事，无成。<br><strong>《象》曰：</strong>食旧德，从上吉也。</p>
					<p><strong>九四：</strong>不克讼，复既命。渝，安贞，吉。<br><strong>《象》曰：</strong>复即命渝，安贞不失也。</p>
					<p><strong>九五：</strong>讼，元吉。<br><strong>《象》曰：</strong>讼元吉，以中正也。</p>
					<p><strong>上九：</strong>或锡之鞶带，终朝三褫之。<br><strong>《象》曰：</strong>以讼受服，亦不足敬也。</p>
				`,
				'地水师第七': `
					<div class="hexagram-symbol">–  –<br>–  –<br>–  –<br>–  –<br>————<br>–  –</div>
					<p><strong>师：贞，丈人，吉，无咎。</strong></p>
					<p><strong>《彖》曰：</strong>师，众也。贞，正也。能以众正，可以王矣。刚中而应，行险而顺，以此毒天下，而民从之，吉又何咎矣。</p>
					<p><strong>《象》曰：</strong>地中有水，师。君子以容民畜众。</p>
					<p><strong>初六：</strong>师出以律，否臧，凶。<br><strong>《象》曰：</strong>师出以律，失律凶也。</p>
					<p><strong>九二：</strong>在师中，吉，无咎，王三锡命。<br><strong>《象》曰：</strong>在师中吉，承天宠也。王三锡命，怀万邦也。</p>
					<p><strong>六三：</strong>师或舆尸，凶。<br><strong>《象》曰：</strong>师或舆尸，大无功也。</p>
					<p><strong>六四：</strong>师左次，无咎。<br><strong>《象》曰：</strong>左次无咎，未失常也。</p>
					<p><strong>六五：</strong>田有禽。利执言，无咎。长子帅师，弟子舆尸，贞凶。<br><strong>《象》曰：</strong>长子帅师，以中行也。弟子舆尸，使不当也。</p>
					<p><strong>上六：</strong>大君有命，开国承家，小人勿用。<br><strong>《象》曰：</strong>大君有命，以正功也。小人勿用，必乱邦也。</p>
				`,
				'水地比第八': `
					<div class="hexagram-symbol">–  –<br>————<br>–  –<br>–  –<br>–  –<br>–  –</div>
					<p><strong>比：吉。原筮，元永贞，无咎。不宁方来，后夫凶。</strong></p>
					<p><strong>《彖》曰：</strong>「比，吉」也。比，辅也，下顺从也。「原筮，元永贞，无咎」，以刚中也。「不宁方来」，上下应也。「后夫凶」，其道穷也。</p>
					<p><strong>《象》曰：</strong>地上有水，比。先王以建万国，亲诸侯。</p>
					<p><strong>初六：</strong>有孚比之，无咎。有孚盈缶，终来有它，吉。<br><strong>《象》曰：</strong>比之初六，有它吉也。</p>
					<p><strong>六二：</strong>比之自内，贞吉。<br><strong>《象》曰：</strong>比之自内，不自失也。</p>
					<p><strong>六三：</strong>比之匪人。<br><strong>《象》曰：</strong>比之匪人，不亦伤乎？</p>
					<p><strong>六四：</strong>外比之，贞吉。<br><strong>《象》曰：</strong>外比于贤，以从上也。</p>
					<p><strong>九五：</strong>显比，王用三驱，失前禽，邑人不诫，吉。<br><strong>《象》曰：</strong>「显比」之吉，位正中也。舍逆取顺，「失前禽」也。「邑人不诫」，上使中也。</p>
					<p><strong>上六：</strong>比之无首，凶。<br><strong>《象》曰：</strong>「比之无首」，无所终也。</p>
				`,
				'风天小畜第九': `
					<div class="hexagram-symbol">————<br>————<br>–  –<br>————<br>————<br>————</div>
					<p><strong>小畜：亨。密云不雨。自我西郊。</strong></p>
					<p><strong>《彖》曰：</strong>小畜，柔得位而上下应之，曰小畜。健而巽，刚中而志行，乃亨。「密云不雨」，尚往也。「自我西郊」，施未行也。</p>
					<p><strong>《象》曰：</strong>风行天上，小畜。君子以懿文德。</p>
					<p><strong>初九：</strong>复自道，何其咎。吉。<br><strong>《象》曰：</strong>复自道，其义吉也。</p>
					<p><strong>九二：</strong>牵复，吉。<br><strong>《象》曰：</strong>「牵复」在中，亦不自失也。</p>
					<p><strong>九三：</strong>舆说辐。夫妻反目。<br><strong>《象》曰：</strong>「夫妻反目」，不能正室也。</p>
					<p><strong>六四：</strong>有孚，血去，惕出无咎。<br><strong>《象》曰：</strong>「有孚」「惕出」，上合志也。</p>
					<p><strong>九五：</strong>有孚挛如，富以其邻。<br><strong>《象》曰：</strong>「有孚挛如」，不独富也。</p>
					<p><strong>上九：</strong>既雨既处，尚德载。妇贞厉。月几望，君子征凶。<br><strong>《象》曰：</strong>「既雨既处」，德积载也。「君子征凶」，有所疑也。</p>
				`,
				'天泽履第十': `
					<div class="hexagram-symbol">————<br>————<br>————<br>–  –<br>————<br>————</div>
					<p><strong>履：履虎尾，不咥人。亨。</strong></p>
					<p><strong>《彖》曰：</strong>履，柔履刚也。说而应乎乾，是以「履虎尾，不咥人，亨」。刚中正，履帝位而不疚，光明也。</p>
					<p><strong>《象》曰：</strong>上天下泽，履。君子以辨上下，定民志。</p>
					<p><strong>初九：</strong>素履往，无咎。<br><strong>《象》曰：</strong>素履之往，独行愿也。</p>
					<p><strong>九二：</strong>履道坦坦，幽人贞吉。<br><strong>《象》曰：</strong>幽人贞吉，中不自乱也。</p>
					<p><strong>六三：</strong>眇能视，跛能履，履虎尾，咥人，凶。武人为于大君。<br><strong>《象》曰：</strong>「眇能视」，不足以有明也。「跛能履」，不足以与行也。咥人之凶，位不当也。「武人为于大君」，志刚也。</p>
					<p><strong>九四：</strong>履虎尾，愬愬，终吉。<br><strong>《象》曰：</strong>「愬愬，终吉」。志行也。</p>
					<p><strong>九五：</strong>夬履，贞厉。<br><strong>《象》曰：</strong>「夬履，贞厉」，位正当也。</p>
					<p><strong>上九：</strong>视履考祥，其旋元吉。<br><strong>《象》曰：</strong>「元吉」在上，大有庆也。</p>
				`,
				'地天泰第十一': `
					<div class="hexagram-symbol">–  –<br>–  –<br>–  –<br>————<br>————<br>————</div>
					<p><strong>泰：小往大来，吉，亨。</strong></p>
					<p><strong>《彖》曰：</strong>「泰，小往大来。吉亨」。则是天地交而万物通也，上下交而其志同也。内阳而外阴，内健而外顺，内君子而外小人，君子道长，小人道消也。</p>
					<p><strong>《象》曰：</strong>天地交，泰。后以财成天地之道，辅相天地之宜，以左右民。</p>
					<p><strong>初九：</strong>拔茅茹，以其汇。征吉。<br><strong>《象》曰：</strong>「拔茅」「征吉」，志在外也。</p>
					<p><strong>九二：</strong>包荒，用冯河，不遐遗。朋亡，得尚于中行。<br><strong>《象》曰：</strong>「包荒」，「得尚于中行」，以光大也。</p>
					<p><strong>九三：</strong>无平不陂，无往不复。艰贞无咎。勿恤其孚，于食有福。<br><strong>《象》曰：</strong>「无往不复」，天地际也。</p>
					<p><strong>六四：</strong>翩翩，不富以其邻，不戒以孚。<br><strong>《象》曰：</strong>「翩翩不富」，皆失实也。「不戒以孚」，中心愿也。</p>
					<p><strong>六五：</strong>帝乙归妹，以祉元吉。<br><strong>《象》曰：</strong>以祉，元吉，中以行愿也。</p>
					<p><strong>上六：</strong>城复于隍，勿用师，自邑告命。贞吝。<br><strong>《象》曰：</strong>城复于隍，其命乱也。</p>
				`,
				'天地否第十二': `
					<div class="hexagram-symbol">————<br>————<br>————<br>-   -<br>-   -<br>-   -</div>
					<p><strong>否：否之匪人，不利君子贞，大往小来。</strong></p>
					<p><strong>《彖》曰：</strong>「否之匪人，不利君子贞，大往小来」。则是天地不交而万物不通也，上下不交而天下无邦也。内阴而外阳，内柔而外刚，内小人而外君子，小人道长，君子道消也。</p>
					<p><strong>《象》曰：</strong>天地不交，否。君子以俭德辟难，不可荣以禄。</p>
					<p><strong>初六，拔茅茹以其汇。贞吉，亨。</strong><br><strong>《象》曰：</strong>「拔茅」「贞吉」，志在君也。</p>
					<p><strong>六二：</strong>包承，小人吉，大人否。亨。<br><strong>《象》曰：</strong>「大人否亨」，不乱群也。</p>
					<p><strong>六三：</strong>包羞。<br><strong>《象》曰：</strong>「包羞」，位不当也。</p>
					<p><strong>九四：</strong>有命，无咎，畴离祉。<br><strong>《象》曰：</strong>「有命无咎」，志行也。</p>
					<p><strong>九五：</strong>休否，大人吉。其亡其亡，系于苞桑。<br><strong>《象》曰：</strong>大人之吉，位正当也。</p>
					<p><strong>上九：</strong>倾否，先否后喜。<br><strong>《象》曰：</strong>否终则倾，何可长也。</p>
				`,
				'天火同人第十三': `
					<div class="hexagram-symbol">————<br>————<br>————<br>————<br>–  –<br>————</div>
					<p><strong>同人：同人于野，亨。利涉大川。利君子贞。</strong></p>
					<p><strong>《彖》曰：</strong>同人，柔得位得中，而应乎乾，曰同人。同人曰：「同人于野亨，利涉大川」。乾行也。文明以健，中正而应，君子正也。唯君子为能通天下之志。</p>
					<p><strong>《象》曰：</strong>天与火，同人。君子以类族辨物。</p>
					<p><strong>初九：</strong>同人于门，无咎。<br><strong>《象》曰：</strong>出门同人，又谁咎也。</p>
					<p><strong>六二：</strong>同人于宗，吝。<br><strong>《象》曰：</strong>「同人于宗」，吝道也。</p>
					<p><strong>九三：</strong>伏戎于莽，升其高陵，三岁不兴。<br><strong>《象》曰：</strong>「伏戎于莽」，敌刚也。「三岁不兴」，安行也。</p>
					<p><strong>九四：</strong>乘其墉，弗克攻，吉。<br><strong>《象》曰：</strong>「乘其墉」，义弗克也。其吉，则困而反则也。</p>
					<p><strong>九五：</strong>同人先号咷而后笑，大师克，相遇。<br><strong>《象》曰：</strong>同人之先，以中直也。大师相遇，言相克也。</p>
					<p><strong>上九：</strong>同人于郊，无悔。<br><strong>《象》曰：</strong>「同人于郊」，志未得也。</p>
				`,
				'火天大有第十四': `
					<div class="hexagram-symbol">————<br>–  –<br>————<br>————<br>————<br>————</div>
					<p><strong>大有：元亨。</strong></p>
					<p><strong>《彖》曰：</strong>大有，柔得尊位大中，而上下应之，曰「大有」。其德刚健而文明，应乎天而时行，是以元亨。</p>
					<p><strong>《象》曰：</strong>火在天上，大有。君子以遏恶扬善，顺天休命。</p>
					<p><strong>初九：</strong>无交害，匪咎。艰则无咎。<br><strong>《象》曰：</strong>大有初九，「无交害」也。</p>
					<p><strong>九二：</strong>大车以载，有攸往，无咎。<br><strong>《象》曰：</strong>「大车以载」，积中不败也。</p>
					<p><strong>九三：</strong>公用亨于天子，小人弗克。<br><strong>《象》曰：</strong>「公用亨于天子」，小人害也。</p>
					<p><strong>九四：</strong>匪其彭，无咎。<br><strong>《象》曰：</strong>「匪其彭，无咎」。明辨晢也。</p>
					<p><strong>六五：</strong>厥孚交如威如，吉。<br><strong>《象》曰：</strong>「厥孚交如」，信以发志也。威如之吉，易而无备也。</p>
					<p><strong>上九：</strong>自天祐之，吉，无不利。<br><strong>《象》曰：</strong>大有上吉，自天祐也。</p>
				`,
				'地山谦第十五': `
					<div class="hexagram-symbol">–  –<br>–  –<br>–  –<br>————<br>–  –<br>–  –</div>
					<p><strong>谦：亨。君子有终。</strong></p>
					<p><strong>《彖》曰：</strong>「谦，亨」。天道下济而光明，地道卑而上行。天道亏盈而益谦，地道变盈而流谦，鬼神害盈而福谦，人道恶盈而好谦。谦，尊而光，卑而不可逾，君子之终也。</p>
					<p><strong>《象》曰：</strong>地中有山，谦。君子以裒多益寡，称物平施。</p>
					<p><strong>初六：</strong>谦谦君子，用涉大川，吉。<br><strong>《象》曰：</strong>谦谦君子，卑以自牧也。</p>
					<p><strong>六二：</strong>鸣谦，贞吉。<br><strong>《象》曰：</strong>鸣谦贞吉，中心得也。</p>
					<p><strong>九三：</strong>劳谦君子，有终，吉。<br><strong>《象》曰：</strong>劳谦君子，万民服也。</p>
					<p><strong>六四：</strong>无不利，捴谦。<br><strong>《象》曰：</strong>无不利，捴谦，不违则也。</p>
					<p><strong>六五：</strong>不富，以其邻，利用侵伐，无不利。<br><strong>《象》曰：</strong>利用侵伐，征不服也。</p>
					<p><strong>上六：</strong>鸣谦，利用行师，征邑国。<br><strong>《象》曰：</strong>鸣谦，志未得也。可用行师，征邑国也。</p>
				`,
				'雷地豫第十六': `
					<div class="hexagram-symbol">–  –<br>–  –<br>————<br>–  –<br>–  –<br>–  –</div>
					<p><strong>豫：利建侯行师。</strong></p>
					<p><strong>《彖》曰：</strong>豫，刚应而志行，顺以动，豫。豫，顺以动，故天地如之，而况建侯、行师乎？天地以顺动，故日月不过，而四时不忒。圣人以顺动，则刑罚清而民服，豫之时义大矣哉！</p>
					<p><strong>《象》曰：</strong>雷出地奋，豫。先王以作乐崇德，殷荐之上帝，以配祖考。</p>
					<p><strong>初六：</strong>鸣豫，凶。<br><strong>《象》曰：</strong>初六鸣豫，志穷凶也。</p>
					<p><strong>六二：</strong>介于石，不终日，贞吉。<br><strong>《象》曰：</strong>不终日贞吉，以中正也。</p>
					<p><strong>六三：</strong>盱豫，悔。迟，有悔。<br><strong>《象》曰：</strong>盱豫不悔，位不当也。</p>
					<p><strong>九四：</strong>由豫，大有得，勿疑。朋盍簪。<br><strong>《象》曰：</strong>由豫大有得，志大行也。</p>
					<p><strong>六五：</strong>贞疾，恒不死。<br><strong>《象》曰：</strong>六五贞疾，乘刚也。恒不死，中未亡也。</p>
					<p><strong>上六：</strong>冥豫，成有渝。无咎。<br><strong>《象》曰：</strong>「冥豫」在上，何可长也？</p>
				`,
				'泽雷随第十七': `
					<div class="hexagram-symbol">–  –<br>————<br>————<br>–  –<br>–  –<br>————</div>
					<p><strong>随：元亨，利贞，无咎。</strong></p>
					<p><strong>《彖》曰：</strong>随，刚来而下，柔动而说，随。大亨，贞，无咎，而天下随时，随时之义大矣哉！</p>
					<p><strong>《象》曰：</strong>泽中有雷，随。君子以向晦入宴息。</p>
					<p><strong>初九：</strong>官有渝，贞吉，出门交，有功。<br><strong>《象》曰：</strong>官有渝，从正吉也。出门交有功，不失也。</p>
					<p><strong>六二：</strong>系小子，失丈夫。<br><strong>《象》曰：</strong>系小子，弗兼与也。</p>
					<p><strong>六三：</strong>系丈夫，失小子，随有求得，利居贞。<br><strong>《象》曰：</strong>系丈夫，志舍下也。</p>
					<p><strong>九四：</strong>随有获，贞凶。有孚在道，以明，何咎？<br><strong>《象》曰：</strong>随有获，其义凶也。有孚在道，明功也。</p>
					<p><strong>九五：</strong>孚于嘉，吉。<br><strong>《象》曰：</strong>孚于嘉吉，位正中也。</p>
					<p><strong>上六：</strong>拘系之，乃从维之，王用亨于西山。<br><strong>《象》曰：</strong>拘系之，上穷也。</p>
				`,
				'山风蛊第十八': `
					<div class="hexagram-symbol">————<br>–  –<br>–  –<br>————<br>————<br>–  –</div>
					<p><strong>蛊：元亨。利涉大川，先甲三日，后甲三日。</strong></p>
					<p><strong>《彖》曰：</strong>蛊，刚上而柔下，巽而止，蛊。蛊，元亨而天下治也。「利涉大川」，往有事也。「先甲三日，后甲三日」，终则有始，天行也。</p>
					<p><strong>《象》曰：</strong>山下有风，蛊。君子以振民育德。</p>
					<p><strong>初六：</strong>干父之蛊，有子，考无咎。厉，终吉。<br><strong>《象》曰：</strong>干父之蛊，意承考也。</p>
					<p><strong>九二：</strong>干母之蛊，不可贞。<br><strong>《象》曰：</strong>干母之蛊，得中道也。</p>
					<p><strong>九三：</strong>干父之蛊，小有悔，无大咎。<br><strong>《象》曰：</strong>「干父之蛊」，终无咎也。</p>
					<p><strong>六四：</strong>裕父之蛊，往见吝。<br><strong>《象》曰：</strong>「裕父之蛊」，往未得也。</p>
					<p><strong>六五：</strong>干父之蛊，用誉。<br><strong>《象》曰：</strong>「干父用誉」，承以德也。</p>
					<p><strong>上九：</strong>不事王侯，高尚其事。<br><strong>《象》曰：</strong>「不事王侯」，志可则也。</p>
				`,
				'地泽临第十九': `
					<div class="hexagram-symbol">–  –<br>–  –<br>–  –<br>–  –<br>————<br>————</div>
					<p><strong>临：元亨，利贞。至于八月，有凶。</strong></p>
					<p><strong>《彖》曰：</strong>临，刚浸而长，说而顺。刚中而应，大亨以正，天之道也。至于八月，有凶，消不久也。</p>
					<p><strong>《象》曰：</strong>泽上有地，临。君子以教思无穷，容保民无疆。</p>
					<p><strong>初九：</strong>咸临，贞吉。<br><strong>《象》曰：</strong>咸临，贞吉，志行正也。</p>
					<p><strong>九二：</strong>咸临，吉，无不利。<br><strong>《象》曰：</strong>咸临，吉，无不利，未顺命也。</p>
					<p><strong>六三：</strong>甘临，无攸利。既忧之，无咎。<br><strong>《象》曰：</strong>甘临，位不当也。既忧之。咎不长也。</p>
					<p><strong>六四：</strong>至临，无咎。<br><strong>《象》曰：</strong>至临无咎，位当也。</p>
					<p><strong>六五：</strong>知临，大君之宜，吉。<br><strong>《象》曰：</strong>大君之宜，行中之谓也。</p>
					<p><strong>上六：</strong>敦临，吉，无咎。<br><strong>《象》曰：</strong>敦临之吉，志在内也。</p>
				`,
				'风地观第二十': `
					<div class="hexagram-symbol">————<br>————<br>-   -<br>-   -<br>-   -<br>-   -</div>
					<p><strong>观：盥而不荐。有孚颙若。</strong></p>
					<p><strong>《彖》曰：</strong>大观在上，顺而巽，中正以观天下。观，「盥而不荐，有孚颙若」，下观而化也。观天之神道，而四时不忒，圣人以神道设教，而天下服矣。</p>
					<p><strong>《象》曰：</strong>风行地上，观。先王以省方，观民设教。</p>
					<p><strong>初六：</strong>童观，小人无咎，君子吝。<br><strong>《象》曰：</strong>初六：童观，小人道也。</p>
					<p><strong>六二：</strong>窥观，利女贞。<br><strong>《象》曰：</strong>窥观，女贞，亦可丑也。</p>
					<p><strong>六三：</strong>观我生，进退。<br><strong>《象》曰：</strong>观我生进退，未失道也。</p>
					<p><strong>六四：</strong>观国之光，利用宾于王。<br><strong>《象》曰：</strong>观国之光，尚宾也。</p>
					<p><strong>九五：</strong>观我生，君子无咎。<br><strong>《象》曰：</strong>观我生，观民也。</p>
					<p><strong>上九，观其生，君子无咎。</strong><br><strong>《象》曰：</strong>观其生，志未平也。</p>
					`,
					'火雷噬嗑第二十一': `
					<div class="hexagram-symbol">————<br>–  –<br>————<br>–  –<br>–  –<br>————</div>
					<p><strong>噬嗑：亨。利用狱。</strong></p>
					<p><strong>《彖》曰：</strong>颐中有物，曰噬嗑。噬嗑而亨，刚柔分动而明，雷电合而章。柔得中而上行，虽不当位，利用狱也。</p>
					<p><strong>《象》曰：</strong>雷电，噬嗑。先王以明罚敕法。</p>
					<p><strong>初九：</strong>屦校灭趾，无咎。<br><strong>《象》曰：</strong>屦校灭趾，不行也。</p>
					<p><strong>六二：</strong>噬肤灭鼻，无咎。<br><strong>《象》曰：</strong>噬肤，灭鼻，乘刚也。</p>
					<p><strong>六三：</strong>噬腊肉，遇毒，小吝，无咎。<br><strong>《象》曰：</strong>遇毒，位不当也。</p>
					<p><strong>九四：</strong>噬干胏，得金矢。利艰贞，吉。<br><strong>《象》曰：</strong>利艰贞吉，未光也。</p>
					<p><strong>六五：</strong>噬干肉，得黄金。贞厉，无咎。<br><strong>《象》曰：</strong>「贞厉无咎」，得当也。</p>
					<p><strong>上九：</strong>何校灭耳，凶。<br><strong>《象》曰：</strong>何校灭耳，聪不明也。</p>
					`,
					'山火贲第二十二': `
					<div class="hexagram-symbol">————<br>–  –<br>–  –<br>————<br>–  –<br>————</div>
					<p><strong>贲：亨。小利有攸往。</strong></p>
					<p><strong>《彖》曰：</strong>贲：亨，柔来而文刚，故亨。分，刚上而文柔，故小利有攸往。刚柔交错，天文也。文明以止，人文也。观乎天文，以察时变。观乎人文，以化成天下。</p>
					<p><strong>《象》曰：</strong>山下有火，贲。君子以明庶政，无敢折狱。</p>
					<p><strong>初九：</strong>贲其趾，舍车而徒。<br><strong>《象》曰：</strong>舍车而徒，义弗乘也。</p>
					<p><strong>六二：</strong>贲其须。<br><strong>《象》曰：</strong>贲其须，与上兴也。</p>
					<p><strong>九三：</strong>贲如，濡如，永贞，吉。<br><strong>《象》曰：</strong>永贞之吉，终莫之陵也。</p>
					<p><strong>六四：</strong>贲如皤如，白马翰如。匪寇婚媾。<br><strong>《象》曰：</strong>六四，当位疑也。匪寇婚媾，终无尤也。</p>
					<p><strong>六五：</strong>贲于丘园，束帛戋戋，吝，终吉。<br><strong>《象》曰：</strong>六五之吉，有喜也。</p>
					<p><strong>上九：</strong>白贲，无咎。<br><strong>《象》曰：</strong>白贲无咎，上得志也。</p>
					`,
					'山地剥第二十三': `
					<div class="hexagram-symbol">————<br>–  –<br>–  –<br>–  –<br>–  –<br>–  –</div>
					<p><strong>剥：不利有攸往。</strong></p>
					<p><strong>《彖》曰：</strong>剥，剥也。柔变刚也。不利有攸往，小人长也。顺而止之，观象也。君子尚消息盈虚，天行也。</p>
					<p><strong>《象》曰：</strong>出附于地，剥。上以厚下，安宅。</p>
					<p><strong>初六：</strong>剥床以足，蔑贞，凶。<br><strong>《象》曰：</strong>剥床以足，以灭下也。</p>
					<p><strong>六二：</strong>剥床以辨，蔑贞，凶。<br><strong>《象》曰：</strong>剥床以辨，未有与也。</p>
					<p><strong>六三：</strong>剥之，无咎。<br><strong>《象》曰：</strong>剥之无咎，失上下也。</p>
					<p><strong>六四：</strong>剥床以肤，凶。<br><strong>《象》曰：</strong>「剥床以肤」，切近灾也。</p>
					<p><strong>六五：</strong>贯鱼，以宫人宠，无不利。<br><strong>《象》曰：</strong>「以宫人宠」，终无尤也。</p>
					<p><strong>上九：</strong>硕果不食，君子得舆，小人剥庐。<br><strong>《象》曰：</strong>君子得舆，民所载也。小人剥庐，终不可用也。</p>
					`,
				'地雷复第二十四': `
					<div class="hexagram-symbol">–  –<br>–  –<br>–  –<br>–  –<br>–  –<br>————</div>
					<p><strong>复：亨。出入无疾。朋来无咎。反复其道，七日来复，利有攸往。</strong></p>
					<p><strong>《彖》曰：</strong>复，亨。刚反，动而以顺行。是以出入无疾，朋来无咎。反复其道，七日来复，天行也。利有攸往，刚长也。复，其见天地之心乎？</p>
					<p><strong>《象》曰：</strong>雷在地中，复。先王以至日闭关，商旅不行，后不省方。</p>
					<p><strong>初九：</strong>不远复，无祗悔，元吉。<br><strong>《象》曰：</strong>不远之复，以修身也。</p>
					<p><strong>六二：</strong>休复，吉。<br><strong>《象》曰：</strong>休复之吉，以下仁也。</p>
					<p><strong>六三：</strong>频复，厉，无咎。<br><strong>《象》曰：</strong>频复之厉，义无咎也。</p>
					<p><strong>六四：</strong>中行独复。<br><strong>《象》曰：</strong>中行独复，以从道也。</p>
					<p><strong>六五：</strong>敦复，无悔。<br><strong>《象》曰：</strong>敦复无悔，中以自考也。</p>
					<p><strong>上六：</strong>迷复，凶，有灾眚。用行师，终有大败，以其国君凶，至于十年不克征。<br><strong>《象》曰：</strong>迷复之凶，反君道也。</p>
				`,
				'天雷无妄第二十五': `
					<div class="hexagram-symbol">————<br>————<br>————<br>–  –<br>–  –<br>————</div>
					<p><strong>无妄：元亨，利贞。其匪正有眚，不利有攸往。</strong></p>
					<p><strong>《彖》曰：</strong>无妄，刚自外来，而为主于内，动而健，刚中而应。大亨以正，天之命也。「其匪正，有眚，不利有攸往」，无妄之往，何之矣？天命不祐，行矣哉！</p>
					<p><strong>《象》曰：</strong>天下雷行，物与无妄。先王以茂对时育万物。</p>
					<p><strong>初九：</strong>无妄，往，吉。<br><strong>《象》曰：</strong>无妄之往，得志也。</p>
					<p><strong>六二：</strong>不耕获，不菑畬，则利用攸往。<br><strong>《象》曰：</strong>不耕获，未富也。</p>
					<p><strong>六三：</strong>无妄之灾，或系之牛，行人之得，邑人之灾。<br><strong>《象》曰：</strong>行人得牛，邑人灾也。</p>
					<p><strong>九四：</strong>可贞，无咎。<br><strong>《象》曰：</strong>可贞无咎，固有之也。</p>
					<p><strong>九五：</strong>无妄之疾，勿药，有喜。<br><strong>《象》曰：</strong>无妄之药，不可试也。</p>
					<p><strong>上九：</strong>无妄，行有眚，无攸利。<br><strong>《象》曰：</strong>无妄之行，穷之灾也。</p>
				`,
				'山天大畜第二十六': `
					<div class="hexagram-symbol">————<br>–  –<br>–  –<br>————<br>————<br>————</div>
					<p><strong>大畜：利贞。不家食，吉。利涉大川。</strong></p>
					<p><strong>《彖》曰：</strong>大畜，刚健笃实，辉光日新。其德刚上而尚贤，能止健，大正也。不家食，吉，养贤也。利涉大川，应乎天也。</p>
					<p><strong>《象》曰：</strong>天在山中，大畜。君子以多识前言往行，以畜其德。</p>
					<p><strong>初九：</strong>有厉，利已。<br><strong>《象》曰：</strong>有厉，利已，不犯灾也。</p>
					<p><strong>九二：</strong>舆说輹。<br><strong>《象》曰：</strong>舆说輹，中无尤也。</p>
					<p><strong>九三：</strong>良马逐，利艰贞，曰闲舆卫，利有攸往。<br><strong>《象》曰：</strong>利有攸往，上合志也。</p>
					<p><strong>六四：</strong>童牛之牿，元吉。<br><strong>《象》曰：</strong>六四元吉，有喜也。</p>
					<p><strong>六五：</strong>豮豕之牙，吉。<br><strong>《象》曰：</strong>六五之吉，有庆也。</p>
					<p><strong>上九：</strong>何天之衢，亨。<br><strong>《象》曰：</strong>何天之衢，道大行也。</p>
				`,
				'山雷颐第二十七': `
					<div class="hexagram-symbol">————<br>–  –<br>–  –<br>–  –<br>–  –<br>————</div>
					<p><strong>颐：贞吉。观颐，自求口实。</strong></p>
					<p><strong>《彖》曰：</strong>颐，贞吉，养正则吉也。观颐，观其所养也。自求口实，观其自养也。天地养万物，圣人养贤以及万民，颐之时大矣哉！</p>
					<p><strong>《象》曰：</strong>山下有雷，颐。君子以慎言语，节饮食。</p>
					<p><strong>初九：</strong>舍尔灵龟，观我朵颐，凶。<br><strong>《象》曰：</strong>观我朵颐，亦不足贵也。</p>
					<p><strong>六二：</strong>颠颐，拂经，于丘颐，征凶。<br><strong>《象》曰：</strong>六二征凶，行失类也。</p>
					<p><strong>六三，拂颐，贞凶，十年勿用，无攸利。</strong><br><strong>《象》曰：</strong>十年勿用，道大悖也。</p>
					<p><strong>六四：</strong>颠颐，吉。虎视眈眈，其欲逐逐，无咎。<br><strong>《象》曰：</strong>颠颐之吉，上施光也。</p>
					<p><strong>六五：</strong>拂经，居贞吉，不可涉大川。<br><strong>《象》曰：</strong>居贞之吉，顺以从上也。</p>
					<p><strong>上九：</strong>由颐，厉，吉。利涉大川。<br><strong>《象》曰：</strong>由颐厉吉，大有庆也。</p>
				`,
				'泽风大过第二十八': `
					<div class="hexagram-symbol">–  –<br>————<br>————<br>————<br>————<br>–  –</div>
					<p><strong>大过：栋挠，利有攸往，亨。</strong></p>
					<p><strong>《彖》曰：</strong>大过，大者过也。栋挠，本末弱也。刚过而中，巽而说，行。利有攸往，乃亨。大过之时大矣哉！</p>
					<p><strong>《象》曰：</strong>泽灭木，大过。君子以独立不惧，遁世无闷。</p>
					<p><strong>初六：</strong>藉用白茅，无咎。<br><strong>《象》曰：</strong>藉用白茅，柔在下也。</p>
					<p><strong>九二：</strong>枯杨生稊，老夫得其女妻，无不利。<br><strong>《象》曰：</strong>老夫女妻，过以相与也。</p>
					<p><strong>九三：</strong>栋桡，凶。<br><strong>《象》曰：</strong>栋桡之凶，不可以有辅也。</p>
					<p><strong>九四：</strong>栋隆，吉。有它吝。<br><strong>《象》曰：</strong>栋隆之吉，不桡乎下也。</p>
					<p><strong>九五：</strong>枯杨生华，老妇得其士夫，无咎，无誉。<br><strong>《象》曰：</strong>枯杨生华，何可久也。老妇士夫，亦可丑也。</p>
					<p><strong>上六：</strong>过涉灭顶，凶。无咎。<br><strong>《象》曰：</strong>过涉之凶，不可咎也。</p>
				`,
				'坎为水第二十九': `
					<div class="hexagram-symbol">–  –<br>————<br>–  –<br>–  –<br>————<br>–  –</div>
					<p><strong>坎：习坎，有孚，维心亨。行有尚。</strong></p>
					<p><strong>《彖》曰：</strong>习坎，重险也。水流而不盈。行险而不失其信。维心亨，乃以刚中也。行有尚，往有功也。天险，不可升也。地险，山川丘陵也。王公设险以守其国。险之时用大矣哉！</p>
					<p><strong>《象》曰：</strong>水洊至，习坎。君子以常德行，习教事。</p>
					<p><strong>初六：</strong>习坎，入于坎窞，凶。<br><strong>《象》曰：</strong>习坎入坎，失道，凶也。</p>
					<p><strong>九二：</strong>坎，有险，求小得。<br><strong>《象》曰：</strong>求小得，未出中也。</p>
					<p><strong>六三：</strong>来之坎坎，险且枕，入于坎，窞，勿用。<br><strong>《象》曰：</strong>来之坎坎，终无功也。</p>
					<p><strong>六四，樽酒，簋贰，用缶，纳约自牖，终无咎。</strong><br><strong>《象》曰：</strong>樽酒簋贰，刚柔际也。</p>
					<p><strong>九五：</strong>坎不盈，祗既平，无咎。<br><strong>《象》曰：</strong>坎不盈，中未大也。</p>
					<p><strong>上六：</strong>系用徽纆，窴于丛棘，三岁不得，凶。<br><strong>《象》曰：</strong>上六失道，凶三岁也。</p>
				`,
				'离为火第三十': `
					<div class="hexagram-symbol">————<br>–  –<br>————<br>————<br>–  –<br>————</div>
					<p><strong>离：利贞。亨。畜牝牛，吉。</strong></p>
					<p><strong>《彖》曰：</strong>离，丽也。日月丽乎天，百谷草木丽乎土。重明以丽乎正，乃化成天下。柔丽乎中正，故亨，是以畜牝牛吉也。</p>
					<p><strong>《象》曰：</strong>明两作，离。大人以继明照于四方。</p>
					<p><strong>初九：</strong>履错然，敬之，无咎。<br><strong>《象》曰：</strong>履错之敬，以辟咎也。</p>
					<p><strong>六二：</strong>黄离，元吉。<br><strong>《象》曰：</strong>黄离元吉，得中道也。</p>
					<p><strong>九三：</strong>日昃之离，不鼓缶而歌，则大耋之嗟，凶。<br><strong>《象》曰：</strong>日昃之离，何可久也？</p>
					<p><strong>九四：</strong>突如其来如，焚如，死如，弃如。<br><strong>《象》曰：</strong>突如其来如，无所容也。</p>
					<p><strong>六五：</strong>出涕沱若，戚嗟若，吉。<br><strong>《象》曰：</strong>六五之吉，离王公也。</p>
					<p><strong>上九：</strong>王用出征，有嘉折首，获匪其丑，无咎。<br><strong>《象》曰：</strong>王用出征，以正邦也。</p>
				`,
				'泽山咸第三十一': `
					<div class="hexagram-symbol">–  –<br>————<br>————<br>————<br>–  –<br>–  –</div>
					<p><strong>咸：亨。利贞，取女吉。</strong></p>
					<p><strong>《象》曰：</strong>咸，感也。柔上而刚下，二气感应以相与。止而说，男下女，是以「亨。利贞，取女吉」也。天地感而万物化生，圣人感人心而天下和平。观其所感，而天地万物之情可见矣！</p>
					<p><strong>《象》曰：</strong>山上有泽，咸。君子以虚受人。</p>
					<p><strong>初六：</strong>咸其拇。<br><strong>《象》曰：</strong>「咸其拇」，志在外也。</p>
					<p><strong>六二：</strong>咸其腓，凶。居吉。<br><strong>《象》曰：</strong>虽凶，居吉，顺不害也。</p>
					<p><strong>九三：</strong>咸其股，执其随，往吝。<br><strong>《象》曰：</strong>「咸其股」，亦不处也。志在随人，所执下也。</p>
					<p><strong>九四：</strong>贞吉，悔亡。憧憧往来，朋从尔思。<br><strong>《象》曰：</strong>「贞吉，悔亡」，未感害也。「憧憧往来」，未光大也。</p>
					<p><strong>九五：</strong>咸其晦，无悔。<br><strong>《象》曰：</strong>「咸其晦」，志末也。</p>
					<p><strong>上六:咸其辅，颊，舌。</strong><br>上为感之极位，阴柔居之，此即不能以至诚感物，唯求于口舌之间感人，乃小人女子之常态，必不能动于人，故云颊。<br><strong>象曰:</strong>咸其辅颊舌，滕口说也。<br>世间唯至诚能感人，如靠口舌说话之才，感人必不能长久。</p>
				`,
				'雷风恒第三十二': `
					<div class="hexagram-symbol">–  –<br>–  –<br>————<br>————<br>————<br>–  –</div>
					<p><strong>恒：亨。无咎。利贞。利有攸往。</strong></p>
					<p><strong>《彖》曰：</strong>恒，久也。刚上而柔下。雷风相与，巽而动，刚柔皆应，恒。恒亨无咎利贞，久于其道也。天地之道恒久而不已也。利有攸往，终则有始也。日月得天而能久照，四时变化而能久成。圣人久于其道而天下化成。观其所恒，而天地万物之情可见矣。</p>
					<p><strong>《象》曰：</strong>雷风，恒。君子以立不易方。</p>
					<p><strong>初六：</strong>浚恒，贞凶，无攸利。<br><strong>《象》曰：</strong>浚恒之凶，始求深也。</p>
					<p><strong>九二：</strong>悔亡。<br><strong>《象》曰：</strong>九二悔亡，能久中也。</p>
					<p><strong>九三：</strong>不恒其德，或承之羞，贞吝。<br><strong>《象》曰：</strong>不恒其德，无所容也。</p>
					<p><strong>九四：</strong>田无禽。<br><strong>《象》曰：</strong>久非其位，安得禽也。</p>
					<p><strong>六五：</strong>恒其德，贞，妇人吉，夫子凶。<br><strong>《象》曰：</strong>妇人贞吉，从一而终也。夫子制义，从妇凶也。</p>
					<p><strong>上六：</strong>振恒，凶。<br><strong>《象》曰：</strong>振恒在上，大无功也。</p>
				`,
				'天山遁第三十三': `
					<div class="hexagram-symbol">————<br>————<br>————<br>————<br>-   -<br>-   -</div>
					<p><strong>遁：亨。小利贞。</strong></p>
					<p><strong>《彖》曰：</strong>遁亨，遁而亨也。刚当位而应，与时行也。小利贞，浸而长也。遁之时义大矣哉！</p>
					<p><strong>《象》曰：</strong>天下有山，遁。君子以远小人，不恶而严。</p>
					<p><strong>初六：</strong>遁尾，厉，勿用有攸往。<br><strong>《象》曰：</strong>遁尾之厉，不往何灾也？</p>
					<p><strong>六二：</strong>执之用黄牛之革，莫之胜说。<br><strong>《象》曰：</strong>执用黄牛，固志也。</p>
					<p><strong>九三：</strong>系遁，有疾厉，畜臣妾吉。<br><strong>《象》曰：</strong>系遁之厉，有疾惫也。畜臣妾吉，不可大事也。</p>
					<p><strong>九四：</strong>好遁，君子吉，小人否。<br><strong>《象》曰：</strong>君子好遁，小人否也。</p>
					<p><strong>九五：</strong>嘉遁，贞吉。<br><strong>《象》曰：</strong>嘉遁贞吉，以正志也。</p>
					<p><strong>上九：</strong>肥遁，无不利。<br><strong>《象》曰：</strong>肥遁无不利，无所疑也。</p>
				`,
				'雷天大壮第三十四': `
					<div class="hexagram-symbol">–  –<br>–  –<br>————<br>————<br>————<br>————</div>
					<p><strong>大壮：利贞。</strong></p>
					<p><strong>《彖》曰：</strong>大壮，大者壮也。刚以动，故壮。大壮利贞，大者正也。正大，而天地之情可见矣。</p>
					<p><strong>《象》曰：</strong>雷在天上，大壮。君子以非礼弗履。</p>
					<p><strong>初九：</strong>壮于趾，征凶，有孚。<br><strong>《象》曰：</strong>壮于趾，其孚穷也。</p>
					<p><strong>九二：</strong>贞吉。<br><strong>《象》曰：</strong>九二「贞吉」，以中也。</p>
					<p><strong>九三：</strong>小人用壮，君子用罔，贞厉。羝羊触藩，羸其角。<br><strong>《象》曰：</strong>小人用壮，君子以罔也。</p>
					<p><strong>九四：</strong>贞吉，悔亡。藩决不羸，壮于大舆之輹。<br><strong>《象》曰：</strong>藩决不羸，尚往也。</p>
					<p><strong>六五：</strong>丧羊于易，无悔。<br><strong>《象》曰：</strong>丧羊于易，位不当也。</p>
					<p><strong>上六：</strong>羝羊触藩，不能退，不能遂，无攸利，艰则吉。<br><strong>《象》曰：</strong>不能退，不能遂，不详也。艰则吉，咎不长也。</p>
				`,
				'火地晋第三十五': `
					<div class="hexagram-symbol">————<br>–  –<br>————<br>–  –<br>–  –<br>–  –</div>
					<p><strong>晋：康侯用锡马蕃庶，昼日三接。</strong></p>
					<p><strong>《彖》曰：</strong>晋，进也，明出地上。顺而丽乎大明，柔进而上行，是以康侯用锡马蕃庶，昼日三接也。</p>
					<p><strong>《象》曰：</strong>明出地上，晋。君子以自昭明德。</p>
					<p><strong>初六：</strong>晋如，摧如，贞吉。罔孚，裕，无咎。<br><strong>《象》曰：</strong>晋如，摧如，独行正也。裕，无咎。未受命也。</p>
					<p><strong>六二：</strong>晋如，愁如，贞吉。受兹介福，于其王母。<br><strong>《象》曰：</strong>受兹介福，以中正也。</p>
					<p><strong>六三：</strong>众允，悔亡。<br><strong>《象》曰：</strong>众允之志，上行也。</p>
					<p><strong>九四：</strong>晋如，鼫鼠，贞厉。<br><strong>《象》曰：</strong>鼫鼠贞厉，位不当也。</p>
					<p><strong>六五：</strong>悔亡，失得，勿恤。往，吉，无不利。<br><strong>《象》曰：</strong>失得勿恤，往有庆也。</p>
					<p><strong>上九：</strong>晋其角，维用伐邑，厉，吉，无咎，贞吝。<br><strong>《象》曰：</strong>维用伐邑，道未光也。</p>
				`,
				'地火明夷第三十六': `
					<div class="hexagram-symbol">–  –<br>-  -<br>-   -<br>————<br>–  –<br>————</div>
					<p><strong>明夷：利艰贞。</strong></p>
					<p><strong>《彖》曰：</strong>明入地中，「明夷」。内文明而外柔顺，以蒙大难，文王以之。利艰贞，晦其明也，内难而能正其志，箕子以之。</p>
					<p><strong>《象》曰：</strong>明入地中，明夷。君子以莅众用晦而明。</p>
					<p><strong>初九：</strong>明夷于飞，垂其翼。君子于行，三日不食。有攸往，主人有言。<br><strong>《象》曰：</strong>君子于行，义不食也。</p>
					<p><strong>六二：</strong>明夷，夷于左股，用拯马壮，吉。<br><strong>《象》曰：</strong>六二之吉，顺以则也。</p>
					<p><strong>九三：</strong>明夷于南狩，得其大首，不可疾贞。<br><strong>《象》曰：</strong>南狩之志，乃得大也。</p>
					<p><strong>六四：</strong>入于左腹，获明夷之心，于出门庭。<br><strong>《象》曰：</strong>入于左腹，获心意也。</p>
					<p><strong>六五：</strong>箕子之明夷，利贞。<br><strong>《象》曰：</strong>箕子之贞，明不可息也。</p>
					<p><strong>上六：</strong>不明晦，初登于天，后入于地。<br><strong>《象》曰：</strong>初登于天，照四国也。后入天地，失则也。</p>
				`,
				'风火家人第三十七': `
					<div class="hexagram-symbol">————<br>————<br>–  –<br>————<br>–  –<br>————</div>
					<p><strong>家人：利女贞。</strong></p>
					<p><strong>《彖》曰：</strong>家人，女正位乎内，男正位乎外。男女正，天地之大义也。家人有严君焉，父母之谓也。父父，子子，兄兄，弟弟，夫夫，妇妇，而家道正。正家而天下定矣。</p>
					<p><strong>《象》曰：</strong>风自火出，家人。君子以言有物而行有恒。</p>
					<p><strong>初九：</strong>闲有家，悔亡。<br><strong>《象》曰：</strong>闲有家，志未变也。</p>
					<p><strong>六二：</strong>无攸遂，在中馈，贞吉。<br><strong>《象》曰：</strong>六二之吉，顺以巽也。</p>
					<p><strong>九三：</strong>家人嗃嗃，悔厉，吉。妇子嘻嘻，终吝。<br><strong>《象》曰：</strong>家人嗃嗃，未失也。妇子嘻嘻，失家节也。</p>
					<p><strong>六四：</strong>富家，大吉。<br><strong>《象》曰：</strong>富家大吉，顺在位也。</p>
					<p><strong>九五：</strong>王假有家，勿恤，吉。<br><strong>《象》曰：</strong>王假有家，交相爱也。</p>
					<p><strong>上九，有孚，威如，终吉。</strong><br><strong>《象》曰：</strong>威如之吉，反身之谓也。</p>
				`,
				'火泽睽第三十八': `
					<div class="hexagram-symbol">————<br>–  –<br>————<br>–  –<br>————<br>————</div>
					<p><strong>睽：小事吉。</strong></p>
					<p><strong>《彖》曰：</strong>睽，火动而上，泽动而下。二女同居，其志不同行。说而丽乎明，柔进而上行，得中而应乎刚，是以小事吉。天地睽而其事同也。男女睽而其志通也。万物睽而其事类也，睽之时用大矣哉！</p>
					<p><strong>《象》曰：</strong>上火下泽，睽。君子以同而异。</p>
					<p><strong>初九：</strong>悔亡。丧马，勿逐，自复。见恶人，无咎。<br><strong>《象》曰：</strong>见恶人，以辟咎也。</p>
					<p><strong>九二：</strong>遇主于巷，无咎。<br><strong>《象》曰：</strong>遇主于巷，未失道也。</p>
					<p><strong>六三：</strong>见舆曳，其牛掣，其人天且劓，无初有终。<br><strong>《象》曰：</strong>见舆曳，位不当也。无初有终，遇刚也。</p>
					<p><strong>九四：</strong>睽孤，遇元夫，交孚，厉，无咎。<br><strong>《象》曰：</strong>交孚无咎，志行也。</p>
					<p><strong>六五：</strong>悔亡。厥宗噬肤，往何咎。<br><strong>《象》曰：</strong>厥宗噬肤，往有庆也。</p>
					<p><strong>上九：</strong>睽孤，见豕负途，载鬼一车，先张之弧，后说之弧，匪寇，婚媾。往遇雨则吉。<br><strong>《象》曰：</strong>遇雨之吉，群疑亡也。</p>
				`,
				'水山蹇第三十九': `
					<div class="hexagram-symbol">–  –<br>————<br>–  –<br>————<br>–  –<br>–  –</div>
					<p><strong>蹇：利西南，不利东北。利见大人。贞吉。</strong></p>
					<p><strong>《彖》曰：</strong>蹇，难也，险在前也。见险而能止，知矣哉！蹇，利西南，往得中也。不利东北，其道穷也。利见大人，往有功也。当位贞吉，以正邦也。蹇之时用大矣哉！</p>
					<p><strong>《象》曰：</strong>山上有水，蹇。君子以反身修德。</p>
					<p><strong>初六：</strong>往蹇，来誉。<br><strong>《象》曰：</strong>往蹇来誉，宜待也。</p>
					<p><strong>六二：</strong>王臣蹇蹇，匪躬之故。<br><strong>《象》曰：</strong>王臣蹇蹇，终无尤也。</p>
					<p><strong>九三：</strong>往蹇，来反。<br><strong>《象》曰：</strong>往蹇，来反，内喜之也。</p>
					<p><strong>六四：</strong>往蹇，来连。<br><strong>《象》曰：</strong>往蹇，来连，当位实也。</p>
					<p><strong>九五：</strong>大蹇，朋来。<br><strong>《象》曰：</strong>大蹇，朋来，以中节也。</p>
					<p><strong>上六：</strong>往蹇，来硕，吉，利见大人。<br><strong>《象》曰：</strong>往蹇，来硕，志在内也。利见大人，以从贵也。</p>
				`,
					'雷水解第四十': `
						<div class="hexagram-symbol">–  –<br>–  –<br>————<br>–  –<br>————<br>–  –</div>
						<p><strong>解：利西南。无所往，其来复，吉。有攸往，夙吉。</strong></p>
						<p><strong>《彖》曰：</strong>解，险以动，动而免乎险，解。解，利西南，往得众也。其来复吉，乃得中也。有攸往夙吉，往有功也。天地解而雷雨作，雷雨作而百果草木皆甲坼。解之时大矣哉！</p>
						<p><strong>《象》曰：</strong>雷雨作，解。君子以赦过宥罪。</p>
						<p><strong>初六：</strong>无咎。<br><strong>《象》曰：</strong>刚柔之际，义无咎也。</p>
						<p><strong>九二：</strong>田获三狐，得黄矢，贞吉。<br><strong>《象》曰：</strong>九二贞吉，得中道也。</p>
						<p><strong>六三：</strong>负且乘，致寇至，贞吝。<br><strong>《象》曰：</strong>负且乘，亦可丑也。自我致戎，又谁咎也？</p>
						<p><strong>九四：</strong>解而拇，朋至斯孚。<br><strong>《象》曰：</strong>解而拇，未当位也。</p>
						<p><strong>六五：</strong>君子维有解，吉，有孚于小人。<br><strong>《象》曰：</strong>君子有解，小人退也。</p>
						<p><strong>上六：</strong>公用射隼，于高墉之上，获之，无不利。<br><strong>《象》曰：</strong>公用射隼，以解悖也。</p>
						`,
						'山泽损第四十一': `
						<div class="hexagram-symbol">————<br>–  –<br>–  –<br>–  –<br>————<br>————</div>
						<p><strong>损：有孚，元吉，无咎。可贞，利有攸往。曷之用，二簋可用享。</strong></p>
						<p><strong>《彖》曰：</strong>损，损下益上，其道上行。损而有孚，元吉，无咎，可贞，利有攸往，曷之用？二簋可用享。二簋应有时。损刚益柔有时，损益盈虚，与时偕行。</p>
						<p><strong>《象》曰：</strong>山下有泽，损。君子以惩忿窒欲。</p>
						<p><strong>初九：</strong>已事遄往，无咎。酌损之。<br><strong>《象》曰：</strong>已事遄往，尚合志也。</p>
						<p><strong>九二：</strong>利贞，征凶。弗损，益之。<br><strong>《象》曰：</strong>九二利贞，中以为志也。</p>
						<p><strong>六三：</strong>三人行，则损一人，一人行，则得其友。<br><strong>《象》曰：</strong>一人行，三则疑也。</p>
						<p><strong>六四：</strong>损其疾，使遄有喜，无咎。<br><strong>《象》曰：</strong>损其疾，亦可喜也。</p>
						<p><strong>六五：</strong>或益之，十朋之龟，弗克违，元吉。<br><strong>《象》曰：</strong>六五元吉，自上祐也。</p>
						<p><strong>上九：</strong>弗损，益之，无咎，贞吉，利有攸往，得臣无家。<br><strong>《象》曰：</strong>弗损，益之，大得志也。</p>
						`,
				'风雷益第四十二': `
					<div class="hexagram-symbol">————<br>————<br>–  –<br>–  –<br>–  –<br>————</div>
					<p><strong>益：利有攸往。利涉大川。</strong></p>
					<p><strong>《彖》曰：</strong>益，损上益下，民说无疆。自上下下，其道大光。利有攸往，中正有庆。利涉大川，木道乃行。益动而巽，日进无疆。天施地生，其益无方。凡益之道，与时偕行。</p>
					<p><strong>《象》曰：</strong>风雷，益。君子以见善则迁，有过则改。</p>
					<p><strong>初九：</strong>利用为大作，元吉，无咎。<br><strong>《象》曰：</strong>元吉无咎，下不厚事也。</p>
					<p><strong>六二：</strong>或益之，十朋之龟，弗克违，永贞吉。王用享于帝，吉。<br><strong>《象》曰：</strong>或益之，自外来也。</p>
					<p><strong>六三：</strong>益之，用凶事，无咎。有孚，中行，告公用圭。<br><strong>《象》曰：</strong>益用凶事，固有之也。</p>
					<p><strong>六四：</strong>中行，告公从。利用为依迁国。<br><strong>《象》曰：</strong>告公从，以益志也。</p>
					<p><strong>九五：</strong>有孚惠心，勿问元吉。有孚，惠我德。<br><strong>《象》曰：</strong>有孚惠心，勿问之矣。惠我德，大得志也。</p>
					<p><strong>上九：</strong>莫益之，或击之，立心勿恒，凶。<br><strong>《象》曰：</strong>莫益之，偏辞也。或击之，自外来也。</p>
				`,
				'泽天夬第四十三': `
					<div class="hexagram-symbol">–  –<br>————<br>————<br>————<br>————<br>————</div>
					<p><strong>夬：扬于王庭，孚号。有厉，告自邑。不利即戎，利有攸往。</strong></p>
					<p><strong>《彖》曰：</strong>夬，决也，刚决柔也。健而说，决而和。扬于王庭，柔乘五刚也。孚号有厉，其危乃光也。告自邑，不利即戎，所尚乃穷也。利有攸往，刚长乃终也。</p>
					<p><strong>《象》曰：</strong>泽上于天，夬。君子以施禄及下，居德则忌。</p>
					<p><strong>初九：</strong>壮于前趾，往不胜，为咎。<br><strong>《象》曰：</strong>不胜而往，咎也。</p>
					<p><strong>九二：</strong>惕号，莫夜有戎，勿恤。<br><strong>《象》曰：</strong>有戎勿恤，得中道也。</p>
					<p><strong>九三：</strong>壮于頄，有凶。君子夬夬，独行遇雨若濡，有愠，无咎。<br><strong>《象》曰：</strong>君子夬夬，终无咎也。</p>
					<p><strong>九四：</strong>臀无肤，其行次且。牵羊悔亡，闻言不信。<br><strong>《象》曰：</strong>其行次且，位不当也。闻言不信，聪不明也。</p>
					<p><strong>九五：</strong>苋陆夬夬，中行无咎。<br><strong>《象》曰：</strong>中行无咎，中未光也。</p>
					<p><strong>上六：</strong>无号，终有凶。<br><strong>《象》曰：</strong>无号之凶，终不可长也。</p>
				`,
				'天风姤第四十四': `
					<div class="hexagram-symbol">————<br>————<br>————<br>————<br>————<br>-   -</div>
					<p><strong>姤：女壮，勿用取女。</strong></p>
					<p><strong>《彖》曰：</strong>姤，遇也，柔遇刚也。勿用取女，不可与长也。天地相遇，品物咸章也。刚遇中正，天下大行也。姤之时义大矣哉！</p>
					<p><strong>《象》曰：</strong>天下有风，姤。后以施命诰四方。</p>
					<p><strong>初六：</strong>系于金柅，贞吉。有攸往，见凶，羸豕孚蹢躅。<br><strong>《象》曰：</strong>系于金柅，柔道牵也。</p>
					<p><strong>九二：</strong>包有鱼，无咎，不利宾。<br><strong>《象》曰：</strong>包有鱼，义不及宾也。</p>
					<p><strong>九三：</strong>臀无肤，其行次且，厉，无大咎。<br><strong>《象》曰：</strong>其行次且，行未牵也。</p>
					<p><strong>九四：</strong>包无鱼，起凶。<br><strong>《象》曰：</strong>无鱼之凶，远民也。</p>
					<p><strong>九五：</strong>以杞包瓜，含章，有陨自天。<br><strong>《象》曰：</strong>九五含章，中正也。有陨自天，志不舍命也。</p>
					<p><strong>上九：</strong>姤其角，吝，无咎。<br><strong>《象》曰：</strong>姤其角，上穷吝也。</p>
				`,
				'泽地萃第四十五': `
					<div class="hexagram-symbol">–  –<br>————<br>————<br>–  –<br>–  –<br>–  –</div>
					<p><strong>萃：亨，王假有庙。利见大人。亨，利贞，用大牲吉。利有攸往。</strong></p>
					<p><strong>《彖》曰：</strong>萃，聚也。顺以说，刚中而应，故聚也。王假有庙，致孝享也。利见大人亨，聚以正也。用大牲吉，利有攸往，顺天命也。观其所聚，而天地万物之情可见矣。</p>
					<p><strong>《象》曰：</strong>泽上于地，萃。君子以除戎器，戒不虞。</p>
					<p><strong>初六：</strong>有孚不终，乃乱乃萃，若号，一握为笑，勿恤，往无咎。<br><strong>《象》曰：</strong>乃乱乃萃，其志乱也。</p>
					<p><strong>六二：</strong>引吉，无咎，孚乃利用禴。<br><strong>《象》曰：</strong>引吉无咎，中未变也。</p>
					<p><strong>六三：</strong>萃如，嗟如，无攸利，往无咎，小吝。<br><strong>《象》曰：</strong>往无咎，上巽也。</p>
					<p><strong>九四：</strong>大吉，无咎。<br><strong>《象》曰：</strong>大吉无咎，位不当也。</p>
					<p><strong>九五：</strong>萃有位，无咎。匪孚，元永贞，悔亡。<br><strong>《象》曰：</strong>萃有位，志未光也。</p>
					<p><strong>上六：</strong>赍咨涕洟，无咎。<br><strong>《象》曰：</strong>赍咨涕洟，未安上也。</p>
				`,
				'地风升第四十六': `
					<div class="hexagram-symbol">–  –<br>–  –<br>–  –<br>————<br>————<br>–  –</div>
					<p><strong>升：元亨。用见大人，勿恤。南征，吉。</strong></p>
					<p><strong>《彖》曰：</strong>柔以时升，巽而顺，刚中而应，是以大亨，用见大人，勿恤，有庆也。南征，吉，志行也。</p>
					<p><strong>《象》曰：</strong>地中生木，升。君子以顺德，积小以高大。</p>
					<p><strong>初六：</strong>允升，大吉。<br><strong>《象》曰：</strong>允升大吉，上合志也。</p>
					<p><strong>九二：</strong>孚乃利用禴，无咎。<br><strong>《象》曰：</strong>九二之孚，有喜也。</p>
					<p><strong>九三：</strong>升虚邑。<br><strong>《象》曰：</strong>升虚邑，无所疑也。</p>
					<p><strong>六四：</strong>王用亨于岐山，吉，无咎。<br><strong>《象》曰：</strong>王用亨于岐山，顺事也。</p>
					<p><strong>六五：</strong>贞吉，升阶。<br><strong>《象》曰：</strong>贞吉升阶，大得志也。</p>
					<p><strong>上六：</strong>冥升，利于不息之贞。<br><strong>《象》曰：</strong>冥升在上，消不富也。</p>
				`,
				'泽水困第四十七': `
					<div class="hexagram-symbol">–  –<br>————<br>————<br>–  –<br>————<br>–  –</div>
					<p><strong>困：亨。贞大人吉，无咎。有言不信。</strong></p>
					<p><strong>《彖》曰：</strong>困，刚揜也。险以说，因而不失其所，亨，其唯君子乎。贞大人吉，以刚中也。有言不信，尚口乃穷也。</p>
					<p><strong>《象》曰：</strong>泽无水，困。君子以致命遂志。</p>
					<p><strong>初六：</strong>臀困于株木，入于幽谷，三岁不觌。<br><strong>《象》曰：</strong>入于幽谷，幽不明也。</p>
					<p><strong>九二：</strong>困于酒食，朱绂方来。利用享祀。征凶，无咎。<br><strong>《象》曰：</strong>困于酒食，中有庆也。</p>
					<p><strong>六三：</strong>困于石，据于蒺藜，入于其宫，不见其妻，凶。<br><strong>《象》曰：</strong>据于蒺藜，乘刚也。入于其宫，不见其妻，不祥也。</p>
					<p><strong>九四：</strong>来徐徐，困于金车，吝，有终。<br><strong>《象》曰：</strong>来徐徐，志在下也。虽不当位，有与也。</p>
					<p><strong>九五：</strong>劓刖，困于赤绂，乃徐有说，利用祭祀。<br><strong>《象》曰：</strong>劓刖，志未得也。乃徐有说，以中直也。利用祭祀，受福也。</p>
					<p><strong>上六：</strong>困于葛藟，于臲臲，曰动悔，有悔，征吉。<br><strong>《象》曰：</strong>困于葛藟，未当也。动悔，有悔，吉，行也。</p>
				`,
				'水风井第四十八': `
					<div class="hexagram-symbol">–  –<br>————<br>–  –<br>————<br>————<br>–  –</div>
					<p><strong>井：改邑不改井，无丧无得。往来井井。汔至，亦未繘井，羸其瓶，凶。</strong></p>
					<p><strong>《彖》曰：</strong>巽乎水而上水，井。井养而不穷也。改邑不改井，乃以刚中也。汔至亦未繘，井，未有功也。羸其瓶，是以凶也。</p>
					<p><strong>《象》曰：</strong>木上有水，井。君子以劳民劝相。</p>
					<p><strong>初六：</strong>井泥不食。旧井无禽。<br><strong>《象》曰：</strong>井泥不食，下也。旧井无禽，时舍也。</p>
					<p><strong>九二：</strong>井谷射鲋，瓮敝漏。<br><strong>《象》曰：</strong>井谷射鲋，无与也。</p>
					<p><strong>九三：</strong>井渫不食，为我心恻。可用汲，王明并受其福。<br><strong>《象》曰：</strong>井渫不食，行恻也。求王明，受福也。</p>
					<p><strong>六四：</strong>井甃，无咎。<br><strong>《象》曰：</strong>井甃无咎，修井也。</p>
					<p><strong>九五：</strong>井洌，寒泉食。<br><strong>《象》曰：</strong>寒泉之食，中正也。</p>
					<p><strong>上六：</strong>井收勿幕，有孚元吉。<br><strong>《象》曰：</strong>元吉在上，大成也。</p>
				`,
				'泽火革第四十九': `
					<div class="hexagram-symbol">–  –<br>————<br>————<br>————<br>–  –<br>————</div>
					<p><strong>革：已日乃孚。元亨。利贞，悔亡。</strong></p>
					<p><strong>《彖》曰：</strong>革，水火相息，二女同居，其志不相得曰革。已日乃孚，革而信之。文明以说，大亨以正。革而当，其悔乃亡。天地革而四时成，汤武革命，顺乎天而应乎人。革之时大矣哉！</p>
					<p><strong>《象》曰：</strong>泽中有火，革。君子以治历明时。</p>
					<p><strong>初九：</strong>巩用黄牛之革。<br><strong>《象》曰：</strong>巩用黄牛，不可以有为也。</p>
					<p><strong>六二：</strong>巳日乃革之，征吉，无咎。<br><strong>《象》曰：</strong>巳日革之，行有嘉也。</p>
					<p><strong>九三：</strong>征凶，贞厉。革言三就，有孚。<br><strong>《象》曰：</strong>革言三就，又何之矣。</p>
					<p><strong>九四：</strong>悔亡。有孚，改命，吉。<br><strong>《象》曰：</strong>改命之吉，信志也。</p>
					<p><strong>九五：</strong>大人虎变，未占有孚。<br><strong>《象》曰：</strong>大人虎变，其文炳也。</p>
					<p><strong>上六：</strong>君子豹变，小人革面，征凶，居贞吉。<br><strong>《象》曰：</strong>君子豹变，其文蔚也。小人革面，顺以从君也。</p>
				`,
				'火风鼎第五十': `
					<div class="hexagram-symbol">————<br>–  –<br>————<br>————<br>————<br>–  –</div>
					<p><strong>鼎：元吉，亨。</strong></p>
					<p><strong>《彖》曰：</strong>鼎，象也。以木巽火，亨饪也。圣人亨以享上帝，而大亨以养圣贤。巽而耳目聪明，柔进而上行，得中而应乎刚，是以元亨。</p>
					<p><strong>《象》曰：</strong>木上有火，鼎。君子以正位凝命。</p>
					<p><strong>初六：</strong>鼎颠趾，利出否。得妾以其子，无咎。<br><strong>《象》曰：</strong>鼎颠趾，未悖也。利出否，以从贵也。</p>
					<p><strong>九二：</strong>鼎有实，我仇有疾，不我能即，吉。<br><strong>《象》曰：</strong>鼎有实，慎所之也。我仇有疾，终无尤也。</p>
					<p><strong>九三：</strong>鼎耳革，其行塞，雉膏不食，方雨，亏悔，终吉。<br><strong>《象》曰：</strong>鼎耳革，失其义也。</p>
					<p><strong>九四：</strong>鼎折足，覆公餗，其形渥，凶。<br><strong>《象》曰：</strong>覆公餗，信如何也。</p>
					<p><strong>六五：</strong>鼎黄耳，金铉，利贞。<br><strong>《象》曰：</strong>鼎黄耳，中以为实也。</p>
					<p><strong>上九：</strong>鼎玉铉，大吉，无不利。<br><strong>《象》曰：</strong>玉铉在上，刚柔节也。</p>
				`,
				'震为雷第五十一': `
					<div class="hexagram-symbol">–  –<br>–  –<br>————<br>–  –<br>–  –<br>————</div>
					<p><strong>震：亨。震来虩虩，笑言哑哑，震惊百里，不丧匕鬯。</strong></p>
					<p><strong>《彖》曰：</strong>震，亨。「震来虩虩」，恐致福也。「笑言哑哑」，后有则也。震惊百里，惊远而惧迩也。不丧匕鬯，出可以守宗庙社稷，以为祭主也。</p>
					<p><strong>《象》曰：</strong>洊雷，震。君子以恐惧修省。</p>
					<p><strong>初九：</strong>震来虩虩，后笑言哑哑，吉。<br><strong>《象》曰：</strong>震来虩虩，恐致福也。笑言哑哑，后有则也。</p>
					<p><strong>六二：</strong>震来厉，亿丧贝，跻于九陵，勿逐，七日得。<br><strong>《象》曰：</strong>震来厉，乘刚也。</p>
					<p><strong>六三：</strong>震苏苏，震行无眚。<br><strong>《象》曰：</strong>震苏苏，位不当也。</p>
					<p><strong>九四：</strong>震遂泥。<br><strong>《象》曰：</strong>震遂泥，未光也。</p>
					<p><strong>六五：</strong>震往来，厉，意无丧，有事。<br><strong>《象》曰：</strong>震往来厉，危行也。其事在中，大无丧也。</p>
					<p><strong>上六：</strong>震索索，视矍矍，征凶。震不于其躬，于其邻，无咎。婚媾有言。<br><strong>《象》曰：</strong>震索索，中未得也。虽凶无咎，畏邻戒也。</p>
				`,
				'艮为山第五十二': `
					<div class="hexagram-symbol">————<br>–  –<br>–  –<br>————<br>–  –<br>–  –</div>
					<p><strong>艮：艮其背，不获其身，行其庭，不见其人，无咎。</strong></p>
					<p><strong>《彖》曰：</strong>艮，止也。时止则止，时行则行，动静不失其时，其道光明。艮其止，止其所也。上下敌应，不相与也。是以不获其身、行其庭不见其人、无咎也。</p>
					<p><strong>《象》曰：</strong>兼山，艮。君子以思不出其位。</p>
					<p><strong>初六：</strong>艮其趾，无咎。利永贞。<br><strong>《象》曰：</strong>艮其趾，未失正也。</p>
					<p><strong>六二：</strong>艮其腓，不拯其随，其心不快。<br><strong>《象》曰：</strong>不拯其随，未退听也。</p>
					<p><strong>九三，艮其限，列其夤，厉熏心。</strong><br><strong>《象》曰：</strong>艮其限，危熏心也。</p>
					<p><strong>六四：</strong>艮其身，无咎。<br><strong>《象》曰：</strong>艮其身，止诸躬也。</p>
					<p><strong>六五：</strong>艮其辅，言有序，悔亡。<br><strong>《象》曰：</strong>艮其辅，以中正也。</p>
					<p><strong>上九，敦艮，吉。</strong><br><strong>《象》曰：</strong>敦艮之吉，以厚终也。</p>
				`,
				'风山渐第五十三': `
					<div class="hexagram-symbol">————<br>————<br>–  –<br>————<br>–  –<br>–  –</div>
					<p><strong>渐：女归吉，利贞。</strong></p>
					<p><strong>《彖》曰：</strong>渐之进也，女归吉也。进得位，往有功也。进以正，可以正邦也。其位刚得中也。止而巽，动不穷也。</p>
					<p><strong>《象》曰：</strong>山上有木，渐。君子以居贤德善俗。</p>
					<p><strong>初六：</strong>鸿渐于干。小子厉，有言，无咎。<br><strong>《象》曰：</strong>小子之厉，义无咎也。</p>
					<p><strong>六二：</strong>鸿渐于磐，饮食衎衎，吉。<br><strong>《象》曰：</strong>饮食衎衎，不素饱也。</p>
					<p><strong>九三：</strong>鸿渐于陆。夫征不复，妇孕不育，凶。利御寇。<br><strong>《象》曰：</strong>夫征不复，离群丑也。妇孕不育，失其道也。利用御寇，顺相保也。</p>
					<p><strong>六四：</strong>鸿渐于木，或得其桷，无咎。<br><strong>《象》曰：</strong>或得其桷，顺以巽也。</p>
					<p><strong>九五：</strong>鸿渐于陵，妇三岁不孕，终莫之胜，吉。<br><strong>《象》曰：</strong>终莫之胜吉，得所愿也。</p>
					<p><strong>上九：</strong>鸿渐于陆，其羽可用为仪，吉。<br><strong>《象》曰：</strong>其羽可用为仪吉，不可乱也。</p>
				`,
				'雷泽归妹第五十四': `
					<div class="hexagram-symbol">–  –<br>–  –<br>————<br>–  –<br>————<br>————</div>
					<p><strong>归妹：征凶，无攸利。</strong></p>
					<p><strong>《彖》曰：</strong>归妹，天地之大义也。天地不交而万物不兴。归妹，人之终始也。说以动，所归妹也。征凶，位不当也。无攸利，柔乘刚也。</p>
					<p><strong>《象》曰：</strong>泽上有雷，归妹。君子以永终知敝。</p>
					<p><strong>初九：</strong>归妹以娣。跛能履，征吉。<br><strong>《象》曰：</strong>归妹以娣，以恒也。跛能履吉，相承也。</p>
					<p><strong>九二：</strong>眇能视，利幽人之贞。<br><strong>《象》曰：</strong>「利幽人之贞」，未变常也。</p>
					<p><strong>六三，归妹以须，反归以娣。</strong><br><strong>《象》曰：</strong>归妹以须，未当也。</p>
					<p><strong>九四：</strong>归妹愆期，迟归有时。<br><strong>《象》曰：</strong>愆期之志，有待而行也。</p>
					<p><strong>六五：</strong>帝乙归妹，其君之袂不如其娣之袂良。月几望，吉。<br><strong>《象》曰：</strong>帝乙归妹，不如其娣之袂良也。其位在中，以贵行也。</p>
					<p><strong>上六：</strong>女承筐无实，士刲羊无血，无攸利。<br><strong>《象》曰：</strong>上六无实，承虚筐也。</p>
				`,
				'雷火丰第五十五': `
					<div class="hexagram-symbol">-  -<br>-  -<br>————<br>————<br>-  -<br>————</div>
					<p><strong>丰：亨，王假之。勿忧，宜日中。</strong></p>
					<p><strong>《彖》曰：</strong>丰，大也。明以动，故丰。王假之，尚大也。勿忧宜日中，宜照天下也。日中则昃，月盈则食，天地盈虚，与时消息，而况于人乎，况于鬼神乎。</p>
					<p><strong>《象》曰：</strong>雷电皆至，丰。君子以折狱致刑。</p>
					<p><strong>初九：</strong>遇其配主，虽旬无咎，往有尚。<br><strong>《象》曰：</strong>虽旬无咎，过旬灾也。</p>
					<p><strong>六二：</strong>丰其蔀，日中见斗。往得疑疾，有孚发若，吉。<br><strong>《象》曰：</strong>有孚发若，信以发志也。</p>
					<p><strong>九三：</strong>丰其沛，日中见沫，折其右肱，无咎。<br><strong>《象》曰：</strong>丰其沛，不可大事也。折其右肱，终不可用也。</p>
					<p><strong>九四：</strong>丰其蔀，日中见斗，遇其夷主，吉。<br><strong>《象》曰：</strong>丰其蔀，位不当也。日中见斗，幽不明也。遇其夷主，吉行也。</p>
					<p><strong>六五：</strong>来章有庆誉，吉。<br><strong>《象》曰：</strong>六五之吉，有庆也。</p>
					<p><strong>上六：</strong>丰其屋，蔀其家，窥其户，阒其无人，三岁不觌，凶。<br><strong>《象》曰：</strong>丰其屋，天际翔也。窥其户，阒其无人，自藏也。</p>
				`,
				'火山旅第五十六': `
					<div class="hexagram-symbol">————<br>–  –<br>————<br>————<br>–  –<br>–  –</div>
					<p><strong>旅：小亨。旅贞吉。</strong></p>
					<p><strong>《彖》曰：</strong>旅小亨，柔得中乎外，而顺乎刚，止而丽乎明，是以小亨旅贞吉也。旅之时义大矣哉！</p>
					<p><strong>《象》曰：</strong>山上有火，旅。君子以明慎用刑而不留狱。</p>
					<p><strong>初六：</strong>旅琐琐，斯其所取灾。<br><strong>《象》曰：</strong>旅琐琐，志穷灾也。</p>
					<p><strong>六二：</strong>旅即次，怀其资，得童仆，贞。<br><strong>《象》曰：</strong>得童仆贞，终无尤也。</p>
					<p><strong>九三：</strong>旅焚其次，丧其童仆，贞厉。<br><strong>《象》曰：</strong>旅焚其次，亦以伤矣。以旅与下，其义丧也。</p>
					<p><strong>九四：</strong>旅于处，得其资斧，我心不快。<br><strong>《象》曰：</strong>旅于处，未得位也。得其资斧，心未快也。</p>
					<p><strong>六五：</strong>射雉，一矢亡，终以誉命。<br><strong>《象》曰：</strong>终以誉命，上逮也。</p>
					<p><strong>上九：</strong>鸟焚其巢，旅人先笑后号咷。丧牛于易，凶。<br><strong>《象》曰：</strong>以旅在上，其义焚也。丧牛于易，终莫之闻也。</p>
				`,
				'巽为风第五十七': `
					<div class="hexagram-symbol">————<br>————<br>–  –<br>————<br>————<br>–  –</div>
					<p><strong>巽：小亨。利有攸往。利见大人。</strong></p>
					<p><strong>《彖》曰：</strong>重巽以申命。刚巽乎中正而志行。柔皆顺乎刚，是以小亨、利有攸往、利见大人。</p>
					<p><strong>《象》曰：</strong>随风，巽。君子以申命行事。</p>
					<p><strong>初六：</strong>进退，利武人之贞。<br><strong>《象》曰：</strong>进退，志疑也。利武人之贞，志治也。</p>
					<p><strong>九二：</strong>巽在床下，用史巫纷若，吉，无咎。<br><strong>《象》曰：</strong>纷若之吉，得中也。</p>
					<p><strong>九三：</strong>频巽，吝。<br><strong>《象》曰：</strong>频巽之吝，志穷也。</p>
					<p><strong>六四：</strong>悔亡，田获三品。<br><strong>《象》曰：</strong>田获三品，有功也。</p>
					<p><strong>九五：</strong>贞吉，悔亡，无不利，无初有终。先庚三日，后庚三日，吉。<br><strong>《象》曰：</strong>九五之吉，位正中也。</p>
					<p><strong>上九：</strong>巽在床下，丧其资斧，贞凶。<br><strong>《象》曰：</strong>巽在床下，上穷也。丧其资斧，正乎凶也。</p>
				`,
				'兑为泽第五十八': `
					<div class="hexagram-symbol">–  –<br>————<br>————<br>–  –<br>————<br>————</div>
					<p><strong>兑：亨。利贞。</strong></p>
					<p><strong>《彖》曰：</strong>兑，说也。刚中而柔外，说以利贞，是以顺乎天而应乎人。说以先民，民忘其劳。说以犯难，民忘其死。说之大，民劝矣哉！</p>
					<p><strong>《象》曰：</strong>丽泽，兑。君子以朋友讲习。</p>
					<p><strong>初九：</strong>和兑，吉。<br><strong>《象》曰：</strong>和兑之吉，行未疑也。</p>
					<p><strong>九二：</strong>孚兑，吉，悔亡。<br><strong>《象》曰：</strong>孚兑之吉，信志也。</p>
					<p><strong>六三：</strong>来兑，凶。<br><strong>《象》曰：</strong>来兑之凶，位不当也。</p>
					<p><strong>九四：</strong>商兑未宁，介疾有喜。<br><strong>《象》曰：</strong>九四之喜，有庆也。</p>
					<p><strong>九五：</strong>孚于剥，有厉。<br><strong>《象》曰：</strong>孚于剥，位正当也。</p>
					<p><strong>上六：</strong>引兑。<br><strong>《象》曰：</strong>上六引兑，未光也。</p>
				`,
				'风水涣第五十九': `
					<div class="hexagram-symbol">————<br>————<br>–  –<br>–  –<br>————<br>–  –</div>
					<p><strong>涣：亨。王假有庙。利涉大川，利贞。</strong></p>
					<p><strong>《彖》曰：</strong>涣，亨，刚来而不穷，柔得位乎外而上同。「王假有庙」，王乃在中也。「利涉大川」，乘木有功也。</p>
					<p><strong>《象》曰：</strong>风行水上，涣。先王以享于帝，立庙。</p>
					<p><strong>初六：</strong>用拯马壮，吉。<br><strong>《象》曰：</strong>初六之吉顺也。</p>
					<p><strong>九二：</strong>涣奔其机，悔亡。<br><strong>《象》曰：</strong>涣奔其机，得愿也。</p>
					<p><strong>六三：</strong>涣其躬，无悔。<br><strong>《象》曰：</strong>涣其躬，志在外也。</p>
					<p><strong>六四：</strong>涣其群，元吉。涣有丘，匪夷所思。<br><strong>《象》曰：</strong>涣其群元吉，光大也。</p>
					<p><strong>九五：</strong>涣汗其大号，涣王居，无咎。<br><strong>《象》曰：</strong>王居无咎，正位也。</p>
					<p><strong>上九：</strong>涣其血，去逖出，无咎。<br><strong>《象》曰：</strong>涣其血，远害也。</p>
				`,
				'水泽节第六十': `
					<div class="hexagram-symbol">–  –<br>————<br>–  –<br>–  –<br>————<br>————</div>
					<p><strong>节：亨。苦节，不可贞。</strong></p>
					<p><strong>《彖》曰：</strong>节亨。刚柔分而刚得中。苦节不可贞，其道穷也。说以行险，当位以节，中正以通。天地节而四时成。节以制度，不伤财，不害民。</p>
					<p><strong>《象》曰：</strong>泽上有水，节。君子以制数度，议德行。</p>
					<p><strong>初九：</strong>不出户庭，无咎。<br><strong>《象》曰：</strong>不出户庭，知通塞也。</p>
					<p><strong>九二：</strong>不出门庭，凶。<br><strong>《象》曰：</strong>不出门庭凶，失时极也。</p>
					<p><strong>六三：</strong>不节若，则嗟若，无咎。<br><strong>《象》曰：</strong>不节之嗟，又谁咎也。</p>
					<p><strong>六四：</strong>安节。亨。<br><strong>《象》曰：</strong>安节之亨，承上道也。</p>
					<p><strong>九五：</strong>甘节，吉，往有尚。<br><strong>《象》曰：</strong>甘节之吉，居位中也。</p>
					<p><strong>上六：</strong>苦节，贞凶，悔亡。<br><strong>《象》曰：</strong>苦节贞凶，其道穷也。</p>
				`,
				'风泽中孚第六十一': `
					<div class="hexagram-symbol">————<br>————<br>–  –<br>–  –<br>————<br>————</div>
					<p><strong>中孚：豚鱼，吉。利涉大川，利贞。</strong></p>
					<p><strong>《彖》曰：</strong>中孚，柔在内而刚得中，说而巽，孚乃化邦也。豚鱼吉，信及豚鱼也。利涉大川，乘木舟虚也。中孚以利贞，乃应乎天也。</p>
					<p><strong>《象》曰：</strong>泽上有风，中孚。君子以议狱缓死。</p>
					<p><strong>初九：</strong>虞吉，有它不燕。<br><strong>《象》曰：</strong>初九「虞吉」，志未变也。</p>
					<p><strong>九二：</strong>鸣鹤在阴，其子和之。我有好爵，吾与尔靡之。<br><strong>《象》曰：</strong>其子和之，中心愿也。</p>
					<p><strong>六三：</strong>得敌，或鼓或罢，或泣或歌。<br><strong>《象》曰：</strong>或鼓或罢，位不当也。</p>
					<p><strong>六四：</strong>月几望，马匹亡，无咎。<br><strong>《象》曰：</strong>马匹亡，绝类上也。</p>
					<p><strong>九五：</strong>有孚挛如，无咎。<br><strong>《象》曰：</strong>有孚挛如，位正当也。</p>
					<p><strong>上九：</strong>翰音登于天，贞凶。<br><strong>《象》曰：</strong>翰音登于天，何可长也。</p>
				`,
				'雷山小过第六十二': `
					<div class="hexagram-symbol">–  –<br>–  –<br>————<br>————<br>–  –<br>–  –</div>
					<p><strong>小过：亨。利贞。可小事，不可大事。飞鸟遗之音，不宜上，宜下，大吉。</strong></p>
					<p><strong>《彖》曰：</strong>小过，小者过而亨也。过以利贞，与时行也。柔得中，是以小事吉也。刚失位而不中，是以不可大事也。有飞鸟之象焉，飞鸟遗之音、不宜上宜下、大吉，上逆而下顺也。</p>
					<p><strong>《象》曰：</strong>山上有雷，小过。君子以行过乎恭，丧过乎哀，用过乎俭。</p>
					<p><strong>初六：</strong>飞鸟以凶。<br><strong>《象》曰：</strong>飞鸟以凶，不可如何也。</p>
					<p><strong>六二：</strong>过其祖，遇其妣。不及其君，遇其臣。无咎。<br><strong>《象》曰：</strong>不及其君，臣不可过也。</p>
					<p><strong>九三：</strong>弗过防之，从或戕之，凶。<br><strong>《象》曰：</strong>从或戕之，凶如何也？</p>
					<p><strong>九四：</strong>无咎。弗过遇之，往厉必戒，勿用永贞。<br><strong>《象》曰：</strong>弗过遇之，位不当也。往厉必戒，终不可长也。</p>
					<p><strong>六五：</strong>密云不雨，自我西郊。公弋取彼在穴。<br><strong>《象》曰：</strong>密云不雨，已上也。</p>
					<p><strong>上六：</strong>弗遇过之，飞鸟离之，凶，是谓灾眚。<br><strong>《象》曰：</strong>弗遇过之，已亢也。</p>
				`,
				'水火既济第六十三': `
					<div class="hexagram-symbol">–  –<br>————<br>–  –<br>————<br>–  –<br>————</div>
					<p><strong>既济：亨小，利贞。初吉终乱。</strong></p>
					<p><strong>《彖》曰：</strong>既济亨，小者亨也。利贞。刚柔正而位当也。初吉，柔得中也。终止则乱，其道穷也。</p>
					<p><strong>《象》曰：</strong>水在火上，既济。君子以思患而豫防之。</p>
					<p><strong>初九：</strong>曳其轮，濡其尾，无咎。<br><strong>《象》曰：</strong>曳其轮，义无咎也。</p>
					<p><strong>六二：</strong>妇丧其茀，勿逐，七日得。<br><strong>《象》曰：</strong>七日得，以中道也。</p>
					<p><strong>九三：</strong>高宗伐鬼方，三年克之，小人勿用。<br><strong>《象》曰：</strong>三年克之，惫也。</p>
					<p><strong>六四：</strong>繻有衣袽，终日戒。<br><strong>《象》曰：</strong>终日戒，有所疑也。</p>
					<p><strong>九五：</strong>东邻杀牛，不如西邻之禴祭，实受其福。<br><strong>《象》曰：</strong>东邻杀牛，不如西邻之时也。实受其福，吉大来也。</p>
					<p><strong>上六：</strong>濡其首，厉。<br><strong>《象》曰：</strong>濡其首厉，何可久也。</p>
				`,
				'火水未济第六十四': `
					<div class="hexagram-symbol">————<br>–  –<br>————<br>–  –<br>————<br>–  –</div>
					<p><strong>未济：亨。小狐汔济，濡其尾，无攸利。</strong></p>
					<p><strong>《彖》曰：</strong>未济亨，柔得中也。小狐汔济，未出中也。濡其尾，无攸利，不续终也。虽不当位，刚柔应也。</p>
					<p><strong>《象》曰：</strong>火在水上，未济。君子以慎辨物居方。</p>
					<p><strong>初六：</strong>濡其尾，吝。<br><strong>《象》曰：</strong>濡其尾，亦不知极也。</p>
					<p><strong>九二：</strong>曳其轮，贞吉。<br><strong>《象》曰：</strong>九二贞吉，中以行正也。</p>
					<p><strong>六三：</strong>未济，征凶。利涉大川。<br><strong>《象》曰：</strong>未济征凶，位不当也。</p>
					<p><strong>九四：</strong>贞吉，悔亡。震用伐鬼方，三年，有赏于大国。<br><strong>《象》曰：</strong>贞吉悔亡，志行也。</p>
					<p><strong>六五：</strong>贞吉，无悔。君子之光，有孚吉。<br><strong>《象》曰：</strong>君子之光，其辉吉也。</p>
					<p><strong>上九：</strong>有孚于饮酒，无咎。濡其首，有孚失是。<br><strong>《象》曰：</strong>饮酒濡首，亦不知节也。</p>
				`
			};
			
			return guaInfo[guaName] || `
				<p>该卦象内容正在完善中...</p>
				<p>卦名：${guaName}</p>
				<p>请稍后查看完整内容。</p>
			`;
		}
		
		
		// 隐藏卦信息悬浮框
		window.hideGuaTooltip = function() {
			const tooltip = document.getElementById('gua-tooltip');
			if (tooltip) {
				tooltip.remove();
				console.log('悬浮框已隐藏');
			}
		}
		
		// 修改现有的hideAllTooltips函数，添加卦悬浮框的隐藏
		if (typeof hideAllTooltips === 'function') {
			const originalHideAllTooltips = hideAllTooltips;
			window.hideAllTooltips = function() {
				originalHideAllTooltips();
				hideGuaTooltip();
			};
		}
		
		// 使用事件委托，因为卦名是动态生成的
		document.addEventListener('click', function(e) {
			// 只检查点击的是卦名部分（.gua-name）
			if (e.target.classList.contains('gua-name')) {
				e.preventDefault();
				e.stopPropagation();

				console.log('卦名被点击了:', e.target);

				// 获取完整的卦名（乾为天第一），不包含"本卦·"或"变卦·"
				const guaHeader = e.target.parentElement;
				const guaNameText = e.target.textContent; // "乾为天"
				const guaLabelAfter = guaHeader.querySelector('.gua-label:last-child');
				const numberPart = guaLabelAfter ? guaLabelAfter.textContent : ''; // "第1"
				const guaNameWithNumber = guaNameText + numberPart; // "乾为天第一"

				console.log('卦名部分:', guaNameWithNumber);

				const existingTooltip = document.getElementById('gua-tooltip');

				if (existingTooltip) {
					// 如果已经有悬浮框，先隐藏再显示新的
					hideGuaTooltip();
					// 稍微延迟一下确保DOM更新
					setTimeout(() => {
						showGuaTooltip(e.target, guaNameWithNumber);
					}, 10);
				} else {
					// 没有悬浮框，直接显示
					showGuaTooltip(e.target, guaNameWithNumber);
				}
			}
		});

		// 点击其他地方隐藏悬浮框
		document.addEventListener('click', function(e) {
			// 如果点击的不是卦名、悬浮框本身，就隐藏悬浮框
			if (!e.target.classList.contains('gua-name') && 
				!e.target.closest('.gua-tooltip')) {
				hideGuaTooltip();
			}
		});

		// ===== 练习功能 =====
		window.startPractice = function(practiceId) {
			console.log('开始练习:', practiceId);
			
			if (practiceId === 'practice1') {
				// 打开64卦练习
				const modal = document.createElement('div');
				modal.style.cssText = `
					position: fixed;
					top: 0;
					left: 0;
					width: 100%;
					height: 100%;
					background: transparent;
					z-index: 10000;
					display: flex;
					justify-content: center;
					align-items: center;
				`;
				
				const content = document.createElement('div');
				content.style.cssText = `
					background: transparent;
					width: 100%;
					height: 100%;
					border: none;
					overflow: hidden;
					position: relative;
				`;
				
				const closeBtn = document.createElement('button');
				closeBtn.innerHTML = '×';
				closeBtn.style.cssText = `
					position: fixed;
					top: 20px;
					right: 20px;
					background: rgba(0,0,0,0.7);
					color: white;
					border: none;
					font-size: 20px;
					cursor: pointer;
					z-index: 10001;
					width: 40px;
					height: 40px;
					border-radius: 50%;
					display: flex;
					align-items: center;
					justify-content: center;
					box-shadow: 0 2px 10px rgba(0,0,0,0.3);
				`;
				
				closeBtn.onclick = () => document.body.removeChild(modal);
				
				// 创建iframe
				const iframe = document.createElement('iframe');
				iframe.style.cssText = `
					width: 100%;
					height: 100%;
					border: none;
					background: transparent;
				`;
				
				// 尝试多个路径
				const possiblePaths = [
					'六爻排盘调用/64卦练习 调用.html',
					'./六爻排盘调用/64卦练习 调用.html',
					'../六爻排盘调用/64卦练习 调用.html'
				];
				
				let pathIndex = 0;
				
				function tryLoadIframe() {
					if (pathIndex >= possiblePaths.length) {
						alert('无法加载64卦练习，请检查文件是否存在');
						document.body.removeChild(modal);
						return;
					}
					
					const currentPath = possiblePaths[pathIndex];
					console.log('尝试加载路径:', currentPath);
					
					iframe.src = currentPath;
					iframe.onerror = () => {
						console.log('路径失败:', currentPath);
						pathIndex++;
						tryLoadIframe();
					};
					iframe.onload = () => {
						console.log('成功加载文件:', currentPath);
					};
				}
				
				content.appendChild(iframe);
				content.appendChild(closeBtn);
				modal.appendChild(content);
				document.body.appendChild(modal);
				
				tryLoadIframe();
			} else {
				// 其他练习显示敬请期待
				alert('练习功能即将开放，敬请期待！');
			}
		}

		// ===== 工具功能 =====
		window.openTool = function(toolId) {
			console.log('打开工具:', toolId);
			
			let toolPath = '';
			let toolName = '';
			
			if (toolId === 'xiaoliuren') {
				toolPath = '六爻排盘调用/小六壬实时 调用.htm';
				toolName = '小六壬';
			} else if (toolId === 'minggong') {
				toolPath = '六爻排盘调用/命宫计算器 调用.htm';
				toolName = '命宫计算器';
			} else if (toolId === 'guaquery') {
				toolPath = '六爻排盘调用/64卦查询 调用.htm';
				toolName = '64卦查询';
			} else if (toolId === 'guatable') {
				toolPath = '六爻排盘调用/64卦表 调用.htm';
				toolName = '64卦表';
			} else if (toolId === 'coming1' || toolId === 'coming2') {
				alert('该工具正在开发中，敬请期待！');
				return;
			} else {
				alert('未知工具，请稍后再试！');
				return;
			}
			
			// 使用iframe加载文件，避免CORS限制
			const modal = document.createElement('div');
			modal.style.cssText = `
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: transparent;
				z-index: 10000;
				display: flex;
				justify-content: center;
				align-items: center;
			`;
			
			const content = document.createElement('div');
			content.style.cssText = `
				background: transparent;
				width: 100%;
				height: 100%;
				border: none;
				overflow: hidden;
				position: relative;
			`;
			
			const closeBtn = document.createElement('button');
			closeBtn.innerHTML = '×';
			closeBtn.style.cssText = `
				position: fixed;
				top: 20px;
				right: 20px;
				background: rgba(0,0,0,0.7);
				color: white;
				border: none;
				border-radius: 50%;
				width: 40px;
				height: 40px;
				font-size: 20px;
				cursor: pointer;
				z-index: 10001;
				box-shadow: 0 2px 10px rgba(0,0,0,0.3);
			`;
			
			closeBtn.onclick = () => {
				document.body.removeChild(modal);
			};
			
			const iframe = document.createElement('iframe');
			iframe.style.cssText = `
				width: 100%;
				height: 100%;
				border: none;
				background: transparent;
			`;
			
			// 尝试多个路径
			const possiblePaths = [
				toolPath,
				'./' + toolPath,
				'../' + toolPath
			];
			
			let pathIndex = 0;
			
			function tryLoadIframe() {
				if (pathIndex >= possiblePaths.length) {
					alert('无法加载' + toolName + '，请检查文件是否存在');
					document.body.removeChild(modal);
					return;
				}
				
				const currentPath = possiblePaths[pathIndex];
				console.log('尝试加载路径:', currentPath);
				
				iframe.src = currentPath;
				iframe.onerror = () => {
					console.log('路径失败:', currentPath);
					pathIndex++;
					setTimeout(tryLoadIframe, 100);
				};
				
				iframe.onload = () => {
					console.log('成功加载:', currentPath);
				};
			}
			
			content.appendChild(closeBtn);
			content.appendChild(iframe);
			modal.appendChild(content);
			document.body.appendChild(modal);
			
			// 开始尝试加载
			setTimeout(tryLoadIframe, 100);
		};

		// ===== 书本功能 =====
		window.openBook = function(bookId) {
			console.log('打开书本:', bookId);
			
			if (bookId === 'book1') {
				// 使用iframe加载文件，避免CORS限制
				const modal = document.createElement('div');
				modal.style.cssText = `
					position: fixed;
					top: 0;
					left: 0;
					width: 100%;
					height: 100%;
					background: rgba(0,0,0,0.8);
					z-index: 10000;
					display: flex;
					justify-content: center;
					align-items: center;
				`;
				
				const content = document.createElement('div');
				content.style.cssText = `
					background: white;
					width: 95%;
					height: 95%;
					border-radius: 8px;
					overflow: hidden;
					position: relative;
				`;
				
				const closeBtn = document.createElement('button');
				closeBtn.innerHTML = '×';
				closeBtn.style.cssText = `
					position: absolute;
					top: 10px;
					right: 15px;
					background: rgba(0,0,0,0.5);
					color: white;
					border: none;
					font-size: 24px;
					cursor: pointer;
					z-index: 10001;
					width: 30px;
					height: 30px;
					border-radius: 50%;
					display: flex;
					align-items: center;
					justify-content: center;
				`;
				
				closeBtn.onclick = () => document.body.removeChild(modal);
				
				// 创建iframe
				const iframe = document.createElement('iframe');
				iframe.style.cssText = `
					width: 100%;
					height: 100%;
					border: none;
					background: transparent;
					-webkit-user-select: text;
					-moz-user-select: text;
					-ms-user-select: text;
					user-select: text;
					-webkit-touch-callout: default;
					pointer-events: auto;
				`;
				
				// 尝试多个路径
				const possiblePaths = [
					'六爻排盘调用/周易电子书 调用.html',
					'./六爻排盘调用/周易电子书 调用.html',
					'../六爻排盘调用/周易电子书 调用.html'
				];
				
				let pathIndex = 0;
				
				function tryLoadIframe() {
					if (pathIndex >= possiblePaths.length) {
						alert('无法加载周易电子书，请检查文件是否存在');
						document.body.removeChild(modal);
						return;
					}
					
					const currentPath = possiblePaths[pathIndex];
					console.log('尝试加载路径:', currentPath);
					
					iframe.src = currentPath;
					iframe.onerror = () => {
						console.log('路径失败:', currentPath);
						pathIndex++;
						tryLoadIframe();
					};
					iframe.onload = () => {
						console.log('成功加载文件:', currentPath);
						// 电子书加载完成后，如果用户已登录，立即同步笔记
						if (window.supabaseService && window.supabaseService.currentUser) {
							console.log('电子书加载完成，用户已登录，开始同步笔记');
							setTimeout(() => {
								// 修复file://协议下的postMessage问题
								const targetOrigin = window.location.protocol === 'file:' ? '*' : window.location.origin;
								iframe.contentWindow.postMessage({
									type: 'syncNotesAfterLogin'
								}, targetOrigin);
							}, 500);
						}
					};
				}
				
				content.appendChild(iframe);
				content.appendChild(closeBtn);
				modal.appendChild(content);
				document.body.appendChild(modal);
				
				tryLoadIframe();
			} else {
				// 其他书籍显示敬请期待
				const bookNames = {
					'book2': '六爻',
					'book3': '梅花易数'
				};
				
				const bookName = bookNames[bookId] || '未知书籍';
				alert(`正在打开《${bookName}》，功能即将开放，敬请期待！`);
			}
		}

		// ===== 学习子板块切换功能 =====
		function initStudySubsections() {
			// 移除之前的事件监听器（如果有的话）
			const existingListeners = document.querySelectorAll('.study-nav-item[data-listener-added]');
			existingListeners.forEach(item => {
				item.removeEventListener('click', handleStudyNavClick);
				item.removeAttribute('data-listener-added');
			});

			// 为所有学习导航项添加点击事件
			const studyNavItems = document.querySelectorAll('.study-nav-item');
			studyNavItems.forEach(item => {
				item.addEventListener('click', handleStudyNavClick);
				item.setAttribute('data-listener-added', 'true');
			});
		}

		function handleStudyNavClick(e) {
			const clickedItem = e.target;
			const subsection = clickedItem.getAttribute('data-subsection');
			
			// 移除所有导航项的active状态
			const allNavItems = document.querySelectorAll('.study-nav-item');
			allNavItems.forEach(item => item.classList.remove('active'));
			
			// 隐藏所有子板块
			const allSubsections = document.querySelectorAll('.study-subsection');
			allSubsections.forEach(subsection => subsection.classList.remove('active'));
			
			// 激活当前点击的导航项
			clickedItem.classList.add('active');
			
			// 显示对应的子板块
			const targetSubsection = document.getElementById('study-' + subsection);
			if (targetSubsection) {
				targetSubsection.classList.add('active');
			}
			
			console.log('切换到学习子板块:', subsection);
		}
		
		})();
	</script>
	
	<!-- 云端同步集成脚本 -->
	<!-- 选择其中一种方案： -->
	<!-- 方案1：Firebase（需要启用计费） -->
	<!-- <script type="module" src="firebase-config.js"></script> -->
	<!-- <script src="firebase-service.js"></script> -->
	<!-- <script src="firebase-integration.js"></script> -->
	
	<!-- 方案2：Supabase（推荐，无需计费） -->
	<!-- 引入缓存同步服务 -->
	<script src="cache-sync-service.js"></script>
	<!-- 引入同步状态显示组件 -->
	<script src="sync-status-widget.js"></script>
	<script type="module">
		// 直接嵌入 Supabase 配置
		const supabaseConfig = {
			url: "https://pztjbqmjuqhafwxaywtu.supabase.co",
			anonKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6dGpicW1qdXFoYWZ3eGF5d3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3NTMwMTIsImV4cCI6MjA3MzMyOTAxMn0.iyZZH_nIK_J91cRysJ3js8OLSJf82auXWeUTQLamGRk"
		};
		
		// 创建 Supabase 客户端
		import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2';
		window.supabase = createClient(supabaseConfig.url, supabaseConfig.anonKey);
		
		console.log('Supabase客户端已创建:', {
			url: supabaseConfig.url,
			hasKey: !!supabaseConfig.anonKey,
			client: !!window.supabase
		});
	</script>
	
	<!-- SupabaseService 类定义 -->
	<script>
		// Supabase数据存储服务类
		class SupabaseService {
			constructor() {
				this.currentUser = null;
				this.connectionError = false;
				this.init();
			}
			
			// 等待 supabase 加载完成
			waitForSupabase() {
				return new Promise((resolve) => {
					const checkSupabase = () => {
						if (window.supabase) {
							resolve();
						} else {
							setTimeout(checkSupabase, 100);
						}
					};
					checkSupabase();
				});
			}

			// 初始化服务
			async init() {
				console.log('SupabaseService 开始初始化...');
				
				// 等待 supabase 加载完成
				await this.waitForSupabase();
				console.log('Supabase 客户端已加载');
				
				// 监听用户认证状态
				window.supabase.auth.onAuthStateChange((event, session) => {
					console.log('认证状态变化:', event, session ? '有会话' : '无会话');
					this.currentUser = session?.user || null;
					if (this.currentUser) {
						console.log('用户已登录:', this.currentUser.email);
						this.onUserLogin(this.currentUser);
					} else {
						console.log('用户未登录');
						this.onUserLogout();
					}
				});
				
				console.log('SupabaseService 初始化完成');
			}

			// 用户登录
			async login(email, password) {
				try {
					// 检查连接状态
					if (this.connectionError) {
						return { success: false, error: '网络连接异常，请检查网络后重试' };
					}
					
					console.log('SupabaseService.login 被调用:', { email, hasPassword: !!password });
					console.log('Supabase 客户端状态:', !!window.supabase);
					
					const { data, error } = await window.supabase.auth.signInWithPassword({
						email: email,
						password: password
					});
					
					console.log('Supabase 登录响应:', { data, error });
					
					if (error) {
						console.error('登录错误:', error);
						// 检查是否是邮箱未确认错误
						if (error.message.includes('Email not confirmed') || error.message.includes('email_not_confirmed')) {
							return { 
								success: false, 
								error: '邮箱未确认，请检查邮箱并点击确认链接',
								needsConfirmation: true
							};
						}
						throw error;
					}
					console.log('登录成功:', data.user);
					return { success: true, user: data.user };
				} catch (error) {
					console.error('登录出错:', error);
					// 检查是否是网络错误
					if (error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION_CLOSED')) {
						this.connectionError = true;
						return { success: false, error: '网络连接失败，请检查网络后重试' };
					}
					return { success: false, error: error.message };
				}
			}

			// 用户注册
			async register(email, password) {
				try {
					console.log('Supabase注册请求:', { email, password: '***' });
					console.log('Supabase客户端状态:', !!window.supabase);
					
					const { data, error } = await window.supabase.auth.signUp({
						email: email,
						password: password
					});
					
					console.log('Supabase注册响应:', { data, error });
					
					if (error) {
						throw error;
					}
					
					return { success: true, user: data.user };
				} catch (error) {
					console.error('注册出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 用户登出
			async logout() {
				try {
					const { error } = await window.supabase.auth.signOut();
					if (error) {
						throw error;
					}
					this.currentUser = null;
					console.log('用户已登出');
					return { success: true };
				} catch (error) {
					console.error('登出出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 修改密码
			async changePassword(currentPassword, newPassword) {
				try {
					const { error } = await window.supabase.auth.updateUser({
						password: newPassword
					});
					
					if (error) {
						throw error;
					}
					
					return { success: true };
				} catch (error) {
					console.error('修改密码出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 重置密码
			async resetPassword(email) {
				try {
					// 使用固定的重定向URL，确保与Supabase配置一致
					const redirectUrl = 'https://Ruby-liuyuner.github.io/liuyaopaipan0913/confirm.html?type=recovery';
					
					console.log('发送密码重置邮件到:', email);
					console.log('重定向URL:', redirectUrl);
					
					const { error } = await window.supabase.auth.resetPasswordForEmail(email, {
						redirectTo: redirectUrl,
						emailRedirectTo: redirectUrl
					});

					if (error) {
						throw error;
					}
					return { success: true };
				} catch (error) {
					console.error('重置密码出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 保存排盘记录到云端
			async savePaipanRecord(record) {
				try {
					console.log('保存排盘记录到云端:', record);
					
					const recordData = {
						question: record.question,
						time: record.time,
						gua_data: {
							yongshen: record.yongshen,
							fullGuaContent: record.fullGuaContent,
							timestamp: record.timestamp
						}
					};
					
					console.log('处理后的记录数据:', recordData);
					
					const { data, error } = await window.supabase
						.from('paipan_records')
						.insert([recordData])
						.select();
					
					if (error) {
						throw error;
					}
					
					console.log('排盘记录保存成功:', data);
					return { success: true, data: data[0] };
				} catch (error) {
					console.error('保存排盘记录出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 获取排盘记录
			async getPaipanRecords() {
				try {
					const { data, error } = await window.supabase
						.from('paipan_records')
						.select('*')
						.order('created_at', { ascending: false });
					
					if (error) {
						throw error;
					}
					
					return { success: true, data: data || [] };
				} catch (error) {
					console.error('获取排盘记录出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 删除排盘记录
			async deletePaipanRecord(recordId) {
				try {
					const { error } = await window.supabase
						.from('paipan_records')
						.delete()
						.eq('id', recordId);
					
					if (error) {
						throw error;
					}
					
					return { success: true };
				} catch (error) {
					console.error('删除排盘记录出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 保存电子书笔记
			async saveBookNote(noteData) {
				try {
					console.log('保存电子书笔记到云端:', noteData);
					
					// 映射字段名到数据库列名
					const mappedData = {
						chapter_id: noteData.chapterId,
						chapter_title: noteData.chapterTitle,
						content: noteData.content,
						highlights: noteData.highlights
					};
					
					console.log('映射后的数据:', mappedData);
					
					// 首先检查是否已存在相同文字的笔记
					const highlightText = noteData.highlights?.[0]?.text;
					if (highlightText) {
						const { data: existingNotes, error: queryError } = await window.supabase
							.from('book_notes')
							.select('*')
							.eq('chapter_id', noteData.chapterId)
							.eq('user_id', this.currentUser.id);
						
						if (queryError) {
							throw queryError;
						}
						
						// 查找相同文字的笔记
						const existingNote = existingNotes?.find(note => 
							note.highlights?.some(h => h.text === highlightText)
						);
						
						if (existingNote) {
							// 更新现有笔记
							console.log('找到现有笔记，将更新:', existingNote.id);
							const { data, error } = await window.supabase
								.from('book_notes')
								.update(mappedData)
								.eq('id', existingNote.id)
								.select();
							
							if (error) {
								throw error;
							}
							
							console.log('电子书笔记更新成功:', data);
							return { success: true, data: data[0] };
						}
					}
					
					// 如果没有找到现有笔记，创建新笔记
					const { data, error } = await window.supabase
						.from('book_notes')
						.insert([mappedData])
						.select();
					
					if (error) {
						throw error;
					}
					
					console.log('电子书笔记创建成功:', data);
					return { success: true, data: data[0] };
				} catch (error) {
					console.error('保存电子书笔记出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 获取电子书笔记
			async getBookNotes(chapterId) {
				try {
					const { data, error } = await window.supabase
						.from('book_notes')
						.select('*')
						.eq('chapter_id', chapterId)
						.order('created_at', { ascending: false });
					
					if (error) {
						throw error;
					}
					
					// 映射数据库列名到前端字段名
					const mappedData = (data || []).map(note => ({
						id: note.id,
						chapterId: note.chapter_id,
						chapterTitle: note.chapter_title,
						content: note.content,
						highlights: note.highlights,
						createdAt: note.created_at
					}));
					
					return { success: true, data: mappedData };
				} catch (error) {
					console.error('获取电子书笔记出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 更新电子书笔记
			async updateBookNote(noteId, noteData) {
				try {
					// 映射字段名到数据库列名
					const mappedData = {
						chapter_id: noteData.chapterId,
						chapter_title: noteData.chapterTitle,
						content: noteData.content,
						highlights: noteData.highlights
					};
					
					const { data, error } = await window.supabase
						.from('book_notes')
						.update(mappedData)
						.eq('id', noteId)
						.select();
					
					if (error) {
						throw error;
					}
					
					return { success: true, data: data[0] };
				} catch (error) {
					console.error('更新电子书笔记出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 删除电子书笔记
			async deleteBookNote(noteId) {
				try {
					console.log('尝试删除笔记:', noteId);
					
					// 首先尝试直接删除（如果是云端ID）
					let { error } = await window.supabase
						.from('book_notes')
						.delete()
						.eq('id', noteId);
					
					// 如果直接删除失败，可能是本地ID，需要通过文字内容查找
					if (error) {
						console.log('直接删除失败，尝试通过文字内容查找:', error.message);
						
						// 从本地ID中提取文字内容
						const text = noteId.replace('text_note_', '');
						
						// 查找包含该文字的笔记
						const { data: existingNotes, error: queryError } = await window.supabase
							.from('book_notes')
							.select('*')
							.eq('chapter_id', 'zhouyi')
							.eq('user_id', this.currentUser.id);
						
						if (queryError) {
							throw queryError;
						}
						
						// 查找匹配的笔记
						const matchingNote = existingNotes?.find(note => 
							note.highlights?.some(h => h.text === text)
						);
						
						if (matchingNote) {
							console.log('找到匹配的云端笔记，删除:', matchingNote.id);
							const { error: deleteError } = await window.supabase
								.from('book_notes')
								.delete()
								.eq('id', matchingNote.id);
							
							if (deleteError) {
								throw deleteError;
							}
						} else {
							console.log('未找到匹配的云端笔记');
							return { success: true }; // 本地已删除，云端没有对应记录
						}
					}
					
					console.log('电子书笔记删除成功');
					return { success: true };
				} catch (error) {
					console.error('删除电子书笔记出错:', error);
					return { success: false, error: error.message };
				}
			}

			// 重置连接错误状态
			resetConnectionError() {
				this.connectionError = false;
				console.log('连接错误状态已重置');
			}
			
			// 用户登录成功回调
			onUserLogin(user) {
				console.log('用户登录成功，开始同步数据...');
				// 登录成功时重置连接错误状态
				this.connectionError = false;
				// 这里可以添加登录成功后的逻辑
			}

			// 用户登出回调
			onUserLogout() {
				console.log('用户已登出');
				// 这里可以添加登出后的逻辑
			}
		}
	</script>
	

	<!-- 认证模态框 -->
	<div id="authModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
		<div style="background: white; border-radius: 15px; padding: 40px; width: 80%; max-width: 500px; position: relative;">
			<div style="text-align: center; margin-bottom: 30px;">
				<h1 style="color: #333; font-size: 2em; margin-bottom: 10px;">用户认证</h1>
			</div>
			
			<div id="loginForm">
				<div style="margin-bottom: 20px;">
					<label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">邮箱</label>
					<input type="email" id="loginEmail" placeholder="请输入邮箱" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
				</div>
				<div style="margin-bottom: 20px;">
					<label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">密码</label>
					<input type="password" id="loginPassword" placeholder="请输入密码" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
				</div>
				<button id="loginSubmitBtn" style="width: 100%; padding: 12px; background: #555; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 15px;">登录</button>
				<div style="text-align: center; margin-bottom: 10px;">
					<button id="forgotPasswordBtn" style="background: none; border: none; color: #666; cursor: pointer; text-decoration: underline; font-size: 14px;">忘记密码？</button>
				</div>
				<div style="text-align: center;">
					<span style="color: #666;">还没有账户？</span>
					<button id="switchToRegister" style="background: none; border: none; color: #555; cursor: pointer; text-decoration: underline;">立即注册</button>
				</div>
			</div>
			
			<div id="registerForm" style="display: none;">
				<div style="margin-bottom: 20px;">
					<label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">邮箱</label>
					<input type="email" id="registerEmail" placeholder="请输入邮箱" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
				</div>
				<div style="margin-bottom: 20px;">
					<label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">密码</label>
					<input type="password" id="registerPassword" placeholder="请输入密码（至少6位）" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
				</div>
				<button id="registerSubmitBtn" style="width: 100%; padding: 12px; background: #555; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 15px;">注册</button>
				<div style="text-align: center;">
					<span style="color: #666;">已有账户？</span>
					<button id="switchToLogin" style="background: none; border: none; color: #555; cursor: pointer; text-decoration: underline;">立即登录</button>
				</div>
			</div>
			
			<div id="changePasswordForm" style="display: none;">
				<div style="margin-bottom: 20px;">
					<label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">当前密码</label>
					<input type="password" id="currentPassword" placeholder="请输入当前密码" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
				</div>
				<div style="margin-bottom: 20px;">
					<label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">新密码</label>
					<input type="password" id="newPassword" placeholder="请输入新密码（至少6位）" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
				</div>
				<div style="margin-bottom: 20px;">
					<label style="display: block; margin-bottom: 5px; color: #333; font-weight: 500;">确认新密码</label>
					<input type="password" id="confirmNewPassword" placeholder="请再次输入新密码" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
				</div>
				<button id="changePasswordSubmitBtn" style="width: 100%; padding: 12px; background: #555; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 15px;">修改密码</button>
				<div style="text-align: center;">
					<button id="switchToLoginFromChange" style="background: none; border: none; color: #555; cursor: pointer; text-decoration: underline;">返回登录</button>
				</div>
			</div>
			
			<button id="closeAuthModal" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">×</button>
			
			<div id="authMessage" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
		</div>
	</div>
	
	<!-- 云端同步功能脚本 -->
	<script>
		// 等待页面加载完成
		document.addEventListener('DOMContentLoaded', function() {
			// 创建 SupabaseService 实例
			window.supabaseService = new SupabaseService();
			console.log('SupabaseService 实例已创建');
			
			// 等待 supabaseService 初始化完成
			waitForSupabaseService();
			
			// 绑定认证模态框事件
			bindAuthModalEvents();
		});
		
		// 等待 SupabaseService 初始化完成
		function waitForSupabaseService() {
			const checkService = () => {
				if (window.supabaseService) {
					console.log('SupabaseService 已初始化，开始初始化云端同步功能');
					
					// 测试 Supabase 连接
					testSupabaseConnection();
					
					initCloudSync();
				} else {
					console.log('等待 SupabaseService 初始化...');
					setTimeout(checkService, 100);
				}
			};
			checkService();
		}
		
		// 测试 Supabase 连接
		async function testSupabaseConnection() {
			const maxRetries = 3;
			let retryCount = 0;
			
			while (retryCount < maxRetries) {
				try {
					console.log(`测试 Supabase 连接... (尝试 ${retryCount + 1}/${maxRetries})`);
					console.log('Supabase 客户端:', window.supabase);
					console.log('Supabase 配置:', {
						url: window.supabase?.supabaseUrl,
						key: window.supabase?.supabaseKey ? '已设置' : '未设置'
					});
					
					// 尝试获取当前用户（不需要登录）
					const { data, error } = await window.supabase.auth.getUser();
					console.log('Supabase 连接测试结果:', { data, error });
					
					// 如果成功，跳出重试循环
					break;
				} catch (error) {
					retryCount++;
					console.error(`Supabase 连接测试失败 (尝试 ${retryCount}/${maxRetries}):`, error);
					
					if (retryCount < maxRetries) {
						console.log(`等待 2 秒后重试...`);
						await new Promise(resolve => setTimeout(resolve, 2000));
					} else {
						console.error('Supabase 连接测试最终失败，可能是网络问题或服务不可用');
						// 显示用户友好的错误提示
						if (window.supabaseService) {
							window.supabaseService.connectionError = true;
						}
					}
				}
			}
		}
		
		
		// 登录按钮点击处理函数
		function handleLoginClick(event) {
			event.preventDefault();
			event.stopPropagation();
			
			const modal = document.getElementById('authModal');
			if (modal) {
				modal.style.display = 'flex';
			}
		}
		
		// 绑定认证模态框事件
		function bindAuthModalEvents() {
			// 绑定登录按钮事件（我的标签页中的按钮）
			const profileLoginBtn = document.getElementById('profileLoginBtn');
			if (profileLoginBtn) {
				profileLoginBtn.addEventListener('click', handleLoginClick);
			}
			
			
			// 绑定退出登录按钮事件
			const profileLogoutBtn = document.getElementById('profileLogoutBtn');
			if (profileLogoutBtn) {
				profileLogoutBtn.addEventListener('click', async function() {
					await window.supabaseService.logout();
					updateUserStatus();
				});
			}
			
			// 绑定修改密码按钮事件
			const changePasswordBtn = document.getElementById('changePasswordBtn');
			if (changePasswordBtn) {
				changePasswordBtn.addEventListener('click', function() {
					// 显示修改密码表单
					document.getElementById('loginForm').style.display = 'none';
					document.getElementById('registerForm').style.display = 'none';
					document.getElementById('changePasswordForm').style.display = 'block';
					document.getElementById('authModal').style.display = 'flex';
				});
			}
			
			// 绑定忘记密码按钮事件
			const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
			if (forgotPasswordBtn) {
				forgotPasswordBtn.addEventListener('click', async function(e) {
					e.preventDefault();
					console.log('忘记密码按钮被点击');
					const email = document.getElementById('loginEmail').value;
					console.log('邮箱地址:', email);
					if (!email) {
						console.log('邮箱为空，显示警告');
						showMessage('请先输入邮箱地址', 'warning');
						return;
					}
					
					console.log('开始发送密码重置邮件');
					const result = await window.supabaseService.resetPassword(email);
					console.log('密码重置结果:', result);
					if (result.success) {
						console.log('密码重置成功，显示成功消息');
						alert('密码重置邮件已发送！请检查邮箱（包括垃圾邮件文件夹）并点击邮件中的链接重置密码。');
						document.getElementById('authModal').style.display = 'none';
					} else {
						console.log('密码重置失败:', result.error);
						alert('发送失败：' + result.error);
					}
				});
			} else {
				console.log('忘记密码按钮未找到');
			}
			
			// 绑定关闭模态框事件
			const closeAuthModal = document.getElementById('closeAuthModal');
			if (closeAuthModal) {
				closeAuthModal.addEventListener('click', function() {
					document.getElementById('authModal').style.display = 'none';
				});
			}
			
			// 绑定切换表单事件
			const switchToRegister = document.getElementById('switchToRegister');
			if (switchToRegister) {
				switchToRegister.addEventListener('click', function() {
					document.getElementById('loginForm').style.display = 'none';
					document.getElementById('registerForm').style.display = 'block';
				});
			}
			
			const switchToLogin = document.getElementById('switchToLogin');
			if (switchToLogin) {
				switchToLogin.addEventListener('click', function() {
					document.getElementById('registerForm').style.display = 'none';
					document.getElementById('loginForm').style.display = 'block';
				});
			}
			
			// 绑定修改密码表单切换事件
			const switchToLoginFromChange = document.getElementById('switchToLoginFromChange');
			if (switchToLoginFromChange) {
				switchToLoginFromChange.addEventListener('click', function() {
					document.getElementById('changePasswordForm').style.display = 'none';
					document.getElementById('loginForm').style.display = 'block';
				});
			}
			
			// 绑定登录提交事件
			const loginSubmitBtn = document.getElementById('loginSubmitBtn');
			if (loginSubmitBtn) {
				console.log('登录按钮找到，绑定事件');
				loginSubmitBtn.addEventListener('click', async function(event) {
					console.log('登录按钮被点击');
					event.preventDefault();
					
					const email = document.getElementById('loginEmail').value;
					const password = document.getElementById('loginPassword').value;
					
					console.log('登录信息:', { email: email ? '已填写' : '未填写', password: password ? '已填写' : '未填写' });
					
					if (!email || !password) {
						showMessage('请填写邮箱和密码', 'error');
						return;
					}
					
					console.log('开始登录...');
					
					// 等待 supabaseService 初始化完成
					if (!window.supabaseService) {
						console.log('等待 supabaseService 初始化...');
						await new Promise(resolve => {
							const checkService = () => {
								if (window.supabaseService) {
									resolve();
								} else {
									setTimeout(checkService, 100);
								}
							};
							checkService();
						});
					}
					
					console.log('supabaseService 状态:', !!window.supabaseService);
					
					try {
						const result = await window.supabaseService.login(email, password);
						console.log('登录结果:', result);
						
						if (result.success) {
							// 手动更新用户状态
							window.supabaseService.currentUser = result.user;
							showMessage('登录成功！', 'success');
							document.getElementById('authModal').style.display = 'none';
							updateUserStatus();
							
							// 登录成功后同步电子书笔记（延迟执行，确保iframe已加载）
							setTimeout(() => {
								syncBookNotesAfterLogin();
							}, 1000);
						} else {
							// 检查是否需要邮箱确认
							if (result.needsConfirmation) {
								showMessage('邮箱未确认，请检查邮箱并点击确认链接后再登录', 'warning');
							} else {
								showMessage('登录失败：' + result.error, 'error');
							}
						}
					} catch (error) {
						console.error('登录过程中出错:', error);
						showMessage('登录过程中出错：' + error.message, 'error');
					}
				});
			} else {
				console.error('未找到登录按钮元素');
			}
			
			// 绑定注册提交事件
			const registerSubmitBtn = document.getElementById('registerSubmitBtn');
			if (registerSubmitBtn) {
				registerSubmitBtn.addEventListener('click', async function() {
					const email = document.getElementById('registerEmail').value;
					const password = document.getElementById('registerPassword').value;
					
					if (!email || !password) {
						showMessage('请填写邮箱和密码', 'error');
						return;
					}
					
					if (password.length < 6) {
						showMessage('密码至少需要6位', 'error');
						return;
					}
					
					try {
						console.log('开始注册:', email);
						const result = await window.supabaseService.register(email, password);
						console.log('注册结果:', result);
						
						if (result.success) {
							// 手动更新用户状态
							window.supabaseService.currentUser = result.user;
							console.log('注册成功，用户信息:', result.user);
							showMessage('注册成功！用户已自动登录', 'success');
							
							// 延迟关闭模态框，让用户看到消息
							setTimeout(() => {
								document.getElementById('authModal').style.display = 'none';
								updateUserStatus();
							}, 2000);
						} else {
							// 检查是否是频率限制错误
							if (result.isRateLimited) {
								showMessage('请求过于频繁，请等待30秒后重试', 'warning');
							} else {
								showMessage('注册失败：' + result.error, 'error');
							}
						}
					} catch (error) {
						showMessage('注册过程中发生错误：' + error.message, 'error');
					}
				});
			}
			
			// 绑定修改密码提交事件
			const changePasswordSubmitBtn = document.getElementById('changePasswordSubmitBtn');
			if (changePasswordSubmitBtn) {
				changePasswordSubmitBtn.addEventListener('click', async function() {
					const currentPassword = document.getElementById('currentPassword').value;
					const newPassword = document.getElementById('newPassword').value;
					const confirmNewPassword = document.getElementById('confirmNewPassword').value;
					
					if (!currentPassword || !newPassword || !confirmNewPassword) {
						showMessage('请填写所有字段', 'error');
						return;
					}
					
					if (newPassword.length < 6) {
						showMessage('新密码至少需要6位', 'error');
						return;
					}
					
					if (newPassword !== confirmNewPassword) {
						showMessage('两次输入的新密码不一致', 'error');
						return;
					}
					
					try {
						const result = await window.supabaseService.changePassword(currentPassword, newPassword);
						if (result.success) {
							showMessage('密码修改成功！', 'success');
							document.getElementById('authModal').style.display = 'none';
							// 清空表单
							document.getElementById('currentPassword').value = '';
							document.getElementById('newPassword').value = '';
							document.getElementById('confirmNewPassword').value = '';
						} else {
							showMessage('密码修改失败：' + result.error, 'error');
						}
					} catch (error) {
						showMessage('密码修改过程中发生错误：' + error.message, 'error');
					}
				});
			}
		}
		
		// 初始化云端同步功能
		function initCloudSync() {
			// 检查用户登录状态
			updateUserStatus();
		}
		
		// 登录成功后同步电子书笔记
		function syncBookNotesAfterLogin() {
			console.log('开始同步电子书笔记...');
			// 通知电子书iframe重新加载笔记
			const iframe = document.querySelector('iframe[src*="周易电子书"]');
			console.log('找到的电子书iframe:', iframe);
			if (iframe && iframe.contentWindow) {
				console.log('发送同步消息到电子书iframe');
				iframe.contentWindow.postMessage({
					type: 'syncNotesAfterLogin'
				}, '*');
				console.log('已通知电子书同步笔记');
			} else {
				console.log('未找到电子书iframe或iframe未加载完成');
			}
		}

		// 更新用户状态显示
		function updateUserStatus() {
			console.log('updateUserStatus 被调用');
			console.log('当前用户状态:', window.supabaseService?.currentUser);
			
			// 更新"我的"标签页中的用户状态
			const profileUserInfo = document.getElementById('profileUserInfo');
			const profileLoginPrompt = document.getElementById('profileLoginPrompt');
			const profileUserEmail = document.getElementById('profileUserEmail');
			
			console.log('UI元素状态:', {
				profileUserInfo: !!profileUserInfo,
				profileLoginPrompt: !!profileLoginPrompt,
				profileUserEmail: !!profileUserEmail
			});
			
			if (window.supabaseService && window.supabaseService.currentUser) {
				console.log('显示已登录状态');
				// 已登录状态
				if (profileUserEmail) {
					profileUserEmail.textContent = window.supabaseService.currentUser.email;
					console.log('更新邮箱显示:', window.supabaseService.currentUser.email);
				}
				if (profileUserInfo) {
					profileUserInfo.style.display = 'block';
					console.log('显示用户信息区域');
				}
				if (profileLoginPrompt) {
					profileLoginPrompt.style.display = 'none';
					console.log('隐藏登录提示');
				}
			} else {
				console.log('显示未登录状态');
				// 未登录状态
				if (profileUserInfo) {
					profileUserInfo.style.display = 'none';
				}
				if (profileLoginPrompt) {
					profileLoginPrompt.style.display = 'block';
				}
			}
		}
		
		// 显示消息
		function showMessage(message, type) {
			const messageDiv = document.getElementById('authMessage');
			messageDiv.textContent = message;
			messageDiv.style.display = 'block';
			messageDiv.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
			messageDiv.style.color = type === 'success' ? '#155724' : '#721c24';
			
			setTimeout(() => {
				messageDiv.style.display = 'none';
			}, 3000);
		}
		
		// 监听排盘完成事件
		document.addEventListener('paipanCompleted', function() {
			updateUserStatus();
		});
		
		// 监听来自iframe的消息（电子书笔记）
		window.addEventListener('message', async function(event) {
			console.log('收到iframe消息:', event.data, '来源:', event.origin);
			
			// 安全检查：确保消息来源（兼容file://协议）
			// 在file://协议下，允许来自null origin的消息
			const currentOrigin = window.location.origin || 'file://';
			const eventOrigin = event.origin;
			
			// 如果是file://协议，允许null origin或file:// origin
			if (currentOrigin === 'file://') {
				if (eventOrigin !== null && eventOrigin !== 'file://' && eventOrigin !== 'null') {
					console.log('消息来源不匹配，忽略:', eventOrigin, 'vs', currentOrigin);
					return;
				}
			} else {
				// 对于HTTP协议，严格检查origin
				if (eventOrigin !== currentOrigin) {
					console.log('消息来源不匹配，忽略:', eventOrigin, 'vs', currentOrigin);
					return;
				}
			}
			
			if (event.data.type === 'saveBookNote') {
				console.log('处理保存笔记请求:', event.data.data);
				try {
					// 使用缓存同步服务保存笔记
					if (window.cacheSyncService) {
						console.log('使用缓存同步服务保存笔记');
						const noteId = await window.cacheSyncService.saveNote(event.data.data);
						
						// 发送响应回iframe
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'saveBookNoteResponse',
							success: true,
							noteId: noteId,
							message: '笔记已保存，将在网络可用时同步到云端'
						}, targetOrigin);
						
						console.log('笔记已通过缓存同步服务保存');
					} else if (window.supabaseService && window.supabaseService.currentUser) {
						console.log('缓存同步服务不可用，使用直接云端保存');
						const result = await window.supabaseService.saveBookNote(event.data.data);
						
						// 发送响应回iframe
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'saveBookNoteResponse',
							success: result.success,
							error: result.error
						}, targetOrigin);
						
						if (result.success) {
							console.log('电子书笔记已保存到云端');
						} else {
							console.log('电子书笔记云端保存失败:', result.error);
						}
					} else {
						console.log('用户未登录且缓存同步服务不可用');
						// 发送失败响应
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'saveBookNoteResponse',
							success: false,
							error: '用户未登录且缓存同步服务不可用'
						}, targetOrigin);
					}
				} catch (error) {
					console.log('电子书笔记保存出错:', error);
					// 发送错误响应
					const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
					event.source.postMessage({
						type: 'saveBookNoteResponse',
						success: false,
						error: error.message
					}, targetOrigin);
				}
			} else if (event.data.type === 'getBookNotes') {
				console.log('处理获取笔记请求:', event.data.data);
				try {
					// 使用缓存同步服务获取笔记
					if (window.cacheSyncService) {
						console.log('使用缓存同步服务获取笔记');
						const notes = await window.cacheSyncService.getAllNotes();
						
						// 发送响应回iframe
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'bookNotesResponse',
							success: true,
							data: notes,
							message: '已获取所有笔记（包含云端和本地）'
						}, targetOrigin);
						
						console.log('通过缓存同步服务获取到笔记:', notes.length);
					} else if (window.supabaseService && window.supabaseService.currentUser) {
						console.log('缓存同步服务不可用，使用直接云端获取');
						const result = await window.supabaseService.getBookNotes(event.data.data.chapterId);
						console.log('云端笔记获取结果:', result);
						
						// 发送响应回iframe
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'bookNotesResponse',
							success: result.success,
							data: result.data,
							error: result.error
						}, targetOrigin);
					} else {
						console.log('用户未登录且缓存同步服务不可用');
						// 发送空响应
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'bookNotesResponse',
							success: false,
							data: [],
							error: '用户未登录且缓存同步服务不可用'
						}, targetOrigin);
					}
				} catch (error) {
					console.log('电子书笔记获取出错:', error);
					// 发送错误响应
					const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
					event.source.postMessage({
						type: 'bookNotesResponse',
						success: false,
						data: [],
						error: error.message
					}, targetOrigin);
				}
			} else if (event.data.type === 'deleteBookNote') {
				console.log('处理删除笔记请求:', event.data.data);
				try {
					// 使用缓存同步服务删除笔记
					if (window.cacheSyncService) {
						console.log('使用缓存同步服务删除笔记');
						const success = await window.cacheSyncService.deleteNote(event.data.data.noteId);
						
						// 发送响应回iframe
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'deleteBookNoteResponse',
							success: success,
							message: success ? '笔记已删除，将在网络可用时同步到云端' : '删除失败'
						}, targetOrigin);
						
						console.log('通过缓存同步服务删除笔记:', success);
					} else if (window.supabaseService && window.supabaseService.currentUser) {
						console.log('缓存同步服务不可用，使用直接云端删除');
						const result = await window.supabaseService.deleteBookNote(event.data.data.noteId);
						console.log('云端笔记删除结果:', result);
						
						// 发送响应回iframe
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'deleteBookNoteResponse',
							success: result.success,
							error: result.error
						}, targetOrigin);
					} else {
						console.log('用户未登录且缓存同步服务不可用');
						// 发送失败响应
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'deleteBookNoteResponse',
							success: false,
							error: '用户未登录且缓存同步服务不可用'
						}, targetOrigin);
					}
				} catch (error) {
					console.log('电子书笔记删除出错:', error);
					// 发送错误响应
					const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
					event.source.postMessage({
						type: 'deleteBookNoteResponse',
						success: false,
						error: error.message
					}, targetOrigin);
				}
			} else if (event.data.type === 'forceSyncAll') {
				console.log('处理强制同步所有数据请求');
				try {
					if (window.cacheSyncService) {
						console.log('开始强制同步所有数据');
						await window.cacheSyncService.forceSyncAll();
						
						// 发送响应回iframe
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'forceSyncAllResponse',
							success: true,
							message: '强制同步已完成'
						}, targetOrigin);
						
						console.log('强制同步完成');
					} else {
						console.log('缓存同步服务不可用');
						const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
						event.source.postMessage({
							type: 'forceSyncAllResponse',
							success: false,
							error: '缓存同步服务不可用'
						}, targetOrigin);
					}
				} catch (error) {
					console.log('强制同步出错:', error);
					const targetOrigin = event.origin && event.origin !== 'null' ? event.origin : '*';
					event.source.postMessage({
						type: 'forceSyncAllResponse',
						success: false,
						error: error.message
					}, targetOrigin);
				}
			}
		});
		
	</script>
</body>
</html>


